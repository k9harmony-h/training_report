<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        /* â˜…â˜…â˜… BRANDING UPDATE: K9 Harmony Shelter Colors â˜…â˜…â˜… */
        :root {
            --primary-color: #88b08b; /* Sage Green (ãƒ¡ã‚¤ãƒ³: é®é™åŠ¹æœ) */
            --accent-color: #e8f5e9; /* Light Pale Green (èƒŒæ™¯ã®æ·¡ã„ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ) */
            --alert-color: #e07a5f; /* Terracotta Orange (è­¦å‘Šãƒ»æ³¨æ„è‰²) */
            --mask-color: #f0f0f0;
        }
        /* â˜…â˜…â˜… END BRANDING UPDATE â˜…â˜…â˜… */

        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif; background-color: #f9fbf9; color: #333; padding-bottom: 200px; }

        .version-stamp { position: fixed; top: 0; right: 0; background: var(--primary-color); color: white; font-size: 10px; padding: 2px 5px; z-index: 9999; font-family: monospace; opacity: 0.9; }

        /* DEBUG CONSOLE */
        #debug-console-container { display: block; margin-top: 30px; }
        #debug-console { background-color: #000; color: #0f0; font-family: monospace; font-size: 11px; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-break: break-all; border: 2px solid #555; }

        /* COMMON STYLES */
        .card-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); height: 100%; border: 1px solid #eee; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; margin-bottom: 15px; }
        .info-label { font-weight: bold; color: #666; display: block; font-size: 0.85rem; margin-bottom: 2px; }
        .info-value { font-size: 1rem; min-height: 24px; word-break: break-word; font-weight: 500; }
        .loading { text-align: center; padding: 40px; color: #666; }
        
        /* Dog Photo */
        #d_photo_container {
            width: 200px; height: 200px; background-color: #fff; border-radius: 12px; border: 4px solid var(--accent-color); overflow: hidden; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; flex-shrink: 0;
        }
        .dog-profile-img { width: 100%; height: 100%; object-fit: cover; }

        /* QR Code */
        .qr-section { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd; display: flex; align-items: center; gap: 10px; }
        .qr-img { width: 60px; height: 60px; border: 1px solid #ddd; padding: 2px; background: white; }
        .qr-text { font-size: 0.75rem; color: #666; line-height: 1.3; }

        /* Masking & Buttons */
        .masked-wrapper { background: var(--mask-color); padding: 4px 10px; border-radius: 6px; display: inline-flex; align-items: center; }
        .masked-text { letter-spacing: 3px; color: #aaa; user-select: none; margin-right: 10px; font-family: monospace; }
        .real-text { display: none; font-weight: bold; color: #333; margin-right: 10px; }
        .btn-toggle-mask { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--alert-color); color: var(--alert-color); background: white; cursor: pointer; transition: all 0.2s; }
        .btn-toggle-mask.active { background: var(--alert-color); color: white; }
        .btn-cert-view { font-size: 0.85rem; padding: 6px 15px; margin-left: auto; border-radius: 6px; background-color: var(--primary-color); color: white; border: none; cursor: pointer; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        
        /* Help Button */
        .btn-help { border: none; background: none; color: #999; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
        .btn-help:hover { color: var(--primary-color); }

        /* Dog Select Modal Button */
        .dog-select-btn { width: 100%; margin-bottom: 10px; padding: 15px; font-weight: bold; font-size: 1.1rem; border-radius: 12px; background: #f8f9fa; border: 2px solid var(--primary-color); color: var(--primary-color); transition: all 0.2s; }
        .dog-select-btn:active { background: var(--primary-color); color: #fff; transform: scale(0.98); }

        .no-print-area { margin: 20px 0 30px; text-align: center; }
        .btn-print { background-color: var(--primary-color); color: white; padding: 12px 30px; border-radius: 50px; border: none; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 10px rgba(136, 176, 139, 0.4); transition: transform 0.1s; width: 100%; margin-bottom: 10px; }
        .btn-print-crate { background-color: var(--alert-color); color: white; }
        .disclaimer-footer { font-size: 0.8rem; color: #999; margin-top: 40px; padding-bottom: 20px; border-top: 1px solid #eee; padding-top: 20px; }

        /* Screen Layout */
        @media screen {
            .info-row { margin-bottom: 12px; }
            .screen-two-col-layout { display: flex; gap: 20px; flex-wrap: wrap; }
            .screen-two-col-layout > .print-block { flex: 1 1 400px; }
            .basic-info-wrapper { display: flex; flex-direction: column; text-align: center; align-items: center; }
            .basic-info-text { width: 100%; text-align: left; }
        }

        /* --- PRINT MEDIA QUERIES --- */
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            body { background: white; -webkit-print-color-adjust: exact; padding: 0; font-size: 10pt; }
            .no-print-area, header, .btn-toggle-mask, .btn-cert-view, .modal, .version-stamp, #debug-console-container { display: none !important; }
            .masked-wrapper { background: none; padding: 0; display: block; }
            .masked-text { display: none !important; }
            .real-text { display: block !important; color: #000; }

            /* MODE SWITCHING */
            body.print-mode-handbook #crate-tag-display { display: none; }
            body.print-mode-handbook #main-display { display: block; }

            body.print-mode-crate #main-display { display: none; }
            body.print-mode-crate #crate-tag-display { display: block; width: 100%; height: 100%; }

            /* HANDBOOK LAYOUT (4-Split) */
            body.print-mode-handbook .print-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: 10mm; height: 180mm; }
            body.print-mode-handbook #d_photo_container { width: 140px; height: 140px; margin-right: 15px; border: 2px solid #333; }
            body.print-mode-handbook .card-section { box-shadow: none; border: 2px solid #333; padding: 10px; height: 100%; page-break-inside: avoid; }
            body.print-mode-handbook .basic-info-wrapper { display: flex; flex-direction: row; text-align: left; }

            /* CRATE TAG LAYOUT */
            .crate-container {
                border: 4px solid var(--primary-color);
                border-radius: 20px; padding: 20px; height: 190mm; display: grid; grid-template-columns: 30% 70%; gap: 20px;
            }
            .crate-left { text-align: center; border-right: 2px dashed #ccc; padding-right: 20px; }
            .crate-right { display: flex; flex-direction: column; gap: 15px; }
            
            .crate-photo-box {
                width: 100%; aspect-ratio: 1; border: 4px solid var(--alert-color); border-radius: 15px; overflow: hidden; margin-bottom: 10px;
            }
            .crate-photo-img { width: 100%; height: 100%; object-fit: cover; }
            
            .crate-name { font-size: 32pt; font-weight: 900; color: #000; line-height: 1.1; margin-bottom: 10px; }
            .crate-breed { font-size: 14pt; color: #555; font-weight: bold; }
            
            .crate-alert-box {
                border: 3px solid var(--alert-color); background-color: #fff5f5; padding: 10px; border-radius: 10px;
            }
            .crate-alert-title { color: var(--alert-color); font-weight: bold; font-size: 12pt; display: block; border-bottom: 1px solid var(--alert-color); margin-bottom: 5px; }
            .crate-alert-content { font-size: 16pt; font-weight: bold; color: #000; }

            .crate-write-box {
                border: 2px solid #888; border-radius: 8px; padding: 5px; flex-grow: 1; min-height: 60px;
            }
            .crate-label { font-size: 10pt; font-weight: bold; color: var(--primary-color); display: block; margin-bottom: 2px; }
            .crate-write-line { border-bottom: 1px solid #ccc; height: 25px; margin-top: 15px; }
            
            .crate-footer {
                margin-top: auto; border-top: 2px solid var(--primary-color); padding-top: 10px; display: flex; justify-content: space-between; align-items: center;
            }
            .crate-checkbox {
                border: 2px solid #333; width: 20px; height: 20px; display: inline-block; margin-right: 5px; vertical-align: middle;
            }
        }
    </style>
</head>
<body class="print-mode-handbook">

    <div class="version-stamp">v2025.12.02-COLOR-FIX</div>

    <div class="container py-4">
        <div class="no-print-area">
            <div class="d-flex align-items-center justify-content-center mb-3">
                <h4 class="fw-bold m-0" style="color: var(--primary-color);">â›‘ï¸ ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</h4>
                <button class="btn-help ms-2" data-bs-toggle="modal" data-bs-target="#helpModal"><i class="fa-solid fa-circle-question"></i></button>
            </div>
            
            <div id="loading" class="loading">
                <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 fw-bold">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
            </div>

            <div id="content-controls" style="display:none; max-width: 500px; margin: 0 auto;">
                <p class="text-muted mb-3 small">ä»¥ä¸‹ã‹ã‚‰ç”¨é€”ã«åˆã‚ã›ã¦å°åˆ·ã—ã¦ãã ã•ã„ã€‚</p>
                
                <div class="row g-2">
                    <div class="col-6">
                        <button onclick="printMode('handbook')" class="btn btn-print">
                            <i class="fa-solid fa-book-medical"></i><br>é˜²ç½æ‰‹å¸³<br><span style="font-size:0.7rem; font-weight:normal;">æŒã¡æ­©ãç”¨ (4åˆ†å‰²)</span>
                        </button>
                    </div>
                    <div class="col-6">
                        <button onclick="printMode('crate')" class="btn btn-print btn-print-crate">
                            <i class="fa-solid fa-house-chimney-medical"></i><br>ãƒã‚¦ã‚¹æ²ç¤º<br><span style="font-size:0.7rem; font-weight:normal;">ã‚±ãƒ¼ã‚¸è²¼ä»˜ç”¨ (A4)</span>
                        </button>
                    </div>
                </div>
                <button onclick="goBack()" class="btn btn-outline-secondary px-4 rounded-pill fw-bold mt-3">æˆ»ã‚‹</button>
            </div>
        </div>

        <div id="main-display" style="display:none;">
            <div class="print-container">
                
                <div class="print-block">
                    <div class="card-section">
                        <div class="section-title">åŸºæœ¬æƒ…å ± / Owner Info</div>
                        
                        <div class="basic-info-wrapper">
                            <div id="d_photo_container"><div class="spinner-border text-secondary" role="status"></div></div>
                            
                            <div class="basic-info-text">
                                <div class="row info-row">
                                    <div class="col-7"><span class="info-label">ãŠåå‰ (Dog Name)</span><div class="info-value fs-5 fw-bold" id="d_name">-</div></div>
                                    <div class="col-5"><span class="info-label">çŠ¬ç¨® (Breed)</span><div class="info-value" id="d_breed">-</div></div>
                                </div>
                                <div class="row info-row">
                                    <div class="col-4"><span class="info-label">æ€§åˆ¥</span><div class="info-value" id="d_gender">-</div></div>
                                    <div class="col-4"><span class="info-label">èª•ç”Ÿæ—¥</span><div class="info-value" id="d_birth">-</div></div>
                                    <div class="col-4"><span class="info-label">å¹´é½¢</span><div class="info-value" id="d_age">-</div></div>
                                </div>
                                <hr class="my-2" style="border-color: var(--accent-color);">
                                <div class="info-row">
                                    <span class="info-label">é£¼ã„ä¸»æ§˜ (Owner)</span><div class="info-value fw-bold" id="c_name">-</div>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ä½æ‰€ (Address)</span>
                                    <div class="masked-wrapper">
                                        <span class="masked-text" id="c_address_masked">***</span>
                                        <span class="real-text" id="c_address_real">-</span>
                                        <button class="btn-toggle-mask" onclick="toggleMask(this, 'ä½æ‰€')">è¡¨ç¤º</button>
                                    </div>
                                </div>
                                <div class="info-row mb-0">
                                    <span class="info-label">é›»è©±ç•ªå· (Phone)</span>
                                    <div class="masked-wrapper">
                                        <span class="masked-text" id="c_phone_masked">***-****-****</span>
                                        <span class="real-text" id="c_phone_real">-</span>
                                        <button class="btn-toggle-mask" onclick="toggleMask(this, 'é›»è©±ç•ªå·')">è¡¨ç¤º</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="screen-two-col-layout">
                    <div class="print-block">
                        <div class="card-section">
                            <div class="section-title" style="color: var(--alert-color); border-bottom-color: #f8d7da;">ç·Šæ€¥é€£çµ¡å…ˆ / Emergency</div>
                            <div class="info-row">
                                <span class="info-label">ç·Šæ€¥é€£çµ¡å…ˆ (Emergency Contact)</span><div class="info-value fw-bold" id="c_em_name">-</div>
                                <div class="masked-wrapper mt-1">
                                    <span class="masked-text" id="c_em_phone_masked">***-****-****</span>
                                    <span class="real-text" id="c_em_phone_real">-</span>
                                    <button class="btn-toggle-mask" onclick="toggleMask(this, 'é€£çµ¡å…ˆ')">è¡¨ç¤º</button>
                                </div>
                            </div>
                            <div class="info-row p-2 rounded" style="background-color: #fff3cd; border: 1px solid #ffeeba;">
                                <span class="info-label text-danger">ä»£ç†å¼•å—äºº (Proxy Person)</span>
                                <div class="info-value fw-bold" id="c_proxy_name">-</div>
                                <div class="masked-wrapper mt-1" style="background: rgba(255,255,255,0.7);">
                                    <span class="masked-text" id="c_proxy_phone_masked">***-****-****</span>
                                    <span class="real-text" id="c_proxy_phone_real">-</span>
                                    <button class="btn-toggle-mask" onclick="toggleMask(this, 'é€£çµ¡å…ˆ')">è¡¨ç¤º</button>
                                </div>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æŒ‡å®šé¿é›£æ‰€ (Evacuation Site)</span><div class="info-value" id="c_evac">-</div>
                            </div>
                            
                            <div id="qr-container" class="qr-section" style="display:none;">
                                <img id="map-qr-img" class="qr-img" src="" alt="QR">
                                <div class="qr-text"><strong>ğŸ—ºï¸ é¿é›£æ‰€ãƒ»ç—…é™¢ãƒãƒƒãƒ—</strong><br>Googleãƒãƒƒãƒ—ãŒé–‹ãã¾ã™</div>
                            </div>
                        </div>
                    </div>

                    <div class="print-block">
                        <div class="card-section">
                            <div class="section-title">ã‚±ã‚¢æƒ…å ± / Care Info</div>
                            <div class="info-row p-2 rounded border border-danger" style="background-color: #fff5f5;">
                                <span class="info-label text-danger">âš ï¸ ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ (Allergies)</span>
                                <div class="info-value fw-bold text-danger" id="d_allergy">-</div>
                            </div>
                            <div class="info-row">
                                <span class="info-label">é£Ÿã¹ã¦ã„ã‚‹ãƒ•ãƒ¼ãƒ‰ (Food)</span><div class="info-value" id="d_food">-</div>
                            </div>
                            <div class="info-row mb-0">
                                <span class="info-label">æ€§æ ¼ãƒ»æ³¨æ„äº‹é … (Caution)</span><div class="info-value" id="d_caution">-</div>
                            </div>
                            <div class="mt-3 text-end"><small class="text-muted" style="font-size:0.7rem;">æœ€çµ‚æ›´æ–°æ—¥: <span id="print_date"></span></small></div>
                        </div>
                    </div>
                </div>

                <div class="print-block">
                    <div class="card-section">
                        <div class="section-title">åŒ»ç™‚æƒ…å ± / Medical</div>
                        <div class="info-row">
                            <span class="info-label">ã‹ã‹ã‚Šã¤ã‘å‹•ç‰©ç—…é™¢ (Vet)</span><div class="info-value fw-bold" id="d_vet">-</div>
                        </div>
                        <div class="row info-row">
                            <div class="col-6">
                                <div class="p-2 rounded" style="background: var(--accent-color);">
                                    <span class="info-label">ç‹‚çŠ¬ç—…äºˆé˜²æ¥ç¨®</span>
                                    <div class="d-flex align-items-center justify-content-between mt-1">
                                        <span id="d_rabies_status" class="fw-bold small">-</span>
                                        <button id="btn_rabies_img" class="btn-cert-view" style="display:none;">ğŸ“·</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded" style="background: var(--accent-color);">
                                    <span class="info-label">æ··åˆãƒ¯ã‚¯ãƒãƒ³</span>
                                    <div class="d-flex align-items-center justify-content-between mt-1">
                                        <span id="d_vaccine_status" class="fw-bold small">-</span>
                                        <button id="btn_vaccine_img" class="btn-cert-view" style="display:none;">ğŸ“·</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row info-row">
                            <div class="col-6"><span class="info-label">æ—¢å¾€æ­´</span><div class="info-value small" id="d_history">-</div></div>
                            <div class="col-6"><span class="info-label">å¸¸å‚™è–¬</span><div class="info-value text-danger fw-bold small" id="d_medicine">-</div></div>
                        </div>
                        <div class="info-row mb-0 bg-light p-1 rounded">
                            <span class="info-label">é‘‘æœ­ / Chip</span><div class="info-value" style="font-family: monospace; font-size: 0.9rem;"><span id="d_license"></span> / <span id="d_chip"></span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="print-footer">ã€ã”æ³¨æ„ã€‘æœ¬ã‚«ãƒ¼ãƒ‰ã¯å…¬çš„è¨¼æ˜æ›¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚K9 Harmony Portal</div>
        </div>

        <div id="crate-tag-display">
            <div class="crate-container">
                <div class="crate-left">
                    <div class="crate-photo-box">
                        <img id="crate_dog_img" class="crate-photo-img" src="" alt="Dog">
                    </div>
                    <div class="crate-name" id="crate_d_name">NAME</div>
                    <div class="crate-breed" id="crate_d_breed">Breed</div>
                    <div class="mt-4 text-start">
                        <div class="small fw-bold">é£¼ã„ä¸» (Owner)</div>
                        <div class="fs-5 fw-bold" id="crate_c_name">-</div>
                        <div class="fs-6 mt-1" id="crate_c_phone">-</div>
                    </div>
                    <div class="mt-4 text-start">
                        <div class="small fw-bold">ä»£ç†äºº (Proxy)</div>
                        <div class="fs-6 fw-bold" id="crate_proxy_name">-</div>
                        <div class="fs-6" id="crate_proxy_phone">-</div>
                    </div>
                </div>
                
                <div class="crate-right">
                    <div class="crate-alert-box">
                        <span class="crate-alert-title">âš ï¸ æ€§æ ¼ãƒ»æ³¨æ„äº‹é … (Caution)</span>
                        <div class="crate-alert-content" id="crate_caution">-</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="crate-write-box">
                                <span class="crate-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ (Allergies)</span>
                                <div id="crate_allergy" class="fw-bold">-</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="crate-write-box">
                                <span class="crate-label">æ—¢å¾€æ­´ãƒ»æŒç—… (History)</span>
                                <div id="crate_history">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="crate-write-box" style="flex-grow:1;">
                        <span class="crate-label">é£Ÿäº‹ãƒ»çµ¦é¤Œãƒ­ã‚° (Food Log) - ç½å®³æ™‚ã¯æ‰‹æ›¸ãã§ä¿®æ­£ã—ã¦ãã ã•ã„</span>
                        <div class="d-flex justify-content-between text-muted small mt-1">
                            <span>é€šå¸¸æ™‚: <span id="crate_food">-</span></span>
                        </div>
                        <div class="crate-write-line"></div>
                        <div class="crate-write-line"></div>
                        <div class="crate-write-line"></div>
                    </div>

                    <div class="crate-write-box" style="flex-grow:1;">
                        <span class="crate-label">æŠ•è–¬ãƒ»ã‚±ã‚¢ãƒ­ã‚° (Meds/Care)</span>
                        <div class="d-flex justify-content-between text-muted small mt-1">
                            <span>é€šå¸¸æ™‚: <span id="crate_medicine">-</span></span>
                        </div>
                        <div class="crate-write-line"></div>
                        <div class="crate-write-line"></div>
                        <div class="crate-write-line"></div>
                    </div>

                    <div class="crate-footer">
                        <div class="small text-muted">ç™ºè¡Œæ—¥: <span id="crate_print_date"></span></div>
                        <div class="fw-bold" style="font-size:11pt;">
                            <span class="crate-checkbox"></span> ç·Šæ€¥æ™‚ã®ç£åŒ»å‡¦ç½®ã‚’ä¸€ä»»ã—ã¾ã™ (Emergency Care Authorized)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="disclaimer-footer no-print-area text-center">
            <p>ã€å…è²¬äº‹é …ãƒ»ã”æ³¨æ„ã€‘<br>æœ¬ã‚¢ãƒ—ãƒªãŠã‚ˆã³å‡ºåŠ›ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã¯ã€å…¬çš„ãªè¨¼æ˜æ›¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ²è¼‰æƒ…å ±ã¯æœ€çµ‚æ›´æ–°æ—¥æ™‚ç‚¹ã®ã‚‚ã®ã§ã™ã€‚<br>Â© K9 Harmony</p>
        </footer>
        
        <div id="debug-console-container" class="container no-print-area">
            <h6 class="text-danger fw-bold mb-2">âš ï¸ Debug Console</h6>
            <div id="debug-console">Initializing...</div>
        </div>
    </div>

    <div class="modal fade" id="helpModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold" style="color: var(--primary-color);">ã“ã®æ‰‹å¸³ã«ã¤ã„ã¦</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-muted mb-3">K9 Harmony Portal</p><h6 class="fw-bold">2ã¤ã®å°åˆ·ãƒ¢ãƒ¼ãƒ‰</h6><ul class="small ps-3"><li><strong>é˜²ç½æ‰‹å¸³:</strong> ãŠè²¡å¸ƒã«å…¥ã‚‹å››ã¤æŠ˜ã‚Šã‚µã‚¤ã‚ºã€‚</li><li><strong>ãƒã‚¦ã‚¹æ²ç¤º (NEW):</strong> é¿é›£æ‰€ã®ã‚¯ãƒ¬ãƒ¼ãƒˆã«è²¼ã‚‹A4ä¸€æšã‚µã‚¤ã‚ºã€‚æ‰‹æ›¸ãæ¬„ãŒã‚ã‚Šã€å¤‰åŒ–ã™ã‚‹çŠ¶æ³ã«å¯¾å¿œã§ãã¾ã™ã€‚</li></ul></div><div class="modal-footer border-0 pt-0"><button type="button" class="btn btn-secondary btn-sm rounded-pill px-4" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button></div></div></div></div>
    <div class="modal fade" id="dogSelectModal" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title fw-bold w-100 text-center">ã‚ã‚“ã¡ã‚ƒã‚“ã‚’é¸æŠ</h5></div><div class="modal-body" id="dogSelectBody"></div></div></div></div>
    <div class="modal fade" id="imageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-body text-center p-4" style="background:#f0f0f0;"><img id="modalImage" src="" class="img-fluid rounded" style="max-height:70vh;"><button class="btn btn-secondary mt-3 rounded-pill" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";
        let imageModal, dogSelectModal;
        let currentUserId, currentDogId;

        function log(msg) {
            const el = document.getElementById('debug-console');
            const time = new Date().toLocaleTimeString();
            el.innerHTML = `[${time}] ${msg}\n` + el.innerHTML;
            console.log(msg);
        }

        function goBack() {
            let url = 'index.html';
            if (currentDogId) url += `?dogId=${currentDogId}`;
            window.location.href = url;
        }

        function printMode(mode) {
            document.body.classList.remove('print-mode-handbook', 'print-mode-crate');
            if(mode === 'crate') {
                document.body.classList.add('print-mode-crate');
            } else {
                document.body.classList.add('print-mode-handbook');
            }
            window.print();
        }

        window.onload = async function() {
            imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            dogSelectModal = new bootstrap.Modal(document.getElementById('dogSelectModal'));
            
            try {
                log('Starting LIFF init...');
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                
                const urlParams = new URLSearchParams(window.location.search);
                currentDogId = urlParams.get('dogId');
                log(`User: ${currentUserId.substring(0,5)}..., DogID: ${currentDogId || 'Auto'}`);

                fetchData(currentUserId, currentDogId);
            } catch (err) {
                log('FATAL ERROR: ' + err.message);
                document.getElementById('loading').innerHTML = `<p class="text-danger fw-bold">åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ<br><small>${err.message}</small></p>`;
            }
        };

        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            log('Fetching main data...');
            fetch(url).then(res => res.json()).then(data => {
                if (data.error) { 
                    log('API Error: ' + data.error);
                    document.getElementById('loading').innerHTML = `<p class="text-danger fw-bold">${data.error}</p>`; return; 
                }
                if (data.multiple_dogs) { 
                    log('Multiple dogs found. Showing selector.');
                    showDogSelectModal(data.multiple_dogs);
                    return; 
                }
                
                renderData(data);
                fetchDogImage(userId, data.dog.id);
            }).catch(err => {
                log('Fetch Error: ' + err.message);
                document.getElementById('loading').innerHTML = `<p class="text-danger fw-bold">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
            });
        }

        function showDogSelectModal(dogs) {
            const body = document.getElementById('dogSelectBody');
            body.innerHTML = '';
            dogs.forEach(dog => {
                const btn = document.createElement('button');
                btn.className = 'dog-select-btn';
                btn.innerText = dog.name; 
                btn.onclick = () => selectDog(dog.id);
                body.appendChild(btn);
            });
            document.getElementById('loading').style.display = 'none';
            dogSelectModal.show();
        }

        function selectDog(dogId) {
            dogSelectModal.hide();
            document.getElementById('loading').style.display = 'block';
            currentDogId = dogId;
            fetchData(currentUserId, dogId);
        }

        function renderData(data) {
            log('Rendering data...');
            try {
                const c = data.customer || {};
                const d = data.dog || {};
                currentDogId = d.id;

                // --- Handbook Data ---
                setText('d_name', d.name_disp);
                setText('d_breed', d.breed);
                setText('d_gender', d.gender);
                setText('d_birth', d.birth_date);
                setText('d_age', d.age); // Y-M format
                setText('c_name', c.name);
                setMaskedText('c_address', c.address, maskAddress(c.address));
                setMaskedText('c_phone', c.phone, null);
                setText('c_em_name', c.em_name);
                setMaskedText('c_em_phone', c.em_phone, null);
                setText('c_proxy_name', c.proxy_name);
                setMaskedText('c_proxy_phone', c.proxy_phone, null);
                setText('c_evac', c.evac_site);

                // --- Crate Tag Data ---
                setText('crate_d_name', d.name_disp);
                setText('crate_d_breed', d.breed);
                setText('crate_c_name', c.name);
                setText('crate_c_phone', c.phone);
                setText('crate_proxy_name', c.proxy_name);
                setText('crate_proxy_phone', c.proxy_phone);
                setText('crate_caution', d.caution);
                setText('crate_allergy', d.allergy);
                setText('crate_history', d.history);
                setText('crate_food', d.food);
                setText('crate_medicine', d.medicine);

                // --- QR Code ---
                if (c.evac_site && c.evac_site !== 'è¨˜è¼‰ãªã—') {
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.evac_site)}`;
                    const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(mapUrl)}`;
                    document.getElementById('map-qr-img').src = qrSrc;
                    document.getElementById('qr-container').style.display = 'flex';
                }

                setupCertButton('d_rabies_status', 'btn_rabies_img', d.has_rabies, d.rabies_img_ref);
                setupCertButton('d_vaccine_status', 'btn_vaccine_img', d.has_vaccine, d.vaccine_img_ref);

                const now = new Date().toLocaleDateString('ja-JP');
                setText('print_date', now);
                setText('crate_print_date', now);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content-controls').style.display = 'block';
                document.getElementById('main-display').style.display = 'block';
                log('Render complete.');
            } catch (e) {
                log('Render Error: ' + e.message);
                console.error(e);
            }
        }

        function fetchDogImage(userId, dogId) {
            let url = `${API_URL}?userId=${userId}&type=img_profile&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.image) {
                    document.getElementById('d_photo_container').innerHTML = `<img src="${data.image}" class="dog-profile-img">`;
                    document.getElementById('d_photo_container').style.border = 'none';
                    document.getElementById('crate_dog_img').src = data.image;
                } else {
                    document.getElementById('d_photo_container').innerHTML = '<span class="text-muted small">No Image</span>';
                }
            });
        }

        function maskAddress(address) {
            if (!address || address === 'è¨˜è¼‰ãªã—') return address;
            const match = address.match(/(.*?[éƒ½é“åºœçœŒ])/);
            if (match) return match[1] + ' *** (ä»¥é™éè¡¨ç¤º)';
            return address.substring(0, 4) + ' ***';
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = (text === undefined || text === null || text === '') ? '-' : text;
        }
        
        function setMaskedText(baseId, realText, maskedText) {
            try {
                const realEl = document.getElementById(baseId + '_real');
                const maskedEl = document.getElementById(baseId + '_masked');
                
                if(!realEl || !maskedEl) return;

                const btn = realEl.parentElement.querySelector('.btn-toggle-mask');

                if (!realText || realText === 'è¨˜è¼‰ãªã—') {
                    realEl.textContent = 'è¨˜è¼‰ãªã—'; 
                    maskedEl.style.display = 'none'; 
                    realEl.style.display = 'block';
                    if(btn) btn.style.display = 'none'; 
                    return;
                }
                realEl.textContent = realText;
                maskedEl.textContent = maskedText || '***-****-****';
                if(btn) btn.style.display = 'inline-block';
            } catch(e) { log('Error in setMaskedText: ' + e.message); }
        }

        function toggleMask(btn, label) {
            const wrapper = btn.parentElement;
            const masked = wrapper.querySelector('.masked-text');
            const real = wrapper.querySelector('.real-text');
            if (real.style.display === 'block') {
                real.style.display = 'none'; masked.style.display = 'block'; btn.textContent = 'è¡¨ç¤º'; btn.classList.remove('active');
            } else {
                if(confirm(`å‘¨å›²ã«äººãŒã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n${label}ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ`)) {
                    real.style.display = 'block'; masked.style.display = 'none'; btn.textContent = 'éš ã™'; btn.classList.add('active');
                }
            }
        }

        function setupCertButton(statusId, btnId, hasCert, imgRef) {
            document.getElementById(statusId).textContent = hasCert ? 'æ¥ç¨®æ¸ˆã¿' : 'æœªç™»éŒ²';
            const btn = document.getElementById(btnId);
            if (hasCert && imgRef) {
                btn.style.display = 'inline-flex';
                btn.onclick = () => {
                    document.getElementById('modalImage').src = (imgRef.indexOf('http')===-1) ? `https://drive.google.com/uc?export=view&id=${imgRef}` : imgRef;
                    imageModal.show();
                };
            } else { btn.style.display = 'none'; }
        }

        function openImageModal(ref) {
            const imgEl = document.getElementById('modalImage');
            const loadingEl = document.getElementById('modalLoading');
            imgEl.style.display = 'none'; loadingEl.style.display = 'inline-block';
            let src = ref;
            if (ref.indexOf('http') === -1) src = `https://drive.google.com/uc?export=view&id=${ref}`;
            else if (ref.indexOf('drive.google.com') > -1) {
                const match = ref.match(/\/d\/(.+?)\//);
                if(match) src = `https://drive.google.com/uc?export=view&id=${match[1]}`;
            }
            imgEl.src = src; imgEl.style.display = 'block';
            imageModal.show();
        }
    </script>
</body>
</html>
