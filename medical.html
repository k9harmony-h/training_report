<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony Portal - うちの子医療・防災手帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/2.23.1/liff.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ... (既存のCSS省略) ... */

        /* デバッグログ表示エリアのスタイル（画面上部に強制表示） */
        #debug-log-area {
            position: fixed;
            top: 50px; /* ヘッダーの下 */
            left: 0;
            width: 100%;
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            padding: 5px;
            max-height: 80px; 
            overflow-y: scroll;
            z-index: 9999;
            border-top: 2px solid #555;
            word-wrap: break-word; 
        }
        
        /* ログスタンプ表示の調整 */
        #log-stamp-static {
            position: absolute;
            top: 0;
            left: 0;
            background: #333;
            color: white;
            padding: 2px 5px;
            font-size: 10px;
            font-family: monospace;
            z-index: 10000;
        }

    </style>
</head>
<body>
    <p id="log-stamp-static">INIT-002</p> 
    
    <div class="liff-app-container">
        <header class="p-3 bg-white shadow-sm sticky-top">
            <h1 class="h5 text-center mb-0" style="color: var(--color-primary);"><i class="fa-solid fa-paw me-2"></i>K9 Harmony Portal - うちの子医療・防災手帳</h1>
        </header>

        <div id="debug-log-area">
            <strong style="color:#fff;">DEBUG LOG:</strong> <span id="debug-log-content"></span>
        </div>

        <main class="container-fluid p-3" style="padding-top: 100px !important;"> <div id="liff-status" class="text-center my-5">
                <p id="liff-message" class="text-muted">LIFF初期化中...</p>
                <i id="liff-spinner" class="fa-solid fa-spinner fa-spin fa-2x text-primary" style="display:none;"></i>
            </div>
            
            </main>
        
        </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDogData = null;
        let currentPrintMode = '';
        let printSelectModal;
        let pdfPreviewModal;
        
        // ====================================
        // ログユーティリティ (画面とコンソールに出力)
        // ====================================
        // NOTE: この関数は、DOMContentLoadedで呼び出されるため、DOMのアクセスは保証される
        function log(message) {
            console.log(`[APP LOG] ${message}`);
            // 画面上のデバッグエリアにもログを出力
            const logContent = document.getElementById('debug-log-content');
            if (logContent) {
                const date = new Date();
                const now = date.toLocaleTimeString();
                
                // ログスタンプの動的更新 (hhmm-001形式)
                const hh = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                document.getElementById('log-stamp-static').textContent = `${hh}${mm}-001`;

                logContent.innerHTML = `[${now}] ${message}<br>` + logContent.innerHTML;
            }
        }

        // ====================================
        // LIFF初期化
        // ====================================
        async function initializeLiff() {
            try {
                const LIFF_ID = '2008546673-MJY7j3ox'; 
                
                log('Step 1/4: LIFF initialization started.');
                document.getElementById('liff-spinner').style.display = 'inline-block';

                await liff.init({ liffId: LIFF_ID });
                log('Step 2/4: LIFF initialized successfully.');
                
                // ... (LIFF成功時の処理は省略、今はログ表示に集中) ...
                
            } catch (e) {
                // エラー発生時は即座に画面にメッセージを表示
                log(`FATAL: LIFF initialization failed: ${e.message}`);
                // エラー時の画面表示ロジックは最小限に留める
                document.getElementById('liff-message').textContent = `LIFF初期化エラー: ${e.message}`;
                document.getElementById('liff-spinner').style.display = 'none';
            }
        }

        // ... (データ操作、レンダリング、イベントハンドラ、PDF生成ロジックは変更なし) ...
        
        // ====================================
        // 初期処理
        // ====================================

        document.addEventListener('DOMContentLoaded', () => {
            // ログの初期メッセージをここで出力
            log('DOM fully loaded. Starting initialization cycle.');
            
            // モーダルインスタンス化の処理を移動（LIFF初期化成功後に実行されるように）
            const printSelectModalEl = document.getElementById('printSelectModal');
            printSelectModal = new bootstrap.Modal(printSelectModalEl);
            const pdfPreviewModalEl = document.getElementById('pdfPreviewModal');
            pdfPreviewModal = new bootstrap.Modal(pdfPreviewModalEl);

            initializeLiff();
        });
    </script>
</body>
</html>
