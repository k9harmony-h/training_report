<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        :root {
            --primary-color: #6da06f;
            --accent-color: #e7f3e8;
            --alert-color: #d9534f;
            --mask-color: #f0f0f0;
        }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; color: #333; padding-bottom: 50px; }

        /* --- VERSION STAMP --- */
        .version-stamp {
            position: fixed; top: 0; right: 0; background: #6da06f; color: white; font-size: 10px; padding: 2px 5px; z-index: 9999; font-family: monospace; opacity: 0.8;
        }

        /* --- DEBUG CONSOLE (Hidden by default) --- */
        #debug-console-container { display: none; margin-top: 30px; }
        #debug-console {
            background-color: #222; color: #0f0; font-family: monospace; font-size: 11px; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto;
        }

        /* --- COMMON STYLES --- */
        .card-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); height: 100%; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; margin-bottom: 15px; }
        .info-label { font-weight: bold; color: #666; display: block; font-size: 0.85rem; margin-bottom: 2px; }
        .info-value { font-size: 1rem; min-height: 24px; word-break: break-word; font-weight: 500; }
        .loading { text-align: center; padding: 40px; color: #666; }
        
        /* Dog Photo */
        #d_photo_container {
            width: 200px; height: 200px; background-color: #f8f9fa; border-radius: 12px; border: 3px solid var(--accent-color); overflow: hidden; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .dog-profile-img { width: 100%; height: 100%; object-fit: cover; }

        /* Masking UI */
        .masked-wrapper { background: var(--mask-color); padding: 4px 10px; border-radius: 6px; display: inline-flex; align-items: center; }
        .masked-text { letter-spacing: 3px; color: #aaa; user-select: none; margin-right: 10px; font-family: monospace; }
        .real-text { display: none; font-weight: bold; color: #333; margin-right: 10px; }
        .btn-toggle-mask {
            font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--alert-color); color: var(--alert-color); background: white; cursor: pointer; transition: all 0.2s;
        }
        .btn-toggle-mask:hover { background: var(--alert-color); color: white; }
        .btn-toggle-mask.active { background: var(--alert-color); color: white; }

        /* Certificate Button */
        .btn-cert-view {
            font-size: 0.85rem; padding: 6px 15px; margin-left: auto; border-radius: 6px; background-color: var(--primary-color); color: white; border: none; cursor: pointer; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-cert-view:hover { opacity: 0.9; color: white; }

        /* UI Elements */
        .no-print-area { margin: 20px 0 30px; text-align: center; }
        .btn-print { background-color: var(--primary-color); color: white; padding: 12px 40px; border-radius: 50px; border: none; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(109, 160, 111, 0.3); transition: transform 0.1s; }
        .btn-print:active { transform: scale(0.98); }
        .disclaimer-footer { font-size: 0.8rem; color: #999; margin-top: 40px; padding-bottom: 20px; border-top: 1px solid #eee; padding-top: 20px; }

        /* Screen-only layout adjustments */
        @media screen {
            .info-row { margin-bottom: 12px; }
            /* æ¨ªä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ */
            .screen-two-col-layout { display: flex; gap: 20px; flex-wrap: wrap; }
            .screen-two-col-layout > .print-block { flex: 1 1 400px; /* å¹…ãŒè¶³ã‚Šãªã‘ã‚Œã°ç¸¦ä¸¦ã³ã«ãªã‚‹ */ }
        }

        /* --- PRINT MODE --- */
        @media print {
            @page { size: A4 landscape; margin: 8mm; }
            body { background: white; -webkit-print-color-adjust: exact; padding: 0; font-size: 10pt; }
            .no-print-area, header, .btn-toggle-mask, .btn-cert-view, .modal-backdrop, .modal, .version-stamp, #debug-console-container { display: none !important; }
            .masked-wrapper { background: none; padding: 0; display: block; }
            .masked-text { display: none !important; }
            .real-text { display: block !important; color: #000; }
            #d_photo_container { border: 2px solid #ddd; }
            .card-section { box-shadow: none; padding: 15px; border: 1px solid #ddd; height: auto; }
            .section-title { border-bottom: 1px solid #ccc; color: #000; margin-bottom: 10px; }
            .info-value { border-bottom: 1px dotted #ccc; padding-bottom: 2px; }

            /* Print Grid Layout */
            .print-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: 15px; }
            .print-block { break-inside: avoid; }
            /* å°åˆ·æ™‚ã¯å¼·åˆ¶çš„ã«æ¨ªä¸¦ã³ã‚’è§£é™¤ã—ã¦ã‚°ãƒªãƒƒãƒ‰ã«ä»»ã›ã‚‹ */
            .screen-two-col-layout { display: contents; }
            
            .print-footer { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 9pt; color: #666; background: white; padding: 5px; }
        }
    </style>
</head>
<body>

    <div class="version-stamp">v2025.12.02-LAYOUT-FIX</div>

    <div class="container py-4">
        <div class="no-print-area">
            <h4 class="fw-bold mb-3" style="color: var(--primary-color);">â›‘ï¸ ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</h4>
            <div id="loading" class="loading">
                <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 fw-bold">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
            </div>
            <div id="content-controls" style="display:none;">
                <p class="text-muted mb-4">ç·Šæ€¥æ™‚ã«å‚™ãˆã€ã“ã®æƒ…å ±ã‚’å°åˆ·ã—ã¦æºå¸¯ã€ã¾ãŸã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="d-flex justify-content-center gap-3">
                    <button onclick="window.print()" class="btn btn-print">ğŸ–¨ï¸ æ‰‹å¸³ã‚’å°åˆ·ã™ã‚‹</button>
                    <button onclick="window.location.href='index.html'" class="btn btn-outline-secondary px-4 rounded-pill fw-bold">æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <div id="main-display" style="display:none;">
            <div class="print-container">
                
                <div class="print-block">
                    <div class="card-section">
                        <div class="section-title">åŸºæœ¬æƒ…å ± / Owner Info</div>
                        <div class="d-flex gap-4 align-items-start">
                            <div id="d_photo_container">
                                <div class="spinner-border text-secondary" role="status"></div>
                            </div>
                            
                            <div class="flex-grow-1">
                                <div class="row info-row">
                                    <div class="col-7"><span class="info-label">ãŠåå‰ (Dog Name)</span><div class="info-value fs-4 fw-bold" id="d_name">-</div></div>
                                    <div class="col-5"><span class="info-label">çŠ¬ç¨® (Breed)</span><div class="info-value" id="d_breed">-</div></div>
                                </div>
                                <div class="row info-row">
                                    <div class="col-4"><span class="info-label">æ€§åˆ¥</span><div class="info-value" id="d_gender">-</div></div>
                                    <div class="col-4"><span class="info-label">èª•ç”Ÿæ—¥</span><div class="info-value" id="d_birth">-</div></div>
                                    <div class="col-4"><span class="info-label">å¹´é½¢</span><div class="info-value" id="d_age">-</div></div>
                                </div>
                                <hr class="my-3" style="border-color: var(--accent-color);">
                                <div class="info-row">
                                    <span class="info-label">é£¼ã„ä¸»æ§˜ (Owner)</span><div class="info-value fw-bold" id="c_name">-</div>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ä½æ‰€ (Address)</span>
                                    <div class="masked-wrapper">
                                        <span class="masked-text" id="c_address_masked">***</span>
                                        <span class="real-text" id="c_address_real">-</span>
                                        <button class="btn-toggle-mask" onclick="toggleMask(this, 'ä½æ‰€')">è¡¨ç¤º</button>
                                    </div>
                                </div>
                                <div class="info-row mb-0">
                                    <span class="info-label">é›»è©±ç•ªå· (Phone)</span>
                                    <div class="masked-wrapper">
                                        <span class="masked-text">***-****-****</span>
                                        <span class="real-text" id="c_phone">-</span>
                                        <button class="btn-toggle-mask" onclick="toggleMask(this, 'é›»è©±ç•ªå·')">è¡¨ç¤º</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="screen-two-col-layout">
                    <div class="print-block">
                        <div class="card-section">
                            <div class="section-title" style="color: var(--alert-color); border-bottom-color: #f8d7da;">ç·Šæ€¥é€£çµ¡å…ˆ / Emergency</div>
                            <div class="info-row">
                                <span class="info-label">ç·Šæ€¥é€£çµ¡å…ˆ (Emergency Contact)</span><div class="info-value fw-bold" id="c_em_name">-</div>
                                <div class="masked-wrapper mt-1">
                                    <span class="masked-text">***-****-****</span><span class="real-text" id="c_em_phone">-</span>
                                    <button class="btn-toggle-mask" onclick="toggleMask(this, 'é€£çµ¡å…ˆ')">è¡¨ç¤º</button>
                                </div>
                            </div>
                            <div class="info-row p-3 rounded" style="background-color: #fff3cd; border: 1px solid #ffeeba;">
                                <span class="info-label text-danger">ä»£ç†å¼•å—äºº (Proxy Person)</span>
                                <div class="small text-muted mb-1" style="font-size:0.75rem;">â€»é£¼ã„ä¸»ä¸åœ¨æ™‚ã«çŠ¬ã‚’ä¿è­·ã™ã‚‹äºº</div>
                                <div class="info-value fw-bold" id="c_proxy_name">-</div>
                                <div class="masked-wrapper mt-1" style="background: rgba(255,255,255,0.7);">
                                    <span class="masked-text">***-****-****</span><span class="real-text" id="c_proxy_phone">-</span>
                                    <button class="btn-toggle-mask" onclick="toggleMask(this, 'é€£çµ¡å…ˆ')">è¡¨ç¤º</button>
                                </div>
                            </div>
                            <div class="info-row mb-0">
                                <span class="info-label">æŒ‡å®šé¿é›£æ‰€ (Evacuation Site)</span><div class="info-value" id="c_evac">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="print-block">
                        <div class="card-section">
                            <div class="section-title">ã‚±ã‚¢æƒ…å ± / Care Info</div>
                            <div class="info-row p-3 rounded border border-danger" style="background-color: #fff5f5;">
                                <span class="info-label text-danger">âš ï¸ ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ (Allergies)</span>
                                <div class="info-value fw-bold text-danger" id="d_allergy">-</div>
                            </div>
                            <div class="info-row">
                                <span class="info-label">é£Ÿã¹ã¦ã„ã‚‹ãƒ•ãƒ¼ãƒ‰ (Food)</span><div class="info-value" id="d_food">-</div>
                            </div>
                            <div class="info-row mb-0">
                                <span class="info-label">æ€§æ ¼ãƒ»æ³¨æ„äº‹é … (Caution)</span><div class="info-value" id="d_caution">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="print-block">
                    <div class="card-section">
                        <div class="section-title">åŒ»ç™‚æƒ…å ± / Medical</div>
                        <div class="info-row">
                            <span class="info-label">ã‹ã‹ã‚Šã¤ã‘å‹•ç‰©ç—…é™¢ (Vet)</span><div class="info-value fw-bold fs-5" id="d_vet">-</div>
                        </div>
                        <div class="row info-row">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <div class="p-3 rounded" style="background: var(--accent-color);">
                                    <span class="info-label">ç‹‚çŠ¬ç—…äºˆé˜²æ¥ç¨®</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <span id="d_rabies_status" class="fw-bold">-</span>
                                        <button id="btn_rabies_img" class="btn-cert-view" style="display:none;">ğŸ“· è¨¼æ˜æ›¸ã‚’è¦‹ã‚‹</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded" style="background: var(--accent-color);">
                                    <span class="info-label">æ··åˆãƒ¯ã‚¯ãƒãƒ³</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <span id="d_vaccine_status" class="fw-bold">-</span>
                                        <button id="btn_vaccine_img" class="btn-cert-view" style="display:none;">ğŸ“· è¨¼æ˜æ›¸ã‚’è¦‹ã‚‹</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row info-row">
                            <div class="col-md-6">
                                <span class="info-label">æ—¢å¾€æ­´ (Medical History)</span><div class="info-value" id="d_history">-</div>
                            </div>
                            <div class="col-md-6">
                                <span class="info-label">å¸¸å‚™è–¬ (Medicine)</span><div class="info-value text-danger fw-bold" id="d_medicine">-</div>
                            </div>
                        </div>
                        <div class="info-row mb-0 bg-light p-2 rounded">
                            <span class="info-label">é‘‘æœ­ç•ªå· / ãƒã‚¤ã‚¯ãƒ­ãƒãƒƒãƒ—</span>
                            <div class="info-value" style="font-family: monospace;"><span id="d_license"></span> / <span id="d_chip"></span></div>
                        </div>
                        <div class="mt-3 text-end">
                            <small class="text-muted">ç™ºè¡Œæ—¥ (Date): <span id="print_date"></span></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="print-footer">ã€ã”æ³¨æ„ã€‘æœ¬ã‚«ãƒ¼ãƒ‰ã¯å…¬çš„è¨¼æ˜æ›¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç‹‚çŠ¬ç—…äºˆé˜²æ³•ã«åŸºã¥ãæ‰‹ç¶šãç­‰ã§ã¯ã€å¿…ãšåŸæœ¬ã‚’ã”æç¤ºãã ã•ã„ã€‚K9 Harmony Portal</div>
        </div>

        <footer class="disclaimer-footer no-print-area text-center">
            <p>ã€å…è²¬äº‹é …ãƒ»ã”æ³¨æ„ã€‘<br>æœ¬ã‚¢ãƒ—ãƒªãŠã‚ˆã³å‡ºåŠ›ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã¯ã€å…¬çš„ãªè¨¼æ˜æ›¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ²è¼‰æƒ…å ±ã¯æœ€çµ‚æ›´æ–°æ—¥æ™‚ç‚¹ã®ã‚‚ã®ã§ã™ã€‚<br>Â© K9 Harmony</p>
            <button onclick="document.getElementById('debug-console-container').style.display='block'" class="btn btn-sm btn-link text-muted" style="text-decoration: none; opacity: 0.5;">âš™ï¸</button>
        </footer>
        
        <div id="debug-console-container" class="container no-print-area">
            <h6 class="text-danger fw-bold mb-2">âš ï¸ Debug Console <button onclick="this.parentElement.parentElement.style.display='none'" class="btn btn-sm btn-outline-secondary float-end">Close</button></h6>
            <div id="debug-console">Initializing...</div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">è¨¼æ˜æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4" style="background: #f0f0f0;">
                    <div id="modalLoading" class="spinner-border text-primary" role="status" style="display:none;"></div>
                    <img id="modalImage" src="" class="img-fluid rounded shadow-sm" style="max-height: 70vh;" alt="Certificate" onload="document.getElementById('modalLoading').style.display='none';">
                    <div class="mt-3 text-muted small">â€»ç”»åƒã‚’é•·æŠ¼ã—ãªã©ã§ä¿å­˜ã—ã¦ãã ã•ã„</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // â–¼â–¼â–¼ æ­£ã—ã„API URL â–¼â–¼â–¼
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";
        let imageModal;
        let currentUserId, currentDogId;

        function log(msg) {
            const el = document.getElementById('debug-console');
            const time = new Date().toLocaleTimeString();
            el.innerHTML = `[${time}] ${msg}\n` + el.innerHTML;
            console.log(msg);
        }

        window.onload = async function() {
            imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            try {
                log('Starting LIFF init...');
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                
                const urlParams = new URLSearchParams(window.location.search);
                currentDogId = urlParams.get('dogId');
                log(`User: ${currentUserId.substring(0,5)}..., DogID: ${currentDogId || 'Auto'}`);

                fetchData(currentUserId, currentDogId);
            } catch (err) {
                log('FATAL ERROR: ' + err.message);
                document.getElementById('loading').innerHTML = `<p class="text-danger fw-bold">åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br><small>${err.message}</small></p>`;
            }
        };

        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            log('Fetching main data...');
            fetch(url).then(res => res.json()).then(data => {
                if (data.error) { 
                    log('API Error: ' + data.error);
                    document.getElementById('loading').innerHTML = `<p class="text-danger fw-bold">${data.error}</p>`; return; 
                }
                if (data.multiple_dogs) { 
                    document.getElementById('loading').innerHTML = `<p class="text-warning fw-bold">çŠ¬ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆindex.htmlã‹ã‚‰é¸æŠï¼‰</p>`; return; 
                }
                renderData(data);
                // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå¾Œã«çŠ¬ã®ç”»åƒã‚’éåŒæœŸã§å–å¾—
                fetchDogImage(userId, data.dog.id);
            }).catch(err => {
                log('Fetch Error: ' + err.message);
                document.getElementById('loading').innerHTML = `<p class="text-danger fw-bold">é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
            });
        }

        function renderData(data) {
            log('Rendering data...');
            const c = data.customer || {};
            const d = data.dog || {};

            setText('d_name', d.name_disp);
            setText('d_breed', d.breed);
            setText('d_gender', d.gender);
            setText('d_birth', d.birth_date);
            setText('d_age', d.age);
            
            setText('c_name', c.name);
            // ä½æ‰€ãƒã‚¹ã‚­ãƒ³ã‚°å‡¦ç†
            setMaskedText('c_address', c.address, maskAddress(c.address));
            setMaskedText('c_phone', c.phone, null); // é›»è©±ã¯å˜ç´”ãƒã‚¹ã‚¯
            
            setText('c_em_name', c.em_name);
            setMaskedText('c_em_phone', c.em_phone, null);
            setText('c_proxy_name', c.proxy_name);
            setMaskedText('c_proxy_phone', c.proxy_phone, null);
            setText('c_evac', c.evac_site);

            setText('d_allergy', d.allergy);
            setText('d_food', d.food);
            setText('d_caution', d.caution);

            setText('d_vet', d.vet_name);
            setText('d_history', d.history);
            setText('d_medicine', d.medicine);
            setText('d_license', d.license_no);
            setText('d_chip', d.microchip);

            setupCertButton('d_rabies_status', 'btn_rabies_img', d.has_rabies, d.rabies_img_ref);
            setupCertButton('d_vaccine_status', 'btn_vaccine_img', d.has_vaccine, d.vaccine_img_ref);

            setText('print_date', new Date().toLocaleDateString('ja-JP'));

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content-controls').style.display = 'block';
            document.getElementById('main-display').style.display = 'block';
            log('Render complete.');
        }

        // çŠ¬ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’éåŒæœŸå–å¾—
        function fetchDogImage(userId, dogId) {
            const imgContainer = document.getElementById('d_photo_container');
            let url = `${API_URL}?userId=${userId}&type=img_profile&dogId=${dogId}`;
            log('Fetching dog image...');
            fetch(url).then(res => res.json()).then(data => {
                if(data.image) {
                    imgContainer.innerHTML = `<img src="${data.image}" class="dog-profile-img" alt="Dog Photo">`;
                    imgContainer.style.border = 'none';
                } else {
                    imgContainer.innerHTML = '<span class="text-muted fw-bold small">No Image</span>';
                }
            }).catch(e => {
                log('Dog Image Error: ' + e.message);
                imgContainer.innerHTML = '<span class="text-danger small">Error</span>';
            });
        }

        // ä½æ‰€ã‚’ç°¡æ˜“ãƒã‚¹ã‚­ãƒ³ã‚°ï¼ˆéƒ½é“åºœçœŒä»¥é™ã‚’éš ã™ï¼‰
        function maskAddress(address) {
            if (!address || address === 'è¨˜è¼‰ãªã—') return address;
            const match = address.match(/(.*?[éƒ½é“åºœçœŒ])/);
            if (match) {
                return match[1] + ' *** (ä»¥é™éè¡¨ç¤º)';
            }
            // éƒ½é“åºœçœŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯é©å½“ã«éš ã™
            return address.substring(0, 4) + ' ***';
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = (text === undefined || text === null || text === '') ? '-' : text;
        }
        
        function setMaskedText(baseId, realText, maskedText) {
            const realEl = document.getElementById(baseId + '_real');
            const maskedEl = document.getElementById(baseId + '_masked');
            const btn = realEl.parentElement.querySelector('.btn-toggle-mask');

            if (!realText || realText === 'è¨˜è¼‰ãªã—') {
                realEl.textContent = 'è¨˜è¼‰ãªã—'; maskedEl.style.display = 'none'; realEl.style.display = 'block';
                if(btn) btn.style.display = 'none';
                return;
            }
            realEl.textContent = realText;
            maskedEl.textContent = maskedText || '***-****-****'; // æŒ‡å®šãŒãªã‘ã‚Œã°é›»è©±ç”¨ãƒã‚¹ã‚¯
            if(btn) btn.style.display = 'inline-block';
        }

        function toggleMask(btn, label) {
            const wrapper = btn.parentElement;
            const masked = wrapper.querySelector('.masked-text');
            const real = wrapper.querySelector('.real-text');
            if (real.style.display === 'block') {
                real.style.display = 'none'; masked.style.display = 'block'; btn.textContent = 'è¡¨ç¤º'; btn.classList.remove('active');
            } else {
                if(confirm(`å‘¨å›²ã«äººãŒã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n${label}ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ`)) {
                    real.style.display = 'block'; masked.style.display = 'none'; btn.textContent = 'éš ã™'; btn.classList.add('active');
                }
            }
        }

        function setupCertButton(statusId, btnId, hasCert, imgRef) {
            document.getElementById(statusId).textContent = hasCert ? 'æ¥ç¨®æ¸ˆã¿' : 'æœªç™»éŒ²/æœŸé™åˆ‡ã‚Œ';
            const btn = document.getElementById(btnId);
            if (hasCert && imgRef) {
                btn.style.display = 'inline-flex';
                btn.onclick = () => openImageModal(imgRef);
            } else { btn.style.display = 'none'; }
        }

        function openImageModal(ref) {
            const imgEl = document.getElementById('modalImage');
            const loadingEl = document.getElementById('modalLoading');
            imgEl.style.display = 'none'; loadingEl.style.display = 'inline-block';
            let src = ref;
            if (ref.indexOf('http') === -1) src = `https://drive.google.com/uc?export=view&id=${ref}`;
            else if (ref.indexOf('drive.google.com') > -1) {
                const match = ref.match(/\/d\/(.+?)\//);
                if(match) src = `https://drive.google.com/uc?export=view&id=${match[1]}`;
            }
            imgEl.src = src; imgEl.style.display = 'block';
            imageModal.show();
        }
    </script>
</body>
</html>
