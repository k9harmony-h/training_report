<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>うちの子医療・防災手帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        :root { --primary-color: #88b08b; --accent-color: #e8f5e9; --alert-color: #e07a5f; --text-color: #333; --mask-color: #f0f0f0; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f9fbf9; color: var(--text-color); padding-bottom: 150px; }
        
        /* 共通UI */
        .no-print-area { margin: 20px 0 30px; text-align: center; }
        .card-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #eee; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; margin-bottom: 15px; }
        .info-row { margin-bottom: 8px; border-bottom:1px dashed #eee; padding-bottom:4px; }
        .info-label { font-weight: bold; color: #666; font-size: 0.8rem; display: block; margin-bottom: 1px; }
        .info-value { font-size: 1rem; font-weight: 500; word-break: break-all; }
        
        /* 写真エリア */
        #d_photo_container { width: 150px; height: 150px; background: #fff; border-radius: 12px; border: 4px solid var(--accent-color); overflow: hidden; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
        .dog-profile-img { width: 100%; height: 100%; object-fit: cover; }

        /* マスク表示 */
        .masked-wrapper { display: flex; align-items: center; gap: 10px; }
        .masked-text { display: inline-block; letter-spacing: 2px; color: #aaa; background: var(--mask-color); padding: 2px 8px; border-radius: 4px; }
        .real-text { display: none; font-weight: bold; color: #333; }
        .btn-toggle-mask { font-size: 0.7rem; padding: 2px 10px; border: 1px solid var(--alert-color); color: var(--alert-color); background: white; border-radius: 20px; }

        /* ロゴ・デバッグ */
        .logo-placeholder { display: inline-block; padding: 5px 10px; border: 2px dashed #ccc; color: #999; font-size: 0.8rem; }
        #debug-console { background: #111; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 8px; height: 150px; overflow-y: scroll; margin-top:20px; }
    </style>
</head>
<body>
    <div class="container py-3">
        <div class="no-print-area">
            <div class="text-center mb-2"><span class="logo-placeholder">[Logo img]</span></div>
            <h4 class="fw-bold mb-3" style="color: var(--primary-color);">うちの子医療・防災手帳</h4>
            <div id="loading" class="text-center py-5"><div class="spinner-border text-success"></div><p>Loading...</p></div>
        </div>

        <div id="main-display" style="display:none;">
            
            <div class="card-section">
                <div class="section-title">基本情報</div>
                <div id="d_photo_container"><div class="spinner-border spinner-border-sm text-secondary"></div></div>
                <div class="text-center mb-3"><h2 id="d_name" class="fw-bold mb-0">-</h2></div>
                <div class="row text-center mb-2">
                    <div class="col-6 border-end"><span class="info-label">犬種</span><div id="d_breed">-</div></div>
                    <div class="col-6"><span class="info-label">毛色</span><div id="d_color">-</div></div>
                </div>
                <div class="row text-center mb-3">
                    <div class="col-4 border-end"><span class="info-label">年齢</span><div id="d_age">-</div></div>
                    <div class="col-4 border-end"><span class="info-label">性別</span><div id="d_gender">-</div></div>
                    <div class="col-4"><span class="info-label">去勢</span><div id="d_neutered">-</div></div>
                </div>
                <div class="info-row"><span class="info-label">飼い主名</span><div id="c_name" class="fw-bold">-</div></div>
                <div class="info-row"><span class="info-label">住所</span><div class="masked-wrapper"><span id="c_address_masked" class="masked-text">***</span><span id="c_address_real" class="real-text">-</span><button class="btn-toggle-mask" onclick="toggleMask('c_address')">表示</button></div></div>
                <div class="info-row"><span class="info-label">電話番号</span><div class="masked-wrapper"><span id="c_phone_masked" class="masked-text">***</span><span id="c_phone_real" class="real-text">-</span><button class="btn-toggle-mask" onclick="toggleMask('c_phone')">表示</button></div></div>
            </div>

            <div class="card-section">
                <div class="section-title">医療情報</div>
                <div class="mb-3 p-2 bg-light rounded border">
                    <h6 class="fw-bold small text-muted"><i class="fa-solid fa-hospital"></i> かかりつけ医</h6>
                    <div class="info-row"><span class="info-label">病院名</span><div id="d_vet_name" class="fw-bold">-</div></div>
                    <div class="info-row"><span class="info-label">電話</span><div id="d_vet_phone">-</div></div>
                    <div class="info-row"><span class="info-label">住所</span><div id="d_vet_address" class="small">-</div></div>
                </div>
                <div class="info-row"><span class="info-label">既往歴</span><div id="d_history">-</div></div>
                <div class="info-row"><span class="info-label">常用薬</span><div id="d_medicine" class="text-danger">-</div></div>
                <div class="info-row"><span class="info-label">アレルギー</span><div id="d_allergy" class="text-danger fw-bold">-</div></div>
                <div class="row mt-2">
                    <div class="col-6"><span class="info-label">鑑札番号</span><div id="d_license" class="small">-</div></div>
                    <div class="col-6"><span class="info-label">チップ</span><div id="d_chip" class="small">-</div></div>
                </div>
            </div>

            <div class="card-section">
                <div class="section-title" style="color:var(--alert-color); border-color:#f8d7da;">緊急時情報</div>
                <div class="info-row"><span class="info-label">緊急連絡先</span><div id="c_em_name">-</div><div id="c_em_phone">-</div></div>
                <div class="info-row"><span class="info-label">代理人</span><div id="c_proxy_name">-</div><div id="c_proxy_phone">-</div></div>
                <div class="info-row"><span class="info-label">指定避難所</span><div id="c_evac" class="fw-bold">-</div></div>
            </div>

            <div class="card-section">
                <div class="section-title">ケア・生活情報</div>
                <div class="info-row"><span class="info-label">フード</span><div id="d_food">-</div></div>
                <div class="info-row"><span class="info-label text-danger">注意</span><div id="d_caution" class="text-danger fw-bold">-</div></div>
            </div>
        </div>

        <div id="controls" class="no-print-area mt-4" style="display:none;">
            <p class="text-muted small mb-2">▼ 以下のボタンは今後GAS連携後に機能します</p>
            <button onclick="alert('Step 2実装後にスライドを作成します')" class="btn btn-secondary w-100 mb-2">防災手帳を作成 (A4横)</button>
            <button onclick="alert('Step 2実装後にスライドを作成します')" class="btn btn-secondary w-100 mb-2">クレートタグを作成 (A4縦)</button>
            <button onclick="alert('Step 2実装後にスライドを作成します')" class="btn btn-secondary w-100 mb-2">迷子ポスターを作成 (A4縦)</button>
        </div>

        <div id="debug-console">Initializing...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";

        function log(msg) {
            const el = document.getElementById('debug-console');
            if(el) el.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + el.innerHTML;
            console.log(msg);
        }

        window.onload = async function() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                const dogId = urlParams.get('dogId');
                log(`User: ${profile.userId}, DogID: ${dogId}`);
                fetchData(profile.userId, dogId);
            } catch (err) { log('Init Error: ' + err.message); }
        };

        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            fetch(url).then(res => { if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); }).then(data => {
                if(data.error) { alert('Error: ' + data.error); return; }
                renderData(data);
                if(data.dog && data.dog.id) fetchImage(userId, data.dog.id);
            }).catch(e => log('Connection Error: ' + e.message));
        }

        function renderData(data) {
            const c = data.customer || {};
            const d = data.dog || {};
            log('Data Loaded: ' + d.name_disp);

            // 流し込み (Screen Display Only)
            setText('d_name', d.name_disp);
            setText('d_breed', d.breed);
            setText('d_color', d.color);
            setText('d_age', d.age);
            setText('d_gender', d.gender);
            setText('d_neutered', d.neutered);
            
            setText('c_name', c.name);
            setMaskedText('c_address', c.address, maskAddress(c.address));
            setMaskedText('c_phone', c.phone, maskPhone(c.phone));

            setText('d_vet_name', d.vet_name);
            setText('d_vet_address', d.vet_address);
            setText('d_vet_phone', d.vet_phone);

            setText('d_history', d.history);
            setText('d_medicine', d.medicine);
            setText('d_allergy', d.allergy);
            setText('d_license', d.license_no);
            setText('d_chip', d.microchip);

            setText('c_em_name', c.em_name);
            setText('c_em_phone', c.em_phone); // Screen view kept simple for now
            setText('c_proxy_name', c.proxy_name);
            setText('c_proxy_phone', c.proxy_phone);
            setText('c_evac', c.evac_site);

            setText('d_food', d.food);
            setText('d_caution', d.caution);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('main-display').style.display = 'block';
        }

        function fetchImage(userId, dogId) {
            let url = `${API_URL}?userId=${userId}&type=img_profile&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.image) {
                    const el = document.getElementById('d_photo_container');
                    if(el) {
                        el.innerHTML = `<img src="${data.image}" class="dog-profile-img">`;
                        el.style.border = 'none';
                    }
                } else {
                    document.getElementById('d_photo_container').innerHTML = '<span class="small text-muted">No Photo</span>';
                }
            });
        }

        // Helpers
        function maskAddress(addr) { if(!addr) return; const m = addr.match(/(.*?[都道府県].*?[市区町村])/); return m ? m[0]+' ***' : addr.substring(0,5)+' ***'; }
        function maskPhone(tel) { if(!tel) return; return tel.substring(0,3)+'-****-****'; }
        function setText(id, txt) { const el = document.getElementById(id); if(el) el.textContent = txt || '-'; }
        
        function setMaskedText(baseId, realVal, maskedVal) { 
            const rEl = document.getElementById(baseId + '_real'); 
            const mEl = document.getElementById(baseId + '_masked'); 
            const btn = rEl ? rEl.parentElement.querySelector('.btn-toggle-mask') : null; 
            if(!rEl || !mEl) return; 
            if(!realVal || realVal === '記載なし') { 
                rEl.textContent = '記載なし'; mEl.style.display='none'; rEl.style.display='inline'; 
                if(btn) btn.style.display='none'; 
            } else { 
                rEl.textContent = realVal; mEl.textContent = maskedVal; 
                mEl.style.display='inline'; rEl.style.display='none'; 
                if(btn) btn.style.display='inline-block'; 
            } 
        }
        function toggleMask(baseId) { 
            const rEl = document.getElementById(baseId + '_real'); 
            const mEl = document.getElementById(baseId + '_masked'); 
            if(rEl.style.display === 'none') { 
                if(confirm('表示しますか？')) { rEl.style.display='inline'; mEl.style.display='none'; } 
            } else { 
                rEl.style.display='none'; mEl.style.display='inline'; 
            } 
        }
    </script>
</body>
</html>
