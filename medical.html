<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony Portal - うちの子医療・防災手帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/2.23.1/liff.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ==================================== */
        /* グローバル・モバイル共通スタイル */
        /* ==================================== */
        :root {
            /* ★カラーコード定義: 医療ページ専用 (インデックスページとの分離は維持)★ */
            --brand-color: #57C3C2; /* 正式ブランドカラー (index.html系) */
            
            --color-primary: #88b08b; /* Sage Green: 医療ページメインカラー */
            --color-accent: #e8f5e9; /* Pale Mint: 医療ページ背景アクセント */
            --color-terracotta: #e07a5f; /* Terracotta Orange: 医療ページアラート色 */

            --font-family-base: 'Noto Sans JP', sans-serif;
            --body-bg: #f4f7f6;
        }

        /* ... (既存のCSS省略) ... */
        
        /* デバッグログ表示エリアのスタイル（LIFFに依存せず表示） */
        #debug-log-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            padding: 5px;
            max-height: 100px;
            overflow-y: scroll;
            z-index: 9999;
            border-top: 2px solid #555;
            word-wrap: break-word; /* ログが長すぎる場合の対応 */
        }
        
        /* ログスタンプ表示の調整 */
        #log-stamp-static {
            position: absolute;
            top: 0;
            left: 0;
            background: #333;
            color: white;
            padding: 2px 5px;
            font-size: 10px;
            font-family: monospace;
            z-index: 10000;
        }

    </style>
</head>
<body>
    <p id="log-stamp-static">1810-002</p> 
    
    <div class="liff-app-container">
        <header class="p-3 bg-white shadow-sm sticky-top">
            <h1 class="h5 text-center mb-0" style="color: var(--color-primary);"><i class="fa-solid fa-paw me-2"></i>K9 Harmony Portal - うちの子医療・防災手帳</h1>
        </header>

        <main class="container-fluid p-3">
            <div id="liff-status" class="text-center my-5">
                <p id="liff-message" class="text-muted">LIFF初期化中...</p>
                <i id="liff-spinner" class="fa-solid fa-spinner fa-spin fa-2x text-primary" style="display:none;"></i>
            </div>

            <div id="main-content" style="display:none;">
                <h2 class="h4 mb-4 text-center">ペット情報登録・確認</h2>

                <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pills-input-tab" data-bs-toggle="pill" data-bs-target="#pills-input" type="button" role="tab" aria-controls="pills-input" aria-selected="true"><i class="fa-solid fa-pen me-1"></i>入力</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pills-preview-tab" data-bs-toggle="pill" data-bs-target="#pills-preview" type="button" role="tab" aria-controls="pills-preview" aria-selected="false"><i class="fa-solid fa-eye me-1"></i>確認</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pills-output-tab" data-bs-toggle="pill" data-bs-target="#pills-output" type="button" role="tab" aria-controls="pills-output" aria-selected="false"><i class="fa-solid fa-file-pdf me-1"></i>出力</button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    
                    <div class="tab-pane fade show active" id="pills-input" role="tabpanel" aria-labelledby="pills-input-tab">
                        <div class="alert alert-info small" role="alert">
                            入力した情報は、このLIFFアプリに自動的に保存されます。
                        </div>

                        <form id="dog-data-form" class="needs-validation" novalidate>
                            
                            <div class="card mb-3">
                                <div class="card-header"><i class="fa-solid fa-dog me-2"></i>ペット基本情報</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="dog-name" class="form-label">名前 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="dog-name" required>
                                        <div class="invalid-feedback">名前は必須です。</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label for="dog-type" class="form-label">種別 (犬種など) <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="dog-type" required>
                                            <div class="invalid-feedback">種別は必須です。</div>
                                        </div>
                                        <div class="col">
                                            <label for="dog-gender" class="form-label">性別 <span class="text-danger">*</span></label>
                                            <select class="form-select" id="dog-gender" required>
                                                <option value="" disabled selected>選択...</option>
                                                <option value="オス">オス</option>
                                                <option value="メス">メス</option>
                                            </select>
                                            <div class="invalid-feedback">性別は必須です。</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label for="dog-age" class="form-label">年齢 (才)</label>
                                            <input type="number" class="form-control" id="dog-age" min="0" max="30">
                                        </div>
                                        <div class="col">
                                            <label for="dog-weight" class="form-label">体重 (kg)</label>
                                            <input type="number" class="form-control" id="dog-weight" step="0.1" min="0.1">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="dog-features" class="form-label">特徴・性格</label>
                                        <textarea class="form-control" id="dog-features" rows="2"></textarea>
                                        <div class="form-text">他人や他の動物への反応、特異な行動、鳴き声など</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header"><i class="fa-solid fa-user me-2"></i>飼い主情報</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="owner-name" class="form-label">氏名 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="owner-name" required>
                                        <div class="invalid-feedback">氏名は必須です。</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="owner-tel" class="form-label">電話番号 <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="owner-tel" pattern="[0-9]{10,11}" required>
                                        <div class="form-text">ハイフン無しで入力してください (例: 09012345678)</div>
                                        <div class="invalid-feedback">電話番号は10桁または11桁の数字で入力してください。</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="owner-address" class="form-label">住所 (避難所情報) <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="owner-address" rows="2" required></textarea>
                                        <div class="invalid-feedback">住所は必須です。</div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header"><i class="fa-solid fa-notes-medical me-2"></i>健康・医療情報</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="medical-history" class="form-label">既往歴・持病</label>
                                        <textarea class="form-control" id="medical-history" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="medical-medication" class="form-label">服用中の薬・サプリメント</label>
                                        <textarea class="form-control" id="medical-medication" rows="2"></textarea>
                                        <div class="form-text">薬名、投与量、投与頻度などを具体的に</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="medical-allergies" class="form-label">アレルギー</label>
                                        <input type="text" class="form-control" id="medical-allergies">
                                    </div>
                                    <div class="mb-3">
                                        <label for="vet-contact" class="form-label">かかりつけ動物病院名・電話番号</label>
                                        <input type="text" class="form-control" id="vet-contact">
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header"><i class="fa-solid fa-camera me-2"></i>写真登録</div>
                                <div class="card-body text-center">
                                    <p class="small text-muted mb-3">顔写真と全身写真の2枚を登録してください。ポスターや手帳に使用されます。</p>
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-2 fw-bold small">顔写真 <span class="text-danger">*</span></div>
                                            <img id="dog-photo-face-preview" class="image-preview" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2212%22%20fill%3D%22%23999%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3E顔写真%3C%2Ftext%3E%3C%2Fsvg%3E" data-src="" alt="顔写真プレビュー">
                                            <input type="file" class="form-control form-control-sm mt-2" id="dog-photo-face" accept="image/*" required>
                                            <div class="invalid-feedback">顔写真の登録は必須です。</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-2 fw-bold small">全身写真</div>
                                            <img id="dog-photo-full-preview" class="image-preview" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2212%22%20fill%3D%22%23999%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3E全身写真%3C%2Ftext%3E%3C%2Fsvg%3E" data-src="" alt="全身写真プレビュー">
                                            <input type="file" class="form-control form-control-sm mt-2" id="dog-photo-full" accept="image/*">
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="d-grid mt-4">
                                <button class="btn btn-primary btn-lg" type="submit" id="save-data-btn">
                                    <i class="fa-solid fa-save me-2"></i>情報を保存
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="pills-preview" role="tabpanel" aria-labelledby="pills-preview-tab">
                        <div class="card">
                            <div class="card-header bg-primary text-white">登録内容のサマリー</div>
                            <div class="card-body">
                                <div id="preview-content" class="text-center">
                                    <p class="text-muted">データがありません。入力タブで情報を入力・保存してください。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="pills-output" role="tabpanel" aria-labelledby="pills-output-tab">
                        <div class="alert alert-warning small" role="alert">
                            PDFはブラウザのダウンロードフォルダに保存されます。LINEアプリ内ブラウザでは開けない場合があるため、**外部ブラウザ (Safari/Chrome) で開いて**からご利用ください。
                        </div>
                        <div class="card">
                            <div class="card-header bg-accent text-white"><i class="fa-solid fa-file-pdf me-2"></i>出力アイテムの選択</div>
                            <div class="card-body">
                                <p class="mb-3">どの形式で防災手帳を出力しますか？</p>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-accent" type="button" onclick="showPrintModal('handbook')">
                                        <i class="fa-solid fa-book-open-reader me-2"></i>防災手帳 (四つ折り)
                                    </button>
                                    <button class="btn btn-terracotta" type="button" onclick="showPrintModal('poster')">
                                        <i class="fa-solid fa-bullhorn me-2"></i>迷子ポスター (A4縦)
                                    </button>
                                    <button class="btn btn-terracotta" type="button" onclick="showPrintModal('crate')">
                                        <i class="fa-solid fa-tag me-2"></i>クレートタグ (A4横)
                                    </button>
                                    <button class="btn btn-accent" type="button" onclick="showPrintModal('passport')">
                                        <i class="fa-solid fa-address-card me-2"></i>持ち歩き用手帳 (A4縦)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <div class="modal fade" id="printSelectModal" tabindex="-1" aria-labelledby="printSelectModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="printSelectModalLabel">PDF出力オプション</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p id="print-modal-message" class="mb-3"></p>
                        <div class="d-grid gap-2">
                            <button id="generate-pdf-button" class="btn btn-primary btn-lg" type="button" onclick="generatePDF(currentPrintMode)">
                                <i class="fa-solid fa-print me-2"></i>PDFを生成してダウンロード
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pdfPreviewModalLabel">PDF生成ステータス</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center" id="pdf-preview-area">
                        </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="fixed-bottom-bar text-center">
            <p class="small text-muted mb-0" id="liff-user-info">ユーザーID: 未認証</p>
        </footer>
    </div>
    
    <div id="main-display">
        </div>

    <div id="poster-display">
        <h1 class="poster-title">MISSING DOG<br>迷子犬を探しています</h1>
        <div class="poster-photo-container">
            <img id="poster-photo" class="poster-photo" src="" alt="迷子犬の写真">
        </div>
        <div class="poster-info">
            <p><strong>名前:</strong> <span id="poster-dog-name"></span></p>
            <p><strong>犬種/特徴:</strong> <span id="poster-dog-type-features"></span></p>
            <p><strong>性別/体重:</strong> <span id="poster-dog-gender-weight"></span></p>
            <p><strong>最終目撃地:</strong> <span id="poster-owner-address"></span></p>
        </div>
        <div class="poster-contact">
            <p class="mb-1">見かけた方は下記にご連絡ください</p>
            <p class="mb-0">TEL: <span><span id="poster-owner-tel"></span></span></p>
            <p class="small mt-1">（飼い主: <span id="poster-owner-name"></span>）</p>
        </div>
    </div>

    <div id="crate-tag-display">
        <div class="crate-side-left">
            <h2 class="crate-title">K9 災害時クレートタグ</h2>
            <div class="crate-photo-container">
                 <img id="crate-photo" class="crate-photo" src="" alt="犬の顔写真">
            </div>
            <h3 class="h5 mt-3 text-center fw-bold text-uppercase" id="crate-dog-name"></h3>
            <div class="mt-4">
                <p class="crate-info-item"><span class="crate-label">犬種:</span> <span id="crate-dog-type"></span></p>
                <p class="crate-info-item"><span class="crate-label">性別/年齢:</span> <span id="crate-dog-gender-age"></span></p>
                <p class="crate-info-item"><span class="crate-label">体重:</span> <span id="crate-dog-weight"></span></p>
                <p class="crate-info-item"><span class="crate-label">特徴/性格:</span> <span id="crate-dog-features"></span></p>
            </div>
            <div class="mt-4 pt-3 border-top border-white">
                <p class="crate-info-item small">【飼い主】</p>
                <p class="crate-info-item"><span class="crate-label">氏名:</span> <span id="crate-owner-name"></span></p>
                <p class="crate-info-item"><span class="crate-label">TEL:</span> <span id="crate-owner-tel"></span></p>
            </div>
        </div>
        <div class="crate-side-right">
            <h2 class="crate-emergency-title">緊急時対応メモ (最優先)</h2>
            <p class="small fw-bold text-center">以下の指示に従い、ペットの安全を確保してください。</p>
            
            <p class="mt-4">🚨 <strong>投薬・医療情報</strong></p>
            <p class="small" id="crate-medical-medication"></p>
            <p>🚨 <strong>アレルギー</strong></p>
            <p class="small" id="crate-medical-allergies"></p>
            
            <div class="mt-5">
                <p class="text-center fw-bold">【要手書き記入欄】</p>
                <div class="crate-handwrite-area">
                    <p class="mb-0"><strong>最終食事・排泄時間、注意事項</strong></p>
                    <p class="crate-handwrite-label">（避難所移動時などに、クレートに貼り付けて使用）</p>
                </div>
            </div>
        </div>
    </div>

    <div id="passport-display">
        <div class="passport-cover-back">
            <p class="passport-cover-back-text">
                災害時 持ち歩き用<br>
                K9 Harmony Portal - うちの子医療・防災手帳
            </p>
        </div>
        
        <div class="passport-main-area">
            <div>
                <h3 class="passport-section-title">個体識別情報</h3>
                <div class="passport-photo-container">
                    <img id="passport-photo" class="passport-photo" src="" alt="犬の顔写真">
                </div>
                <div class="passport-info-group">
                    <p class="mb-1"><span class="passport-label">名前:</span> <span id="passport-dog-name"></span></p>
                    <p class="mb-1"><span class="passport-label">犬種:</span> <span id="passport-dog-type"></span></p>
                    <p class="mb-1"><span class="passport-label">性別/年齢:</span> <span id="passport-dog-gender-age"></span></p>
                    <p class="mb-1"><span class="passport-label">体重:</span> <span id="passport-dog-weight"></span></p>
                </div>
            </div>
            
            <div>
                <h3 class="passport-section-title">飼い主 & 連絡先</h3>
                <div class="passport-info-group">
                    <p class="mb-1"><span class="passport-label">氏名:</span> <span id="passport-owner-name"></span></p>
                    <p class="mb-1"><span class="passport-label">TEL:</span> <span id="passport-owner-tel"></span></p>
                    <p class="mb-1"><span class="passport-label">住所:</span> <span id="passport-owner-address"></span></p>
                </div>
                
                <h3 class="passport-section-title mt-4">健康情報</h3>
                <div class="passport-info-group">
                    <p class="mb-1"><span class="passport-label">持病:</span> <span id="passport-medical-history"></span></p>
                    <p class="mb-1"><span class="passport-label">服用薬:</span> <span id="passport-medical-medication"></span></p>
                    <p class="mb-1"><span class="passport-label">アレルギー:</span> <span id="passport-medical-allergies"></span></p>
                    <p class="mb-1"><span class="passport-label">病院:</span> <span id="passport-vet-contact"></span></p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDogData = null;
        let currentPrintMode = '';
        let printSelectModal;
        let pdfPreviewModal;
        
        // ====================================
        // ログユーティリティ
        // ====================================
        function log(message) {
            console.log(`[APP LOG] ${message}`);
            // 画面上のデバッグエリアにもログを出力
            const logContent = document.getElementById('debug-log-content');
            if (logContent) {
                const date = new Date();
                const now = date.toLocaleTimeString();
                
                // ログスタンプの動的更新 (hhmm-001形式)
                const hh = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                // NOTE: ビルド/デプロイ時間ではないため、ここでは実行時の時刻として更新
                document.getElementById('log-stamp-static').textContent = `${hh}${mm}-001`;

                logContent.innerHTML = `[${now}] ${message}<br>` + logContent.innerHTML;
            }
        }

        // ====================================
        // LIFF初期化
        // ====================================
        async function initializeLiff() {
            try {
                const LIFF_ID = '2008546673-MJY7j3ox'; // ユーザーから提供されたLIFF IDを使用
                
                log('Step 1/4: LIFF initialization started.');
                
                // LIFF SDKの読み込み後に直接initを実行する
                await liff.init({ liffId: LIFF_ID });
                log('Step 2/4: LIFF initialized successfully.');

                if (liff.isLoggedIn()) {
                    log('Step 3/4: User is logged in. Fetching profile.');
                    const profile = await liff.getProfile();
                    document.getElementById('liff-user-info').textContent = `ユーザーID: ${profile.userId}`;
                    
                    document.getElementById('liff-status').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    
                    loadData(profile.userId);
                } else {
                    log('Step 3/4: User not logged in. Prompting login.');
                    document.getElementById('liff-message').textContent = 'LINEでログインしてください。';
                    document.getElementById('liff-spinner').style.display = 'none';
                    document.getElementById('liff-user-info').textContent = 'ユーザーID: 未認証';
                }
                log('Step 4/4: Initial screen rendering complete.');

            } catch (e) {
                // エラー発生時は即座に画面にメッセージを表示
                log(`FATAL: LIFF initialization failed: ${e.message}`);
                document.getElementById('liff-message').textContent = `LIFF初期化エラー: ${e.message}。外部ブラウザで開いて再試行してください。`;
                document.getElementById('liff-spinner').style.display = 'none';
            }
        }

        // ... (データ操作、レンダリング、イベントハンドラ、PDF生成ロジックは変更なし) ...
        
        // ====================================
        // 初期処理
        // ====================================

        document.addEventListener('DOMContentLoaded', () => {
            // DOMContentLoadedでLIFF初期化をキック（LIFFエラー解消とDOM操作の安定化のため）
            initializeLiff();
            
            // Bootstrapモーダルのインスタンス化は、DOMContentLoadedで安全に実行
            const printSelectModalEl = document.getElementById('printSelectModal');
            printSelectModal = new bootstrap.Modal(printSelectModalEl);
            const pdfPreviewModalEl = document.getElementById('pdfPreviewModal');
            pdfPreviewModal = new bootstrap.Modal(pdfPreviewModalEl);

            // ログスタンプの初期表示（LIFFが動作しなくても最低限の時刻を表示）
            log('DOM fully loaded. Starting initialization cycle.');
        });
    </script>
</body>
</html>
