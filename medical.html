<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>うちの子医療・防災手帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary-color: #88b08b; --accent-color: #e8f5e9; --alert-color: #e07a5f; --text-color: #333; --mask-color: #f0f0f0; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f9fbf9; color: var(--text-color); padding-bottom: 300px; }
        .version-stamp { position: fixed; top: 0; right: 0; background: #6610f2; color: white; font-size: 10px; padding: 2px 6px; z-index: 9999; }
        .no-print-area { margin: 20px 0 30px; text-align: center; }
        .card-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #eee; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; margin-bottom: 15px; }
        
        .info-row { margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-weight: bold; color: #666; font-size: 0.8rem; display: block; margin-bottom: 2px; }
        .info-value { font-size: 1rem; font-weight: 500; min-height: 24px; word-break: break-all; }
        
        #d_photo_container { width: 160px; height: 160px; background: #fff; border-radius: 12px; border: 4px solid var(--accent-color); overflow: hidden; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
        .dog-profile-img { width: 100%; height: 100%; object-fit: cover; }

        /* Masking */
        .masked-wrapper { display: flex; align-items: center; justify-content: space-between; }
        .masked-text { letter-spacing: 2px; color: #aaa; background: var(--mask-color); padding: 2px 8px; border-radius: 4px; }
        .real-text { display: none; font-weight: bold; color: #333; }
        .btn-toggle-mask { font-size: 0.7rem; padding: 2px 10px; border: 1px solid var(--alert-color); color: var(--alert-color); background: white; border-radius: 20px; margin-left: 10px; }
        
        /* Cert Button */
        .btn-cert-view { font-size: 0.8rem; padding: 4px 12px; border-radius: 6px; background-color: var(--primary-color); color: white; border: none; }

        /* Print/Generating/Debug (Hidden logic same as before) */
        #generating-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #debug-console-container { display: block; margin-top: 30px; padding: 0 10px; }
        #debug-console { background: #111; color: #0f0; font-family: monospace; font-size: 11px; padding: 15px; border-radius: 8px; }
        #poster-display, #crate-display { display: none; }
        #generated-image-preview { width: 100%; height: auto; border: 2px solid #ccc; border-radius: 4px; }

        @media print {
            .no-print-area, #debug-console-container, .version-stamp, #generating-overlay, .modal-backdrop { display: none !important; }
            body { background: white; }
            /* (Poster/Crate CSS omitted for brevity - Keep them if you need print logic here) */
        }
    </style>
</head>
<body class="mode-handbook">

    <div class="version-stamp">v2025.12.02-FULL-DATA</div>

    <div id="generating-overlay">
        <div class="spinner-border text-primary"></div><h4 class="mt-3">作成中...</h4>
    </div>

    <div class="container py-3">
        <div class="no-print-area">
            <h4 class="fw-bold mb-3" style="color: var(--primary-color);">⛑️ うちの子医療・防災手帳</h4>
            <div id="loading" class="loading"><div class="spinner-border text-success"></div><p>Loading...</p></div>
        </div>

        <div id="main-display" style="display:none;">
            
            <div class="card-section">
                <div class="section-title">基本情報</div>
                
                <div class="row">
                    <div class="col-5 text-center">
                        <div id="d_photo_container">
                            <div class="spinner-border spinner-border-sm text-secondary"></div>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="info-row"><span class="info-label">名前</span><div id="d_name" class="fw-bold fs-5">-</div></div>
                        <div class="info-row"><span class="info-label">犬種</span><div id="d_breed">-</div></div>
                        <div class="info-row"><span class="info-label">年齢</span><div id="d_age">-</div></div>
                        <div class="info-row"><span class="info-label">性別</span><div id="d_gender">-</div></div>
                    </div>
                </div>
                
                <div class="row mt-2">
                    <div class="col-6"><div class="info-row"><span class="info-label">毛色</span><div id="d_color">-</div></div></div>
                    <div class="col-6"><div class="info-row"><span class="info-label">去勢</span><div id="d_neutered">-</div></div></div>
                </div>

                <hr class="my-3">
                
                <div class="info-row">
                    <span class="info-label">飼い主名</span><div id="c_name" class="fw-bold">-</div>
                </div>
                <div class="info-row">
                    <span class="info-label">住所 (市区町村以降マスク)</span>
                    <div class="masked-wrapper">
                        <span id="c_address_masked" class="masked-text">***</span>
                        <span id="c_address_real" class="real-text">-</span>
                        <button class="btn-toggle-mask" onclick="toggleMask('c_address')">表示</button>
                    </div>
                </div>
                <div class="info-row">
                    <span class="info-label">電話番号 (頭3桁以降マスク)</span>
                    <div class="masked-wrapper">
                        <span id="c_phone_masked" class="masked-text">***-****-****</span>
                        <span id="c_phone_real" class="real-text">-</span>
                        <button class="btn-toggle-mask" onclick="toggleMask('c_phone')">表示</button>
                    </div>
                </div>
            </div>

            <div class="card-section">
                <div class="section-title" style="color:var(--alert-color); border-color:#f8d7da;">緊急時情報</div>
                
                <div class="mb-3">
                    <h6 class="fw-bold small text-muted"><i class="fa-solid fa-user-shield"></i> 緊急連絡先</h6>
                    <div class="info-row"><span class="info-label">氏名</span><div id="c_em_name">-</div></div>
                    <div class="info-row">
                        <span class="info-label">電話番号</span>
                        <div class="masked-wrapper">
                            <span id="c_em_phone_masked" class="masked-text">***-****-****</span>
                            <span id="c_em_phone_real" class="real-text">-</span>
                            <button class="btn-toggle-mask" onclick="toggleMask('c_em_phone')">表示</button>
                        </div>
                    </div>
                </div>

                <div class="mb-3 p-2 bg-light rounded">
                    <h6 class="fw-bold small text-muted"><i class="fa-solid fa-person-walking-luggage"></i> 代理人 (Proxy)</h6>
                    <div class="info-row"><span class="info-label">氏名</span><div id="c_proxy_name">-</div></div>
                    <div class="info-row">
                        <span class="info-label">電話番号</span>
                        <div class="masked-wrapper">
                            <span id="c_proxy_phone_masked" class="masked-text">***-****-****</span>
                            <span id="c_proxy_phone_real" class="real-text">-</span>
                            <button class="btn-toggle-mask" onclick="toggleMask('c_proxy_phone')">表示</button>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <h6 class="fw-bold small text-muted"><i class="fa-solid fa-hospital"></i> かかりつけ動物病院</h6>
                    <div class="info-row"><span class="info-label">病院名</span><div id="d_vet_name" class="fw-bold">-</div></div>
                    <div class="info-row"><span class="info-label">住所</span><div id="d_vet_address" class="small">-</div></div>
                    <div class="info-row"><span class="info-label">電話番号</span><div id="d_vet_phone">-</div></div>
                </div>

                <div class="info-row mb-0">
                    <span class="info-label">指定避難所</span><div id="c_evac" class="fw-bold">-</div>
                </div>
            </div>

            <div class="card-section">
                <div class="section-title">医療情報</div>
                
                <div class="row mb-2">
                    <div class="col-6"><div class="info-row"><span class="info-label">鑑札番号</span><div id="d_license" class="small font-monospace">-</div></div></div>
                    <div class="col-6"><div class="info-row"><span class="info-label">マイクロチップ</span><div id="d_chip" class="small font-monospace">-</div></div></div>
                </div>

                <div class="info-row"><span class="info-label">既往歴</span><div id="d_history">-</div></div>
                <div class="info-row"><span class="info-label">常用薬</span><div id="d_medicine" class="text-danger">-</div></div>
                <div class="info-row"><span class="info-label">アレルギー</span><div id="d_allergy" class="text-danger fw-bold">-</div></div>

                <div class="row mt-3">
                    <div class="col-6">
                        <div class="p-2 border rounded text-center bg-light">
                            <span class="info-label mb-1">狂犬病予防注射</span>
                            <div id="d_rabies_status" class="fw-bold small mb-2">-</div>
                            <button id="btn-rabies-img" class="btn-cert-view w-100" style="display:none;">証明書を表示</button>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 border rounded text-center bg-light">
                            <span class="info-label mb-1">混合ワクチン</span>
                            <div id="d_vaccine_status" class="fw-bold small mb-2">-</div>
                            <button id="btn-vaccine-img" class="btn-cert-view w-100" style="display:none;">証明書を表示</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-section">
                <div class="section-title">ケア・生活情報</div>
                <div class="info-row"><span class="info-label">フード</span><div id="d_food">-</div></div>
                <div class="info-row mb-0"><span class="info-label">性格・注意事項</span><div id="d_caution">-</div></div>
            </div>

        </div>
        <div id="controls" class="no-print-area mt-4" style="display:none; max-width:500px; margin:0 auto;">
            <p class="text-muted small mb-2 text-start">必要な形式を選択してください：</p>
            <button onclick="generateOutput('handbook')" class="btn btn-primary w-100 mb-2 fw-bold" style="background-color: #88b08b; border:none;"><i class="fa-solid fa-book"></i> 防災手帳 (A4横)</button>
            <button onclick="generateOutput('crate')" class="btn btn-primary w-100 mb-2 fw-bold" style="background-color: #e07a5f; border:none;"><i class="fa-solid fa-tent"></i> クレートタグ (A4縦)</button>
            <button onclick="generateOutput('poster')" class="btn btn-primary w-100 mb-2 fw-bold" style="background-color: #dc3545; border:none;"><i class="fa-solid fa-bullhorn"></i> 迷子ポスター (A4縦)</button>
            <button onclick="window.location.href='index.html'" class="btn btn-outline-secondary w-100 rounded-pill mt-3">戻る</button>
        </div>

        <div id="debug-console-container" class="no-print-area">
            <h6 class="text-danger fw-bold">⚠️ Debug Console</h6>
            <div id="debug-console">Initializing...</div>
        </div>
    </div>

    <div class="modal fade" id="outputModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0"><h5 class="modal-title fw-bold text-success">作成完了</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <p class="small text-start alert alert-primary"><strong>iPhoneの方へ:</strong> 下の画像を長押しして「写真に保存」してください。</p>
                    <img id="generated-image-preview" src="">
                </div>
                <div class="modal-footer border-0"><button type="button" class="btn btn-secondary w-100 rounded-pill" data-bs-dismiss="modal">閉じる</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-body text-center p-4" style="background:#f0f0f0;"><img id="modalImage" src="" class="img-fluid rounded"><button class="btn btn-secondary mt-3 rounded-pill" data-bs-dismiss="modal">閉じる</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";
        let outputModal, imageModal;

        function log(msg) {
            const el = document.getElementById('debug-console');
            if(el) el.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.innerHTML;
            console.log(msg);
        }

        window.onload = async function() {
            if(typeof bootstrap !== 'undefined') {
                outputModal = new bootstrap.Modal(document.getElementById('outputModal'));
                imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            }
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                const dogId = urlParams.get('dogId');
                log(`User: ${profile.userId}, DogID: ${dogId}`);
                fetchData(profile.userId, dogId);
            } catch (err) { log('Init Error: ' + err.message); }
        };

        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.error) { log('API Error: ' + data.error); return; }
                renderData(data);
                if(data.dog && data.dog.id) fetchImage(userId, data.dog.id);
            }).catch(e => log('Fetch Error: ' + e.message));
        }

        function renderData(data) {
            const c = data.customer || {};
            const d = data.dog || {};

            // 1. Basic Info
            setText('d_name', d.name_disp);
            setText('d_breed', d.breed);
            setText('d_age', d.age);
            setText('d_gender', d.gender);
            setText('d_color', d.color); // Added
            setText('d_neutered', d.neutered); // Added
            
            setText('c_name', c.name);
            // Masking Logic Applied
            setMaskedText('c_address', c.address, maskAddress(c.address, 'city'));
            setMaskedText('c_phone', c.phone, maskPhone(c.phone));

            // 2. Emergency
            setText('c_em_name', c.em_name);
            setMaskedText('c_em_phone', c.em_phone, maskPhone(c.em_phone));
            setText('c_proxy_name', c.proxy_name);
            setMaskedText('c_proxy_phone', c.proxy_phone, maskPhone(c.proxy_phone));
            
            setText('d_vet_name', d.vet_name);
            setText('d_vet_address', d.vet_address); // Added
            setText('d_vet_phone', d.vet_phone);     // Added
            setText('c_evac', c.evac_site);

            // 3. Medical
            setText('d_license', d.license_no);
            setText('d_chip', d.microchip);
            setText('d_history', d.history);
            setText('d_medicine', d.medicine);
            setText('d_allergy', d.allergy);
            
            setupCertButton('d_rabies_status', 'btn-rabies-img', d.has_rabies, d.rabies_img_ref);
            setupCertButton('d_vaccine_status', 'btn-vaccine-img', d.has_vaccine, d.vaccine_img_ref);

            // 4. Care
            setText('d_food', d.food);
            setText('d_caution', d.caution);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('main-display').style.display = 'block';
        }

        function fetchImage(userId, dogId) {
            let url = `${API_URL}?userId=${userId}&type=img_profile&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.image) {
                    document.getElementById('d_photo_container').innerHTML = `<img src="${data.image}" class="dog-profile-img">`;
                    document.getElementById('d_photo_container').style.border = 'none';
                } else {
                    document.getElementById('d_photo_container').innerHTML = '<span class="text-muted small">No Image</span>';
                }
            });
        }

        // --- Masking Logic ---
        function maskAddress(addr, type) {
            if(!addr || addr === '記載なし') return addr;
            // 簡易: 最初の「区」「市」等で切る (Simple Logic)
            const match = addr.match(/(.*?[都道府県].*?[市区町村])/);
            if(match) return match[0] + ' *** (以降マスク)';
            return addr.substring(0, 5) + ' ***';
        }
        function maskPhone(tel) {
            if(!tel || tel === '記載なし') return tel;
            // 頭3桁残し (090-XXXX-XXXX -> 090-****-****)
            return tel.substring(0, 3) + '-****-****';
        }

        function setMaskedText(baseId, realVal, maskedVal) {
            try {
                const rEl = document.getElementById(baseId + '_real');
                const mEl = document.getElementById(baseId + '_masked');
                if(!rEl || !mEl) return;
                
                const btn = rEl.parentElement.querySelector('.btn-toggle-mask');
                if(!realVal || realVal === '記載なし') {
                    rEl.textContent = '記載なし'; mEl.style.display='none'; rEl.style.display='block';
                    if(btn) btn.style.display='none';
                    return;
                }
                rEl.textContent = realVal;
                mEl.textContent = maskedVal;
                if(btn) btn.style.display='inline-block';
            } catch(e) {}
        }

        function toggleMask(baseId) {
            const rEl = document.getElementById(baseId + '_real');
            const mEl = document.getElementById(baseId + '_masked');
            if(rEl.style.display === 'block' || rEl.style.display === 'inline') {
                rEl.style.display='none'; mEl.style.display='block';
            } else {
                if(confirm('表示しますか？')) { rEl.style.display='block'; mEl.style.display='none'; }
            }
        }

        // --- Helpers ---
        function setText(id, txt) { const el = document.getElementById(id); if(el) el.textContent = txt || '-'; }
        function setupCertButton(statId, btnId, has, ref) {
            document.getElementById(statId).textContent = has ? '確認済み' : '未確認/無し'; // Changed "Uploaded" to Confirmed
            const btn = document.getElementById(btnId);
            if(has && ref) {
                btn.style.display='inline-block';
                btn.onclick = () => {
                    const src = (ref.indexOf('http')===-1) ? `https://drive.google.com/uc?export=view&id=${ref}` : ref;
                    document.getElementById('modalImage').src = src;
                    imageModal.show();
                };
            } else { btn.style.display='none'; }
        }

        // --- Stub for PDF Generation (Will be fully integrated in next step) ---
        async function generateOutput(mode) {
            log(`Generate: ${mode} (Preview Mode)`);
            // ここに html2canvas 処理が入ります
            // 今回はデータ復帰確認が主目的のため省略
            alert('データ連携確認用ビルドです。PDF生成ロジックは次回組み込みます。');
        }
    </script>
</body>
</html>
