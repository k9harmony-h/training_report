<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>うちの子医療・防災手帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        :root { --primary-color: #88b08b; --accent-color: #e8f5e9; --alert-color: #e07a5f; --text-color: #333; --mask-color: #f0f0f0; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f9fbf9; color: var(--text-color); padding-bottom: 150px; }
        .no-print-area { margin: 20px 0 30px; text-align: center; }
        .card-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #eee; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; margin-bottom: 15px; }
        .info-row { margin-bottom: 8px; border-bottom:1px dashed #eee; padding-bottom:4px; }
        .info-label { font-weight: bold; color: #666; font-size: 0.8rem; display: block; margin-bottom: 1px; }
        .info-value { font-size: 1rem; font-weight: 500; word-break: break-all; }
        #d_photo_container { width: 150px; height: 150px; background: #fff; border-radius: 12px; border: 4px solid var(--accent-color); overflow: hidden; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
        .dog-profile-img { width: 100%; height: 100%; object-fit: cover; }
        .masked-wrapper { display: flex; align-items: center; gap: 10px; }
        .masked-text { display: inline-block; letter-spacing: 2px; color: #aaa; background: var(--mask-color); padding: 2px 8px; border-radius: 4px; }
        .real-text { display: none; font-weight: bold; color: #333; }
        .btn-toggle-mask { font-size: 0.7rem; padding: 2px 10px; border: 1px solid var(--alert-color); color: var(--alert-color); background: white; border-radius: 20px; }
        .logo-placeholder { display: inline-block; padding: 5px 10px; border: 2px dashed #ccc; color: #999; font-size: 0.8rem; }
        #debug-console { background: #111; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 8px; height: 150px; overflow-y: scroll; margin-top:20px; display:none; }
        
        /* ログスタンプ */
        #log-stamp { background: #d32f2f; color: white; text-align: center; font-weight: bold; padding: 5px; font-size: 0.8rem; }

        /* プリント案内モーダル用スタイル */
        .print-step { margin-bottom: 15px; border-left: 3px solid var(--primary-color); padding-left: 10px; }
        .print-step-title { font-weight: bold; display: block; margin-bottom: 5px; }
        .app-link-btn { display: inline-block; margin: 5px; padding: 8px 15px; background: #eee; color: #333; text-decoration: none; border-radius: 5px; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div id="log-stamp">v2025.12.10-Step1-PC-Download</div>

    <div class="container py-3">
        <div class="no-print-area">
            <div class="text-center mb-2"><span class="logo-placeholder">[Logo img]</span></div>
            <h4 class="fw-bold mb-3" style="color: var(--primary-color);">うちの子医療・防災手帳</h4>
            <div id="loading" class="text-center py-5"><div class="spinner-border text-success"></div><p>Loading...</p></div>
        </div>

        <div id="main-display" style="display:none;">
            <div class="card-section">
                <div class="section-title">基本情報</div>
                <div id="d_photo_container"><div class="spinner-border spinner-border-sm text-secondary"></div></div>
                <div class="text-center mb-3"><h2 id="d_name" class="fw-bold mb-0">-</h2></div>
                <div class="row text-center mb-2">
                    <div class="col-6 border-end"><span class="info-label">犬種</span><div id="d_breed">-</div></div>
                    <div class="col-6"><span class="info-label">毛色</span><div id="d_color">-</div></div>
                </div>
                <div class="row text-center mb-3">
                    <div class="col-4 border-end"><span class="info-label">年齢</span><div id="d_age">-</div></div>
                    <div class="col-4 border-end"><span class="info-label">性別</span><div id="d_gender">-</div></div>
                    <div class="col-4"><span class="info-label">去勢</span><div id="d_neutered">-</div></div>
                </div>
                <div class="info-row"><span class="info-label">飼い主名</span><div id="c_name" class="fw-bold">-</div></div>
                <div class="info-row"><span class="info-label">住所</span><div class="masked-wrapper"><span id="c_address_masked" class="masked-text">***</span><span id="c_address_real" class="real-text">-</span><button class="btn-toggle-mask" onclick="toggleMask('c_address')">表示</button></div></div>
                <div class="info-row"><span class="info-label">電話番号</span><div class="masked-wrapper"><span id="c_phone_masked" class="masked-text">***</span><span id="c_phone_real" class="real-text">-</span><button class="btn-toggle-mask" onclick="toggleMask('c_phone')">表示</button></div></div>
            </div>

            <div class="card-section">
                <div class="section-title">医療情報</div>
                <div class="mb-3 p-2 bg-light rounded border">
                    <h6 class="fw-bold small text-muted"><i class="fa-solid fa-hospital"></i> かかりつけ医</h6>
                    <div class="info-row"><span class="info-label">病院名</span><div id="d_vet_name" class="fw-bold">-</div></div>
                    <div class="info-row"><span class="info-label">電話</span><div id="d_vet_phone">-</div></div>
                    <div class="info-row"><span class="info-label">住所</span><div id="d_vet_address" class="small">-</div></div>
                </div>
                <div class="info-row"><span class="info-label">既往歴</span><div id="d_history">-</div></div>
                <div class="info-row"><span class="info-label">常用薬</span><div id="d_medicine" class="text-danger">-</div></div>
                <div class="info-row"><span class="info-label">アレルギー</span><div id="d_allergy" class="text-danger fw-bold">-</div></div>
                <div class="row mt-2">
                    <div class="col-6"><span class="info-label">鑑札番号</span><div id="d_license" class="small">-</div></div>
                    <div class="col-6"><span class="info-label">チップ</span><div id="d_chip" class="small">-</div></div>
                </div>
            </div>

            <div class="card-section">
                <div class="section-title" style="color:var(--alert-color); border-color:#f8d7da;">緊急時情報</div>
                <div class="info-row"><span class="info-label">緊急連絡先</span><div id="c_em_name">-</div><div id="c_em_phone">-</div></div>
                <div class="info-row"><span class="info-label">代理人</span><div id="c_proxy_name">-</div><div id="c_proxy_phone">-</div></div>
                <div class="info-row"><span class="info-label">指定避難所</span><div id="c_evac" class="fw-bold">-</div></div>
            </div>

            <div class="card-section">
                <div class="section-title">ケア・生活情報</div>
                <div class="info-row"><span class="info-label">フード</span><div id="d_food">-</div></div>
                <div class="info-row"><span class="info-label text-danger">注意</span><div id="d_caution" class="text-danger fw-bold">-</div></div>
            </div>
        </div>

        <div id="controls" class="no-print-area mt-4" style="display:none;">
            <p class="text-muted small mb-2 fw-bold">▼ 防災書類をPDFで作成・ダウンロード</p>
            <button id="btn-handbook" onclick="generatePdf('handbook')" class="btn btn-outline-success w-100 mb-2 fw-bold shadow-sm"><i class="fa-solid fa-book"></i> 防災手帳を作成 (A4横)</button>
            <button id="btn-crate" onclick="generatePdf('crate')" class="btn btn-outline-primary w-100 mb-2 fw-bold shadow-sm"><i class="fa-solid fa-tag"></i> クレートタグを作成 (A4縦)</button>
            <button id="btn-poster" onclick="generatePdf('poster')" class="btn btn-outline-danger w-100 mb-2 fw-bold shadow-sm"><i class="fa-solid fa-bullhorn"></i> 迷子ポスターを作成 (A4縦)</button>
        </div>

        <div id="debug-console">Initializing...</div>
    </div>

    <div class="modal fade" id="printModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-print"></i> 印刷のご案内</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">作成されたPDFは、ご自宅のプリンターまたはコンビニエンスストアで印刷可能です。</p>
                    
                    <div class="print-step">
                        <span class="print-step-title">1. 保存する</span>
                        <p class="small mb-1">表示されたPDFファイルを端末（スマホ/PC）に保存してください。</p>
                    </div>

                    <div class="print-step">
                        <span class="print-step-title">2. コンビニで印刷する場合</span>
                        <p class="small mb-2">以下のアプリまたはサイトを利用して、保存したPDFを登録してください。</p>
                        
                        <div class="d-grid gap-2 mb-2">
                            <a href="https://www.printing.ne.jp/" target="_blank" class="app-link-btn text-center"><i class="fa-solid fa-store"></i> セブンイレブン (netprint)</a>
                            <a href="https://networkprint.ne.jp/" target="_blank" class="app-link-btn text-center"><i class="fa-solid fa-store"></i> ファミマ/ローソン (ネットワークプリント)</a>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";

        let currentUserId = null;
        let currentDogId = null;
        let printModal = null; // モーダルインスタンス

        function log(msg) {
            const el = document.getElementById('debug-console');
            if(el && el.style.display !== 'none') el.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + el.innerHTML;
            console.log(msg);
        }

        window.onload = async function() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                const urlParams = new URLSearchParams(window.location.search);
                currentDogId = urlParams.get('dogId');
                log(`User: ${currentUserId}, DogID: ${currentDogId}`);
                
                // モーダル初期化
                printModal = new bootstrap.Modal(document.getElementById('printModal'));

                fetchData(currentUserId, currentDogId);
            } catch (err) { log('Init Error: ' + err.message); }
        };

        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.error) { alert('Error: ' + data.error); return; }
                if(data.dog && data.dog.id) currentDogId = data.dog.id;
                renderData(data);
                if(currentDogId) fetchImage(userId, currentDogId);
            }).catch(e => log('Connection Error: ' + e.message));
        }

        function generatePdf(type) {
            if(!currentUserId || !currentDogId) { alert('データ読み込み中です'); return; }
            const btn = document.getElementById(`btn-${type}`);
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 作成中...';

            const url = `${API_URL}?userId=${currentUserId}&dogId=${currentDogId}&type=pdf_${type}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.error) {
                    alert('作成失敗: ' + data.error);
                } else if(data.url) {
                    // ★ Step 1: PC判定と強制DL処理 ★
                    // ユーザーエージェントでPC(iOS/Android以外)かどうか簡易判定
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                    if (!isMobile) {
                        // 【PCの場合】
                        // GoogleドライブURLからIDを抽出し、ダウンロード用URLを作成してクリックさせる
                        try {
                            // URL例: https://drive.google.com/file/d/xxxxx/view...
                            // ID(xxxxx)を正規表現で抽出
                            const match = data.url.match(/\/d\/(.*?)\//);
                            if (match && match[1]) {
                                const fileId = match[1];
                                const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                                
                                // 隠しリンクを作ってクリック
                                const a = document.createElement('a');
                                a.href = downloadUrl;
                                a.download = 'medical_handbook.pdf'; // ファイル名は効かない場合もありますが指定
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                
                                // PCでも案内モーダルは一応出しておく(Step 2で調整)
                                printModal.show();
                            } else {
                                // ID抽出できなかった場合は従来の別窓表示(バックアップ)
                                window.open(data.url, '_blank');
                                printModal.show();
                            }
                        } catch(e) {
                            console.error('Download Logic Error', e);
                            window.open(data.url, '_blank');
                        }
                    } else {
                        // 【スマホの場合】(既存動作維持)
                        liff.openWindow({ url: data.url, external: true });
                        printModal.show();
                    }
                }
            })
            .catch(e => alert('通信エラー: ' + e.message))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
        }

        function fetchImage(userId, dogId) {
            let url = `${API_URL}?userId=${userId}&type=img_profile&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.image) {
                    const el = document.getElementById('d_photo_container');
                    if(el) {
                        el.innerHTML = `<img src="${data.image}" class="dog-profile-img">`;
                        el.style.border = 'none';
                    }
                } else {
                    document.getElementById('d_photo_container').innerHTML = '<span class="small text-muted">No Photo</span>';
                }
            });
        }

        function renderData(data) {
            const c = data.customer || {};
            const d = data.dog || {};
            setText('d_name', d.name_disp);
            setText('d_breed', d.breed);
            setText('d_color', d.color);
            setText('d_age', d.age);
            setText('d_gender', d.gender);
            setText('d_neutered', d.neutered);
            setText('c_name', c.name);
            setMaskedText('c_address', c.address, maskAddress(c.address));
            setMaskedText('c_phone', c.phone, maskPhone(c.phone));
            setText('d_vet_name', d.vet_name);
            setText('d_vet_address', d.vet_address);
            setText('d_vet_phone', d.vet_phone);
            setText('d_history', d.history);
            setText('d_medicine', d.medicine);
            setText('d_allergy', d.allergy);
            setText('d_license', d.license_no);
            setText('d_chip', d.microchip);
            setText('c_em_name', c.em_name);
            setText('c_em_phone', c.em_phone);
            setText('c_proxy_name', c.proxy_name);
            setText('c_proxy_phone', c.proxy_phone);
            setText('c_evac', c.evac_site);
            setText('d_food', d.food);
            setText('d_caution', d.caution);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('main-display').style.display = 'block';
        }

        function maskAddress(addr) { if(!addr) return; const m = addr.match(/(.*?[都道府県].*?[市区町村])/); return m ? m[0]+' ***' : addr.substring(0,5)+' ***'; }
        function maskPhone(tel) { if(!tel) return; return tel.substring(0,3)+'-****-****'; }
        function setText(id, txt) { const el = document.getElementById(id); if(el) el.textContent = txt || '-'; }
        function setMaskedText(baseId, realVal, maskedVal) { 
            const rEl = document.getElementById(baseId + '_real'); 
            const mEl = document.getElementById(baseId + '_masked'); 
            const btn = rEl ? rEl.parentElement.querySelector('.btn-toggle-mask') : null; 
            if(!rEl || !mEl) return; 
            if(!realVal || realVal === '記載なし') { 
                rEl.textContent = '記載なし'; mEl.style.display='none'; rEl.style.display='inline'; 
                if(btn) btn.style.display='none'; 
            } else { 
                rEl.textContent = realVal; mEl.textContent = maskedVal; 
                mEl.style.display='inline'; rEl.style.display='none'; 
                if(btn) btn.style.display='inline-block'; 
            } 
        }
        function toggleMask(baseId) { 
            const rEl = document.getElementById(baseId + '_real'); 
            const mEl = document.getElementById(baseId + '_masked'); 
            if(rEl.style.display === 'none') { 
                if(confirm('表示しますか？')) { rEl.style.display='inline'; mEl.style.display='none'; } 
            } else { 
                rEl.style.display='none'; mEl.style.display='inline'; 
            } 
        }
    </script>
</body>
</html>
