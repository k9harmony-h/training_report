<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        :root {
            --primary-color: #6da06f;
            --accent-color: #e7f3e8;
            --alert-color: #d9534f;
            --mask-color: #f0f0f0;
        }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; color: #333; }

        /* --- SCREEN MODE --- */
        .card-section {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color);
        }
        .section-title {
            font-size: 1.1rem; font-weight: bold; color: var(--primary-color);
            border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;
        }
        .info-label { font-weight: bold; color: #555; display: block; font-size: 0.8rem; }
        .info-value { font-size: 1rem; min-height: 20px; word-break: break-all; }
        .loading { text-align: center; padding: 20px; color: #666; }
        
        .masked-text { letter-spacing: 2px; color: #aaa; background: var(--mask-color); padding: 2px 8px; border-radius: 4px; user-select: none; }
        .real-text { display: none; font-weight: bold; color: #333; }
        .btn-toggle-mask {
            font-size: 0.75rem; padding: 2px 8px; margin-left: 10px;
            border-radius: 12px; border: 1px solid var(--alert-color);
            color: var(--alert-color); background: white; cursor: pointer;
        }
        .btn-toggle-mask.active { background: var(--alert-color); color: white; }

        .btn-cert-view {
            font-size: 0.8rem; padding: 4px 12px; margin-left: 10px;
            border-radius: 4px; background-color: var(--primary-color);
            color: white; border: none; text-decoration: none; cursor: pointer;
        }

        .no-print-area { margin: 20px; text-align: center; }
        .btn-print {
            background-color: var(--primary-color); color: white;
            padding: 10px 30px; border-radius: 50px; border: none; font-weight: bold;
        }
        .disclaimer-footer { font-size: 0.8rem; color: #999; margin-top: 30px; padding-bottom: 20px; }

        /* --- PRINT MODE --- */
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print-area, header, .btn-toggle-mask, .btn-cert-view, .modal-backdrop, .modal { display: none !important; }
            .masked-text { display: none !important; }
            .real-text { display: block !important; }

            .print-container {
                display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
                height: 180mm; gap: 10mm;
            }
            .print-block {
                border: 2px solid #333; border-radius: 8px; padding: 10px; overflow: hidden; position: relative;
            }
            .print-block h3 {
                font-size: 14pt; background: #eee; text-align: center;
                margin: -10px -10px 10px -10px; padding: 5px; border-bottom: 1px solid #333; color: #000;
            }
            .p-label { font-size: 8pt; color: #666; margin-top: 5px; }
            .p-value { font-size: 11pt; font-weight: bold; border-bottom: 1px dotted #ccc; }
            .alert-box { border: 2px solid red; padding: 5px; margin-top: 5px; border-radius: 4px; }
            .alert-title { color: red; font-weight: bold; font-size: 9pt; }
            .card-section { border: none; box-shadow: none; padding: 0; margin: 0; border-left: none; }
            .print-footer { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 8pt; color: #666; }
        }
        @media screen {
            .print-container { display: block; } .print-block { display: contents; }
            .print-only-header, .print-footer { display: none; }
        }
    </style>
</head>
<body>
0146
    <div class="container py-3 no-print-area">
        <h4 class="text-center mb-3">â›‘ï¸ ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</h4>
        <div id="loading" class="loading">
            <div class="spinner-border text-success" role="status"></div>
            <p class="mt-2">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
        <div id="content" style="display:none;">
            <p class="text-center small text-muted">ç·Šæ€¥æ™‚ã«å‚™ãˆã€ã“ã®æƒ…å ±ã‚’å°åˆ·ã—ã¦æºå¸¯ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="d-flex justify-content-center gap-2">
                <button onclick="window.print()" class="btn btn-print">ğŸ–¨ï¸ æ‰‹å¸³ã‚’å°åˆ·ã™ã‚‹</button>
                <button onclick="window.location.href='index.html'" class="btn btn-outline-secondary" style="border-radius:50px;">æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <div class="container" id="main-display" style="display:none;">
        <div class="print-container">
            <div class="print-block">
                <h3 class="print-only-header">åŸºæœ¬æƒ…å ± / Owner Info</h3>
                <div class="card-section">
                    <div class="section-title d-none d-print-none">åŸºæœ¬æƒ…å ±</div>
                    <div class="row">
                        <div class="col-6"><span class="p-label info-label">ãŠåå‰ (Dog Name)</span><div class="p-value info-value" id="d_name">-</div></div>
                        <div class="col-6"><span class="p-label info-label">çŠ¬ç¨® (Breed)</span><div class="p-value info-value" id="d_breed">-</div></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-4"><span class="p-label info-label">æ€§åˆ¥</span><div class="p-value info-value" id="d_gender">-</div></div>
                        <div class="col-4"><span class="p-label info-label">èª•ç”Ÿæ—¥</span><div class="p-value info-value" id="d_birth">-</div></div>
                        <div class="col-4"><span class="p-label info-label">å¹´é½¢</span><div class="p-value info-value" id="d_age">-</div></div>
                    </div>
                    <hr>
                    <span class="p-label info-label">é£¼ã„ä¸»æ§˜ (Owner)</span><div class="p-value info-value" id="c_name">-</div>
                    <span class="p-label info-label">ä½æ‰€ (Address)</span><div class="p-value info-value" id="c_address" style="font-size: 9pt;">-</div>
                    <span class="p-label info-label">é›»è©±ç•ªå· (Phone)</span>
                    <div class="p-value info-value">
                        <span class="masked-text">***-****-****</span><span class="real-text" id="c_phone">-</span>
                        <button class="btn-toggle-mask" onclick="toggleMask(this)">è¡¨ç¤º</button>
                    </div>
                </div>
            </div>

            <div class="print-block">
                <h3 class="print-only-header">ç·Šæ€¥é€£çµ¡å…ˆ / Emergency</h3>
                <div class="card-section">
                    <div class="section-title d-none d-print-none">ç·Šæ€¥é€£çµ¡å…ˆ</div>
                    <div class="mb-3">
                        <span class="p-label info-label">ç·Šæ€¥é€£çµ¡å…ˆ (Emergency Contact)</span><div class="p-value info-value" id="c_em_name">-</div>
                        <div class="p-value info-value">
                            <span class="masked-text">***-****-****</span><span class="real-text" id="c_em_phone">-</span>
                            <button class="btn-toggle-mask" onclick="toggleMask(this)">è¡¨ç¤º</button>
                        </div>
                    </div>
                    <div class="mb-3" style="background-color: #fff3cd; padding: 5px; border-radius: 5px;">
                        <span class="p-label info-label text-danger">ä»£ç†å¼•å—äºº (Proxy Person)</span>
                        <div class="small text-muted d-print-none" style="font-size:8pt;">â€»é£¼ã„ä¸»ä¸åœ¨æ™‚ã«çŠ¬ã‚’ä¿è­·ã™ã‚‹äºº</div>
                        <div class="p-value info-value fw-bold" id="c_proxy_name">-</div>
                        <div class="p-value info-value">
                            <span class="masked-text">***-****-****</span><span class="real-text" id="c_proxy_phone">-</span>
                            <button class="btn-toggle-mask" onclick="toggleMask(this)">è¡¨ç¤º</button>
                        </div>
                    </div>
                    <div><span class="p-label info-label">æŒ‡å®šé¿é›£æ‰€ (Evacuation Site)</span><div class="p-value info-value" id="c_evac">-</div></div>
                </div>
            </div>

            <div class="print-block">
                <h3 class="print-only-header">åŒ»ç™‚æƒ…å ± / Medical</h3>
                <div class="card-section">
                    <div class="section-title d-none d-print-none">åŒ»ç™‚æƒ…å ±</div>
                    <span class="p-label info-label">ã‹ã‹ã‚Šã¤ã‘å‹•ç‰©ç—…é™¢ (Vet)</span><div class="p-value info-value" id="d_vet">-</div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <span class="p-label info-label">ç‹‚çŠ¬ç—…äºˆé˜²æ¥ç¨®</span>
                            <div class="p-value info-value d-flex align-items-center"><span id="d_rabies_status">-</span><button id="btn_rabies_img" class="btn-cert-view" style="display:none;">ğŸ“·</button></div>
                        </div>
                        <div class="col-6">
                            <span class="p-label info-label">æ··åˆãƒ¯ã‚¯ãƒãƒ³</span>
                            <div class="p-value info-value d-flex align-items-center"><span id="d_vaccine_status">-</span><button id="btn_vaccine_img" class="btn-cert-view" style="display:none;">ğŸ“·</button></div>
                        </div>
                    </div>
                    <div class="mt-2"><span class="p-label info-label">æ—¢å¾€æ­´ (Medical History)</span><div class="p-value info-value" id="d_history">-</div></div>
                    <div class="mt-2"><span class="p-label info-label">å¸¸å‚™è–¬ (Medicine)</span><div class="p-value info-value" id="d_medicine" style="color:red;">-</div></div>
                    <div class="mt-2"><span class="p-label info-label">é‘‘æœ­ç•ªå· / ãƒã‚¤ã‚¯ãƒ­ãƒãƒƒãƒ—</span><div class="p-value info-value" style="font-size:9pt;"><span id="d_license"></span> / <span id="d_chip"></span></div></div>
                </div>
            </div>

            <div class="print-block">
                <h3 class="print-only-header">ã‚±ã‚¢æƒ…å ± / Care Info</h3>
                <div class="card-section">
                    <div class="section-title d-none d-print-none">é£Ÿäº‹ãƒ»ã‚±ã‚¢</div>
                    <div class="alert-box"><span class="alert-title">âš ï¸ ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ (Allergies)</span><div class="p-value info-value" id="d_allergy">-</div></div>
                    <div class="mt-2"><span class="p-label info-label">é£Ÿã¹ã¦ã„ã‚‹ãƒ•ãƒ¼ãƒ‰ (Food)</span><div class="p-value info-value" id="d_food">-</div></div>
                    <div class="mt-2"><span class="p-label info-label">æ€§æ ¼ãƒ»æ³¨æ„äº‹é … (Caution)</span><div class="p-value info-value" id="d_caution">-</div></div>
                    <div class="mt-3 text-end"><small style="font-size:8pt; color:#999;">K9 Harmony Portal - Data Generated: <span id="print_date"></span></small></div>
                </div>
            </div>
            <div class="print-footer">ã€ã”æ³¨æ„ã€‘æœ¬ã‚«ãƒ¼ãƒ‰ã¯å…¬çš„è¨¼æ˜æ›¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç‹‚çŠ¬ç—…äºˆé˜²æ³•ã«åŸºã¥ãæ‰‹ç¶šãç­‰ã§ã¯ã€å¿…ãšåŸæœ¬ã‚’ã”æç¤ºãã ã•ã„ã€‚</div>
        </div>
        <footer class="disclaimer-footer no-print-area text-center"><hr><p>ã€å…è²¬äº‹é …ãƒ»ã”æ³¨æ„ã€‘<br>æœ¬ã‚¢ãƒ—ãƒªãŠã‚ˆã³å‡ºåŠ›ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã¯ã€å…¬çš„ãªè¨¼æ˜æ›¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ²è¼‰æƒ…å ±ã¯æœ€çµ‚æ›´æ–°æ—¥æ™‚ç‚¹ã®ã‚‚ã®ã§ã™ã€‚</p></footer>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">è¨¼æ˜æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <div id="modalLoading" class="spinner-border text-primary" role="status" style="display:none;"></div>
                    <img id="modalImage" src="" class="img-fluid" alt="Certificate" onload="document.getElementById('modalLoading').style.display='none';">
                    <div class="mt-2 text-muted small">â€»ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã§ãã¾ã™</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyJ2j7iNeojVPB8SeRozbh9WIqH0CLkwb8Q67300WK2ydsxt8nKdZmLbNQq1Wuu9zX0/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";
        let imageModal;

        window.onload = async function() {
            imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                fetchData(profile.userId, urlParams.get('dogId'));
            } catch (err) {
                document.getElementById('loading').innerHTML = `<p class="text-danger">åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
            }
        };

        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if (data.error) { document.getElementById('loading').innerHTML = `<p class="text-danger">${data.error}</p>`; return; }
                if (data.multiple_dogs) { document.getElementById('loading').innerHTML = `<p class="text-warning">çŠ¬ã‚’é¸æŠã—ã¦ãã ã•ã„</p>`; return; }
                renderData(data);
            }).catch(err => {
                document.getElementById('loading').innerHTML = `<p class="text-danger">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
            });
        }

        function renderData(data) {
            const c = data.customer || {};
            const d = data.dog || {}; // â˜…ä¿®æ­£: ãƒ‡ãƒ¼ã‚¿æ¬ ææ™‚ã®ä¿è­·ã‚’è¿½åŠ 

            setText('d_name', d.name_disp);
            setText('d_breed', d.breed);
            setText('d_gender', d.gender);
            setText('d_birth', d.birth_date);
            setText('d_age', d.age);
            
            setText('c_name', c.name);
            setText('c_address', c.address);
            setText('c_phone', c.phone);
            
            setText('c_em_name', c.em_name);
            setText('c_em_phone', c.em_phone);
            setText('c_proxy_name', c.proxy_name || 'æœªç™»éŒ²');
            setText('c_proxy_phone', c.proxy_phone);
            setText('c_evac', c.evac_site || 'æœªç™»éŒ²');

            setText('d_vet', d.vet_name);
            setText('d_history', d.history);
            setText('d_medicine', d.medicine);
            setText('d_license', d.license_no);
            setText('d_chip', d.microchip);
            setText('d_allergy', d.allergy);
            setText('d_food', d.food);
            setText('d_caution', d.caution);

            setupCertButton('d_rabies_status', 'btn_rabies_img', d.has_rabies, d.rabies_img_ref);
            setupCertButton('d_vaccine_status', 'btn_vaccine_img', d.has_vaccine, d.vaccine_img_ref);

            const today = new Date();
            setText('print_date', today.toLocaleDateString('ja-JP'));

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            document.getElementById('main-display').style.display = 'block';
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text || '-';
        }

        function toggleMask(btn) {
            const container = btn.parentElement;
            const masked = container.querySelector('.masked-text');
            const real = container.querySelector('.real-text');
            if (real.style.display === 'inline') {
                real.style.display = 'none'; masked.style.display = 'inline'; btn.textContent = 'è¡¨ç¤º'; btn.classList.remove('active');
            } else {
                if(confirm('å‘¨å›²ã«äººãŒã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\næƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ')) {
                    real.style.display = 'inline'; masked.style.display = 'none'; btn.textContent = 'éš ã™'; btn.classList.add('active');
                }
            }
        }

        function setupCertButton(statusId, btnId, hasCert, imgRef) {
            document.getElementById(statusId).textContent = hasCert ? 'æ¥ç¨®æ¸ˆã¿' : 'æœªç™»éŒ²';
            const btn = document.getElementById(btnId);
            if (hasCert && imgRef) {
                btn.style.display = 'inline-block';
                btn.onclick = () => openImageModal(imgRef);
            } else { btn.style.display = 'none'; }
        }

        function openImageModal(ref) {
            const imgEl = document.getElementById('modalImage');
            const loadingEl = document.getElementById('modalLoading');
            imgEl.style.display = 'none'; loadingEl.style.display = 'inline-block';
            let src = ref;
            if (ref.indexOf('http') === -1) src = `https://drive.google.com/uc?export=view&id=${ref}`;
            else if (ref.indexOf('drive.google.com') > -1) {
                const match = ref.match(/\/d\/(.+?)\//);
                if(match) src = `https://drive.google.com/uc?export=view&id=${match[1]}`;
            }
            imgEl.src = src; imgEl.style.display = 'block';
            imageModal.show();
        }
    </script>
</body>
</html>
