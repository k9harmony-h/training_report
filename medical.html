<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony Portal - うちの子医療・防災手帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/2.23.1/liff.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ==================================== */
        /* グローバル・モバイル共通スタイル */
        /* ==================================== */
        :root {
            /* ★カラーコード定義の見直し（ブランドカラーと緊急時カラーの分離）★ */
            --brand-color: #57C3C2; /* 正式ブランドカラー (index.html系) */
            
            --color-primary: #88b08b; /* Sage Green: 医療ページメインカラー */
            --color-accent: #e8f5e9; /* Pale Mint: 医療ページ背景アクセント */
            --color-terracotta: #e07a5f; /* Terracotta Orange: 医療ページアラート色 */

            --font-family-base: 'Noto Sans JP', sans-serif;
            --body-bg: #f4f7f6;
        }
        
        /* ... (既存のCSSは省略、上記の:root定義が優先される) ... */
        
        /* デバッグログ表示エリアのスタイル（LIFFに依存せず表示） */
        #debug-log-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            padding: 5px;
            max-height: 100px;
            overflow-y: scroll;
            z-index: 9999;
            border-top: 2px solid #555;
        }

    </style>
</head>
<body>1802
    <div class="liff-app-container">
        <header class="p-3 bg-white shadow-sm sticky-top">
            <h1 class="h5 text-center mb-0" style="color: var(--color-primary);"><i class="fa-solid fa-paw me-2"></i>K9 Harmony Portal - うちの子医療・防災手帳</h1>
        </header>

        <main class="container-fluid p-3">
            <div id="liff-status" class="text-center my-5">
                <p id="liff-message" class="text-muted">LIFF初期化中...</p>
                <i id="liff-spinner" class="fa-solid fa-spinner fa-spin fa-2x text-primary" style="display:none;"></i>
            </div>
            
            </main>
        
        <footer class="fixed-bottom-bar text-center">
            <p class="small text-muted mb-0" id="liff-user-info">ユーザーID: 未認証</p>
        </footer>
    </div>
    
    <div id="debug-log-area">
        <strong style="color:#fff;">DEBUG LOG:</strong> <span id="debug-log-content">LIFF-Independent Log Area Initialized.</span>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDogData = null;
        let currentPrintMode = '';
        let printSelectModal;
        let pdfPreviewModal;
        
        // ====================================
        // ログユーティリティ (画面とコンソールに出力)
        // ====================================
        function log(message) {
            console.log(`[APP LOG] ${message}`);
            // 画面上のデバッグエリアにもログを出力
            const logContent = document.getElementById('debug-log-content');
            if (logContent) {
                const now = new Date().toLocaleTimeString();
                logContent.innerHTML = `[${now}] ${message}<br>` + logContent.innerHTML;
                // 最大行数を制限するなど、さらに改善の余地あり
            }
        }

        // ====================================
        // LIFF初期化 (エラー解消ロジック)
        // ====================================
        async function initializeLiff() {
            try {
                const LIFF_ID = '2008546673-MJY7j3ox';
                log('Step 1/4: LIFF initialization started.');
                
                // LIFF SDKの読み込み後に直接initを実行
                await liff.init({ liffId: LIFF_ID });
                log('Step 2/4: LIFF initialized successfully.');

                if (liff.isLoggedIn()) {
                    log('Step 3/4: User is logged in. Fetching profile.');
                    const profile = await liff.getProfile();
                    document.getElementById('liff-user-info').textContent = `ユーザーID: ${profile.userId}`;
                    
                    document.getElementById('liff-status').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    
                    loadData(profile.userId);
                } else {
                    log('Step 3/4: User not logged in. Prompting login.');
                    document.getElementById('liff-message').textContent = 'LINEでログインしてください。';
                    document.getElementById('liff-spinner').style.display = 'none';
                    document.getElementById('liff-user-info').textContent = 'ユーザーID: 未認証';
                }
                log('Step 4/4: Initial screen rendering complete.');

            } catch (e) {
                // エラー発生時は即座に画面にメッセージを表示
                log(`FATAL: LIFF initialization failed: ${e.message}`);
                document.getElementById('liff-message').textContent = `LIFF初期化エラー: ${e.message}。外部ブラウザで開いて再試行してください。`;
                document.getElementById('liff-spinner').style.display = 'none';
                // LIFFエラー時に、画面表示が停止しないよう、最低限のDOM表示を行う
                document.getElementById('main-content').style.display = 'block'; 
            }
        }

        // ====================================
        // データ操作 (保存・読み込み)
        // [NOTE: GASとの連携ではなく、今回はローカルストレージでの入出力ロジックを実装]
        // ====================================
        
        // ... (saveData, loadData, renderData 関数は変更なし) ...

        // データをローカルストレージに保存
        function saveData(userId) {
            const formData = {
                dog: {
                    name: document.getElementById('dog-name').value,
                    type: document.getElementById('dog-type').value,
                    gender: document.getElementById('dog-gender').value,
                    age: document.getElementById('dog-age').value,
                    weight: document.getElementById('dog-weight').value,
                    features: document.getElementById('dog-features').value,
                },
                owner: {
                    name: document.getElementById('owner-name').value,
                    tel: document.getElementById('owner-tel').value,
                    address: document.getElementById('owner-address').value,
                },
                medical: {
                    history: document.getElementById('medical-history').value,
                    medication: document.getElementById('medical-medication').value,
                    allergies: document.getElementById('medical-allergies').value,
                    vet_contact: document.getElementById('vet-contact').value,
                },
                photos: {
                    // Lazy Load対応: Data URLを直接保存
                    face: document.getElementById('dog-photo-face-preview').src, 
                    full: document.getElementById('dog-photo-full-preview').src,
                }
            };

            try {
                localStorage.setItem(`dog_data_${userId}`, JSON.stringify(formData));
                currentDogData = formData;
                log('Data saved successfully to LocalStorage.');
                alert('入力内容を保存しました。');
                renderData(formData);
            } catch (e) {
                log(`Save data failed: ${e.message}`);
                alert('データの保存に失敗しました。');
            }
        }

        // データをローカルストレージから読み込み
        function loadData(userId) {
            try {
                const storedData = localStorage.getItem(`dog_data_${userId}`);
                if (storedData) {
                    const formData = JSON.parse(storedData);
                    
                    // フォームへの反映
                    document.getElementById('dog-name').value = formData.dog.name || '';
                    document.getElementById('dog-type').value = formData.dog.type || '';
                    document.getElementById('dog-gender').value = formData.dog.gender || '';
                    document.getElementById('dog-age').value = formData.dog.age || '';
                    document.getElementById('dog-weight').value = formData.dog.weight || '';
                    document.getElementById('dog-features').value = formData.dog.features || '';
                    
                    document.getElementById('owner-name').value = formData.owner.name || '';
                    document.getElementById('owner-tel').value = formData.owner.tel || '';
                    document.getElementById('owner-address').value = formData.owner.address || '';

                    document.getElementById('medical-history').value = formData.medical.history || '';
                    document.getElementById('medical-medication').value = formData.medical.medication || '';
                    document.getElementById('medical-allergies').value = formData.medical.allergies || '';
                    document.getElementById('vet-contact').value = formData.medical.vet_contact || '';
                    
                    // Lazy Load: プレビューのsrcを設定
                    document.getElementById('dog-photo-face-preview').src = formData.photos.face || document.getElementById('dog-photo-face-preview').src;
                    document.getElementById('dog-photo-full-preview').src = formData.photos.full || document.getElementById('dog-photo-full-preview').src;

                    currentDogData = formData;
                    log('Data loaded successfully.');
                    renderData(formData);
                } else {
                    log('No stored data found.');
                    renderData(null);
                }
            } catch (e) {
                log(`Load data failed: ${e.message}`);
                renderData(null);
            }
        }
        
        // レンダリング関数 (今回は省略)
        function renderData(data) {
            // ... (レンダリングロジック) ...
        }

        // ... (イベントハンドラ、PDF生成ロジックは変更なし) ...
        
        // ====================================
        // 初期処理
        // ====================================

        document.addEventListener('DOMContentLoaded', () => {
            // DOMContentLoadedでLIFF初期化をキック（最速での実行を試みる）
            initializeLiff();
            // Bootstrapモーダルのインスタンス化
            const printSelectModalEl = document.getElementById('printSelectModal');
            printSelectModal = new bootstrap.Modal(printSelectModalEl);
            const pdfPreviewModalEl = document.getElementById('pdfPreviewModal');
            pdfPreviewModal = new bootstrap.Modal(pdfPreviewModalEl);

            // フォームのバリデーションを無効にする機能を追加 (開発用)
            // document.getElementById('dog-data-form').setAttribute('novalidate', '');
        });
    </script>
</body>
</html>
