<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-color: #88b08b; /* Sage Green */
            --accent-color: #e8f5e9;
            --alert-color: #e07a5f; /* Terracotta Orange */
            --text-color: #333;
        }

        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f9fbf9; color: var(--text-color); padding-bottom: 300px; }

        /* ã‚¹ã‚¿ãƒ³ãƒ— & ãƒ­ã‚° */
        .version-stamp { position: fixed; top: 0; right: 0; background: var(--primary-color); color: white; font-size: 10px; padding: 2px 6px; z-index: 9999; }
        #debug-console-container { display: block; margin-top: 30px; padding: 0 10px; }
        #debug-console { background: #111; color: #0f0; font-family: monospace; font-size: 11px; padding: 15px; border-radius: 8px; }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        .no-print-area { margin: 20px 0 30px; text-align: center; }
        .btn-print { width: 100%; margin-bottom: 10px; padding: 12px; font-weight: bold; border-radius: 8px; border: none; color: white; }
        .card-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        
        /* å†™çœŸ (ç”»é¢ç”¨) */
        #d_photo_container { width: 150px; height: 150px; background: #fff; border-radius: 12px; border: 4px solid var(--accent-color); overflow: hidden; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
        .dog-profile-img { width: 100%; height: 100%; object-fit: cover; }

        /* --- DISPLAY MODES --- */
        #poster-display, #crate-display { display: none; }

        /* --- TASK-1: POSTER STYLE --- */
        .poster-container {
            width: 210mm; min-height: 297mm; background: #fffaf0; padding: 15mm; text-align: center; border: 8px solid #dc3545; box-sizing: border-box; margin: 0 auto;
        }
        /* (ãƒã‚¹ã‚¿ãƒ¼CSSã¯å‰å›ã®ã¾ã¾ç¶­æŒ) */
        .poster-header { color: #dc3545; font-size: 40pt; font-weight: 900; margin-bottom: 10mm; }
        .poster-photo { width: 70%; aspect-ratio: 1/1; object-fit: cover; border: 6px solid #333; margin-bottom: 10mm; background: #ddd; }
        .poster-table { width: 100%; border-collapse: collapse; font-size: 14pt; margin-bottom: 10mm; text-align: left; }
        .poster-table th { border-bottom: 2px solid #dc3545; color: #dc3545; padding: 5px; }
        .poster-table td { border-bottom: 1px solid #ccc; padding: 5px; font-weight: bold; }
        .poster-contact { background: #dc3545; color: white; padding: 15px; border-radius: 15px; font-size: 16pt; font-weight: bold; }

        /* --- TASK-2: CRATE TAG STYLE (Tent) --- */
        .crate-container {
            width: 210mm; height: 297mm; /* A4 Portrait */
            background: white; position: relative; overflow: hidden;
            box-sizing: border-box; border: 1px dashed #ccc; /* Cut line guide */
            margin: 0 auto;
        }
        
        /* Center Fold Line */
        .crate-fold-line {
            position: absolute; top: 50%; left: 0; width: 100%; height: 0;
            border-top: 2px dashed #88b08b; z-index: 10;
        }
        .crate-fold-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 0 10px; color: #88b08b; font-size: 10pt;
        }

        /* BACK SIDE (Top Half - Rotated 180) */
        .crate-back {
            position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            padding: 10mm; box-sizing: border-box;
            transform: rotate(180deg); /* é€†ã•ã¾ã«ã™ã‚‹ */
            display: flex; flex-direction: column; justify-content: space-between;
            background-color: #fdfdfd;
        }
        .crate-owner-section { border: 3px solid #333; padding: 10px; border-radius: 8px; }
        .crate-owner-title { font-weight: bold; background: #333; color: white; display: inline-block; padding: 2px 10px; border-radius: 4px; margin-bottom: 5px; }
        .crate-food-list { font-size: 10pt; display: flex; gap: 10px; }
        .crate-food-box { border: 1px solid #ccc; padding: 5px; flex: 1; border-radius: 5px; }
        .crate-commands { font-size: 10pt; margin-top: 10px; }
        .crate-command-item { border: 1px solid #888; padding: 2px 5px; display: inline-block; margin: 2px; border-radius: 4px; }

        /* FRONT SIDE (Bottom Half) */
        .crate-front {
            position: absolute; top: 50%; left: 0; width: 100%; height: 50%;
            padding: 10mm; box-sizing: border-box;
            text-align: center;
        }
        .crate-main-photo {
            width: 140px; height: 140px; object-fit: cover;
            border-radius: 50%; border: 5px solid var(--alert-color);
            margin: 0 auto 10px; display: block;
        }
        .crate-main-name { font-size: 32pt; font-weight: 900; color: #333; line-height: 1; }
        .crate-main-breed { font-size: 14pt; font-weight: bold; color: #666; margin-bottom: 10px; }
        
        .crate-alert-bar {
            background-color: var(--alert-color); color: white;
            font-weight: bold; font-size: 14pt; padding: 5px;
            border-radius: 8px; margin-bottom: 10px;
        }
        
        .crate-write-area {
            border: 2px dashed #88b08b; border-radius: 8px; padding: 5px;
            text-align: left; height: 80px;
        }
        .crate-bottom-msg {
            margin-top: 10px; font-weight: bold; font-size: 10pt; color: var(--primary-color);
        }

        /* å°åˆ·æ™‚è¨­å®š */
        @media print {
            .no-print-area, #debug-console-container, .version-stamp { display: none !important; }
            body { background: white; }
            
            body.mode-handbook #main-display { display: block; }
            body.mode-handbook #poster-display, body.mode-handbook #crate-display { display: none; }

            body.mode-poster #poster-display { display: block; }
            body.mode-poster #main-display, body.mode-poster #crate-display { display: none; }

            body.mode-crate #crate-display { display: block; }
            body.mode-crate #main-display, body.mode-crate #poster-display { display: none; }
        }
    </style>
</head>
<body class="mode-handbook">

    <div class="version-stamp">v2025.12.02-TASK-2</div>

    <div class="container py-3">
        <div class="no-print-area">
            <h4 class="fw-bold mb-3" style="color: var(--primary-color);">â›‘ï¸ ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</h4>
            
            <div id="loading" class="loading">
                <div class="spinner-border text-success"></div><p>Loading...</p>
            </div>

            <div id="controls" style="display:none; max-width: 500px; margin: 0 auto;">
                <button onclick="switchMode('handbook')" class="btn btn-print" style="background-color: #88b08b;">
                    <i class="fa-solid fa-book"></i> æ‰‹å¸³ãƒ¢ãƒ¼ãƒ‰ (é€šå¸¸)
                </button>
                <button onclick="switchMode('poster')" class="btn btn-print" style="background-color: #dc3545;">
                    <i class="fa-solid fa-bullhorn"></i> è¿·å­ãƒã‚¹ã‚¿ãƒ¼ (TASK-1)
                </button>
                <button onclick="switchMode('crate')" class="btn btn-print" style="background-color: #e07a5f;">
                    <i class="fa-solid fa-tent"></i> ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚° (TASK-2)
                </button>
                
                <hr>
                <button onclick="window.print()" class="btn btn-secondary w-100 rounded-pill">
                    <i class="fa-solid fa-print"></i> å°åˆ· / PDFä¿å­˜
                </button>
                <div class="mt-2 small text-muted">â€»å°åˆ·ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ¢ãƒ¼ãƒ‰ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚</div>
            </div>
        </div>

        <div id="main-display" style="display:none;">
            <div class="card-section">
                <div class="section-title">åŸºæœ¬æƒ…å ±</div>
                <div class="text-center">
                    <div id="d_photo_container"><span class="small">No Photo</span></div>
                </div>
                <div class="row text-center mb-3">
                    <div class="col-12"><h2 id="d_name_main" class="fw-bold">-</h2></div>
                    <div class="col-12 text-muted" id="d_breed_main">-</div>
                </div>
                <div class="alert alert-warning small">
                    <i class="fa-solid fa-circle-info"></i> å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™ã€‚å„ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã‹ã‚‰å°åˆ·ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
        </div>

        <div id="poster-display">
            <div class="poster-container">
                <div class="poster-header">ã†ã¡ã®å­<br>æ¢ã—ã¦ã¾ã™ï¼</div>
                <div class="poster-time">__æœˆ__æ—¥ __æ™‚é ƒ ã„ãªããªã‚Šã¾ã—ãŸ</div>
                <img id="poster_img" class="poster-photo" src="" alt="DOG PHOTO">
                <table class="poster-table">
                    <tr><th>ãŠåå‰</th><td id="poster_name">-</td></tr>
                    <tr><th>ç‰¹å¾´</th><td id="poster_desc">-</td></tr>
                </table>
                <div class="poster-contact">
                    é€£çµ¡å…ˆï¼š<span id="poster_phone">090-XXXX-XXXX</span>
                </div>
            </div>
        </div>

        <div id="crate-display">
            <div class="crate-container">
                <div class="crate-fold-line"></div>
                <div class="crate-fold-text">------ å±±æŠ˜ã‚Š (FOLD HERE) ------</div>

                <div class="crate-back">
                    <div class="crate-owner-section">
                        <div class="crate-owner-title">ç·Šæ€¥é€£çµ¡å…ˆ (Emergency Contact)</div>
                        <div class="fs-5 fw-bold">Owner: <span id="crate_owner">-</span></div>
                        <div class="fs-4 fw-bold"><i class="fa-solid fa-phone"></i> <span id="crate_phone">-</span></div>
                        <hr style="margin:5px 0;">
                        <div class="small">ä»£ç†äºº: <span id="crate_proxy">-</span> (<span id="crate_proxy_tel">-</span>)</div>
                        <div class="small">ã‹ã‹ã‚Šã¤ã‘åŒ»: <span id="crate_vet">-</span></div>
                    </div>

                    <div class="mt-2">
                        <strong>ğŸ†˜ ã‚µãƒã‚¤ãƒãƒ«ãƒ•ãƒ¼ãƒ‰ (Human Food OK/NG)</strong>
                        <div class="crate-food-list">
                            <div class="crate-food-box bg-light">
                                <span class="text-success fw-bold">â­•ï¸ OK</span><br>
                                ç™½ç±³ãƒ»ãƒ‘ãƒ³(å…·ãªã—)<br>ã‚µãƒ„ãƒã‚¤ãƒ¢ãƒ»é¶è‚‰<br>ãƒãƒŠãƒŠãƒ»ãƒªãƒ³ã‚´
                            </div>
                            <div class="crate-food-box bg-light">
                                <span class="text-danger fw-bold">âŒ NG</span><br>
                                ãƒã‚®ãƒ»ç‰ã­ããƒ»ãƒãƒ§ã‚³<br>ãƒ–ãƒ‰ã‚¦ãƒ»ã‚­ã‚·ãƒªãƒˆãƒ¼ãƒ«<br>é³¥ã®éª¨ãƒ»ã‚«ãƒ•ã‚§ã‚¤ãƒ³
                            </div>
                        </div>
                    </div>

                    <div class="mt-2">
                        <strong>ğŸ• ã‚³ãƒãƒ³ãƒ‰ (Commands)</strong><br>
                        <span class="crate-command-item">ã‚ªã‚¹ãƒ¯ãƒª/Sit</span>
                        <span class="crate-command-item">ãƒãƒ†/Wait</span>
                        <span class="crate-command-item">ãƒã‚¦ã‚¹/House</span>
                        <span class="crate-command-item">ã‚ªã‚¤ãƒ‡/Come</span>
                    </div>
                </div>

                <div class="crate-front">
                    <img id="crate_img" class="crate-main-photo" src="">
                    <div id="crate_name" class="crate-main-name">NAME</div>
                    <div id="crate_breed" class="crate-main-breed">Breed / Age</div>

                    <div id="crate_alert" class="crate-alert-bar">
                        âš ï¸ <span id="crate_caution">-</span>
                    </div>

                    <div style="text-align:left; font-size:10pt; font-weight:bold; color:#555;">
                        ğŸš é£Ÿäº‹ãƒ»æŠ•è–¬ãƒ­ã‚° (Food/Meds Log)
                    </div>
                    <div class="crate-write-area">
                        <span class="small text-muted">â€»ã“ã“ã«çµ¦é¤Œæ™‚é–“ã‚„ä½“èª¿ã‚’æ‰‹æ›¸ãã—ã¦ãã ã•ã„</span>
                    </div>

                    <div class="crate-bottom-msg">
                        <i class="fa-solid fa-arrow-up"></i> ç·Šæ€¥é€£çµ¡å…ˆã¯è£é¢(å†…å´)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ <i class="fa-solid fa-arrow-up"></i>
                    </div>
                    
                    <div class="mt-3 text-start small border-top pt-2">
                        <label><input type="checkbox" style="transform:scale(1.5);"> ç·Šæ€¥æ™‚ã®ç£åŒ»å‡¦ç½®ã‚’ä¸€ä»»ã—ã¾ã™ (Authorize Vet Care)</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="debug-console-container" class="no-print-area">
            <h6 class="text-danger fw-bold">âš ï¸ Debug Console</h6>
            <div id="debug-console">Initializing...</div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";

        function log(msg) {
            const el = document.getElementById('debug-console');
            if(el) el.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.innerHTML;
            console.log(msg);
        }

        window.onload = async function() {
            try {
                log('Init LIFF...');
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                const dogId = urlParams.get('dogId');
                
                log(`User: ${profile.userId}, DogID: ${dogId}`);
                fetchData(profile.userId, dogId);
            } catch (err) {
                log('Init Error: ' + err.message);
            }
        };

        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if(data.error) { log('API Error: ' + data.error); return; }
                    renderData(data);
                    if(data.dog && data.dog.id) fetchImage(userId, data.dog.id);
                })
                .catch(e => log('Fetch Error: ' + e.message));
        }

        function renderData(data) {
            const c = data.customer || {};
            const d = data.dog || {};

            // 1. Handbook
            setText('d_name_main', d.name_disp);
            setText('d_breed_main', `${d.breed} / ${d.age}`);

            // 2. Poster
            setText('poster_name', d.name_disp);
            setText('poster_desc', `${d.breed} / ${d.gender} / ${d.age}`);
            setText('poster_phone', c.phone);

            // 3. Crate Tag (TASK-2)
            setText('crate_name', d.name_disp);
            setText('crate_breed', `${d.breed} (${d.gender})`);
            setText('crate_caution', d.caution || 'ç‰¹ã«ãªã— (None)');
            setText('crate_owner', c.name);
            setText('crate_phone', c.phone);
            setText('crate_proxy', c.proxy_name);
            setText('crate_proxy_tel', c.proxy_phone);
            setText('crate_vet', d.vet_name);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('main-display').style.display = 'block';
            log('Render Complete.');
        }

        function fetchImage(userId, dogId) {
            let url = `${API_URL}?userId=${userId}&type=img_profile&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.image) {
                    setImg('d_photo_container', data.image); // Handbook
                    setSrc('poster_img', data.image);       // Poster
                    setSrc('crate_img', data.image);        // Crate
                    log('Image loaded.');
                }
            });
        }

        // Helpers
        function setText(id, txt) {
            const el = document.getElementById(id);
            if(el) el.textContent = (txt && txt !== '') ? txt : '-';
        }
        function setSrc(id, src) {
            const el = document.getElementById(id);
            if(el) el.src = src;
        }
        function setImg(containerId, src) {
            const el = document.getElementById(containerId);
            if(el) {
                el.innerHTML = `<img src="${src}" class="dog-profile-img">`;
                el.style.border = 'none';
            }
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        window.switchMode = function(mode) {
            document.body.className = ''; // Reset
            document.body.classList.add('mode-' + mode);
            
            // Toggle Display manually for safety
            document.getElementById('main-display').style.display = (mode === 'handbook') ? 'block' : 'none';
            document.getElementById('poster-display').style.display = (mode === 'poster') ? 'block' : 'none';
            document.getElementById('crate-display').style.display = (mode === 'crate') ? 'block' : 'none';
            
            alert(`${mode.toUpperCase()} ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚\nã€Œå°åˆ·ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚`);
        };
    </script>
</body>
</html>
