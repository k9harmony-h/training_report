<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony Portal - ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/2.23.1/liff.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ==================================== */
        /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ»ãƒ¢ãƒã‚¤ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        /* ==================================== */
        :root {
            --color-primary: #00A96B; /* ç·‘ (K-9ãƒ­ã‚´ã‚«ãƒ©ãƒ¼) */
            --color-secondary: #FF6A00; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            --color-accent: #57C3C2; /* é’ç·‘ (æŒã¡æ­©ãæ‰‹å¸³ã®æ­£å¼ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼) */
            --color-terracotta: #E2725B; /* ãƒ†ãƒ©ã‚³ãƒƒã‚¿ã‚ªãƒ¬ãƒ³ã‚¸ (ãƒã‚¹ã‚¿ãƒ¼ã€ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ç”¨) */
            --color-sage: #9ABF96; /* ã‚»ãƒ¼ã‚¸ã‚°ãƒªãƒ¼ãƒ³ (ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ç”¨) */
            --font-family-base: 'Noto Sans JP', sans-serif;
            --body-bg: #f4f7f6;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--body-bg);
            padding-bottom: 80px; /* ãƒ•ãƒƒã‚¿ãƒ¼å¯¾ç­– */
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
        }

        /* LIFFå›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .liff-app-container {
            max-width: 600px;
            margin: auto;
            background-color: white;
            min-height: 100vh;
            padding: 0;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼ */
        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            font-weight: 700;
        }
        .btn-primary:hover {
            background-color: #008855;
            border-color: #008855;
        }
        .btn-accent {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
            color: white;
            font-weight: 700;
        }
        .btn-accent:hover {
            background-color: #48a9a8;
            border-color: #48a9a8;
        }
        .btn-outline-primary {
            color: var(--color-primary);
            border-color: var(--color-primary);
            font-weight: 700;
        }
        .btn-outline-primary:hover {
            background-color: var(--color-primary);
            color: white;
        }
        .btn-terracotta {
            background-color: var(--color-terracotta);
            border-color: var(--color-terracotta);
            color: white;
            font-weight: 700;
        }
        .btn-terracotta:hover {
            background-color: #c75e48;
            border-color: #c75e48;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã®è£…é£¾ */
        .form-control:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.25rem rgba(0, 169, 107, 0.25);
        }

        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .image-preview {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ccc;
        }
        
        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card-header {
            background-color: var(--color-primary);
            color: white;
            font-weight: 700;
        }
        .card-title {
            color: var(--color-primary);
        }
        .list-group-item strong {
            color: var(--color-primary);
        }
        
        /* ã‚¿ãƒ–ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .nav-pills .nav-link {
            color: var(--color-primary);
            background-color: #e9ecef;
            border: 1px solid var(--color-primary);
            margin: 0 5px;
            padding: 8px 15px;
            font-weight: 700;
        }
        .nav-pills .nav-link.active {
            color: white;
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .fixed-bottom-bar {
            background-color: white;
            border-top: 1px solid #e0e0e0;
            padding: 10px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }

        /* PDFå‡ºåŠ›ç‰©å…±é€šã®éè¡¨ç¤ºè¨­å®š */
        #main-display, #poster-display, #crate-tag-display, #passport-display {
            display: none;
            /* é€šå¸¸æ™‚ã¯éè¡¨ç¤ºã€‚PDFç”Ÿæˆæ™‚ã®ã¿ä¸€æ™‚çš„ã«è¡¨ç¤ºã•ã›ã‚‹ */
            position: relative; /* PDFç”Ÿæˆæ™‚ã®èª¿æ•´ã®ãŸã‚ */
        }


        /* ==================================== */
        /* @media print: å°åˆ·ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨CSS */
        /* ==================================== */

        /* A4æ¨ªå‘ã (é€šå¸¸ã®æ‰‹å¸³ã¨ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ã«ä½¿ç”¨) */
        @page {
            size: A4 landscape;
            margin: 0;
        }
        
        /* A4ç¸¦å‘ã (ãƒã‚¹ã‚¿ãƒ¼ã¨æŒã¡æ­©ãæ‰‹å¸³ã«ä½¿ç”¨) */
        .print-mode-poster @page, .print-mode-passport @page {
            size: A4 portrait;
            margin: 0;
        }

        /* å°åˆ·æ™‚ã€bodyã«ä»˜ä¸ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã«ã‚ˆã£ã¦å°åˆ·ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ */
        @media print {
            /* å°åˆ·æ™‚ã¯ãƒ¢ãƒã‚¤ãƒ«UIã‚’éè¡¨ç¤º */
            .liff-app-container { display: none !important; }
            .fixed-bottom-bar { display: none !important; }

            body {
                margin: 0;
                padding: 0;
                /* å°åˆ·å¯¾è±¡è¦ç´ ã®ã¿ã‚’è¡¨ç¤º */
                display: block !important;
                background-color: white !important;
            }

            /* å…±é€šè¨­å®š: ã™ã¹ã¦ã®å°åˆ·ç‰©ã¯A4ã‚µã‚¤ã‚ºã§ãƒ•ãƒ«è¡¨ç¤º */
            #main-display, #poster-display, #crate-tag-display, #passport-display {
                display: block !important;
                position: relative !important;
                width: 297mm; /* A4æ¨ªå¹… */
                height: 210mm; /* A4æ¨ªé«˜ã• */
                overflow: hidden;
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                page-break-after: always;
                font-size: 10pt;
                line-height: 1.4;
                color: #000;
            }
            
            /* ç¸¦å‘ãA4ãŒå¿…è¦ãªãƒ¢ãƒ¼ãƒ‰ã®èª¿æ•´ */
            .print-mode-poster #poster-display, 
            .print-mode-passport #passport-display {
                width: 210mm; /* A4ç¸¦å¹… */
                height: 297mm; /* A4ç¸¦é«˜ã• */
            }

            /* --- TASK-1: è¿·å­ãƒã‚¹ã‚¿ãƒ¼ (#poster-display) ã‚¹ã‚¿ã‚¤ãƒ« --- */
            .print-mode-poster #poster-display {
                padding: 10mm;
                text-align: center;
                border: 10px solid var(--color-terracotta); /* ãƒ†ãƒ©ã‚³ãƒƒã‚¿ã‚ªãƒ¬ãƒ³ã‚¸ã®å¤ªæ  */
                line-height: 1.1;
            }
            .print-mode-poster .poster-title {
                font-size: 48pt;
                font-weight: 900;
                color: var(--color-terracotta);
                margin-bottom: 5mm;
                border-bottom: 5px double var(--color-terracotta);
                display: inline-block;
                padding-bottom: 2mm;
            }
            .print-mode-poster .poster-photo-container {
                width: 150mm;
                height: 150mm;
                margin: 0 auto 5mm;
                border: 5px solid var(--color-terracotta);
                overflow: hidden;
            }
            .print-mode-poster .poster-photo {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .print-mode-poster .poster-info {
                font-size: 16pt;
                margin-top: 5mm;
                text-align: left;
                width: 100%;
                max-width: 180mm;
                margin-left: auto;
                margin-right: auto;
            }
            .print-mode-poster .poster-contact {
                font-size: 20pt;
                font-weight: 700;
                color: var(--color-terracotta);
                margin-top: 5mm;
                padding: 3mm;
                border: 3px solid var(--color-terracotta);
            }
            .print-mode-poster .poster-contact span {
                font-size: 30pt;
                font-weight: 900;
            }

            /* --- TASK-2: ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚° (#crate-tag-display) ã‚¹ã‚¿ã‚¤ãƒ« --- */
            .print-mode-crate #crate-tag-display {
                padding: 5mm;
                display: grid !important;
                grid-template-columns: 1fr 1fr; /* å·¦å³2åˆ†å‰² */
                height: 210mm;
            }

            /* ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°: å·¦å´ (ãƒ¡ã‚¤ãƒ³æƒ…å ±) */
            .print-mode-crate .crate-side-left {
                background-color: var(--color-sage); /* ã‚»ãƒ¼ã‚¸ã‚°ãƒªãƒ¼ãƒ³ */
                padding: 10mm;
                color: white;
                height: 100%;
                box-sizing: border-box;
                border-right: 2px solid #fff;
            }
            .print-mode-crate .crate-title {
                font-size: 30pt;
                font-weight: 900;
                text-align: center;
                border-bottom: 4px solid white;
                padding-bottom: 3mm;
                margin-bottom: 5mm;
                line-height: 1.1;
            }
            .print-mode-crate .crate-info-item {
                font-size: 12pt;
                margin-bottom: 2mm;
            }
            .print-mode-crate .crate-label {
                font-weight: 700;
                display: inline-block;
                width: 40mm;
            }
            .print-mode-crate .crate-value {
                font-weight: 500;
            }
            .print-mode-crate .crate-photo-container {
                width: 50mm;
                height: 50mm;
                border: 3px solid white;
                margin: 5mm auto 0;
                overflow: hidden;
            }
            .print-mode-crate .crate-photo {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            /* ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°: å³å´ (ç·Šæ€¥ãƒ»æ‰‹æ›¸ãæƒ…å ±) */
            .print-mode-crate .crate-side-right {
                background-color: var(--color-terracotta); /* ãƒ†ãƒ©ã‚³ãƒƒã‚¿ã‚ªãƒ¬ãƒ³ã‚¸ */
                padding: 10mm;
                color: white;
                height: 100%;
                box-sizing: border-box;
            }
            .print-mode-crate .crate-emergency-title {
                font-size: 24pt;
                font-weight: 900;
                text-align: center;
                margin-bottom: 5mm;
                padding: 2mm;
                background-color: rgba(255, 255, 255, 0.2);
                line-height: 1.1;
            }
            .print-mode-crate .crate-handwrite-area {
                background-color: white;
                color: #333;
                height: 40mm; /* æ‰‹æ›¸ãã‚¹ãƒšãƒ¼ã‚¹ã®ç¢ºä¿ */
                border: 2px solid var(--color-terracotta);
                margin-bottom: 5mm;
                padding: 5mm;
                text-align: center;
                font-size: 14pt;
                font-weight: 700;
            }
            .print-mode-crate .crate-handwrite-label {
                font-size: 10pt;
                color: #888;
                margin-top: 1mm;
            }


            /* --- TASK-2: æŒã¡æ­©ãç”¨æ‰‹å¸³ (#passport-display) ã‚¹ã‚¿ã‚¤ãƒ« --- */
            .print-mode-passport #passport-display {
                padding: 5mm 10mm;
                display: flex !important;
                flex-direction: column; /* ç¸¦é•· */
                height: 297mm;
                width: 210mm;
                box-shadow: none;
                line-height: 1.2;
                font-size: 10pt;
            }

            /* æŒã¡æ­©ãæ‰‹å¸³: ã‚«ãƒãƒ¼ (è£è¡¨ç´™å´) */
            .print-mode-passport .passport-cover-back {
                background-color: var(--color-accent); /* é’ç·‘ */
                color: white;
                height: 70mm; /* ä¸Šéƒ¨3åˆ†ã®1ç¨‹åº¦ */
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 5mm;
                text-align: center;
                font-size: 18pt;
                font-weight: 900;
                border-bottom: 1mm solid white;
            }
            .print-mode-passport .passport-cover-back-text {
                transform: rotate(180deg); /* å°åˆ·å¾Œã®æŠ˜ã‚ŠãŸãŸã¿ç”¨ */
                width: 100%;
            }

            /* æŒã¡æ­©ãæ‰‹å¸³: ãƒ¡ã‚¤ãƒ³æƒ…å ±ã‚¨ãƒªã‚¢ */
            .print-mode-passport .passport-main-area {
                display: grid;
                grid-template-columns: 1fr 1fr; /* 2åˆ— */
                gap: 5mm;
                padding-top: 5mm;
                flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨ */
            }
            .print-mode-passport .passport-photo-container {
                width: 50mm;
                height: 50mm;
                border: 3px solid var(--color-accent);
                overflow: hidden;
                margin-bottom: 5mm;
            }
            .print-mode-passport .passport-photo {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .print-mode-passport .passport-info-group {
                border-left: 3px solid var(--color-accent);
                padding-left: 3mm;
                margin-bottom: 5mm;
            }
            .print-mode-passport .passport-section-title {
                font-size: 12pt;
                font-weight: 700;
                color: var(--color-accent);
                border-bottom: 1px solid var(--color-accent);
                margin-bottom: 2mm;
            }
            .print-mode-passport .passport-label {
                font-weight: 700;
                margin-right: 2mm;
                color: #555;
            }
        }
    </style>
</head>
<body>
    <div class="liff-app-container">
        <header class="p-3 bg-white shadow-sm sticky-top">
            <h1 class="h5 text-center mb-0" style="color: var(--color-primary);"><i class="fa-solid fa-paw me-2"></i>K9 Harmony Portal - ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</h1>
        </header>

        <main class="container-fluid p-3">
            <div id="liff-status" class="text-center my-5">
                <p id="liff-message" class="text-muted">LIFFåˆæœŸåŒ–ä¸­...</p>
                <i id="liff-spinner" class="fa-solid fa-spinner fa-spin fa-2x text-primary" style="display:none;"></i>
            </div>

            <div id="main-content" style="display:none;">
                <h2 class="h4 mb-4 text-center">ãƒšãƒƒãƒˆæƒ…å ±ç™»éŒ²ãƒ»ç¢ºèª</h2>

                <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pills-input-tab" data-bs-toggle="pill" data-bs-target="#pills-input" type="button" role="tab" aria-controls="pills-input" aria-selected="true"><i class="fa-solid fa-pen me-1"></i>å…¥åŠ›</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pills-preview-tab" data-bs-toggle="pill" data-bs-target="#pills-preview" type="button" role="tab" aria-controls="pills-preview" aria-selected="false"><i class="fa-solid fa-eye me-1"></i>ç¢ºèª</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pills-output-tab" data-bs-toggle="pill" data-bs-target="#pills-output" type="button" role="tab" aria-controls="pills-output" aria-selected="false"><i class="fa-solid fa-file-pdf me-1"></i>å‡ºåŠ›</button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    
                    <div class="tab-pane fade show active" id="pills-input" role="tabpanel" aria-labelledby="pills-input-tab">
                        <div class="alert alert-info small" role="alert">
                            å…¥åŠ›ã—ãŸæƒ…å ±ã¯ã€ã“ã®LIFFã‚¢ãƒ—ãƒªã«è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
                        </div>

                        <form id="dog-data-form" class="needs-validation" novalidate>
                            
                            <div class="card mb-3">
                                <div class="card-header"><i class="fa-solid fa-dog me-2"></i>ãƒšãƒƒãƒˆåŸºæœ¬æƒ…å ±</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="dog-name" class="form-label">åå‰ <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="dog-name" required>
                                        <div class="invalid-feedback">åå‰ã¯å¿…é ˆã§ã™ã€‚</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label for="dog-type" class="form-label">ç¨®åˆ¥ (çŠ¬ç¨®ãªã©) <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="dog-type" required>
                                            <div class="invalid-feedback">ç¨®åˆ¥ã¯å¿…é ˆã§ã™ã€‚</div>
                                        </div>
                                        <div class="col">
                                            <label for="dog-gender" class="form-label">æ€§åˆ¥ <span class="text-danger">*</span></label>
                                            <select class="form-select" id="dog-gender" required>
                                                <option value="" disabled selected>é¸æŠ...</option>
                                                <option value="ã‚ªã‚¹">ã‚ªã‚¹</option>
                                                <option value="ãƒ¡ã‚¹">ãƒ¡ã‚¹</option>
                                            </select>
                                            <div class="invalid-feedback">æ€§åˆ¥ã¯å¿…é ˆã§ã™ã€‚</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label for="dog-age" class="form-label">å¹´é½¢ (æ‰)</label>
                                            <input type="number" class="form-control" id="dog-age" min="0" max="30">
                                        </div>
                                        <div class="col">
                                            <label for="dog-weight" class="form-label">ä½“é‡ (kg)</label>
                                            <input type="number" class="form-control" id="dog-weight" step="0.1" min="0.1">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="dog-features" class="form-label">ç‰¹å¾´ãƒ»æ€§æ ¼</label>
                                        <textarea class="form-control" id="dog-features" rows="2"></textarea>
                                        <div class="form-text">ä»–äººã‚„ä»–ã®å‹•ç‰©ã¸ã®åå¿œã€ç‰¹ç•°ãªè¡Œå‹•ã€é³´ãå£°ãªã©</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header"><i class="fa-solid fa-user me-2"></i>é£¼ã„ä¸»æƒ…å ±</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="owner-name" class="form-label">æ°å <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="owner-name" required>
                                        <div class="invalid-feedback">æ°åã¯å¿…é ˆã§ã™ã€‚</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="owner-tel" class="form-label">é›»è©±ç•ªå· <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="owner-tel" pattern="[0-9]{10,11}" required>
                                        <div class="form-text">ãƒã‚¤ãƒ•ãƒ³ç„¡ã—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: 09012345678)</div>
                                        <div class="invalid-feedback">é›»è©±ç•ªå·ã¯10æ¡ã¾ãŸã¯11æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="owner-address" class="form-label">ä½æ‰€ (é¿é›£æ‰€æƒ…å ±) <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="owner-address" rows="2" required></textarea>
                                        <div class="invalid-feedback">ä½æ‰€ã¯å¿…é ˆã§ã™ã€‚</div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header"><i class="fa-solid fa-notes-medical me-2"></i>å¥åº·ãƒ»åŒ»ç™‚æƒ…å ±</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="medical-history" class="form-label">æ—¢å¾€æ­´ãƒ»æŒç—…</label>
                                        <textarea class="form-control" id="medical-history" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="medical-medication" class="form-label">æœç”¨ä¸­ã®è–¬ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ</label>
                                        <textarea class="form-control" id="medical-medication" rows="2"></textarea>
                                        <div class="form-text">è–¬åã€æŠ•ä¸é‡ã€æŠ•ä¸é »åº¦ãªã©ã‚’å…·ä½“çš„ã«</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="medical-allergies" class="form-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
                                        <input type="text" class="form-control" id="medical-allergies">
                                    </div>
                                    <div class="mb-3">
                                        <label for="vet-contact" class="form-label">ã‹ã‹ã‚Šã¤ã‘å‹•ç‰©ç—…é™¢åãƒ»é›»è©±ç•ªå·</label>
                                        <input type="text" class="form-control" id="vet-contact">
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header"><i class="fa-solid fa-camera me-2"></i>å†™çœŸç™»éŒ²</div>
                                <div class="card-body text-center">
                                    <p class="small text-muted mb-3">é¡”å†™çœŸã¨å…¨èº«å†™çœŸã®2æšã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚ãƒã‚¹ã‚¿ãƒ¼ã‚„æ‰‹å¸³ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-2 fw-bold small">é¡”å†™çœŸ <span class="text-danger">*</span></div>
                                            <img id="dog-photo-face-preview" class="image-preview" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2212%22%20fill%3D%22%23999%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3Eé¡”å†™çœŸ%3C%2Ftext%3E%3C%2Fsvg%3E" alt="é¡”å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                                            <input type="file" class="form-control form-control-sm mt-2" id="dog-photo-face" accept="image/*" required>
                                            <div class="invalid-feedback">é¡”å†™çœŸã®ç™»éŒ²ã¯å¿…é ˆã§ã™ã€‚</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-2 fw-bold small">å…¨èº«å†™çœŸ</div>
                                            <img id="dog-photo-full-preview" class="image-preview" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2212%22%20fill%3D%22%23999%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3Eå…¨èº«å†™çœŸ%3C%2Ftext%3E%3C%2Fsvg%3E" alt="å…¨èº«å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                                            <input type="file" class="form-control form-control-sm mt-2" id="dog-photo-full" accept="image/*">
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="d-grid mt-4">
                                <button class="btn btn-primary btn-lg" type="submit" id="save-data-btn">
                                    <i class="fa-solid fa-save me-2"></i>æƒ…å ±ã‚’ä¿å­˜
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="pills-preview" role="tabpanel" aria-labelledby="pills-preview-tab">
                        <div class="card">
                            <div class="card-header bg-primary text-white">ç™»éŒ²å†…å®¹ã®ã‚µãƒãƒªãƒ¼</div>
                            <div class="card-body">
                                <div id="preview-content" class="text-center">
                                    <p class="text-muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›ã‚¿ãƒ–ã§æƒ…å ±ã‚’å…¥åŠ›ãƒ»ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="pills-output" role="tabpanel" aria-labelledby="pills-output-tab">
                        <div class="alert alert-warning small" role="alert">
                            PDFã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚LINEã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é–‹ã‘ãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€**å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ (Safari/Chrome) ã§é–‹ã„ã¦**ã‹ã‚‰ã”åˆ©ç”¨ãã ã•ã„ã€‚
                        </div>
                        <div class="card">
                            <div class="card-header bg-accent text-white"><i class="fa-solid fa-file-pdf me-2"></i>å‡ºåŠ›ã‚¢ã‚¤ãƒ†ãƒ ã®é¸æŠ</div>
                            <div class="card-body">
                                <p class="mb-3">ã©ã®å½¢å¼ã§é˜²ç½æ‰‹å¸³ã‚’å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ</p>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-accent" type="button" onclick="showPrintModal('handbook')">
                                        <i class="fa-solid fa-book-open-reader me-2"></i>é˜²ç½æ‰‹å¸³ (å››ã¤æŠ˜ã‚Š)
                                    </button>
                                    <button class="btn btn-terracotta" type="button" onclick="showPrintModal('poster')">
                                        <i class="fa-solid fa-bullhorn me-2"></i>è¿·å­ãƒã‚¹ã‚¿ãƒ¼ (A4ç¸¦)
                                    </button>
                                    <button class="btn btn-terracotta" type="button" onclick="showPrintModal('crate')">
                                        <i class="fa-solid fa-tag me-2"></i>ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚° (A4æ¨ª)
                                    </button>
                                    <button class="btn btn-accent" type="button" onclick="showPrintModal('passport')">
                                        <i class="fa-solid fa-address-card me-2"></i>æŒã¡æ­©ãç”¨æ‰‹å¸³ (A4ç¸¦)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <div class="modal fade" id="printSelectModal" tabindex="-1" aria-labelledby="printSelectModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="printSelectModalLabel">PDFå‡ºåŠ›ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p id="print-modal-message" class="mb-3"></p>
                        <div class="d-grid gap-2">
                            <button id="generate-pdf-button" class="btn btn-primary btn-lg" type="button" onclick="generatePDF(currentPrintMode)">
                                <i class="fa-solid fa-print me-2"></i>PDFã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pdfPreviewModalLabel">PDFç”Ÿæˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center" id="pdf-preview-area">
                        </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="fixed-bottom-bar text-center">
            <p class="small text-muted mb-0" id="liff-user-info">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ...</p>
        </footer>
    </div>
    
    <div id="main-display">
        </div>

    <div id="poster-display">
        <h1 class="poster-title">MISSING DOG<br>è¿·å­çŠ¬ã‚’æ¢ã—ã¦ã„ã¾ã™</h1>
        <div class="poster-photo-container">
            <img id="poster-photo" class="poster-photo" alt="è¿·å­çŠ¬ã®å†™çœŸ">
        </div>
        <div class="poster-info">
            <p><strong>åå‰:</strong> <span id="poster-dog-name"></span></p>
            <p><strong>çŠ¬ç¨®/ç‰¹å¾´:</strong> <span id="poster-dog-type-features"></span></p>
            <p><strong>æ€§åˆ¥/ä½“é‡:</strong> <span id="poster-dog-gender-weight"></span></p>
            <p><strong>æœ€çµ‚ç›®æ’ƒåœ°:</strong> <span id="poster-owner-address"></span></p>
        </div>
        <div class="poster-contact">
            <p class="mb-1">è¦‹ã‹ã‘ãŸæ–¹ã¯ä¸‹è¨˜ã«ã”é€£çµ¡ãã ã•ã„</p>
            <p class="mb-0">TEL: <span><span id="poster-owner-tel"></span></span></p>
            <p class="small mt-1">ï¼ˆé£¼ã„ä¸»: <span id="poster-owner-name"></span>ï¼‰</p>
        </div>
    </div>

    <div id="crate-tag-display">
        <div class="crate-side-left">
            <h2 class="crate-title">K9 ç½å®³æ™‚ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°</h2>
            <div class="crate-photo-container">
                <img id="crate-photo" class="crate-photo" alt="çŠ¬ã®é¡”å†™çœŸ">
            </div>
            <h3 class="h5 mt-3 text-center fw-bold text-uppercase" id="crate-dog-name"></h3>
            <div class="mt-4">
                <p class="crate-info-item"><span class="crate-label">çŠ¬ç¨®:</span> <span class="crate-value" id="crate-dog-type"></span></p>
                <p class="crate-info-item"><span class="crate-label">æ€§åˆ¥/å¹´é½¢:</span> <span class="crate-value" id="crate-dog-gender-age"></span></p>
                <p class="crate-info-item"><span class="crate-label">ä½“é‡:</span> <span class="crate-value" id="crate-dog-weight"></span></p>
                <p class="crate-info-item"><span class="crate-label">ç‰¹å¾´/æ€§æ ¼:</span> <span class="crate-value" id="crate-dog-features"></span></p>
            </div>
            <div class="mt-4 pt-3 border-top border-white">
                <p class="crate-info-item small">ã€é£¼ã„ä¸»ã€‘</p>
                <p class="crate-info-item"><span class="crate-label">æ°å:</span> <span class="crate-value" id="crate-owner-name"></span></p>
                <p class="crate-info-item"><span class="crate-label">TEL:</span> <span class="crate-value" id="crate-owner-tel"></span></p>
            </div>
        </div>
        <div class="crate-side-right">
            <h2 class="crate-emergency-title">ç·Šæ€¥æ™‚å¯¾å¿œãƒ¡ãƒ¢ (æœ€å„ªå…ˆ)</h2>
            <p class="small fw-bold text-center">ä»¥ä¸‹ã®æŒ‡ç¤ºã«å¾“ã„ã€ãƒšãƒƒãƒˆã®å®‰å…¨ã‚’ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚</p>
            
            <p class="mt-4">ğŸš¨ <strong>æŠ•è–¬ãƒ»åŒ»ç™‚æƒ…å ±</strong></p>
            <p class="small" id="crate-medical-medication"></p>
            <p>ğŸš¨ <strong>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</strong></p>
            <p class="small" id="crate-medical-allergies"></p>
            
            <div class="mt-5">
                <p class="text-center fw-bold">ã€è¦æ‰‹æ›¸ãè¨˜å…¥æ¬„ã€‘</p>
                <div class="crate-handwrite-area">
                    <p class="mb-0"><strong>æœ€çµ‚é£Ÿäº‹ãƒ»æ’æ³„æ™‚é–“ã€æ³¨æ„äº‹é …</strong></p>
                    <p class="crate-handwrite-label">ï¼ˆé¿é›£æ‰€ç§»å‹•æ™‚ãªã©ã«ã€ã‚¯ãƒ¬ãƒ¼ãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ä½¿ç”¨ï¼‰</p>
                </div>
            </div>
        </div>
    </div>

    <div id="passport-display">
        <div class="passport-cover-back">
            <p class="passport-cover-back-text">
                ç½å®³æ™‚ æŒã¡æ­©ãç”¨<br>
                K9 Harmony Portal - ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³
            </p>
        </div>
        
        <div class="passport-main-area">
            <div>
                <h3 class="passport-section-title">å€‹ä½“è­˜åˆ¥æƒ…å ±</h3>
                <div class="passport-photo-container">
                    <img id="passport-photo" class="passport-photo" alt="çŠ¬ã®é¡”å†™çœŸ">
                </div>
                <div class="passport-info-group">
                    <p class="mb-1"><span class="passport-label">åå‰:</span> <span id="passport-dog-name"></span></p>
                    <p class="mb-1"><span class="passport-label">çŠ¬ç¨®:</span> <span id="passport-dog-type"></span></p>
                    <p class="mb-1"><span class="passport-label">æ€§åˆ¥/å¹´é½¢:</span> <span id="passport-dog-gender-age"></span></p>
                    <p class="mb-1"><span class="passport-label">ä½“é‡:</span> <span id="passport-dog-weight"></span></p>
                </div>
            </div>
            
            <div>
                <h3 class="passport-section-title">é£¼ã„ä¸» & é€£çµ¡å…ˆ</h3>
                <div class="passport-info-group">
                    <p class="mb-1"><span class="passport-label">æ°å:</span> <span id="passport-owner-name"></span></p>
                    <p class="mb-1"><span class="passport-label">TEL:</span> <span id="passport-owner-tel"></span></p>
                    <p class="mb-1"><span class="passport-label">ä½æ‰€:</span> <span id="passport-owner-address"></span></p>
                </div>
                
                <h3 class="passport-section-title mt-4">å¥åº·æƒ…å ±</h3>
                <div class="passport-info-group">
                    <p class="mb-1"><span class="passport-label">æŒç—…:</span> <span id="passport-medical-history"></span></p>
                    <p class="mb-1"><span class="passport-label">æœç”¨è–¬:</span> <span id="passport-medical-medication"></span></p>
                    <p class="mb-1"><span class="passport-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼:</span> <span id="passport-medical-allergies"></span></p>
                    <p class="mb-1"><span class="passport-label">ç—…é™¢:</span> <span id="passport-vet-contact"></span></p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDogData = null;
        let currentPrintMode = '';
        let printSelectModal;
        let pdfPreviewModal;
        
        // ====================================
        // ãƒ­ã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ====================================
        function log(message) {
            console.log(`[APP LOG] ${message}`);
            // å¿…è¦ã«å¿œã˜ã¦LIFFã®alertã‚„ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        }

        // ====================================
        // LIFFåˆæœŸåŒ–
        // ====================================
        async function initializeLiff() {
            try {
                // LIFF IDã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã™ã‚‹ã‹ã€ç›´æ¥è¨˜è¿°ã™ã‚‹
                const LIFF_ID = '2008546673-MJY7j3ox'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸLIFF IDã‚’ä½¿ç”¨
                
                log('LIFF initialization started.');
                
                await liff.init({ liffId: LIFF_ID });
                log('LIFF initialized successfully.');

                if (liff.isLoggedIn()) {
                    log('User is logged in.');
                    const profile = await liff.getProfile();
                    document.getElementById('liff-user-info').textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${profile.userId}`;
                    
                    document.getElementById('liff-status').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    
                    loadData(profile.userId);
                } else {
                    log('User is not logged in. Redirecting to login.');
                    // liff.login() ã¯ä½¿ç”¨ã›ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®æ“ä½œã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    document.getElementById('liff-message').textContent = 'LINEã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                    document.getElementById('liff-spinner').style.display = 'none';
                    document.getElementById('liff-user-info').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“';
                }

            } catch (e) {
                log(`LIFF initialization failed: ${e.message}`);
                document.getElementById('liff-message').textContent = `LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${e.message}ã€‚å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`;
                document.getElementById('liff-spinner').style.display = 'none';
            }
        }

        // ====================================
        // ãƒ‡ãƒ¼ã‚¿æ“ä½œ (ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿)
        // ====================================
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        function saveData(userId) {
            const formData = {
                dog: {
                    name: document.getElementById('dog-name').value,
                    type: document.getElementById('dog-type').value,
                    gender: document.getElementById('dog-gender').value,
                    age: document.getElementById('dog-age').value,
                    weight: document.getElementById('dog-weight').value,
                    features: document.getElementById('dog-features').value,
                },
                owner: {
                    name: document.getElementById('owner-name').value,
                    tel: document.getElementById('owner-tel').value,
                    address: document.getElementById('owner-address').value,
                },
                medical: {
                    history: document.getElementById('medical-history').value,
                    medication: document.getElementById('medical-medication').value,
                    allergies: document.getElementById('medical-allergies').value,
                    vet_contact: document.getElementById('vet-contact').value,
                },
                photos: {
                    face: document.getElementById('dog-photo-face-preview').src,
                    full: document.getElementById('dog-photo-full-preview').src,
                }
            };

            try {
                localStorage.setItem(`dog_data_${userId}`, JSON.stringify(formData));
                currentDogData = formData;
                log('Data saved successfully to LocalStorage.');
                alert('å…¥åŠ›å†…å®¹ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                renderData(formData);
            } catch (e) {
                log(`Save data failed: ${e.message}`);
                alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadData(userId) {
            try {
                const storedData = localStorage.getItem(`dog_data_${userId}`);
                if (storedData) {
                    const formData = JSON.parse(storedData);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®åæ˜ 
                    document.getElementById('dog-name').value = formData.dog.name || '';
                    document.getElementById('dog-type').value = formData.dog.type || '';
                    document.getElementById('dog-gender').value = formData.dog.gender || '';
                    document.getElementById('dog-age').value = formData.dog.age || '';
                    document.getElementById('dog-weight').value = formData.dog.weight || '';
                    document.getElementById('dog-features').value = formData.dog.features || '';
                    
                    document.getElementById('owner-name').value = formData.owner.name || '';
                    document.getElementById('owner-tel').value = formData.owner.tel || '';
                    document.getElementById('owner-address').value = formData.owner.address || '';

                    document.getElementById('medical-history').value = formData.medical.history || '';
                    document.getElementById('medical-medication').value = formData.medical.medication || '';
                    document.getElementById('medical-allergies').value = formData.medical.allergies || '';
                    document.getElementById('vet-contact').value = formData.medical.vet_contact || '';
                    
                    document.getElementById('dog-photo-face-preview').src = formData.photos.face || document.getElementById('dog-photo-face-preview').src;
                    document.getElementById('dog-photo-full-preview').src = formData.photos.full || document.getElementById('dog-photo-full-preview').src;

                    currentDogData = formData;
                    log('Data loaded successfully.');
                    renderData(formData);
                } else {
                    log('No stored data found.');
                    renderData(null);
                }
            } catch (e) {
                log(`Load data failed: ${e.message}`);
                renderData(null);
            }
        }
        
        // ====================================
        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»PDFéš ã—DOMã¸ã®ãƒ‡ãƒ¼ã‚¿æµã—è¾¼ã¿)
        // ====================================

        function renderData(data) {
            const previewContent = document.getElementById('preview-content');

            if (!data || !data.dog.name) {
                previewContent.innerHTML = '<p class="text-muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›ã‚¿ãƒ–ã§æƒ…å ±ã‚’å…¥åŠ›ãƒ»ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            // 1. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            previewContent.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <img src="${data.photos.face}" class="image-preview mb-2" alt="é¡”å†™çœŸ">
                        <p class="fw-bold mb-0">${data.dog.name}</p>
                    </div>
                    <div class="col-md-8 text-start">
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item"><strong>ç¨®åˆ¥:</strong> ${data.dog.type}</li>
                            <li class="list-group-item"><strong>æ€§åˆ¥/å¹´é½¢:</strong> ${data.dog.gender} / ${data.dog.age || 'æœªè¨˜å…¥'}æ‰</li>
                            <li class="list-group-item"><strong>ä½“é‡:</strong> ${data.dog.weight || 'æœªè¨˜å…¥'} kg</li>
                            <li class="list-group-item"><strong>ç‰¹å¾´:</strong> ${data.dog.features || 'æœªè¨˜å…¥'}</li>
                        </ul>
                    </div>
                </div>
                <hr>
                <h5 class="card-title mt-3">é£¼ã„ä¸»æƒ…å ±</h5>
                <ul class="list-group list-group-flush small text-start">
                    <li class="list-group-item"><strong>æ°å:</strong> ${data.owner.name}</li>
                    <li class="list-group-item"><strong>TEL:</strong> ${data.owner.tel}</li>
                    <li class="list-group-item"><strong>ä½æ‰€:</strong> ${data.owner.address}</li>
                </ul>
                <h5 class="card-title mt-3">åŒ»ç™‚æƒ…å ±</h5>
                <ul class="list-group list-group-flush small text-start">
                    <li class="list-group-item"><strong>æŒç—…:</strong> ${data.medical.history || 'ãªã—'}</li>
                    <li class="list-group-item"><strong>æœè–¬:</strong> ${data.medical.medication || 'ãªã—'}</li>
                    <li class="list-group-item"><strong>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼:</strong> ${data.medical.allergies || 'ãªã—'}</li>
                    <li class="list-group-item"><strong>ç—…é™¢:</strong> ${data.medical.vet_contact || 'æœªè¨˜å…¥'}</li>
                </ul>
            `;
            
            // 2. éš ã—DOM (PDFå‡ºåŠ›ç”¨) ã¸ã®ãƒ‡ãƒ¼ã‚¿æµã—è¾¼ã¿
            
            // 2-1. è¿·å­ãƒã‚¹ã‚¿ãƒ¼ (#poster-display)
            document.getElementById('poster-photo').src = data.photos.face;
            document.getElementById('poster-dog-name').textContent = data.dog.name;
            document.getElementById('poster-dog-type-features').textContent = `${data.dog.type} (${data.dog.features || 'ç‰¹å¾´æœªè¨˜å…¥'})`;
            document.getElementById('poster-dog-gender-weight').textContent = `${data.dog.gender} / ${data.dog.weight || 'æœªè¨˜å…¥'}kg`;
            document.getElementById('poster-owner-address').textContent = data.owner.address;
            document.getElementById('poster-owner-tel').textContent = data.owner.tel;
            document.getElementById('poster-owner-name').textContent = data.owner.name;

            // 2-2. ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚° (#crate-tag-display)
            document.getElementById('crate-photo').src = data.photos.face;
            document.getElementById('crate-dog-name').textContent = data.dog.name.toUpperCase();
            document.getElementById('crate-dog-type').textContent = data.dog.type;
            document.getElementById('crate-dog-gender-age').textContent = `${data.dog.gender} / ${data.dog.age || 'æœªè¨˜å…¥'}æ‰`;
            document.getElementById('crate-dog-weight').textContent = `${data.dog.weight || 'æœªè¨˜å…¥'} kg`;
            document.getElementById('crate-dog-features').textContent = data.dog.features || 'ç‰¹ã«ãªã—';
            document.getElementById('crate-owner-name').textContent = data.owner.name;
            document.getElementById('crate-owner-tel').textContent = data.owner.tel;
            document.getElementById('crate-medical-medication').textContent = data.medical.medication || 'ãªã—';
            document.getElementById('crate-medical-allergies').textContent = data.medical.allergies || 'ãªã—';
            
            // 2-3. æŒã¡æ­©ãç”¨æ‰‹å¸³ (#passport-display)
            document.getElementById('passport-photo').src = data.photos.face;
            document.getElementById('passport-dog-name').textContent = data.dog.name;
            document.getElementById('passport-dog-type').textContent = data.dog.type;
            document.getElementById('passport-dog-gender-age').textContent = `${data.dog.gender} / ${data.dog.age || 'æœªè¨˜å…¥'}æ‰`;
            document.getElementById('passport-dog-weight').textContent = `${data.dog.weight || 'æœªè¨˜å…¥'} kg`;
            document.getElementById('passport-owner-name').textContent = data.owner.name;
            document.getElementById('passport-owner-tel').textContent = data.owner.tel;
            document.getElementById('passport-owner-address').textContent = data.owner.address;
            document.getElementById('passport-medical-history').textContent = data.medical.history || 'ãªã—';
            document.getElementById('passport-medical-medication').textContent = data.medical.medication || 'ãªã—';
            document.getElementById('passport-medical-allergies').textContent = data.medical.allergies || 'ãªã—';
            document.getElementById('passport-vet-contact').textContent = data.medical.vet_contact || 'æœªè¨˜å…¥';

            // 2-4. é€šå¸¸ã®é˜²ç½æ‰‹å¸³ (#main-display) 
            // ä»Šå›ã®ã‚¿ã‚¹ã‚¯ç¯„å›²å¤–ã§ã™ãŒã€å…¨ã¦ã®DOMã«ãƒ‡ãƒ¼ã‚¿ã‚’æµã—è¾¼ã‚€ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½è¨˜ã—ã¾ã™
            // ... (æ—¢å­˜ã®é˜²ç½æ‰‹å¸³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ãŒã“ã“ã«å…¥ã‚‹æƒ³å®š)
        }

        // ====================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        // ====================================
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
        document.getElementById('dog-data-form').addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const form = event.target;
            if (form.checkValidity()) {
                if (liff.isLoggedIn()) {
                    // å†™çœŸã®DataURLå¤‰æ›ã‚’å¾…ã£ã¦ã‹ã‚‰ä¿å­˜
                    convertPhotosToDataURL().then(() => {
                        saveData(liff.getProfileSync().userId);
                    }).catch(e => {
                        log(`Photo conversion failed: ${e.message}`);
                        alert('å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    });
                } else {
                    alert('LIFFãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                }
            }
            form.classList.add('was-validated');
        }, false);
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›å¤‰æ›´æ™‚ã®å‡¦ç† (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã¨DataURLå¤‰æ›)
        document.getElementById('dog-photo-face').addEventListener('change', function(event) {
            handlePhotoChange(event.target, 'dog-photo-face-preview');
        });
        document.getElementById('dog-photo-full').addEventListener('change', function(event) {
            handlePhotoChange(event.target, 'dog-photo-full-preview');
        });
        
        function handlePhotoChange(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(previewId).src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // DataURLã«å¤‰æ›ã•ã‚Œã¦ã„ãªã„å†™çœŸãŒã‚ã‚Œã°å¤‰æ›ã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®srcã«ã‚»ãƒƒãƒˆã™ã‚‹ (ä¿å­˜å‰ã«å®Ÿè¡Œ)
        async function convertPhotosToDataURL() {
            const faceInput = document.getElementById('dog-photo-face');
            const fullInput = document.getElementById('dog-photo-full');

            // é¡”å†™çœŸã®å‡¦ç†
            if (faceInput.files && faceInput.files[0] && faceInput.files[0].size > 0) {
                document.getElementById('dog-photo-face-preview').src = await fileToDataUrl(faceInput.files[0]);
            }

            // å…¨èº«å†™çœŸã®å‡¦ç† (ä»»æ„)
            if (fullInput.files && fullInput.files[0] && fullInput.files[0].size > 0) {
                document.getElementById('dog-photo-full-preview').src = await fileToDataUrl(fullInput.files[0]);
            }
        }

        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // PDFå‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showPrintModal(mode) {
            if (!currentDogData || !currentDogData.dog.name) {
                alert('å…ˆã«æƒ…å ±ã‚’å…¥åŠ›ãƒ»ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            currentPrintMode = mode;
            let message = '';
            
            switch (mode) {
                case 'handbook':
                    message = 'A4æ¨ªå‘ãã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã§ä¸¡é¢å°åˆ·ã—ã€å››ã¤æŠ˜ã‚Šã«ã™ã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªæ‰‹å¸³ã«ãªã‚Šã¾ã™ã€‚';
                    break;
                case 'poster':
                    message = 'A4ç¸¦å‘ãã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚è¿·å­ç™ºç”Ÿæ™‚ã«å°åˆ·ã—ã¦æ²ç¤ºã—ã¦ãã ã•ã„ã€‚';
                    break;
                case 'crate':
                    message = 'A4æ¨ªå‘ãã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ã‚¯ãƒ¬ãƒ¼ãƒˆã®ç›®ç«‹ã¤å ´æ‰€ã«è²¼ã‚Šä»˜ã‘ã¦ã”ä½¿ç”¨ãã ã•ã„ã€‚';
                    break;
                case 'passport':
                    message = 'A4ç¸¦å‘ãã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚å°åˆ·å¾Œã€ç‚¹ç·šã«æ²¿ã£ã¦æŠ˜ã‚ŠãŸãŸã¿ã€æŒã¡æ­©ãç”¨æ‰‹å¸³ã¨ã—ã¦ã”ä½¿ç”¨ãã ã•ã„ã€‚';
                    break;
            }
            
            document.getElementById('print-modal-message').textContent = message;
            printSelectModal.show();
        }

        // ====================================
        // PDFç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (TASK-3å®Ÿè£…)
        // ====================================

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @description PDFç”Ÿæˆã‚’å®Ÿè¡Œã™ã‚‹ (TASK-3å®Ÿè£…)
Â  Â  Â  Â  Â * @param {string} mode - å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ ('handbook', 'crate', 'poster', 'passport')
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function generatePDF(mode) {
Â  Â  Â  Â  Â  Â  log(`Starting PDF generation for mode: ${mode}`);
Â Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  log('FATAL ERROR: jsPDF/html2canvas not loaded. Aborting.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  printSelectModal.hide();
Â  Â  Â  Â  Â  Â  // PDFç”Ÿæˆä¸­ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å³åº§ã«è¡¨ç¤º
Â  Â  Â  Â  Â  Â  document.getElementById('pdf-preview-area').innerHTML = `<p class="fw-bold mt-5 text-dark"><i class="fa-solid fa-spinner fa-spin me-2"></i> ${mode.toUpperCase()}ã®PDFã‚’ç”Ÿæˆä¸­...</p>`;
Â  Â  Â  Â  Â  Â  pdfPreviewModal.show();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¦ç´ ã¨PDFè¨­å®šã‚’å®šç¾©
Â  Â  Â  Â  Â  Â  const targetConfig = {
Â  Â  Â  Â  Â  Â  Â  Â  handbook: { id: 'main-display', layout: 'l', filename: 'K9_é˜²ç½æ‰‹å¸³_å››ã¤æŠ˜ã‚Š', margin: 0 },
Â  Â  Â  Â  Â  Â  Â  Â  crate: { id: 'crate-tag-display', layout: 'l', filename: 'K9_ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°', margin: 0 },
Â  Â  Â  Â  Â  Â  Â  Â  poster: { id: 'poster-display', layout: 'p', filename: 'K9_è¿·å­ãƒã‚¹ã‚¿ãƒ¼', margin: 0 },
Â  Â  Â  Â  Â  Â  Â  Â  passport: { id: 'passport-display', layout: 'p', filename: 'K9_æŒã¡æ­©ãæ‰‹å¸³', margin: 0 }
Â  Â  Â  Â  Â  Â  }[mode];

Â  Â  Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  Â  Â  const targetElement = document.getElementById(targetConfig.id);
Â  Â  Â  Â  Â  Â  // NOTE: currentDogDataãŒnullã®å ´åˆãŒã‚ã‚‹ãŸã‚ã€å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
Â  Â  Â  Â  Â  Â  const dogName = (currentDogData && currentDogData.dog) ? currentDogData.dog.name : 'Unknown';
Â  Â  Â  Â  Â  Â  const fileName = `${targetConfig.filename}_${dogName}_${new Date().toISOString().substring(0, 10)}.pdf`;

Â  Â  Â  Â  Â  Â  if (!targetElement) { log(`ERROR: Target element #${targetConfig.id} not found.`); return; }

Â  Â  Â  Â  Â  Â  // çŠ¶æ…‹ä¿å­˜ (ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«å¿…é ˆ)
Â  Â  Â  Â  Â  Â  const originalDisplay = targetElement.style.display;
Â  Â  Â  Â  Â  Â  const originalPosition = targetElement.style.position;
Â  Â  Â  Â  Â  Â  const originalTop = targetElement.style.top;
Â  Â  Â  Â  Â  Â  const originalBodyClass = document.body.className;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  log('Applying print classes for capture.');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 1. å°åˆ·ç”¨ã®CSSã‚¯ãƒ©ã‚¹ã‚’ãƒœãƒ‡ã‚£ã«é©ç”¨
Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.add(`print-mode-${mode}`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¦ç´ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£å¯èƒ½çŠ¶æ…‹ã¸
Â  Â  Â  Â  Â  Â  Â  Â  targetElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  targetElement.style.position = 'absolute';
Â  Â  Â  Â  Â  Â  Â  Â  targetElement.style.top = '-9999px'; // ç”»é¢å¤–ã«é…ç½®
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 3. html2canvasã§ã‚­ãƒ£ãƒ—ãƒãƒ£
Â  Â  Â  Â  Â  Â  Â  Â  const canvas = await html2canvas(targetElement, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scale: 3,Â // é«˜è§£åƒåº¦ã‚­ãƒ£ãƒ—ãƒãƒ£
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  useCORS: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowTaint: true
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  log('HTML captured to Canvas.');

Â  Â  Â  Â  Â  Â  Â  Â  // 4. jsPDFã§PDFåŒ–
Â  Â  Â  Â  Â  Â  Â  Â  const imgData = canvas.toDataURL('image/jpeg', 1.0);
Â  Â  Â  Â  Â  Â  Â  Â  const isLandscape = targetConfig.layout === 'l';
Â  Â  Â  Â  Â  Â  Â  Â  const doc = new jsPDF(targetConfig.layout, 'mm', 'a4');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const docWidth = isLandscape ? 297 : 210;
Â  Â  Â  Â  Â  Â  Â  Â  const imgHeight = canvas.height * docWidth / canvas.width;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  doc.addImage(imgData, 'JPEG', 0, 0, docWidth, imgHeight);

Â  Â  Â  Â  Â  Â  Â  Â  // PDFã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
Â  Â  Â  Â  Â  Â  Â  Â  doc.save(fileName);
Â  Â  Â  Â  Â  Â  Â  Â  log(`PDF generated and saved as: ${fileName}`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // ç”»é¢ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('pdf-preview-area').innerHTML = `<p class="fw-bold mt-4 text-dark">PDFãŒ<span class="text-success">ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€</span>ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚</p><p class="small text-muted">ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileName}</p>`;

Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  log(`PDF Generation FATAL ERROR: ${e.message} (Stack: ${e.stack})`);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('pdf-preview-area').innerHTML = `<p class="fw-bold mt-4 text-danger">PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p><p class="small text-muted">ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  // 5. â˜…â˜…â˜… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (æœ€é‡è¦) â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â  Â  Â  log('Cleaning up print classes and restoring display state.');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // CSSã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã€å…ƒã®ã‚¯ãƒ©ã‚¹ã«æˆ»ã™
Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.remove(`print-mode-${mode}`);
Â  Â  Â  Â  Â  Â  Â  Â  document.body.className = originalBodyClass;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // è¦ç´ ã®ä½ç½®ã¨è¡¨ç¤ºå±æ€§ã‚’å…ƒã«æˆ»ã™
Â  Â  Â  Â  Â  Â  Â  Â  targetElement.style.display = originalDisplay;
Â  Â  Â  Â  Â  Â  Â  Â  targetElement.style.position = originalPosition;
Â  Â  Â  Â  Â  Â  Â  Â  targetElement.style.top = originalTop;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // ====================================
        // åˆæœŸå‡¦ç†
        // ====================================

        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
            // Bootstrapãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
            const printSelectModalEl = document.getElementById('printSelectModal');
            printSelectModal = new bootstrap.Modal(printSelectModalEl);
            const pdfPreviewModalEl = document.getElementById('pdfPreviewModal');
            pdfPreviewModal = new bootstrap.Modal(pdfPreviewModalEl);

            // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹ã«ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ  (é–‹ç™ºç”¨)
            // document.getElementById('dog-data-form').setAttribute('novalidate', '');
        });
    </script>
</body>
</html>
