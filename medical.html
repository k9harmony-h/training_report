/**
 * ============================================================================
 * K9 Harmony - Disaster Module
 * ============================================================================
 * @file    disaster.gs
 * @version v2025.12.11-PROBLEM-FIX
 */

const DISASTER_CONFIG = {
  SLIDES: {
    HANDBOOK:       '13B4BsuXuzUE1AZadWILQP_OHHaVAYoBYvEnuxkIX1PQ',
    CRATE_TAG:      '1MSlvMgULTg-HfCp3uFtcPoe_eqlbX5uFzF4OSfqTtVw',
    MISSING_POSTER: '1cA-JDa2cbxC5pko5Nsbtt6W17cRfdBG6PkRMaXYsGXE'
  },
  OUTPUT_FOLDER_ID: '', 
  COLS: {
    // 基本情報
    DOG_NAME: 'dog_name', 
    DOG_GENDER: 'dog_gender', 
    BREED: 'breed', 
    COAT_COLOR: 'coat_color',
    DOG_BIRTH_DATE: 'dog_birth_date', 
    NEUTERED: 'neutered', 
    DOG_PHOTO: 'dog_photo',
    
    // 医療・詳細
    VET_NAME: 'vet_name', 
    VET_PHONE: 'vet_phone', 
    DOG_ALLERGY: 'dog_allergy',
    DOG_MEDICAL_HISTORY: 'dog_medical_history', 
    DOG_MEDICINE: 'dog_medicine', 
    DOG_FOOD: 'dog_food',
    DOG_CAUTION: 'dog_caution', 
    DOG_MICROCHIP: 'dog_microchip', 
    DOG_LICENSE_NO: 'dog_license_no',
    WEIGHT: 'weight', 
    
    // ★修正: 現在のDBカラム名 'problem' に設定
    // (将来 'dog_problem' に変更した場合はここを書き換えてください)
    DOG_PROBLEM: 'problem', 
    
    UPDATED_AT: 'updated_at',
    
    // 顧客情報
    CUSTOMER_NAME: 'customer_name', 
    CUSTOMER_PHONE: 'customer_phone',
    EM_CONTACT_NAME: 'em_contact_name', 
    EM_CONTACT_PHONE: 'em_contact_phone',
    EM_PROXY_NAME: 'em_proxy_name', 
    EM_PROXY_PHONE: 'em_proxy_phone', 
    EVACUATION_SITE: 'evacuation_site'
  }
};

const SHEET_NAME_DOG_D = '犬情報';
const SHEET_NAME_CUST_D = '顧客情報';

/**
 * [API Entry] Webアプリから呼ばれる関数
 */
function generatePdfForApi(lineUserId, dogId, docType) {
  console.log(`[Start] Generate PDF: ${docType} for User: ${lineUserId}, Dog: ${dogId}`); 

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  if (typeof getColumnMap !== 'function') throw new Error('utils.gs not loaded');

  const mergedData = getMergedDataByDogId_(ss, dogId);
  if (!mergedData) {
    console.error('[Error] Dog data not found.'); 
    return { error: 'Dog data not found or ID mismatch.' };
  }

  let templateId = '', suffix = '';
  if (docType === 'handbook') { templateId = DISASTER_CONFIG.SLIDES.HANDBOOK; suffix = 'ハンドブック'; }
  else if (docType === 'crate') { templateId = DISASTER_CONFIG.SLIDES.CRATE_TAG; suffix = 'クレートタグ'; }
  else if (docType === 'poster') { templateId = DISASTER_CONFIG.SLIDES.MISSING_POSTER; suffix = '迷子チラシ'; }
  else return { error: 'Invalid document type.' };

  let folder = DriveApp.getRootFolder();
  if (DISASTER_CONFIG.OUTPUT_FOLDER_ID) { try { folder = DriveApp.getFolderById(DISASTER_CONFIG.OUTPUT_FOLDER_ID); } catch(e){} }

  try {
    // ファイル名からは敬称を除去
    const cleanName = mergedData.dogNameDisplay.replace(/くん|ちゃん$/, '');
    const fileName = `${suffix}_${cleanName}`;
    const pdfFile = createPDF_(templateId, mergedData, folder, fileName);
    try { pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); } catch(e){}
    
    const dlUrl = `https://drive.google.com/uc?export=download&id=${pdfFile.getId()}`;

    console.log(`[Success] PDF Created: ${dlUrl}`); 
    return { success: true, url: pdfFile.getUrl(), downloadUrl: dlUrl, name: fileName };
  } catch (e) {
    console.error(`[Error] PDF Generation Failed: ${e.message}`); 
    return { error: 'PDF Generation Failed: ' + e.message };
  }
}

function getMergedDataByDogId_(ss, dogId) {
  const shDog = ss.getSheetByName(SHEET_NAME_DOG_D);
  const data = shDog.getDataRange().getValues();
  const dMap = getColumnMap(shDog);

  let targetRowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(getVal(data[i], dMap, 'dog_unique_key')) === String(dogId)) {
      targetRowIndex = i + 1; 
      break;
    }
  }
  if (targetRowIndex === -1) return null;
  return getMergedData_(ss, targetRowIndex);
}

function getMergedData_(ss, dogRowIndex) {
  const shDog = ss.getSheetByName(SHEET_NAME_DOG_D);
  const shCust = ss.getSheetByName(SHEET_NAME_CUST_D);
  const dMap = getColumnMap(shDog); 
  const cMap = getColumnMap(shCust); 
  
  const dogValues = shDog.getRange(dogRowIndex, 1, 1, shDog.getLastColumn()).getValues()[0];
  const custKey = getVal(dogValues, dMap, 'customer_unique_key');
  if (!custKey) return null;

  const custDataAll = shCust.getDataRange().getValues();
  let custValues = null;
  for (let i = 1; i < custDataAll.length; i++) {
    if (String(getVal(custDataAll[i], cMap, 'customer_unique_key')) === String(custKey)) { custValues = custDataAll[i]; break; }
  }
  if (!custValues) return null;

  const rawName = getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_NAME);
  const gender  = getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_GENDER);
  
  // ★敬称ロジック
  // 'Male', 'オス', '♂' のいずれかなら「くん」、それ以外は「ちゃん」
  const suffix = (['Male', 'オス', '♂'].includes(gender)) ? 'くん' : 'ちゃん';
  
  const bDate = getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_BIRTH_DATE);
  let age = '';
  if (bDate instanceof Date) {
    const today = new Date();
    let y = today.getFullYear() - bDate.getFullYear();
    const m = today.getMonth() - bDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < bDate.getDate())) y--;
    age = `${y}歳`;
  }

  const allergyDetail = getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_ALLERGY);
  const allergyYN = (allergyDetail && String(allergyDetail).trim() !== '') ? '有' : '無';
  
  const photoVal = getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_PHOTO);
  
  return {
    dogNameDisplay: rawName ? `${rawName}${suffix}` : '',
    breed:      getVal(dogValues, dMap, DISASTER_CONFIG.COLS.BREED),
    gender:     gender, birthDate: bDate, age: age,
    coatColor:  getVal(dogValues, dMap, DISASTER_CONFIG.COLS.COAT_COLOR),
    neutered:   getVal(dogValues, dMap, DISASTER_CONFIG.COLS.NEUTERED),
    dogPhotoSource: photoVal, 
    vetName:        getVal(dogValues, dMap, DISASTER_CONFIG.COLS.VET_NAME),
    vetPhone:       getVal(dogValues, dMap, DISASTER_CONFIG.COLS.VET_PHONE),
    allergy:        allergyDetail, allergyYN: allergyYN,
    medicalHistory: getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_MEDICAL_HISTORY),
    medicine:       getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_MEDICINE),
    food:           getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_FOOD),
    caution:        getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_CAUTION),
    microchip:      getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_MICROCHIP),
    licenseNo:      getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_LICENSE_NO),
    weight:         getVal(dogValues, dMap, DISASTER_CONFIG.COLS.WEIGHT),
    // ★追加: problemの取得
    problem:        getVal(dogValues, dMap, DISASTER_CONFIG.COLS.DOG_PROBLEM),
    
    customerName:   getVal(custValues, cMap, DISASTER_CONFIG.COLS.CUSTOMER_NAME),
    customerPhone:  getVal(custValues, cMap, DISASTER_CONFIG.COLS.CUSTOMER_PHONE),
    emContactName:  getVal(custValues, cMap, DISASTER_CONFIG.COLS.EM_CONTACT_NAME),
    emContactPhone: getVal(custValues, cMap, DISASTER_CONFIG.COLS.EM_CONTACT_PHONE),
    emProxyName:    getVal(custValues, cMap, DISASTER_CONFIG.COLS.EM_PROXY_NAME),
    emProxyPhone:   getVal(custValues, cMap, DISASTER_CONFIG.COLS.EM_PROXY_PHONE),
    evacuationSite: getVal(custValues, cMap, DISASTER_CONFIG.COLS.EVACUATION_SITE),
    updateDate:     new Date()
  };
}

function createPDF_(templateId, data, folder, fileName) {
  const templateFile = DriveApp.getFileById(templateId);
  const tempFile = templateFile.makeCopy(`TEMP_${fileName}`, folder);
  const slideApp = SlidesApp.openById(tempFile.getId());
  const slides = slideApp.getSlides();

  slides.forEach((slide, index) => {
    replaceText_(slide, data);
    console.log(`[Debug] Processing Slide ${index + 1} for Image Replacement`);
    replaceImage_(slide, '{dog_photo}', data.dogPhotoSource);
  });

  slideApp.saveAndClose();
  const pdfBlob = tempFile.getAs(MimeType.PDF);
  const pdfFile = folder.createFile(pdfBlob).setName(fileName + '.pdf');
  tempFile.setTrashed(true);
  return pdfFile;
}

function replaceText_(slide, data) {
  slide.replaceAllText('{dog_name}',       data.dogNameDisplay);
  slide.replaceAllText('{breed}',          valOrNone(data.breed));
  slide.replaceAllText('{dog_gender}',     valOrNone(data.gender));
  slide.replaceAllText('{dog_birth_date}', formatDateSafe(data.birthDate, 'yyyy/MM/dd'));
  slide.replaceAllText('{age}',            valOrNone(data.age));
  slide.replaceAllText('{coat_color}',     valOrNone(data.coatColor));
  slide.replaceAllText('{neutered}',       valOrNone(data.neutered));
  slide.replaceAllText('{vet_name}',            valOrNone(data.vetName));
  slide.replaceAllText('{vet_phone}',           valOrNone(data.vetPhone));
  slide.replaceAllText('{dog_medical_history}', valOrNone(data.medicalHistory));
  slide.replaceAllText('{dog_medicine}',        valOrNone(data.medicine));
  slide.replaceAllText('{dog_food}',            valOrNone(data.food));
  slide.replaceAllText('{dog_allergy}',         valOrNone(data.allergy));
  slide.replaceAllText('{allergyYN}',           data.allergyYN);
  slide.replaceAllText('{dog_caution}',         valOrNone(data.caution));
  slide.replaceAllText('{dog_microchip}',       valOrNone(data.microchip));
  slide.replaceAllText('{dog_license_no}',      data.licenseNo || '');
  slide.replaceAllText('{weight}',              data.weight || '');
  
  // ★出力: problem
  slide.replaceAllText('{problem}',             data.problem || '');

  slide.replaceAllText('{customer_name}',    valOrNone(data.customerName));
  slide.replaceAllText('{customer_phone}',   valOrNone(data.customerPhone));
  slide.replaceAllText('{em_contact_name}',  valOrNone(data.emContactName));
  slide.replaceAllText('{em_contact_phone}', valOrNone(data.emContactPhone));
  slide.replaceAllText('{em_proxy_name}',    valOrNone(data.emProxyName));
  slide.replaceAllText('{em_proxy_phone}',   valOrNone(data.emProxyPhone));
  slide.replaceAllText('{evacuation_site}',  valOrNone(data.evacuationSite));
  slide.replaceAllText('{updateDate}', formatDateSafe(data.updateDate, 'yyyy/MM/dd'));
}

/**
 * 画像置換ロジック (代替テキスト優先)
 */
function replaceImage_(slide, tag, source) {
  if (!source) {
    console.log('[Debug] No Image Source provided. Skipping replace.'); 
    return;
  }

  // 1. 画像Blobの取得
  let imageBlob = null;
  let fileId = '';
  
  try {
    const matchId = String(source).match(/id=([-\w]{25,})/);
    const matchPath = String(source).match(/\/d\/([-\w]{25,})/);
    const simpleMatch = String(source).match(/^[-\w]{25,}$/); 

    if (matchId) fileId = matchId[1];
    else if (matchPath) fileId = matchPath[1];
    else if (simpleMatch) fileId = simpleMatch[0];

    if (fileId) {
       console.log(`[Debug] Found ID: ${fileId}`);
       imageBlob = DriveApp.getFileById(fileId).getBlob();
    }
  } catch(e) { console.log(`[Debug] ID lookup failed: ${e.message}`); }

  // IDで失敗したらファイル名検索
  if (!imageBlob) {
    const parts = String(source).split('/');
    const fileName = parts[parts.length - 1];
    console.log(`[Debug] Searching by name: "${fileName}"`);
    try {
      const files = DriveApp.getFilesByName(fileName);
      if (files.hasNext()) imageBlob = files.next().getBlob();
    } catch(e) { console.warn(`[Warn] Name search error: ${e.message}`); }
  }

  if (!imageBlob) {
    console.warn('[Warn] Image Blob could not be retrieved.');
    return;
  }

  // 2. 図形を検索 (代替テキスト優先)
  const shapes = slide.getShapes();
  const target = findShapeRecursive_(shapes, tag);

  // 3. 置換実行
  if (target) {
    try {
      target.replaceWithImage(imageBlob, true); 
      console.log(`[Debug] Image Replaced. Tag: "${tag}"`); 
    } catch (e) { 
      console.error(`[Error] Image replace failed: ${e.message}`); 
    }
  } else {
    console.warn(`[Warn] Shape with tag "${tag}" NOT FOUND.`); 
  }
}

/**
 * ヘルパー: 図形検索
 */
function findShapeRecursive_(shapes, tag) {
  for (const s of shapes) {
    if (s.getShapeType() === SlidesApp.ShapeType.GROUP) {
      const found = findShapeRecursive_(s.getGroup().getChildren(), tag);
      if (found) return found;
    }
    
    const check = (val) => val && String(val).trim() === tag;

    // ★優先1: 代替テキスト
    if (check(s.getDescription())) return s;

    // ★優先2: タイトル
    if (check(s.getTitle())) return s;

    // ★優先3: テキスト本文
    try {
      if (s.getText && check(s.getText().asString())) return s;
    } catch(e) {}
  }
  return null;
}

/**
 * デバッグ用
 */
function debugPdfHandBook() {
  const TEST_USER_ID = 'U1d95daf0e8dfe55a2d5f22442fcddf2f'; 
  const TEST_DOG_ID  = 'da12c3a5';                        

  console.log('--- Debug Start ---');
  const result = generatePdfForApi(TEST_USER_ID, TEST_DOG_ID, 'handbook');
  console.log('--- Result ---');
  console.log(JSON.stringify(result, null, 2));
}
