<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>うちの子医療・防災手帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-color: #88b08b; /* Sage Green */
            --accent-color: #e8f5e9;
            --alert-color: #e07a5f; /* Terracotta Orange */
            --mask-color: #f0f0f0;
        }

        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f9fbf9; color: #333; padding-bottom: 300px; /* デバッグログ用の余白 */ }

        /* --- ログスタンプ (Version Stamp) --- */
        .version-stamp {
            position: fixed; top: 0; right: 0; 
            background: var(--alert-color); color: white; 
            font-size: 10px; padding: 2px 6px; 
            z-index: 9999; font-family: monospace; opacity: 0.9;
            border-bottom-left-radius: 4px;
        }

        /* --- デバッグコンソール (Console Log) --- */
        #debug-console-container { display: block; margin-top: 30px; padding: 0 10px; }
        #debug-console {
            background-color: #111; color: #0f0; 
            font-family: monospace; font-size: 11px; 
            padding: 15px; border-radius: 8px; 
            white-space: pre-wrap; word-break: break-all; 
            border: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* --- 共通スタイル --- */
        .card-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #eee; margin-bottom: 20px; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; margin-bottom: 15px; }
        .info-label { font-weight: bold; color: #666; font-size: 0.8rem; display: block; }
        .info-value { font-size: 1rem; font-weight: 500; min-height: 24px; word-break: break-word; }
        .loading { text-align: center; padding: 50px 20px; color: #666; }

        /* 写真エリア */
        #d_photo_container {
            width: 160px; height: 160px; 
            background-color: #fff; border-radius: 12px; 
            border: 4px solid var(--accent-color); 
            overflow: hidden; display: flex; align-items: center; justify-content: center; 
            margin: 0 auto 15px auto; object-fit: cover;
        }
        .dog-profile-img { width: 100%; height: 100%; object-fit: cover; }

        /* UIパーツ */
        .btn-help { border: none; background: none; color: #999; font-size: 1.3rem; }
        .btn-print { background-color: var(--primary-color); color: white; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; border: none; margin-bottom: 10px; }
        
        /* マスク機能 */
        .masked-text { letter-spacing: 2px; background: #eee; color: #aaa; padding: 2px 5px; border-radius: 4px; }
        .real-text { display: none; font-weight: bold; }
        .btn-toggle-mask { font-size: 0.7rem; padding: 2px 8px; border: 1px solid var(--alert-color); color: var(--alert-color); background: white; border-radius: 10px; margin-left: 5px; }

        /* --- 迷子ポスター (TASK-1 Main) --- */
        /* 通常時は非表示、印刷/生成時のみ使用 */
        #poster-display { display: none; }
        
        .poster-container {
            width: 210mm; min-height: 297mm; /* A4サイズ */
            background-color: #fffaf0;
            padding: 15mm;
            text-align: center;
            border: 8px solid #dc3545; /* 赤枠 */
            box-sizing: border-box;
            margin: 0 auto;
        }
        .poster-header {
            color: #dc3545;
            font-size: 48pt;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 10mm;
            text-shadow: 2px 2px 0px #fff;
        }
        .poster-time {
            font-size: 16pt;
            font-weight: bold;
            color: #333;
            background: #fff;
            padding: 5px 20px;
            display: inline-block;
            border-radius: 50px;
            margin-bottom: 10mm;
            border: 2px solid #333;
        }
        .poster-photo {
            width: 80%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border: 6px solid #333;
            border-radius: 10px;
            margin-bottom: 10mm;
            background-color: #ddd;
        }
        .poster-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14pt;
            margin-bottom: 10mm;
            text-align: left;
        }
        .poster-table th {
            width: 30%;
            padding: 8px;
            border-bottom: 2px solid #dc3545;
            color: #dc3545;
            font-weight: bold;
        }
        .poster-table td {
            padding: 8px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
        }
        .poster-message {
            font-size: 12pt;
            text-align: left;
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
            margin-bottom: 10mm;
        }
        .poster-contact {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 15px;
            font-size: 18pt;
            font-weight: bold;
        }
        .poster-contact span {
            display: block;
            font-size: 24pt;
            margin-top: 5px;
        }

        /* 印刷時設定 */
        @media print {
            .no-print-area, #debug-console-container, .version-stamp { display: none !important; }
            /* モードによって表示を切り替え */
            body.mode-poster #main-display { display: none; }
            body.mode-poster #poster-display { display: block; }
            
            body.mode-handbook #poster-display { display: none; }
            body.mode-handbook #main-display { display: block; }
        }
    </style>
</head>
<body class="mode-handbook">

    <div class="version-stamp">v2025.12.02-TASK-1</div>

    <div class="container py-3">
        <div class="no-print-area">
            <div class="d-flex align-items-center justify-content-center mb-3">
                <h4 class="fw-bold m-0" style="color: var(--primary-color);">⛑️ うちの子医療・防災手帳</h4>
                <button class="btn-help ms-2" onclick="alert('災害時の身分証となる手帳です。印刷して携帯してください。')">
                    <i class="fa-solid fa-circle-question"></i>
                </button>
            </div>

            <div id="loading" class="loading">
                <div class="spinner-border text-success" role="status"></div>
                <p class="mt-3">データを読み込んでいます...</p>
            </div>

            <div id="controls" style="display:none; max-width: 500px; margin: 0 auto;">
                <button onclick="switchMode('poster')" class="btn btn-print" style="background-color: #dc3545;">
                    <i class="fa-solid fa-bullhorn"></i> 迷子ポスターを表示 (TASK-1)
                </button>
                <button onclick="window.print()" class="btn btn-print">
                    <i class="fa-solid fa-print"></i> このページを印刷
                </button>
                <button onclick="location.href='index.html'" class="btn btn-secondary w-100 rounded-pill mt-2">戻る</button>
            </div>
        </div>

        <div id="main-display" style="display:none;">
            <div class="card-section">
                <div class="section-title">基本情報 / Owner Info</div>
                <div class="text-center mb-3">
                    <div id="d_photo_container">
                        <span class="small text-muted">No Photo</span>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6"><span class="info-label">お名前</span><div id="d_name" class="info-value">-</div></div>
                    <div class="col-6"><span class="info-label">犬種</span><div id="d_breed" class="info-value">-</div></div>
                </div>
                <div class="row mb-3">
                    <div class="col-4"><span class="info-label">性別</span><div id="d_gender" class="info-value">-</div></div>
                    <div class="col-4"><span class="info-label">誕生日</span><div id="d_birth" class="info-value">-</div></div>
                    <div class="col-4"><span class="info-label">年齢</span><div id="d_age" class="info-value">-</div></div>
                </div>
                <hr>
                <div class="mb-2">
                    <span class="info-label">飼い主様</span><div id="c_name" class="info-value">-</div>
                </div>
                <div class="mb-2">
                    <span class="info-label">電話番号</span>
                    <div class="d-flex align-items-center">
                        <span id="c_phone_mask" class="masked-text">***-****-****</span>
                        <span id="c_phone_real" class="real-text">-</span>
                        <button class="btn-toggle-mask" onclick="toggleMask('c_phone')">表示</button>
                    </div>
                </div>
            </div>
            
            <div class="card-section">
                <div class="section-title">医療情報 / Medical</div>
                <div class="mb-2"><span class="info-label">かかりつけ医</span><div id="d_vet" class="info-value">-</div></div>
                <div class="mb-2"><span class="info-label">アレルギー</span><div id="d_allergy" class="info-value text-danger fw-bold">-</div></div>
                <div class="mb-2"><span class="info-label">常備薬</span><div id="d_medicine" class="info-value">-</div></div>
            </div>
        </div>

        <div id="poster-display">
            <div class="poster-container">
                <div class="poster-header">うちの子<br>探してます！</div>
                
                <div class="poster-time">
                    ____月____日 ____時頃 迷子になりました
                </div>

                <img id="poster_img" class="poster-photo" src="" alt="DOG PHOTO">

                <table class="poster-table">
                    <tr><th>お名前</th><td id="poster_name">-</td></tr>
                    <tr><th>犬種・毛色</th><td id="poster_breed">-</td></tr>
                    <tr><th>性別・年齢</th><td id="poster_gender_age">-</td></tr>
                    <tr><th>特徴</th><td style="color:#dc3545;">※首輪の色などを記入</td></tr>
                </table>

                <div class="poster-message">
                    大切な家族が迷子になってしまいました。見かけた方は、追いかけずに下記までご連絡をお願いします。<br>
                    保護につながる情報をくださった方には、心よりお礼をさせていただきます。
                </div>

                <div class="poster-contact">
                    飼い主：<span id="poster_owner">-</span>
                    <span id="poster_phone">090-XXXX-XXXX</span>
                </div>
                
                <div class="mt-4 text-start small text-muted">
                    避難所メモ: __________________________
                </div>
            </div>
        </div>

        <div id="debug-console-container" class="no-print-area">
            <h6 class="text-danger fw-bold">⚠️ Debug Console</h6>
            <div id="debug-console">Initializing...</div>
        </div>
    </div>

    <script>
        // 設定
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";

        // ロガー関数
        function log(msg) {
            const el = document.getElementById('debug-console');
            if(el) {
                const time = new Date().toLocaleTimeString();
                el.innerHTML = `[${time}] ${msg}\n` + el.innerHTML;
            }
            console.log(msg);
        }

        // 初期化
        window.onload = async function() {
            try {
                log('Starting LIFF init...');
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    log('Not logged in.');
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                const dogId = urlParams.get('dogId');
                
                log(`User: ${profile.userId}, DogID: ${dogId}`);
                fetchData(profile.userId, dogId);

            } catch (err) {
                log('Init Error: ' + err.message);
                document.getElementById('loading').innerHTML = `<p class="text-danger">Error: ${err.message}</p>`;
            }
        };

        // データ取得
        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            
            log('Fetching data...');
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    log('Data received.');
                    if(data.error) {
                        log('API Error: ' + data.error);
                        return;
                    }
                    renderData(data);
                    // 画像取得
                    if(data.dog && data.dog.id) {
                        fetchImage(userId, data.dog.id);
                    }
                })
                .catch(e => log('Fetch Error: ' + e.message));
        }

        // データ描画 (Nullチェック強化版)
        function renderData(data) {
            const c = data.customer || {};
            const d = data.dog || {};

            // 1. ハンドブック用データ設定
            setText('d_name', d.name_disp);
            setText('d_breed', d.breed);
            setText('d_gender', d.gender);
            setText('d_birth', d.birth_date);
            setText('d_age', d.age);
            setText('c_name', c.name);
            setText('c_phone_real', c.phone);
            setText('d_vet', d.vet_name);
            setText('d_allergy', d.allergy);
            setText('d_medicine', d.medicine);

            // 2. 迷子ポスター用データ設定 (TASK-1)
            setText('poster_name', d.name_disp);
            setText('poster_breed', `${d.breed || '-'} / ${d.color || '-'}`);
            setText('poster_gender_age', `${d.gender || '-'} / ${d.age || '-'}`);
            setText('poster_owner', c.name);
            setText('poster_phone', c.phone);

            // 表示切り替え
            document.getElementById('loading').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('main-display').style.display = 'block';
            log('Render complete.');
        }

        // 画像取得
        function fetchImage(userId, dogId) {
            let url = `${API_URL}?userId=${userId}&type=img_profile&dogId=${dogId}`;
            log('Fetching image...');
            fetch(url).then(res => res.json()).then(data => {
                if(data.image) {
                    // ハンドブック用
                    const con = document.getElementById('d_photo_container');
                    if(con) {
                        con.innerHTML = `<img src="${data.image}" class="dog-profile-img">`;
                        con.style.border = 'none';
                    }
                    // ポスター用
                    const pImg = document.getElementById('poster_img');
                    if(pImg) pImg.src = data.image;
                    
                    log('Image loaded.');
                }
            });
        }

        // 安全なテキストセット関数
        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = (text === undefined || text === null || text === '') ? '-' : text;
            } else {
                log(`Warning: Element #${id} not found.`);
            }
        }

        // マスク切り替え
        function toggleMask(baseId) {
            const real = document.getElementById(baseId + '_real');
            const mask = document.getElementById(baseId + '_mask');
            if(real && mask) {
                if(real.style.display === 'none' || real.style.display === '') {
                    if(confirm('表示しますか？')) {
                        real.style.display = 'inline';
                        mask.style.display = 'none';
                    }
                } else {
                    real.style.display = 'none';
                    mask.style.display = 'inline';
                }
            }
        }

        // モード切替 (ポスター/ハンドブック)
        window.switchMode = function(mode) {
            if(mode === 'poster') {
                document.body.classList.remove('mode-handbook');
                document.body.classList.add('mode-poster');
                alert('迷子ポスターを表示します。この状態で印刷ボタンを押すとポスターが印刷されます。');
            } else {
                document.body.classList.remove('mode-poster');
                document.body.classList.add('mode-handbook');
            }
        };
    </script>
</body>
</html>
