<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary-color: #88b08b; --accent-color: #e8f5e9; --alert-color: #e07a5f; --text-color: #333; --mask-color: #f0f0f0; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f9fbf9; color: var(--text-color); padding-bottom: 300px; }
        
        /* UI Common */
        .no-print-area { margin: 20px 0 30px; text-align: center; }
        .card-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #eee; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; margin-bottom: 15px; }
        .info-row { margin-bottom: 8px; }
        .info-label { font-weight: bold; color: #666; font-size: 0.8rem; display: block; margin-bottom: 1px; }
        .info-value { font-size: 1rem; font-weight: 500; min-height: 24px; word-break: break-all; }
        .masked-wrapper { display: flex; align-items: center; gap: 10px; }
        .masked-text { display: inline-block; letter-spacing: 2px; color: #aaa; background: var(--mask-color); padding: 2px 8px; border-radius: 4px; font-family: monospace; }
        .real-text { display: none; font-weight: bold; color: #333; }
        .btn-toggle-mask { font-size: 0.7rem; padding: 2px 10px; border: 1px solid var(--alert-color); color: var(--alert-color); background: white; border-radius: 20px; cursor: pointer; }
        .btn-toggle-mask:active { background: var(--alert-color); color: white; }
        #d_photo_container { width: 200px; height: 200px; background: #fff; border-radius: 12px; border: 4px solid var(--accent-color); overflow: hidden; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
        .dog-profile-img { width: 100%; height: 100%; object-fit: cover; }
        .btn-cert-view { font-size: 0.8rem; padding: 4px 12px; border-radius: 6px; background-color: var(--primary-color); color: white; border: none; width: 100%; margin-top: 5px; }
        .logo-placeholder { display: inline-block; padding: 5px 10px; border: 2px dashed #ccc; color: #999; font-weight: bold; font-size: 0.8rem; }
        .screen-logo-top { width: 120px; margin-bottom: 15px; }
        .screen-logo-footer { width: 100px; margin-top: 20px; margin-bottom: 10px; opacity: 0.8; }
        
        /* Output Containers (Fixed Size for A4) */
        #poster-display, #crate-display, #handbook-display { display: none; }
        #generating-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #debug-console-container { display: block; margin-top: 30px; padding: 0 10px; }
        #debug-console { background: #111; color: #0f0; font-family: monospace; font-size: 11px; padding: 15px; border-radius: 8px; height: 200px; overflow-y: scroll; }
        #generated-image-preview { width: 100%; height: auto; border: 2px solid #ccc; border-radius: 4px; }

        /* â˜…â˜…â˜… 1. HANDBOOK (A4 Landscape 4-Split) â˜…â˜…â˜… */
        .hb-container {
            width: 1123px; height: 794px; /* A4 Landscape px */
            background: white; margin: 0 auto; border: 1px solid #ccc;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            box-sizing: border-box;
        }
        .hb-box { padding: 30px; position: relative; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
        .hb-box-tl { transform: rotate(180deg); border-right: 1px dashed #999; border-bottom: 1px dashed #999; padding: 30px; } /* è¡¨ç´™ */
        .hb-box-tr { transform: rotate(180deg); border-bottom: 1px dashed #999; padding: 30px; } /* åŒ»ç™‚ */
        .hb-box-bl { border-right: 1px dashed #999; padding: 30px; } /* ç·Šæ€¥ */
        .hb-box-br { padding: 30px; } /* ã‚±ã‚¢ */

        /* Handbook Contents */
        .hb-cover-grid { display: flex; gap: 20px; align-items: center; height: 100%; }
        .hb-cover-img { width: 180px; height: 180px; object-fit: cover; border-radius: 10px; border: 4px solid #eee; }
        .hb-cover-info { flex-grow: 1; text-align: left; }
        .hb-main-title { font-size: 28px; font-weight: 900; color: var(--primary-color); margin-bottom: 10px; }
        .hb-row { font-size: 16px; margin-bottom: 8px; font-weight: bold; border-bottom: 1px dotted #ccc; }
        .hb-label { font-size: 12px; color: #666; margin-right: 5px; }
        
        .hb-header { font-size: 18px; font-weight: bold; color: white; background: var(--primary-color); padding: 5px 15px; border-radius: 5px; margin-bottom: 15px; display: inline-block; }
        .hb-list-row { display: flex; margin-bottom: 8px; border-bottom: 1px dotted #ccc; }
        .hb-list-label { width: 140px; font-weight: bold; color: #555; font-size: 14px; }
        .hb-list-val { flex-grow: 1; font-weight: bold; font-size: 16px; }
        
        .hb-em-grid { display: flex; gap: 20px; }
        .hb-em-col { width: 50%; }
        .hb-em-title { font-size: 16px; font-weight: bold; border-bottom: 2px solid #ccc; margin-bottom: 5px; color: #333; }

        /* â˜…â˜…â˜… 2. POSTER (A4 Portrait) â˜…â˜…â˜… */
        .poster-container { width: 794px; height: 1123px; background: white; margin: 0 auto; position: relative; overflow: hidden; }
        .poster-inner-border { width: 100%; height: 100%; border: 6px solid #ff0000; padding: 30px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
        .poster-title { color: #ff0000; font-size: 60px; font-weight: 900; margin-bottom: 20px; line-height: 1; }
        .poster-date-line { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; width: 100%; text-align: left; }
        .handwrite-space { border-bottom: 3px solid #333; display: inline-block; margin: 0 5px; }
        .poster-photo-frame { width: 80%; height: 400px; border: 5px solid #333; margin-bottom: 20px; background: #eee; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .poster-photo-img { width: 100%; height: 100%; object-fit: contain; }
        .poster-info-table { width: 100%; border-collapse: collapse; font-size: 24px; margin-bottom: 20px; text-align: left; }
        .poster-info-table th { width: 25%; padding: 10px; border-bottom: 4px solid #ff0000; color: #ff0000; font-weight: bold; }
        .poster-info-table td { padding: 10px; border-bottom: 2px solid #ccc; font-weight: bold; color: #000; }
        .poster-message { font-size: 20px; text-align: left; line-height: 1.5; margin-bottom: 20px; font-weight: 600; }
        .poster-contact-box { width: 100%; border: 5px solid #ff0000; padding: 15px; background: #fff5f5; text-align: center; margin-bottom: 20px; }
        .poster-contact-name { font-size: 24px; font-weight: bold; }
        .poster-contact-phone { font-size: 36px; font-weight: 900; color: #ff0000; display: block; }
        .poster-footer { width: 100%; display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; }
        .poster-shelter { font-size: 20px; font-weight: bold; text-align: left; }

        /* â˜…â˜…â˜… 3. CRATE TAG (A4 Portrait) â˜…â˜…â˜… */
        .crate-container { width: 794px; height: 1123px; background: white; position: relative; overflow: hidden; box-sizing: border-box; border: 2px dashed #aaa; margin: 0 auto; }
        .crate-fold-line { position: absolute; top: 45%; left: 0; width: 100%; height: 0; border-top: 4px dashed #88b08b; z-index: 10; }
        
        /* AREA A (Top 45%) */
        .crate-area-a { position: absolute; top: 0; left: 0; width: 100%; height: 45%; padding: 30px; box-sizing: border-box; transform: rotate(180deg); display: flex; gap: 30px; background-color: #fff; border-bottom: 2px dashed #ccc; }
        /* Left: Command (Swapped) */
        .crate-a-left { width: 48%; border-right: 3px solid #ddd; padding-right: 20px; display: flex; flex-direction: column; }
        /* Right: Food (Swapped) */
        .crate-a-right { width: 48%; padding-left: 20px; display: flex; flex-direction: column; position: relative; }
        
        .crate-title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 3px solid #88b08b; }
        .cmd-example { font-size: 18px; background: #eee; padding: 5px; text-align: center; border-radius: 5px; margin-bottom: 10px; font-weight: bold; color: #555; }
        .cmd-row { font-size: 22px; border-bottom: 2px dotted #ccc; margin-bottom: 10px; font-weight: bold; }
        .cmd-footer { margin-top: auto; background: #e8f5e9; color: var(--primary-color); font-weight: bold; text-align: center; padding: 10px; border-radius: 8px; font-size: 18px; }
        
        .food-grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .food-box { flex: 1; border: 3px solid; border-radius: 10px; padding: 10px; text-align: center; }
        .food-ok { border-color: #198754; color: #198754; }
        .food-ng { border-color: #dc3545; color: #dc3545; }
        .food-label { display: block; font-size: 20px; font-weight: 900; border-bottom: 2px solid; margin-bottom: 5px; }
        .food-item { font-size: 16px; font-weight: bold; display: block; }
        
        .allergy-box { border: 3px solid #000; border-radius: 10px; padding: 20px 10px 10px; position: relative; margin-top: 10px; flex-grow: 1; }
        .allergy-title { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: #000; color: #dc3545; font-weight: bold; padding: 2px 15px; border-radius: 5px; font-size: 18px; }
        .allergy-val { font-size: 20px; font-weight: bold; color: #333; text-align: center; }

        /* AREA B (Middle 40%) */
        .crate-area-b { position: absolute; top: 45%; left: 0; width: 100%; height: 40%; padding: 20px 40px; box-sizing: border-box; display: flex; flex-direction: column; }
        .crate-b-main { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .crate-photo { width: 220px; height: 220px; object-fit: cover; border: 6px solid #88b08b; border-radius: 15px; margin-right: 30px; flex-shrink: 0; }
        .crate-name { font-size: 60px; font-weight: 900; color: #333; line-height: 1; margin-bottom: 10px; }
        .crate-sub { font-size: 24px; font-weight: bold; color: #555; }
        .crate-caution { background: #fff0f0; border: 4px solid #dc3545; border-radius: 10px; padding: 10px 20px; font-size: 28px; font-weight: 900; color: #333; text-align: left; margin: 15px 0; }
        
        .crate-med-grid { display: flex; border: 3px solid #ccc; border-radius: 10px; overflow: hidden; height: 140px; margin-bottom: 10px; }
        .med-left { width: 50%; border-right: 3px solid #ccc; padding: 10px; font-size: 18px; font-weight: bold; display: flex; flex-direction: column; justify-content: center; }
        .med-right { width: 50%; display: flex; flex-direction: column; }
        .med-right-top { height: 50%; border-bottom: 3px solid #ccc; padding: 5px 10px; font-size: 18px; font-weight: bold; display: flex; align-items: center; }
        .med-right-bot { height: 50%; padding: 5px 10px; font-size: 18px; font-weight: bold; display: flex; align-items: center; background: #f9f9f9; }
        .med-bg { background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 4px; margin-right: 5px; font-size: 14px; }
        
        .crate-consent { text-align: center; font-size: 18px; font-weight: bold; color: #555; margin-top: 5px; }
        .crate-flip { margin-top: auto; background: var(--primary-color); color: white; font-weight: bold; font-size: 20px; text-align: center; padding: 5px; border-radius: 0 0 15px 15px; }

        /* AREA C (Bottom 15%) */
        .crate-area-c { position: absolute; bottom: 0; left: 0; width: 100%; height: 15%; border-top: 4px dashed #333; background-color: #f8f9fa; padding: 20px 40px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; }
        .contact-grid { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .contact-box { width: 48%; font-weight: bold; font-size: 20px; border-bottom: 2px solid #ccc; }
        .contact-sm { font-size: 14px; color: #666; }
        .vet-area { display: flex; justify-content: space-between; align-items: flex-end; border-top: 2px solid #ccc; padding-top: 10px; }
        .shelter-line { border-bottom: 2px solid #333; width: 200px; display: inline-block; }

        @media print {
            .no-print-area, #debug-console-container, #generating-overlay, .modal-backdrop { display: none !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="mode-handbook">

    <div id="generating-overlay"><div class="spinner-border text-primary"></div><h4 class="mt-3">ä½œæˆä¸­...</h4></div>

    <div class="container py-3">
        <div class="no-print-area">
            <div class="text-center mb-2"><span class="logo-placeholder">[Logo img]</span></div>
            <h4 class="fw-bold mb-3" style="color: var(--primary-color);">ã†ã¡ã®å­åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</h4>
            <div id="loading" class="text-center py-5"><div class="spinner-border text-success"></div><p>Loading...</p></div>
        </div>

        <div id="main-display" style="display:none;">
             <div class="card-section"><div class="section-title">åŸºæœ¬æƒ…å ±</div><div id="d_photo_container"><div class="spinner-border spinner-border-sm text-secondary"></div></div><div class="text-center mb-3"><h2 id="d_name" class="fw-bold mb-1">-</h2></div><div class="row text-center mb-2"><div class="col-6 border-end"><span class="info-label">çŠ¬ç¨®</span><div id="d_breed">-</div></div><div class="col-6"><span class="info-label">æ¯›è‰²</span><div id="d_color">-</div></div></div><div class="row text-center mb-3"><div class="col-4 border-end"><span class="info-label">å¹´é½¢</span><div id="d_age">-</div></div><div class="col-4 border-end"><span class="info-label">æ€§åˆ¥</span><div id="d_gender">-</div></div><div class="col-4"><span class="info-label">å»å‹¢</span><div id="d_neutered">-</div></div></div><hr class="my-3"><div class="info-row"><span class="info-label">é£¼ã„ä¸»å</span><div id="c_name" class="fw-bold">-</div></div><div class="info-row"><span class="info-label">ä½æ‰€</span><div class="masked-wrapper"><span id="c_address_masked" class="masked-text">***</span><span id="c_address_real" class="real-text">-</span><button class="btn-toggle-mask" onclick="toggleMask('c_address')">è¡¨ç¤º</button></div></div><div class="info-row"><span class="info-label">é›»è©±ç•ªå·</span><div class="masked-wrapper"><span id="c_phone_masked" class="masked-text">***</span><span id="c_phone_real" class="real-text">-</span><button class="btn-toggle-mask" onclick="toggleMask('c_phone')">è¡¨ç¤º</button></div></div></div>
             <div class="card-section"><div class="section-title">åŒ»ç™‚æƒ…å ±</div><div class="mb-3 p-2 bg-light rounded border"><h6 class="fw-bold small text-muted mb-2"><i class="fa-solid fa-hospital"></i> ã‹ã‹ã‚Šã¤ã‘å‹•ç‰©ç—…é™¢</h6><div class="info-row"><span class="info-label">ç—…é™¢å</span><div id="d_vet_name" class="fw-bold fs-5">-</div></div><div class="info-row"><span class="info-label">ä½æ‰€</span><div id="d_vet_address" class="small">-</div></div><div class="info-row"><span class="info-label">é›»è©±ç•ªå·</span><div id="d_vet_phone">-</div></div></div><div class="info-row"><span class="info-label">æ—¢å¾€æ­´</span><div id="d_history">-</div></div><div class="info-row"><span class="info-label">å¸¸ç”¨è–¬</span><div id="d_medicine" class="text-danger">-</div></div><div class="info-row"><span class="info-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</span><div id="d_allergy" class="text-danger fw-bold">-</div></div><div class="row mt-3 mb-2"><div class="col-6"><span class="info-label">é‘‘æœ­ç•ªå·</span><div id="d_license" class="small font-monospace">-</div></div><div class="col-6"><span class="info-label">ãƒã‚¤ã‚¯ãƒ­ãƒãƒƒãƒ—</span><div id="d_chip" class="small font-monospace">-</div></div></div></div>
             <div class="card-section"><div class="section-title">ç·Šæ€¥æ™‚æƒ…å ±</div><div class="info-row"><span class="info-label">ç·Šæ€¥é€£çµ¡å…ˆ (æ°å)</span><div id="c_em_name">-</div></div><div class="info-row"><span class="info-label">ç·Šæ€¥é€£çµ¡å…ˆ (é›»è©±)</span><div class="masked-wrapper"><span id="c_em_phone_masked" class="masked-text">***</span><span id="c_em_phone_real" class="real-text">-</span><button class="btn-toggle-mask" onclick="toggleMask('c_em_phone')">è¡¨ç¤º</button></div></div><hr><div class="info-row"><span class="info-label">ä»£ç†äºº (æ°å)</span><div id="c_proxy_name">-</div></div><div class="info-row"><span class="info-label">ä»£ç†äºº (é›»è©±)</span><div class="masked-wrapper"><span id="c_proxy_phone_masked" class="masked-text">***</span><span id="c_proxy_phone_real" class="real-text">-</span><button class="btn-toggle-mask" onclick="toggleMask('c_proxy_phone')">è¡¨ç¤º</button></div></div><hr><div class="info-row mb-0"><span class="info-label">æŒ‡å®šé¿é›£æ‰€</span><div id="c_evac" class="fw-bold">-</div></div></div>
             <div class="no-print-area mt-3 mb-2 text-center"><span class="logo-placeholder">[Logo img]</span></div>
        </div>

        <div id="handbook-display">
            <div class="hb-container">
                <div class="hb-box hb-box-tl">
                    <div class="text-center mb-2"><span class="logo-placeholder">[Logo img]</span></div>
                    <div class="hb-main-title">ã†ã¡ã®å­é˜²ç½ã‚«ãƒ¼ãƒ‰</div>
                    <div class="hb-cover-grid">
                        <img id="hb_img" class="hb-cover-img" src="" alt="Photo">
                        <div class="hb-cover-info">
                            <div class="hb-row"><span class="hb-label">åå‰</span><span id="hb_name" class="hb-val" style="font-size:18px;">-</span></div>
                            <div class="hb-row"><span class="hb-label">æ€§åˆ¥/å¹´é½¢</span><span id="hb_gender_age" class="hb-val">-</span></div>
                            <div class="hb-row"><span class="hb-label">çŠ¬ç¨®/æ¯›è‰²</span><span id="hb_breed_color" class="hb-val">-</span></div>
                            <div class="hb-row"><span class="hb-label">é£¼ã„ä¸»</span><span id="hb_owner" class="hb-val">-</span></div>
                        </div>
                    </div>
                </div>
                <div class="hb-box hb-box-tr">
                    <div class="hb-header">ã‹ã‹ã‚Šã¤ã‘å‹•ç‰©ç—…é™¢</div>
                    <div style="margin-top:20px;">
                        <div class="hb-row"><span class="hb-label">ç—…é™¢å</span><span id="hb_vet_name" class="hb-val" style="font-size:18px;">-</span></div>
                        <div class="hb-row"><span class="hb-label">é›»è©±ç•ªå·</span><span id="hb_vet_phone" class="hb-val">-</span></div>
                        <div class="hb-row"><span class="hb-label">ä½æ‰€</span><span id="hb_vet_address" class="hb-val">-</span></div>
                    </div>
                </div>
                <div class="hb-box hb-box-bl">
                    <div class="hb-em-grid">
                        <div class="hb-em-col">
                            <div class="hb-em-title">ç·Šæ€¥é€£çµ¡å…ˆ</div>
                            <div class="hb-list-val" style="font-size:18px;"><span id="hb_em_name">-</span></div>
                            <div class="hb-list-val"><span id="hb_em_phone">-</span></div>
                        </div>
                        <div class="hb-em-col" style="border-left:1px solid #eee; padding-left:15px;">
                            <div class="hb-em-title">ä»£ç†äººæƒ…å ±</div>
                            <div class="hb-list-val" style="font-size:18px;"><span id="hb_proxy_name">-</span></div>
                            <div class="hb-list-val"><span id="hb_proxy_phone">-</span></div>
                        </div>
                    </div>
                </div>
                <div class="hb-box hb-box-br">
                    <div class="hb-header">ã‚±ã‚¢ãƒ»é¿é›£æ‰€æƒ…å ±</div>
                    <div class="hb-list-row"><span class="hb-list-label">æ—¢å¾€æ­´</span><span id="hb_history" class="hb-list-val">-</span></div>
                    <div class="hb-list-row"><span class="hb-list-label">å¸¸ç”¨è–¬</span><span id="hb_medicine" class="hb-list-val">-</span></div>
                    <div class="hb-list-row"><span class="hb-list-label" style="color:#dc3545;">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</span><span id="hb_allergy" class="hb-list-val" style="color:#dc3545;">-</span></div>
                    <div class="hb-list-row"><span class="hb-list-label">é‘‘æœ­ç•ªå·</span><span id="hb_license" class="hb-list-val">-</span></div>
                    <div class="hb-list-row"><span class="hb-list-label">ãƒã‚¤ã‚¯ãƒ­ãƒãƒƒãƒ—</span><span id="hb_chip" class="hb-list-val">-</span></div>
                    <div class="hb-list-row"><span class="hb-list-label">é¿é›£æ‰€</span><span id="hb_evac" class="hb-list-val">-</span></div>
                </div>
            </div>
        </div>

        <div id="poster-display">
            <div class="poster-container"><div class="poster-inner-border"><div class="poster-title">ã†ã¡ã®å­æ¢ã—ã¦ã¾ã™ï¼</div><div class="poster-date-line"><span class="handwrite-space">ã€€ã€€ã€€</span> æœˆ<span class="handwrite-space">ã€€ã€€ã€€</span> æ—¥<span class="handwrite-space">ã€€ã€€ã€€ã€€ã€€ã€€</span> æ™‚é ƒ<br><span class="handwrite-space" style="width: 75%;">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€</span> å‘¨è¾ºã§ã„ãªããªã‚Šã¾ã—ãŸã€‚</div><div class="poster-photo-frame"><img id="poster_img" class="poster-photo-img" src="" alt="NO PHOTO"></div><table class="poster-info-table"><tr><th>åå‰</th><td id="poster_name" style="font-size:36px;">-</td></tr><tr><th>æ€§åˆ¥ãƒ»å¹´é½¢</th><td id="poster_gender_age">-</td></tr><tr><th>çŠ¬ç¨®ãƒ»æ¯›è‰²</th><td id="poster_breed_color">-</td></tr></table><div class="poster-message">å¤§åˆ‡ãªæ„›çŠ¬ãŒè¿·å­ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚æƒ…å ±æä¾›ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚<br>ä¿è­·ã‚’ã—ã¦ãã ã•ã£ãŸæ–¹ã€ä¿è­·ã«ã¤ãªãŒã‚‹æƒ…å ±ã‚’ãã ã•ã£ãŸæ–¹ã«ã¯ãŠç¤¼ã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚ä¸‹è¨˜ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚</div><div class="poster-split-section"><div class="poster-left-col"><div class="poster-contact-box"><div class="small fw-bold">é€£çµ¡å…ˆ (é£¼ã„ä¸»)</div><div id="poster_owner" class="poster-contact-name">-</div><div id="poster_phone" class="poster-contact-phone">-</div></div></div><div class="poster-right-col"><div class="poster-shelter-area">é¿é›£æ‰€: <br><span class="handwrite-space" style="width:100%; height:30px;"></span></div><div id="poster-qr-container" style="margin-top:10px;"><img id="poster-qr-img" src="" alt="QR" style="width:100px; height:100px; border:1px solid #333; display:none;"></div></div></div><div class="poster-logo-area"><span class="logo-placeholder">[Logo img]</span></div></div></div>
        </div>

        <div id="crate-display">
            <div class="crate-container">
                <div class="crate-fold-line"></div>
                <div class="crate-area-a">
                    <div class="crate-a-left">
                        <span class="crate-header-a">[<span id="crate_name_a"></span>]ã¡ã‚ƒã‚“/ãã‚“ ã‚³ãƒãƒ³ãƒ‰è¾æ›¸</span>
                        <div class="cmd-example">ä¾‹: ãƒãƒ† = Wait(ã‚¦ã‚§ã‚¤ãƒˆ)</div>
                        <div class="cmd-list"><div class="cmd-row"><span class="cmd-key">ãƒãƒ†</span> = </div><div class="cmd-row"><span class="cmd-key">ã‚ªã‚¹ãƒ¯ãƒª</span> = </div><div class="cmd-row"><span class="cmd-key">ã‚ªã‚¤ãƒ‡</span> = </div><div class="cmd-row"><span class="cmd-key">ãƒã‚¦ã‚¹</span> = </div></div>
                        <div class="cmd-footer">ç§ã®å®¶ã§ã¯ã“ã†ã‚„ã£ã¦ä¼ãˆã¦ã¾ã™ï¼</div>
                    </div>
                    <div class="crate-a-right">
                        <span class="crate-header-a">ğŸ†˜ ã‚µãƒã‚¤ãƒãƒ«ãƒ•ãƒ¼ãƒ‰</span>
                        <div class="food-grid">
                            <div class="food-box food-ok"><span class="food-title-ok">â­•ï¸ OK</span><span class="food-item">ç™½ç±³ãƒ»ãƒ‘ãƒ³(å…·ãªã—)</span><span class="food-item">èŠ‹ãƒ»ã‚­ãƒ£ãƒ™ãƒ„ãƒ»é¶è‚‰</span></div>
                            <div class="food-box food-ng"><span class="food-title-ng">âŒ NG</span><span class="food-item">ãƒã‚®é¡ãƒ»ãƒãƒ§ã‚³</span><span class="food-item">ãƒ–ãƒ‰ã‚¦ãƒ»ã‚­ã‚·ãƒªãƒˆãƒ¼ãƒ«</span></div>
                        </div>
                        <div class="allergy-box"><div class="allergy-title">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</div><div id="crate_allergy_content" class="allergy-val">-</div></div>
                        <div class="crate-logo-placeholder"><span class="logo-placeholder">[Logo img]</span></div>
                    </div>
                </div>
                <div class="crate-area-b">
                    <div class="crate-b-main">
                        <img id="crate_img" class="crate-b-photo" src="" alt="Photo">
                        <div class="crate-b-info">
                            <div id="crate_name" class="crate-name-huge">-</div>
                            <div id="crate_breed" class="crate-info-sub">-</div>
                        </div>
                    </div>
                    <div class="crate-caution-box">âš ï¸ ã¡ã‚…ã†ã„ï¼: <span id="crate_caution">-</span></div>
                    <div class="crate-med-grid">
                        <div class="crate-med-left"><span class="med-bg">æ—¢å¾€æ­´</span><span id="crate_history_content" class="med-val">-</span></div>
                        <div class="crate-med-right">
                            <div class="crate-med-right-top"><span class="med-bg">å¸¸å‚™è–¬</span><span id="crate_medicine_content" class="med-val">-</span></div>
                            <div class="crate-med-right-bottom"><span class="med-bg">ãƒ•ãƒ¼ãƒ‰</span><span id="crate_food_content" class="med-val">-</span></div>
                        </div>
                    </div>
                    <div class="crate-consent-area">
                        <input type="checkbox" style="transform:scale(1.5); margin-right:10px;"> 
                        ä¸‡ãŒä¸€ã®æ€ªæˆ‘ã€ä½“èª¿ä¸è‰¯ã®éš›ã¯å¿œæ€¥å‡¦ç½®ã‚’æœ‰è­˜è€…ã«ä¸€ä»»ã—ã¾ã™ã€‚
                    </div>
                    <div class="crate-msg-bottom">ï¼¼ ç·Šæ€¥ã®éš›ã¯ã“ã¡ã‚‰ã«ã”é€£çµ¡ãã ã•ã„(ã‚ãã‚‹) ï¼</div>
                </div>
                <div class="crate-area-c">
                    <div class="contact-grid">
                        <div class="contact-item"><span class="contact-label-sm">é£¼ã„ä¸»æ°å</span><div id="crate_owner" class="contact-val">-</div></div>
                        <div class="contact-item"><span class="contact-label-sm">ä»£ç†äººæ°å</span><div id="crate_proxy" class="contact-val">-</div></div>
                    </div>
                    <div class="contact-grid">
                        <div class="contact-item"><span class="contact-label-sm">é£¼ã„ä¸»é›»è©±</span><div id="crate_phone" class="contact-val">-</div></div>
                        <div class="contact-item"><span class="contact-label-sm">ä»£ç†äººé›»è©±</span><div id="crate_proxy_tel" class="contact-val">-</div></div>
                    </div>
                    <div class="vet-area">
                        <div style="width:50%"><span class="contact-label-sm">ã‹ã‹ã‚Šã¤ã‘å‹•ç‰©ç—…é™¢</span><div id="crate_vet" class="vet-val">-</div><div id="crate_vet_tel" class="vet-val">-</div></div>
                        <div style="width:45%"><span class="contact-label-sm">å±…ä½ã‚¨ãƒªã‚¢</span><div class="shelter-write"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="controls" class="no-print-area mt-4" style="display:none; max-width:500px; margin:0 auto;">
            <button onclick="generateOutput('handbook')" class="btn btn-primary w-100 mb-2 fw-bold" style="background-color: #88b08b; border:none;">é˜²ç½æ‰‹å¸³ (A4æ¨ª)</button>
            <button onclick="generateOutput('crate')" class="btn btn-primary w-100 mb-2 fw-bold" style="background-color: #e07a5f; border:none;">ã‚¯ãƒ¬ãƒ¼ãƒˆã‚¿ã‚° (A4ç¸¦)</button>
            <button onclick="generateOutput('poster')" class="btn btn-primary w-100 mb-2 fw-bold" style="background-color: #dc3545; border:none;">è¿·å­ãƒã‚¹ã‚¿ãƒ¼ (A4ç¸¦)</button>
            <button onclick="window.location.href='index.html'" class="btn btn-outline-secondary w-100 rounded-pill mt-3">æˆ»ã‚‹</button>
        </div>
        
        <div id="debug-console-container" class="no-print-area"><h6 class="text-danger fw-bold">âš ï¸ Debug Console</h6><div id="debug-console">Initializing...</div></div>
    </div>

    <div class="modal fade" id="outputModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title fw-bold text-success">ä½œæˆå®Œäº†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-start alert alert-primary"><strong>iPhoneã®æ–¹ã¸:</strong> ä¸‹ã®ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œå†™çœŸã«ä¿å­˜ã€ã—ã¦ãã ã•ã„ã€‚</p><img id="generated-image-preview" src="" style="width:100%; border:1px solid #ccc;"><div class="mt-3"><button id="btn-download-pdf" class="btn btn-secondary btn-sm" style="display:none;">PCç”¨: PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button></div></div><div class="modal-footer border-0"><button type="button" class="btn btn-secondary w-100 rounded-pill" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const LIFF_ID = "2008546673-MJY7j3ox";
        let outputModal;

        function log(msg) { const el = document.getElementById('debug-console'); if(el) el.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + el.innerHTML; }

        window.onload = async function() {
            if(typeof bootstrap !== 'undefined') outputModal = new bootstrap.Modal(document.getElementById('outputModal'));
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                const dogId = urlParams.get('dogId');
                fetchData(profile.userId, dogId);
            } catch (err) { console.error(err); }
        };

        function fetchData(userId, dogId) {
            let url = `${API_URL}?userId=${userId}`;
            if(dogId) url += `&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.error) { alert('Error: ' + data.error); return; }
                renderData(data);
                if(data.dog && data.dog.id) fetchImage(userId, data.dog.id);
            }).catch(e => alert('Connection Error'));
        }

        function renderData(data) {
            const c = data.customer || {};
            const d = data.dog || {};

            // Common Text Setters (Same as before)
            setText('d_name', d.name_disp); setText('d_breed', d.breed); setText('d_color', d.color); setText('d_age', d.age); setText('d_gender', d.gender); setText('d_neutered', d.neutered);
            setText('c_name', c.name); setMaskedText('c_address', c.address, maskAddress(c.address)); setMaskedText('c_phone', c.phone, maskPhone(c.phone));
            setText('c_em_name', c.em_name); setMaskedText('c_em_phone', c.em_phone, maskPhone(c.em_phone)); setText('c_proxy_name', c.proxy_name); setMaskedText('c_proxy_phone', c.proxy_phone, maskPhone(c.proxy_phone)); setText('c_evac', c.evac_site);
            setText('d_vet_name', d.vet_name); setText('d_vet_address', d.vet_address); setText('d_vet_phone', d.vet_phone); setText('d_history', d.history); setText('d_medicine', d.medicine); setText('d_allergy', d.allergy); setText('d_license', d.license_no); setText('d_chip', d.microchip); setText('d_food', d.food); setText('d_caution', d.caution);

            // Handbook (Full Data)
            setText('hb_name', d.name_disp); setText('hb_gender_age', `${d.gender} / ${d.age}`); setText('hb_breed_color', `${d.breed} / ${d.color}`); setText('hb_owner', c.name);
            setText('hb_vet_name', d.vet_name); setText('hb_vet_phone', d.vet_phone); setText('hb_vet_address', d.vet_address);
            setText('hb_em_name', c.em_name); setText('hb_em_phone', c.phone); setText('hb_proxy_name', c.proxy_name); setText('hb_proxy_phone', c.proxy_phone);
            setText('hb_history', d.history); setText('hb_medicine', d.medicine); setText('hb_allergy', d.allergy); setText('hb_license', d.license_no); setText('hb_chip', d.microchip); setText('hb_evac', c.evac_site);

            // Poster (Full Data)
            setText('poster_name', d.name_disp); setText('poster_gender_age', `${d.gender || '-'} / ${d.age || '-'}æ­³`); setText('poster_breed_color', `${d.breed || '-'} / ${d.color || '-'}`); setText('poster_owner', c.name); setText('poster_phone', c.phone);
            if (c.evac_site && c.evac_site !== 'è¨˜è¼‰ãªã—') {
                const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(`https://www.google.com/maps/search/?api=1&query=${c.evac_site}`)}`;
                document.getElementById('poster-qr-img').src = qrSrc; document.getElementById('poster-qr-img').style.display = 'block';
            }

            // Crate (Full Data)
            setText('crate_name_a', d.name || 'ã‚ã‚“'); setText('crate_name', d.name_disp); setText('crate_breed', `${d.breed} / ${d.gender} / ${d.neutered}`);
            setText('crate_caution', d.caution); setText('crate_allergy_content', d.allergy);
            setText('crate_history_content', d.history); setText('crate_medicine_content', d.medicine); setText('crate_food_content', d.food);
            setText('crate_owner', c.name); setText('crate_phone', c.phone); setText('crate_proxy', c.proxy_name); setText('crate_proxy_tel', c.proxy_phone); setText('crate_vet', d.vet_name); setText('crate_vet_tel', d.vet_phone || '-');

            document.getElementById('loading').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('main-display').style.display = 'block';
        }

        function fetchImage(userId, dogId) {
            let url = `${API_URL}?userId=${userId}&type=img_profile&dogId=${dogId}`;
            fetch(url).then(res => res.json()).then(data => {
                if(data.image) {
                    setImg('d_photo_container', data.image); setSrc('hb_img', data.image); setSrc('poster_img', data.image); setSrc('crate_img', data.image);
                } else { document.getElementById('d_photo_container').innerHTML = '<span class="text-muted small">No Image</span>'; }
            });
        }

        async function generateOutput(mode) {
            const overlay = document.getElementById('generating-overlay');
            overlay.style.display = 'flex';
            let targetId = 'main-display';
            if (mode === 'poster') targetId = 'poster-display';
            if (mode === 'crate') targetId = 'crate-display';
            if (mode === 'handbook') targetId = 'handbook-display';

            const target = document.getElementById(targetId);
            if(!target) { overlay.style.display='none'; return; }

            const prevDisplay = target.style.display;
            target.style.display = 'block';
            
            await new Promise(r => setTimeout(r, 500));

            try {
                // Handbook=Landscape(1123px), Others=Portrait(794px) A4
                const windowW = (mode === 'handbook') ? 1123 : 794;
                const canvas = await html2canvas(target, { scale: 2, useCORS: true, allowTaint: true, windowWidth: windowW });
                const imgData = canvas.toDataURL('image/jpeg', 0.90);
                document.getElementById('generated-image-preview').src = imgData;

                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (!isMobile) {
                    const { jsPDF } = window.jspdf;
                    const orient = (mode === 'handbook') ? 'l' : 'p';
                    const doc = new jsPDF(orient, 'mm', 'a4');
                    doc.addImage(imgData, 'JPEG', 0, 0, orient==='l'?297:210, orient==='l'?210:297);
                    doc.save(`K9_${mode}.pdf`);
                }
                outputModal.show();
            } catch (err) { alert('Error: ' + err.message); } 
            finally {
                target.style.display = prevDisplay;
                overlay.style.display = 'none';
            }
        }

        function maskAddress(addr) { if(!addr) return; const m = addr.match(/(.*?[éƒ½é“åºœçœŒ].*?[å¸‚åŒºç”ºæ‘])/); return m ? m[0]+' ***' : addr.substring(0,5)+' ***'; }
        function maskPhone(tel) { if(!tel) return; return tel.substring(0,3)+'-****-****'; }
        function setMaskedText(baseId, realVal, maskedVal) { const rEl = document.getElementById(baseId + '_real'); const mEl = document.getElementById(baseId + '_masked'); const btn = rEl ? rEl.parentElement.querySelector('.btn-toggle-mask') : null; if(!rEl || !mEl) return; if(!realVal || realVal === 'è¨˜è¼‰ãªã—') { rEl.textContent = 'è¨˜è¼‰ãªã—'; mEl.style.display='none'; rEl.style.display='inline'; if(btn) btn.style.display='none'; } else { rEl.textContent = realVal; mEl.textContent = maskedVal; mEl.style.display='inline'; rEl.style.display='none'; if(btn) btn.style.display='inline-block'; } }
        function toggleMask(baseId) { const rEl = document.getElementById(baseId + '_real'); const mEl = document.getElementById(baseId + '_masked'); if(rEl.style.display === 'none') { if(confirm('è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ')) { rEl.style.display='inline'; mEl.style.display='none'; } } else { rEl.style.display='none'; mEl.style.display='inline'; } }
        function setText(id, txt) { const el = document.getElementById(id); if(el) el.textContent = txt || '-'; }
        function setSrc(id, src) { const el = document.getElementById(id); if(el) el.src = src; }
        function setImg(cid, src) { const el = document.getElementById(cid); if(el) { el.innerHTML = `<img src="${src}" class="dog-profile-img">`; el.style.border='none'; } }
    </script>
</body>
</html>
