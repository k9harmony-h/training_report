<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K9 Harmony | æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Zen+Kurenaido&family=Yusei+Magic&display=swap" rel="stylesheet">

    <style>
        /* [Design System Settings] 10å¹´å¾Œã®ä¿å®ˆæ€§ã‚’æ‹…ä¿ã™ã‚‹ãŸã‚CSSå¤‰æ•°ã§å®šæ•°ç®¡ç† */
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #FDFBF8; /* æ¸©ã‹ã¿ã®ã‚ã‚‹ç”Ÿæˆã‚Šè‰² */
            --text-main: #2C3E50;
            --text-black: #000000;
            --luxury-transition: 0.8s cubic-bezier(0.25, 0.1, 0.25, 1.0);
            --global-radius: 5px;
            --group-margin: 40px;
        }

        /* [Base Layout] */
        body {
            font-family: 'Noto Serif JP', serif;
            background-color: #fafafa; /* èµ·å‹•æ¼”å‡ºã®åˆæœŸèƒŒæ™¯è‰² */
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* [Visual Log Stamp] ãƒ«ãƒ¼ãƒ«6ï¼šé–‹ç™ºé€²æ—ã‚’æ°¸ç¶šçš„ã«è¦–è¦šåŒ– */
        #logOverlay {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(47, 93, 98, 0.85);
            color: #FFF; font-size: 10px; padding: 4px 10px; z-index: 9999; pointer-events: none;
            font-family: monospace; line-height: 1.5;
        }

        /* [Background] æ¸©ã‹ã¿ã®ã‚ã‚‹é›²é¾ç´™ãƒ†ã‚¯ã‚¹ãƒãƒ£ï¼ˆãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£ãƒ•ãƒªãƒ¼Base64åŸ‹ã‚è¾¼ã¿ï¼‰ 
           â€»é€šä¿¡ç’°å¢ƒã«å·¦å³ã•ã‚Œãšã€LIFFå†…ã§ã®ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ã‚’å›é¿ã™ã‚‹ãŸã‚ã®å …ç‰¢ãªå®Ÿè£… */
        #washiBg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(253, 251, 248, 0.7), rgba(253, 251, 248, 0.7)),
                              url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEUAAAD7+/v8/Pz9/f3+/v7////09PT19fX29vb39/f4+Pj5+fn6+vr7+7u8vLy9vb2+vr6/v7/AwMDExMTFxcXGxsbHx8fIyMjJycnKysrLy8vMzMzYIovPAAAAGXRSTlMAGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGCmOshsAAAEQSURBVDjLpZPZDsIgEEVBRREU933Bff//p20C7SAdS9InX86ZOxXw9T80fXmUoYgI5UvX18R0fU0MV9fEfHVNzFfXREhERAREfER8RExEREREZEREZEREZkRkRkRmRkRmZkZmZmZkZmZm5mZmdmZmxmZmxmZm5mZmdmZmZmZmZmbmZmbmZmbmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZueU/yP5A3qOAYWfR4+sAAAAAElFTkSuQmCC");
            background-repeat: repeat;
            opacity: 0; z-index: -1;
            transition: opacity 1.2s ease;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; box-sizing: border-box; position: relative; }

        /* [Opening Animation] æ›¸é“é“å…·ã®é…ç½®ã‚’æ¨¡ã—ãŸã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ãªç™»å ´ */
        .reveal-item { opacity: 0; transform: translateY(15px); }
        .reveal-active { animation: revealEffect 0.8s forwards cubic-bezier(0.25, 0.1, 0.25, 1.0); }
        @keyframes revealEffect { to { opacity: 1; transform: translateY(0); } }

        /* [Header & Titles] */
        .header { text-align: center; margin-bottom: 50px; }
        .logo-main { width: 180px; }
        .main-title-area { text-align: center; margin-bottom: var(--group-margin); }
        .main-title { font-size: 1.8rem; font-weight: 700; color: var(--text-black); letter-spacing: 0.08em; font-family: 'Zen Kurenaido', sans-serif; }
        .sub-title-badge { font-size: 0.75rem; color: var(--neutral-border); display: block; margin-top: 5px; margin-bottom: 40px; }

        /* [UI Layout] ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã®æ ã‚’å»ƒæ­¢ã—ã€ç‹¬ç«‹ã—ãŸã‚«ãƒ¼ãƒ‰ã§æ§‹æˆ */
        .home-card, .q-unit {
            background: rgba(255, 255, 255, 0.5); border: 1px solid var(--neutral-border);
            padding: 35px; border-radius: var(--global-radius); margin-bottom: var(--group-margin);
            backdrop-filter: blur(2px);
        }
        
        /* è¨­å•UIï¼šQ1, Q2ãªã©å„è³ªå•ã”ã¨ã«ç‹¬ç«‹ã—ãŸæ ã§æ§‹æˆï¼ˆè¦ä»¶2.2ï¼‰ */
        .q-text { font-size: 0.9rem; font-weight: bold; margin-bottom: 15px; color: var(--progress-track); }

        /* å…¥åŠ›æ¬„ï¼šä¸‹ç·šã®ã¿ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆè¦ä»¶2.2ï¼‰ */
        .input-group label { display: block; font-size: 0.8rem; font-weight: bold; color: var(--progress-track); margin-bottom: 15px; }
        .input-group input { 
            width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid var(--neutral-border); 
            background: transparent; font-size: 1.4rem; outline: none; transition: 0.4s; font-family: inherit;
        }
        .input-group input::placeholder { color: var(--neutral-border); opacity: 0.1; }

        /* [Interactive] å›ç­”æ¼”å‡ºï¼šå¢¨è·¡æ»²ï¼ˆã¼ãã›ãã—ã‚“ï¼‰ã®ã¿ã‚’æ¡ç”¨ï¼ˆè¦ä»¶3.2 / 15pxå¸ç€å»ƒæ­¢ï¼‰ */
        .opt-group { display: flex; gap: 8px; justify-content: space-between; }
        .opt-btn {
            flex: 1; padding: 12px 2px; border: 1px solid var(--neutral-border); background: transparent;
            border-radius: var(--global-radius); cursor: pointer; font-size: 0.8rem; text-align: center; 
            transition: color 0.5s ease, border-color 0.5s ease; position: relative; overflow: hidden; z-index: 1;
        }
        /* 0.8sã‹ã‘ã¦ä¸­å¤®ã‹ã‚‰åºƒãŒã‚‹å¢¨ã®æ»²ã¿æ¼”å‡º */
        .opt-btn::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: radial-gradient(circle, var(--active-highlight) 0%, rgba(87,195,194,0.4) 60%, transparent 100%);
            border-radius: 50%; transform: translate(-50%, -50%) scale(0);
            opacity: 0; z-index: -1; filter: blur(12px);
            transition: transform 0.8s ease-out, opacity 0.3s;
            will-change: transform, opacity;
        }
        .opt-btn.selected { color: #FFF; border-color: var(--active-highlight); }
        .opt-btn.selected::before {
            transform: translate(-50%, -50%) scale(80); /* 0.8sã§æ å†…ã‚’æº€ãŸã™ */
            opacity: 1; border-radius: 0; filter: blur(2px);
        }

        /* [Navigation] Luxury Float é·ç§»æ¼”å‡ºï¼ˆè¦ä»¶3.2ï¼‰ */
        .page-section { position: absolute; top: 0; left: 0; width: 100%; opacity: 0; pointer-events: none; transition: var(--luxury-transition); }
        .page-section.active { opacity: 1; pointer-events: auto; position: relative; }
        .exit-left { transform: translateX(-50px); opacity: 0; }
        .exit-right { transform: translateX(50px); opacity: 0; }
        .enter-down { animation: enterDown var(--luxury-transition) forwards; }
        @keyframes enterDown { 
            0% { transform: translateY(-30px); opacity: 0; } 
            100% { transform: translateY(0); opacity: 1; } 
        }

        /* [Result Area] çµæœç”»é¢ã®æ§‹æˆé †å®ˆï¼ˆè¦ä»¶Dï¼‰ */
        #resultArea { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--mist-background); z-index: 500; overflow-y: auto; padding: 40px 20px; box-sizing: border-box; }
        .save-guide { font-size: 12px; color: var(--neutral-border); margin: 10px 0; font-family: 'Noto Serif JP'; }
        .share-group { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; width: 100%; align-items: center; }
        .btn { width: 75%; padding: 20px; border-radius: var(--global-radius); border: 1px solid var(--neutral-border); font-weight: 700; cursor: pointer; transition: 0.6s; background: rgba(199, 178, 153, 0.2); color: var(--neutral-border); font-family: inherit; }
        .btn.btn-ready { background: var(--active-highlight); color: #FFF; border: none; }

        /* [Output: Cheki Template] ç²¾å¯†ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆè¦ä»¶4.2 / Cï¼‰ */
        #chekiWrapper { position: absolute; left: -9999px; }
        #chekiTemplate { width: 500px; background: #FFF; padding: 40px 40px 140px 40px; border: 1px solid #EEE; text-align: center; position: relative; overflow: visible; }
        .cheki-photo-area { width: 100%; aspect-ratio: 1/1; background: #F8F8F8; position: relative; overflow: visible; border: 1px solid #EAEAEA; }
        
        /* ãƒã‚¹ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ—é¢¨ãƒãƒƒã‚¸ï¼šå·¦å´é–‹å§‹ç‚¹50pxé™ä¸‹ã€è§’åº¦-9Â°ã€æœ€å‰é¢é…ç½®ï¼ˆè¦ä»¶Cï¼‰ */
        .cheki-result-badge { 
            position: absolute; top: 50px; left: -40px; 
            background: rgba(87, 195, 194, 0.9); color: #FFF; padding: 12px 45px; font-size: 32px; font-weight: bold; 
            transform: rotate(-9deg); transform-origin: top left; z-index: 2000;
            clip-path: polygon(0% 12%, 2% 0%, 98% 3%, 100% 15%, 97% 92%, 94% 100%, 5% 98%, 0% 85%);
            box-shadow: 2px 3px 6px rgba(0,0,0,0.15); white-space: nowrap; max-width: 65%;
        }
        .cheki-hashtag { position: absolute; bottom: 15px; right: 20px; font-size: 18px; color: var(--neutral-border); font-family: sans-serif; font-weight: bold; }
        
        /* åå‰ï¼šæ•¬ç§°ãªã—ã€Yusei Magicç‰¹å¤§ãƒ•ã‚©ãƒ³ãƒˆï¼ˆè¦ä»¶Cï¼‰ */
        .cheki-name-area { margin-top: 60px; font-family: 'Yusei Magic', sans-serif; font-size: 64px; color: var(--text-black); line-height: 1; }
        
        /* èª¬æ˜æ–‡ï¼šãƒ–ãƒ©ãƒ³ãƒ‰ãƒ•ã‚©ãƒ³ãƒˆã€å¹…80%ã€ä½™ç™½20pxç¸®å°ï¼ˆè¦ä»¶Cï¼‰ */
        .cheki-description-area { margin: 20px auto 0; margin-bottom: 20px; width: 80%; font-family: 'Noto Serif JP', serif; font-size: 20px; line-height: 1.8; color: var(--text-main); text-align: left; }

        /* [Footer] è‚¥å¤§åŒ–é˜²æ­¢ã®ãŸã‚120pxæŒ‡å®šï¼ˆè¦ä»¶2.2 / Cï¼‰ */
        .site-footer { background: rgba(255, 255, 255, 0.4); border-top: 1px solid rgba(199, 178, 153, 0.2); padding: 60px 20px; text-align: center; font-size: 0.8rem; color: #7F8C8D; }
        .footer-logo-img { width: 120px; margin-bottom: 25px; opacity: 0.7; }

        .hidden { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.4); display: none; z-index: 3000; align-items: flex-start; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: #FFF; width: 92%; height: 75vh; margin-top: 5vh; border-radius: var(--global-radius); padding: 40px 30px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--neutral-border); }
        .policy-body { flex: 1; overflow-y: auto; font-size: 0.85rem; line-height: 2; color: #555; text-align: left; }
    </style>
</head>
<body>
    <div id="logOverlay">Initializing system...</div>
    <div id="washiBg"></div>

    <div class="container">
        <header class="header reveal-item" id="reveal-1">
            <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" alt="K9 Harmony" class="logo-main" onerror="this.alt='K9 Harmony Logo'; console.error('Logo failed to load.');">
        </header>

        <main id="sectionWrap">
            <section class="page-section active" id="page-home">
                <div class="main-title-area reveal-item" id="reveal-2">
                    <h1 class="main-title">æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</h1>
                    <span class="sub-title-badge">ã€ˆK9 Harmony ãƒ‰ãƒƒã‚°ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ç›£ä¿®ã€‰</span>
                    <p class="description-text" style="text-align:center;">æ„›çŠ¬ã®è¡Œå‹•ã‹ã‚‰ã€æ½œåœ¨çš„ãªæ‚©ã¿ã¨<br>æœ€é©ãªçµ†ã®æ·±ã‚æ–¹ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>
                </div>
                <div class="home-card reveal-item" id="reveal-3">
                    <div class="input-group">
                        <label>æ„›çŠ¬ã®åå‰</label>
                        <input type="text" id="dogName" placeholder="ä¾‹ï¼šãƒãƒ" maxlength="10">
                    </div>
                </div>
                <div class="btn-container reveal-item" id="reveal-4">
                    <button class="btn btn-ready" id="startBtn">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
                    <p style="margin-top:25px;"><span id="openPrivacy" style="text-decoration:underline; font-size:0.75rem; cursor:pointer; color:var(--neutral-border);">å€‹äººæƒ…å ±ä¿è­·æ–¹é‡</span></p>
                </div>
            </section>
            
            <section class="page-section" id="page-groupA"><div id="groupA-list"></div><div class="btn-container"><button class="btn" id="toGroupB" disabled>æ¬¡ã¸é€²ã‚€</button></div></section>
            <section class="page-section" id="page-groupB"><div id="groupB-list"></div><div style="display:flex; justify-content:space-between; align-items:center; width:85%; margin:40px auto 0;"><span id="backToA" style="cursor:pointer; font-size:0.8rem; color:var(--neutral-border); text-decoration:underline;">æˆ»ã‚‹</span><button class="btn" id="toGroupC" disabled style="width:75%;">æ¬¡ã¸é€²ã‚€</button></div></section>
            <section class="page-section" id="page-groupC"><div id="groupC-list"></div><div style="display:flex; justify-content:space-between; align-items:center; width:85%; margin:40px auto 0;"><span id="backToB" style="cursor:pointer; font-size:0.8rem; color:var(--neutral-border); text-decoration:underline;">æˆ»ã‚‹</span><button class="btn" id="finishBtn" disabled style="width:75%;">çµæœã‚’è¦‹ã‚‹</button></div></section>
        </main>
    </div>

    <div id="resultArea" class="hidden">
        <div class="q-unit" style="text-align:center; opacity:1;">
            <h2 id="resultTypeTitle" style="color:var(--progress-track); margin-top:0;">è¨ºæ–­çµæœï¼š---</h2>
            <div id="imgOutWrap" style="position:relative; margin:20px 0;">
                <img id="generatedImageOutput" style="width:100%; border:1px solid var(--neutral-border);" alt="Diagnosis Result Image">
                <div class="save-guide">â€»ç”»åƒé•·æŠ¼ã—ã§ä¿å­˜</div>
            </div>
            <div class="share-group">
                <button class="btn btn-ready" id="sendLiffBtn">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã«é€ä¿¡</button>
                <button class="btn" id="shareTargetBtn" style="background:#FFF; color:var(--progress-track);">å‹ã ã¡ã«ã‚·ã‚§ã‚¢ã™ã‚‹</button>
                <p id="backToReload" style="margin-top:20px; cursor:pointer; font-size:0.85rem; color:var(--neutral-border); text-decoration:underline;">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</p>
            </div>
        </div>
    </div>

    <footer class="site-footer reveal-item" id="reveal-5">
        <div class="footer-logo-container">
            <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" class="footer-logo-img" alt="K9 Harmony">
        </div>
        <div class="footer-info">
            <p><strong>K9 Harmony</strong></p>
            <p>ã€’174-0063 æ±äº¬éƒ½æ¿æ©‹åŒºå‰é‡ç”º6-55-1</p>
            <p>070-9043-1109</p>
        </div>
        <div style="margin-top:20px;">&copy; 2025 K9 Harmony</div>
    </footer>

    <div id="chekiWrapper">
        <div id="chekiTemplate">
            <div class="cheki-photo-area">
                <div class="cheki-result-badge" id="tmpl_type">ã‚¿ã‚¤ãƒ—å</div>
                <div style="font-size:100px; margin-top:60px;">ğŸ¾</div>
                <div class="cheki-hashtag">#K9Harmony #æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</div>
            </div>
            <div class="cheki-name-area" id="tmpl_name">åå‰</div>
            <div class="cheki-description-area" id="tmpl_desc">èª¬æ˜æ–‡</div>
        </div>
    </div>

    <div class="modal" id="privacyModal"><div class="modal-content"><div id="policyContent" class="policy-body"></div><div id="closePrivacy" style="margin-top:20px; text-align:center; padding:15px; background:var(--mist-background); cursor:pointer;">é–‰ã˜ã‚‹</div></div></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
/**
 * [K9 Harmony Logic v5.10]
 * 10å¹´å¾Œã®ä¿å®ˆæ€§ã‚’æ­£ç¾©ã¨ã—ã€å…¨æŒ‡ç¤ºã‚’å®Œå…¨çµ±åˆã€‚
 * ä¸¦è¡Œãƒ­ãƒ¼ãƒ‰ã€å¢¨è·¡æ»²æ¼”å‡ºã€ãƒã‚§ã‚­å‡ºåŠ›ã€LIFF APIã®çµ±åˆç®¡ç†ã‚’æ‹…å½“ã€‚
 */
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec"
};

let MASTER_QUESTIONS = [];
let MASTER_RESULTS = [];
let state = { userId: null, dogName: "", answers: {}, typeName: "" };

/**
 * [Logger] é–‹ç™ºãƒ»é‹ç”¨æ™‚ã®ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã€
 * ãƒ­ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŠã‚ˆã³ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸æ°¸ç¶šçš„ã«å‡ºåŠ›ã™ã‚‹ã€‚
 */
function log(msg) {
    const ts = new Date().toLocaleTimeString();
    const overlay = document.getElementById('logOverlay');
    if(overlay) overlay.innerText = `[${ts}] ${msg}`;
    console.log(`[SYS_LOG] ${ts}: ${msg}`);
}

/**
 * [Data Service] GAS/ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’éåŒæœŸå–å¾—ã™ã‚‹ã€‚
 * è¦ä»¶3.1ã«åŸºã¥ãã€æ¼”å‡ºä¸­ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
 */
async function fetchMasterData() {
    log("Master data loading started...");
    try {
        const res = await fetch(`${CONFIG.GAS_URL}?action=fetchMaster`);
        const data = await res.json();
        MASTER_QUESTIONS = data.questions;
        MASTER_RESULTS = data.results;
        log("Master data loaded successfully.");
    } catch (e) { 
        log("Data sync failed. Please check network."); 
        console.error("Fetch error:", e);
    }
}

/**
 * [UX Service] èµ·å‹•æ™‚1.2ç§’ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ¼”å‡ºã€‚
 * èƒŒæ™¯ã€é›²é¾ç´™ã€ãƒ­ã‚´ã€ã‚¿ã‚¤ãƒˆãƒ«ã®é †ã§ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ã«ç™»å ´ã•ã›ã‚‹ã€‚
 */
async function startOpeningSequence() {
    log("Opening sequence started...");
    document.getElementById('washiBg').style.opacity = 1;
    const timeline = [1,2,3,4,5].map(n => new Promise(r => {
        setTimeout(() => {
            const el = document.getElementById(`reveal-${n}`);
            if(el) el.classList.add('reveal-active');
            r();
        }, 200 * n);
    }));
    // æ¼”å‡ºå®Œäº†ã¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿã™ã‚‹
    await Promise.all([...timeline, initLiff()]);
    log("System ready for user interaction.");
}

/** [LIFF Service] LINEãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¸ã®æ¥ç¶šãŠã‚ˆã³ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾— */
async function initLiff() {
    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        state.userId = liff.getDecodedIDToken().sub;
        log("LIFF context initialized.");
    } catch (e) { 
        log("LIFF Init Failed. Check LIFF ID configuration."); 
    }
}

/**
 * [UI Service] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®è³ªå•ã‚«ãƒ¼ãƒ‰ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹ã€‚
 * å¢¨è·¡æ»²æ¼”å‡ºï¼ˆè¦ä»¶3.2ï¼‰ã‚’å†…åŒ…ã—ãŸãƒœã‚¿ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
 */
function buildSection(group, targetId) {
    const container = document.getElementById(targetId);
    if(!container) return;
    container.innerHTML = '';
    
    MASTER_QUESTIONS.filter(q => q.Section === group).forEach(q => {
        const div = document.createElement('div');
        div.className = (group === 'A') ? 'q-unit section-a-font' : 'q-unit';
        div.style.opacity = 1;
        div.innerHTML = `<div class="q-text">${q.Text}</div>`;
        
        const optGroup = document.createElement('div');
        optGroup.className = 'opt-group';
        
        const options = [
            {t: q.OptA_Text, s: q.OptA_Score},
            {t: q.OptB_Text, s: q.OptB_Score},
            {t: q.OptC_Text, s: q.OptC_Score}
        ];

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn'; 
            btn.innerText = opt.t;
            btn.onclick = () => {
                optGroup.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                state.answers[q.QuestionID] = opt.s;
                checkReady(group);
            };
            optGroup.appendChild(btn);
        });
        div.appendChild(optGroup); 
        container.appendChild(div);
    });
}

/** [UI Service] ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å…¨è³ªå•ã¸ã®å›ç­”ã‚’ç¢ºèªã—ã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ */
function checkReady(group) {
    const qCount = MASTER_QUESTIONS.filter(q => q.Section === group).length;
    const answeredCount = MASTER_QUESTIONS.filter(q => q.Section === group && state.answers[q.QuestionID] !== undefined).length;
    
    if (qCount === answeredCount) {
        const btnMap = { 'A': 'toGroupB', 'B': 'toGroupC', 'C': 'finishBtn' };
        const btn = document.getElementById(btnMap[group]);
        if(btn) {
            btn.disabled = false; 
            btn.classList.add('btn-ready');
        }
    }
}

/** [Navigation Service] Luxury Floatï¼ˆè¦ä»¶3.2ï¼‰ã«åŸºã¥ãç”»é¢é·ç§»ã®åˆ¶å¾¡ */
function navigate(fromId, toId, direction) {
    const fromEl = document.getElementById(fromId);
    const toEl = document.getElementById(toId);
    if(!fromEl || !toEl) return;

    fromEl.classList.remove('active');
    fromEl.classList.add(direction === 'next' ? 'exit-left' : 'exit-right');
    
    setTimeout(() => {
        fromEl.classList.add('hidden'); 
        fromEl.classList.remove('exit-left', 'exit-right');
        toEl.classList.remove('hidden'); 
        void toEl.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶ã«ã‚ˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç«
        toEl.classList.add('active', 'enter-down');
    }, 400);
}

/**
 * [Core Service] 3+3+1ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ãã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã€ã‚¿ã‚¤ãƒ—åˆ¤å®šã€
 * ãŠã‚ˆã³ html2canvas ã«ã‚ˆã‚‹ãƒã‚§ã‚­ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œã™ã‚‹ã€‚
 */
async function processFinal() {
    log("Finalizing results and rendering image...");
    
    // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆè¦ä»¶3.1ï¼‰
    const sX = (state.answers[1] || 0) + (state.answers[2] || 0) + (state.answers[3] || 0);
    const sY = (state.answers[4] || 0) + (state.answers[5] || 0) + (state.answers[6] || 0);
    const c = state.answers[7] || 0;

    // åˆ¤å®šãƒ¬ãƒ³ã‚¸ã¨å¢ƒç•Œå€¤ã‚·ãƒ•ãƒˆï¼ˆè¦ä»¶3.2ï¼‰
    const getRange = (s) => (s <= 12 ? 'LOW' : s <= 111 ? 'MID' : 'HIGH');
    let rX = getRange(sX), rY = getRange(sY);
    
    if ((sX === 12 || sX === 13) && c !== 0) {
        if (c === 1 && rX === 'LOW') rX = 'MID';
        if (c === -1 && rX === 'MID') rX = 'LOW';
    }
    if ((sX === 111 || sX === 112) && c !== 0) {
        if (c === 1 && rX === 'MID') rX = 'HIGH';
        if (c === -1 && rX === 'HIGH') rX = 'MID';
    }

    const result = MASTER_RESULTS.find(r => r.TypeKey === `${rX}_${rY}`);
    state.typeName = result ? result.TypeName + "ã‚¿ã‚¤ãƒ—" : "åˆ¤å®šä¸èƒ½";

    // UIè¡¨ç¤ºã®æ›´æ–°
    document.getElementById('resultArea').classList.remove('hidden');
    document.getElementById('resultTypeTitle').innerText = `è¨ºæ–­çµæœï¼š${state.typeName}`;
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæµã—è¾¼ã¿
    document.getElementById('tmpl_type').innerText = state.typeName;
    document.getElementById('tmpl_name').innerText = state.dogName;
    document.getElementById('tmpl_desc').innerText = result ? result.Description : "";

    // ç”»åƒç”Ÿæˆï¼ˆè¦ä»¶C / 4.2ï¼‰
    await document.fonts.ready;
    const canvasOptions = { scale: 2, useCORS: true, backgroundColor: null };
    html2canvas(document.getElementById('chekiTemplate'), canvasOptions).then(canvas => {
        document.getElementById('generatedImageOutput').src = canvas.toDataURL("image/png");
        log("Result image generated successfully.");
    });

    // ãƒ­ã‚°è¨˜éŒ²ãŠã‚ˆã³è§£æï¼ˆè¦ä»¶4.2 / 5ï¼‰
    gtag('event', 'diagnosis_complete', { 'type': state.typeName });
    fetch(CONFIG.GAS_URL, { 
        method: 'POST', 
        mode: 'no-cors', 
        body: JSON.stringify({ uid: state.userId, dogName: state.dogName, scoreX: sX, scoreY: sY, resultType: state.typeName }) 
    });
}

/** [Entry Point] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸèµ·å‹•ãƒ—ãƒ­ã‚»ã‚¹ */
function init() {
    log("System bootstrap...");
    fetchMasterData(); // ãƒ­ãƒ¼ãƒ‰é–‹å§‹
    startOpeningSequence(); // æ¼”å‡ºé–‹å§‹

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å …ç‰¢ãªç´ä»˜ã‘
    document.getElementById('startBtn').onclick = () => {
        state.dogName = document.getElementById('dogName').value.trim();
        if (!state.dogName) return alert("ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„");
        buildSection('A', 'groupA-list'); navigate('page-home', 'page-groupA', 'next');
        gtag('event', 'diagnosis_start');
    };

    document.getElementById('toGroupB').onclick = () => { buildSection('B', 'groupB-list'); navigate('page-groupA', 'page-groupB', 'next'); gtag('event', 'question_complete', { step: 1 }); };
    document.getElementById('toGroupC').onclick = () => { buildSection('C', 'groupC-list'); navigate('page-groupB', 'page-groupC', 'next'); gtag('event', 'question_complete', { step: 2 }); };
    document.getElementById('backToA').onclick = () => navigate('page-groupB', 'page-groupA', 'back');
    document.getElementById('backToB').onclick = () => navigate('page-groupC', 'page-groupB', 'back');
    document.getElementById('finishBtn').onclick = processFinal;
    document.getElementById('backToReload').onclick = () => location.reload();

    // LIFF ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    document.getElementById('sendLiffBtn').onclick = () => {
        if (!liff.isInClient()) return alert("LINEã‚¢ãƒ—ãƒªå†…ã§å®Ÿè¡Œã—ã¦ãã ã•ã„");
        liff.sendMessages([{ type: 'text', text: `${state.dogName}ã®è¨ºæ–­çµæœã¯ã€Œ${state.typeName}ã€ã§ã—ãŸï¼ğŸ¾` }])
            .then(() => liff.closeWindow()).catch(e => log("Message send failed."));
    };
    document.getElementById('shareTargetBtn').onclick = () => {
        if (liff.isApiAvailable('shareTargetPicker')) {
            liff.shareTargetPicker([{ type: 'text', text: `${state.dogName}ã®è¨ºæ–­çµæœã¯ã€Œ${state.typeName}ã€ï¼ #K9Harmony #æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­` }])
                .then(res => { if(res) log("Shared successfully."); }).catch(e => log("Share failed."));
        } else {
            alert("ã‚·ã‚§ã‚¢æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");
        }
    };

    // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
    document.getElementById('openPrivacy').onclick = () => { document.getElementById('policyContent').innerText = "K9 Harmony ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼å…¨æ–‡..."; document.getElementById('privacyModal').style.display = 'flex'; };
    document.getElementById('closePrivacy').onclick = () => { document.getElementById('privacyModal').style.display = 'none'; };
}

// å®Ÿè¡Œé–‹å§‹
init();
</script>
</body>
</html>
