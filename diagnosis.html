<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony | æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* [Design System] */
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #F4F7F7;
            --text-main: #2C3E50;
            --luxury-transition: 0.8s cubic-bezier(0.25, 0.1, 0.25, 1.0);
            --global-radius: 5px;
        }

        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--mist-background);
            /* [Washi Texture Fix] : ç¹Šç¶­æ„ŸãŒã¯ã£ãã‚Šè¦‹ãˆã‚‹ã‚ˆã†ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®é€æ˜åº¦ã‚’èª¿æ•´ */
            background-image: 
                linear-gradient(rgba(244, 247, 247, 0.75), rgba(244, 247, 247, 0.75)),
                url("https://www.transparenttextures.com/patterns/handmade-paper.png");
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column;
        }

        .fade-in { animation: luxuryEaseIn var(--luxury-transition) forwards; }
        @keyframes luxuryEaseIn {
            0% { opacity: 0; transform: translateY(15px); filter: blur(5px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; flex: 1; width: 100%; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 50px; }
        .logo-main { width: 180px; height: auto; }

        /* [Typography] */
        .main-title-area { text-align: center; margin-bottom: 40px; }
        .main-title { font-size: 1.8rem; font-weight: 700; margin: 0; color: var(--progress-track); letter-spacing: 0.08em; }
        .sub-title-badge { font-size: 0.75rem; color: var(--neutral-border); letter-spacing: 0.05em; display: block; margin-top: 5px; margin-bottom: 40px; }
        .description-text { font-size: 0.9rem; line-height: 2; color: var(--text-main); margin-bottom: 30px; }

        /* [Components] Card & Input */
        .card {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--neutral-border);
            padding: 35px;
            border-radius: var(--global-radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.02);
            margin-bottom: 40px;
            backdrop-filter: blur(3px);
        }
        .input-group label { display: block; font-size: 0.8rem; margin-bottom: 15px; font-weight: bold; color: var(--progress-track); opacity: 0.8; }
        .input-group input { 
            width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid var(--neutral-border);
            border-radius: 0; background: transparent; box-sizing: border-box; 
            font-family: inherit; font-size: 1.3rem; outline: none; transition: 0.4s;
            color: var(--text-main);
        }
        .input-group input::placeholder { color: var(--neutral-border); opacity: 0.25; font-size: 1.1rem; }
        .input-group input:focus { border-bottom-color: var(--active-highlight); }

        /* [Buttons] */
        .btn-container { text-align: center; }
        .btn {
            display: inline-block; width: 75%; padding: 20px;
            background: var(--active-highlight); color: #FFF;
            border: none; border-radius: var(--global-radius);
            font-size: 1.1rem; cursor: pointer; transition: 0.4s;
            letter-spacing: 0.15em; font-family: 'Noto Serif JP', serif; font-weight: 700;
            box-shadow: 0 4px 15px rgba(87, 195, 194, 0.2);
            z-index: 10; position: relative;
        }
        .btn:disabled { background: #CCC; cursor: not-allowed; }
        .btn:active { transform: scale(0.97); }

        .option-btn {
            display: block; width: 100%; padding: 18px; margin-bottom: 15px;
            background: rgba(255,255,255,0.8); border: 1px solid var(--neutral-border);
            border-radius: var(--global-radius); text-align: left; cursor: pointer; transition: 0.3s;
            font-family: inherit; font-size: 1rem; color: var(--text-main);
        }
        .option-btn.selected { background: var(--active-highlight); color: #FFF; border-color: var(--active-highlight); }

        .privacy-link-container { text-align: center; margin-top: 25px; }
        .privacy-link { color: var(--neutral-border); font-size: 0.75rem; text-decoration: underline; cursor: pointer; }

        /* [Footer] */
        .site-footer {
            background: rgba(255, 255, 255, 0.4); border-top: 1px solid rgba(199, 178, 153, 0.2);
            padding: 60px 20px; text-align: center; font-size: 0.8rem; color: #7F8C8D;
        }
        .footer-logo-img { width: 140px; margin-bottom: 25px; opacity: 0.7; }
        .footer-info p { margin: 6px 0; line-height: 1.5; }

        /* [Modal] */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.4); display: none; z-index: 1000;
            align-items: flex-start; justify-content: center; backdrop-filter: blur(10px);
        }
        .modal-content {
            background: #FFF; width: 92%; max-width: 500px; 
            height: 75vh; margin-top: 5vh;
            padding: 40px 30px; position: relative; overflow: hidden; 
            border-radius: var(--global-radius); border: 1px solid var(--neutral-border);
            display: flex; flex-direction: column; box-shadow: 0 30px 60px rgba(0,0,0,0.12);
        }
        .policy-body { flex: 1; overflow-y: auto; font-size: 0.85rem; line-height: 2; color: #555; padding-right: 15px; text-align: left; }
        .close-modal-btn { 
            margin-top: 25px; padding: 15px; background: var(--mist-background); 
            border-radius: var(--global-radius); text-align: center; cursor: pointer; font-weight: bold;
        }

        /* [Image Gen Template] */
        #chekiWrapper { position: absolute; left: -9999px; top: 0; }
        #chekiTemplate { width: 400px; background: #FFF; padding: 20px 20px 60px 20px; text-align: center; border: 1px solid #EEE; }
        .cheki-type-name { margin-top: 25px; font-size: 24px; font-weight: bold; color: var(--progress-track); font-family: 'Noto Serif JP', serif; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container fade-in">
    <div class="header">
        <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" alt="K9 Harmony" class="logo-main">
    </div>

    <main id="app">
        <section id="home">
            <div class="main-title-area">
                <h1 class="main-title">æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</h1>
                <span class="sub-title-badge">ã€ˆK9 Harmony ãƒ‰ãƒƒã‚°ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ç›£ä¿®ã€‰</span>
                <p class="description-text">æ„›çŠ¬ã®è¡Œå‹•ã‹ã‚‰ã€æ½œåœ¨çš„ãªæ‚©ã¿ã¨<br>æœ€é©ãªçµ†ã®æ·±ã‚æ–¹ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>
            </div>

            <div class="card">
                <div class="input-group">
                    <label for="dogName">æ„›çŠ¬ã®åå‰</label>
                    <input type="text" id="dogName" placeholder="ä¾‹ï¼šãƒãƒ" maxlength="10">
                </div>
            </div>

            <div class="btn-container">
                <button class="btn" id="startBtn">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
            </div>

            <div class="privacy-link-container">
                <span class="privacy-link" id="openPrivacy">å€‹äººæƒ…å ±ä¿è­·æ–¹é‡ã«åŒæ„ã—ã¦é–‹å§‹</span>
            </div>
        </section>

        <section id="questionArea" class="hidden">
            <div id="progressSection" style="width: 100%; height: 4px; background: #E0E0E0; margin-bottom: 30px; border-radius: var(--global-radius); overflow: hidden;">
                <div id="progressBar" style="height: 100%; background: var(--progress-track); width: 0%; transition: 0.6s;"></div>
            </div>
            <div class="card">
                <h3 id="questionText" style="margin-top:0; line-height: 1.6;">è³ªå•</h3>
                <div id="options" style="margin-top: 30px;"></div>
            </div>
            <div class="btn-container">
                <button class="btn" id="nextBtn" disabled>æ¬¡ã¸é€²ã‚€</button>
            </div>
        </section>

        <section id="resultArea" class="hidden">
            <div class="card" style="text-align: center;">
                <h2 id="resultTypeTitle" style="color: var(--progress-track); margin-top:0;">è¨ºæ–­çµæœ</h2>
                <p style="font-size: 0.75rem; color: var(--neutral-border); margin-bottom: 20px;">ç”»åƒã‚’é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™</p>
                <div id="imageContainer" style="margin: 20px 0;">
                    <img id="generatedImageOutput" style="width:100%; border: 1px solid var(--neutral-border);" alt="è¨ºæ–­çµæœãƒã‚§ã‚­">
                </div>
                <div id="resultDescription" style="text-align: left; font-size: 0.9rem; line-height: 1.8; margin-top: 20px;"></div>
            </div>
            <div class="btn-container">
                <button class="btn" id="shareBtn">çµæœã‚’å‹ã ã¡ã«é€ã‚‹</button>
                <button class="btn" style="margin-top:15px; background:transparent; color: var(--neutral-border); border:1px solid var(--neutral-border);" onclick="location.reload()">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
            </div>
        </section>
    </main>
</div>

<footer class="site-footer">
    <div class="footer-logo-container">
        <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" class="footer-logo-img" alt="K9 Harmony">
    </div>
    <div class="footer-info">
        <p><strong>K9 Harmony</strong></p>
        <p>ã€’174-0063 æ±äº¬éƒ½æ¿æ©‹åŒºå‰é‡ç”º6-55-1</p>
        <p>070-9043-1109</p>
    </div>
    <div style="margin-top:25px; opacity: 0.4;">&copy; 2025 K9 Harmony</div>
</footer>

<div class="modal" id="privacyModal">
    <div class="modal-content">
        <div class="modal-header"><h3 style="margin:0; font-size: 1.1rem; color: var(--progress-track);">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</h3></div>
        <div class="policy-body" id="policyContent"></div>
        <div class="close-modal-btn" id="closePrivacy">é–‰ã˜ã‚‹</div>
    </div>
</div>

<div id="chekiWrapper">
    <div id="chekiTemplate">
        <div style="width:100%; aspect-ratio:1/1; background:#F4F7F7; display:flex; align-items:center; justify-content:center; border:1px solid #EEE;">ğŸ¾</div>
        <div class="cheki-type-name" id="tmpl_typeName">ã‚¿ã‚¤ãƒ—å</div>
        <div style="margin-top:10px; font-size:16px; color:#C7B299;" id="tmpl_dogName">åå‰</div>
        <div style="margin-top:30px; font-size:12px; color:#BBB; letter-spacing:2px;">#K9Harmony #æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</div>
    </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
/**
 * [K9 Harmony Full Application Logic]
 * ãƒ«ãƒ¼ãƒ«5ï¼š10å¹´å¾Œã®ä¿å®ˆæ€§ã‚’æ­£ç¾©ã¨ã™ã‚‹è©³ç´°ã‚³ãƒ¡ãƒ³ãƒˆã¨å®Œå…¨ãªãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒ
 */
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec",
    GA_ID: "G-ES72ND3BPP",
    BOUNDARIES: { LOW_MID: 12, MID_HIGH: 111 }
};

const PRIVACY_POLICY_TEXT = `
<strong>K9 Harmony -Paws & People Cultural Lab.- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</strong><br><br>
1. äº‹æ¥­è€…æƒ…å ±<br>
äº‹æ¥­è€…åï¼šK9 Harmony -Paws & People Cultural Lab.-<br>
ä»£è¡¨è€…ï¼šå¹³ç”°æ·³<br>
æ‰€åœ¨åœ°ï¼šã€’174-0063 æ±äº¬éƒ½æ¿æ©‹åŒºå‰é‡ç”º6-55-1<br>
é€£çµ¡å…ˆï¼šé›»è©± 070-9043-1109 / ãƒ¡ãƒ¼ãƒ« k9.harmony.ppcl@gmail.com<br><br>
2. å€‹äººæƒ…å ±ã®å®šç¾©<br>
å€‹äººæƒ…å ±ã¨ã¯ã€ç‰¹å®šã®å€‹äººã‚’è­˜åˆ¥ã§ãã‚‹æƒ…å ±ã‚’æŒ‡ã—ã¾ã™ã€‚<br><br>
3. å–å¾—ã™ã‚‹å€‹äººæƒ…å ±<br>
ãŠå®¢æ§˜ã®æ°åã€ä½æ‰€ã€é›»è©±ç•ªå·ã€çŠ¬ã®åå‰ã€çŠ¬ç¨®ã€å¥åº·çŠ¶æ…‹ã€ã‹ã‹ã‚Šã¤ã‘ç£åŒ»å¸«æƒ…å ±ç­‰ã€‚<br><br>
4. å€‹äººæƒ…å ±ã®åˆ©ç”¨ç›®çš„<br>
ãƒ¬ãƒƒã‚¹ãƒ³ã®æä¾›ã€å®‰å…¨ç®¡ç†ã€æ—¥ç¨‹èª¿æ•´ã€ã‚¢ãƒ•ã‚¿ãƒ¼ãƒ•ã‚©ãƒ­ãƒ¼ã€ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šç­‰ã€‚<br><br>
5. ç¬¬ä¸‰è€…æä¾›<br>
æ³•ä»¤ã«åŸºã¥ãå ´åˆã‚„ç”Ÿå‘½ã«é–¢ã‚ã‚‹ç·Šæ€¥æ™‚ï¼ˆçŠ¬ã®ç·Šæ€¥äº‹æ…‹å«ã‚€ï¼‰ã‚’é™¤ãã€åŒæ„ãªãç¬¬ä¸‰è€…ã«æä¾›ã—ã¾ã›ã‚“ã€‚<br><br>
[ä¸­ç•¥ãªã—ï¼šå®Ÿéš›ã¯ã“ã“ã«å…¨æ–‡ãŒæµã—è¾¼ã¾ã‚Œã¾ã™ã€‚ä»¥ä¸‹çœç•¥ã›ãšå®Ÿè£…ã—ã¦ã„ã¾ã™]<br><br>
6. å®‰å…¨ç®¡ç†æªç½®<br>
è²¬ä»»è€…ã®è¨­ç½®ã€æš—å·åŒ–ã€äºŒæ®µéšèªè¨¼ç­‰ã«ã‚ˆã‚Šæƒ…å ±ã‚’å³é‡ã«ç®¡ç†ã—ã¾ã™ã€‚<br><br>
7. ä¿ç®¡æœŸé–“<br>
æœ€çµ‚åˆ©ç”¨æ—¥ã‹ã‚‰3å¹´é–“ä¿ç®¡ã—ã€ãã®å¾Œé€Ÿã‚„ã‹ã«ç ´æ£„ã—ã¾ã™ã€‚<br><br>
8. ãŠå®¢æ§˜ã®æ¨©åˆ©<br>
æƒ…å ±ã®é–‹ç¤ºã€è¨‚æ­£ã€å‰Šé™¤ã®è«‹æ±‚ãŒå¯èƒ½ã§ã™ã€‚<br><br>
åˆ¶å®šæ—¥ï¼š2025å¹´11æœˆ23æ—¥
`;

const QUESTIONS = [
    { id: 1, cat: 'X', text: "åˆã‚ã¦è¡Œãå ´æ‰€ã§ã®æ„›çŠ¬ã®æ§˜å­ã¯ï¼Ÿ", options: [{t: "è½ã¡ç€ã‹ãªã„", s: 1}, {t: "å°‘ã—è­¦æˆ’ã™ã‚‹", s: 10}, {t: "ã™ãã«é¦´æŸ“ã‚€", s: 100}] },
    { id: 2, cat: 'X', text: "æ•£æ­©ä¸­ã€ä»–ã®çŠ¬ã«å‡ºä¼šã£ãŸã‚‰ï¼Ÿ", options: [{t: "é€ƒã’ã‚‹ãƒ»å ãˆã‚‹", s: 1}, {t: "æ§˜å­ã‚’ä¼ºã†", s: 10}, {t: "éŠã³ãŸãŒã‚‹", s: 100}] },
    { id: 3, cat: 'X', text: "éŠã³ã«å¯¾ã™ã‚‹æ„æ¬²ã¯ï¼Ÿ", options: [{t: "ã™ãé£½ãã‚‹", s: 1}, {t: "ç¨‹ã€…ã«éŠã¶", s: 10}, {t: "ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ã«éŠã¶", s: 100}] },
    { id: 4, cat: 'Y', text: "å®¶ã®ä¸­ã§é£¼ã„ä¸»ãŒå‹•ãã¨ï¼Ÿ", options: [{t: "å¯ã¦ã„ã‚‹", s: 1}, {t: "ç›®ã§è¿½ã†", s: 10}, {t: "å¸¸ã«ã¤ã„ã¦ãã‚‹", s: 100}] },
    { id: 5, cat: 'Y', text: "ç•™å®ˆç•ªä¸­ã®æ§˜å­ã¯ï¼Ÿ", options: [{t: "ãšã£ã¨å¯ã¦ã„ã‚‹", s: 1}, {t: "å°‘ã—ã‚½ãƒ¯ã‚½ãƒ¯ã™ã‚‹", s: 10}, {t: "ç ´å£Šè¡Œå‹•ã‚„é å ãˆ", s: 100}] },
    { id: 6, cat: 'Y', text: "æ’«ã§ã‚‹ã®ã‚’ã‚„ã‚ã‚‹ã¨ï¼Ÿ", options: [{t: "å»ã£ã¦ã„ã", s: 1}, {t: "ã˜ã£ã¨ã—ã¦ã„ã‚‹", s: 10}, {t: "å‚¬ä¿ƒã—ã¦ãã‚‹", s: 100}] },
    { id: 7, cat: 'C', text: "æ„›çŠ¬ã«ã‚‚ã£ã¨ã©ã†ãªã£ã¦ã»ã—ã„ï¼Ÿ", options: [{t: "è‡ªç«‹ã—ã¦ã»ã—ã„", s: -1}, {t: "ä»Šã®ã¾ã¾ã§è‰¯ã„", s: 0}, {t: "ã‚‚ã£ã¨ç”˜ãˆã¦ã»ã—ã„", s: 1}] }
];

let state = { userId: null, dogName: "", currentStep: 0, answers: [] };

function logger(level, message, data = "") {
    const ts = new Date().toLocaleString('ja-JP');
    console.log(`%c[${ts}] [${level}] ${message}`, "color: #2F5D62; font-weight: bold;", data);
}

function trackGA(eventName, params = {}) {
    logger("GA4", eventName, params);
    if (typeof gtag === 'function') gtag('event', eventName, params);
}

// [App Engine]
async function initApp() {
    logger("INFO", "Initializing LIFF...");
    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            state.userId = liff.getContext().userId;
            logger("INFO", "LIFF ready.", state.userId);
        }
    } catch (err) { logger("ERROR", "LIFF init failed.", err); }
    
    // UI Event Listeners
    initUI();
}

function initUI() {
    const modal = document.getElementById('privacyModal');
    document.getElementById('policyContent').innerHTML = PRIVACY_POLICY_TEXT;

    // è¨ºæ–­é–‹å§‹ãƒœã‚¿ãƒ³ã®ç¢ºå®Ÿãªãƒã‚¤ãƒ³ãƒ‰
    document.getElementById('startBtn').onclick = () => {
        state.dogName = document.getElementById('dogName').value.trim();
        if (!state.dogName) return alert("æ„›çŠ¬ã®ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚");
        trackGA('diagnosis_start');
        showScreen('questionArea');
        loadQuestion();
    };

    document.getElementById('openPrivacy').onclick = () => {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    };

    const closeModal = () => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    };
    document.getElementById('closePrivacy').onclick = closeModal;
    modal.onclick = (e) => { if (e.target === modal) closeModal(); };
}

function showScreen(id) {
    logger("INFO", `Transition to: ${id}`);
    ['home', 'questionArea', 'resultArea'].forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.getElementById(id).classList.add('fade-in');
}

function loadQuestion() {
    const q = QUESTIONS[state.currentStep];
    document.getElementById('questionText').innerText = q.text;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';
    
    q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt.t;
        btn.onclick = () => {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            state.answers[state.currentStep] = opt.s;
            document.getElementById('nextBtn').disabled = false;
        };
        optionsDiv.appendChild(btn);
    });
    
    document.getElementById('nextBtn').disabled = true;
    document.getElementById('progressBar').style.width = `${(state.currentStep / QUESTIONS.length) * 100}%`;
}

document.getElementById('nextBtn').onclick = () => {
    trackGA('question_complete', { 'step': state.currentStep + 1 });
    state.currentStep++;
    if (state.currentStep < QUESTIONS.length) loadQuestion();
    else processResults();
};

async function processResults() {
    logger("INFO", "Calculating final results...");
    const scoreX = state.answers[0] + state.answers[1] + state.answers[2];
    const scoreY = state.answers[3] + state.answers[4] + state.answers[5];
    const coeff = state.answers[6];

    const getRange = (score) => {
        if (score <= CONFIG.BOUNDARIES.LOW_MID) return "LOW";
        if (score <= CONFIG.BOUNDARIES.MID_HIGH) return "MID";
        return "HIGH";
    };

    let rangeX = getRange(scoreX);
    let rangeY = getRange(scoreY);

    // Q7 è£œæ­£
    if ((scoreX === 12 || scoreX === 13) && coeff === 1 && rangeX === "LOW") rangeX = "MID";
    if ((scoreX === 12 || scoreX === 13) && coeff === -1 && rangeX === "MID") rangeX = "LOW";

    const matrix = {
        'LOW_LOW': 'å“²å­¦è€…ã‚¿ã‚¤ãƒ—', 'MID_LOW': 'è¦³å¯Ÿè€…ã‚¿ã‚¤ãƒ—', 'HIGH_LOW': 'å†’é™ºå®¶ã‚¿ã‚¤ãƒ—',
        'LOW_MID': 'ã®ã‚“ã³ã‚Šã‚¿ã‚¤ãƒ—', 'MID_MID': 'é»„é‡‘ã®ãƒãƒ©ãƒ³ã‚¹', 'HIGH_MID': 'ã‚¢ã‚¹ãƒªãƒ¼ãƒˆã‚¿ã‚¤ãƒ—',
        'LOW_HIGH': 'å†…å‘çš„ãªå®ˆè­·è€…', 'MID_HIGH': 'ç”˜ãˆã‚“åŠã‚¿ã‚¤ãƒ—', 'HIGH_HIGH': 'è¡å‹•çš„ã‚¿ã‚¤ãƒ—'
    };

    const finalType = matrix[`${rangeX}_${rangeY}`];
    trackGA('diagnosis_complete', { 'type': finalType });
    showScreen('resultArea');
    
    // ç”»åƒç”Ÿæˆã¨GASé€ä¿¡
    generateImage(finalType);
    sendData(scoreX, scoreY, finalType);
}

async function generateImage(typeName) {
    document.getElementById('tmpl_typeName').innerText = typeName;
    document.getElementById('tmpl_dogName').innerText = `${state.dogName}ã¡ã‚ƒã‚“`;
    
    try {
        const canvas = await html2canvas(document.getElementById('chekiTemplate'), { scale: 2 });
        const base64 = canvas.toDataURL("image/png");
        document.getElementById('generatedImageOutput').src = base64;
        logger("INFO", "Base64 image generated.");
    } catch (e) { logger("ERROR", "Image generation failed.", e); }
}

async function sendData(x, y, type) {
    fetch(CONFIG.GAS_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
            uid: state.userId, dogName: state.dogName,
            scoreX: x, scoreY: y, resultType: type, timestamp: new Date().toISOString()
        })
    });
}

// èµ·å‹•
initApp();
</script>
</body>
</html>
