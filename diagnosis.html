<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K9 Harmony | æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Yusei+Magic&display=swap" rel="stylesheet">

    <style>
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #FDFBF8;
            --text-main: #2C3E50;
            --text-black: #000000;
            --luxury-transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            --global-radius: 5px;
            --group-margin: 40px;
        }

        /* [Visual Fix] èƒŒæ™¯å®Ÿè£…ï¼šSVGåŸ‹ã‚è¾¼ã¿å‹å’Œç´™ãƒ†ã‚¯ã‚¹ãƒãƒ£ï¼ˆå¤–éƒ¨é€šä¿¡ä¸è¦ãƒ»ç¢ºå®Ÿå®Ÿè£…ï¼‰ */
        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--mist-background);
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* æ¥µã‚ã¦è»½é‡ãªSVGãƒã‚¤ã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åŸ‹ã‚è¾¼ã¿ã€‚ã“ã‚Œã«ã‚ˆã‚Šç”»åƒè½ã¡ã‚’é˜²ã */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: -1;
        }

        #logOverlay {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(47, 93, 98, 0.9);
            color: #FFF; font-size: 10px; padding: 6px 10px; z-index: 9999; pointer-events: none;
            font-family: monospace;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; position: relative; }

        /* [Animations] */
        .reveal-item { opacity: 0; transform: translateY(15px); }
        .reveal-active { animation: revealEffect 0.8s forwards ease-out; }
        @keyframes revealEffect { to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; margin-bottom: 50px; }
        .logo-main { width: 180px; }

        .main-title { font-size: 1.8rem; font-weight: 700; color: var(--progress-track); text-align: center; margin: 0; }
        .sub-title-badge { font-size: 0.75rem; color: var(--neutral-border); display: block; text-align: center; margin-top: 8px; margin-bottom: 40px; }

        /* [Question UI] */
        .q-unit {
            background: rgba(255, 255, 255, 0.7); border: 1px solid var(--neutral-border);
            padding: 25px 20px; border-radius: var(--global-radius); margin-bottom: var(--group-margin);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .q-text { font-size: 0.95rem; font-weight: bold; margin-bottom: 20px; color: var(--progress-track); line-height: 1.6; }

        .opt-group { display: flex; gap: 10px; flex-direction: column; }
        .opt-btn {
            padding: 15px; border: 1px solid var(--neutral-border); background: #FFF;
            border-radius: var(--global-radius); cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s ease; text-align: left; position: relative; font-family: inherit;
        }
        .opt-btn.selected { background: var(--active-highlight); color: #FFF; border-color: var(--active-highlight); }

        .home-card { background: rgba(255, 255, 255, 0.6); border: 1px solid var(--neutral-border); padding: 35px; border-radius: var(--global-radius); margin-bottom: 40px; }
        .input-group label { display: block; font-size: 0.85rem; margin-bottom: 12px; font-weight: bold; color: var(--progress-track); }
        .input-group input { 
            width: 100%; padding: 12px 0; border: none; border-bottom: 2px solid var(--neutral-border);
            background: transparent; font-size: 1.4rem; outline: none; font-family: inherit;
        }

        .btn-container { text-align: center; margin-top: 30px; }
        .btn {
            width: 85%; padding: 18px; background: #EEE; color: #999;
            border: none; border-radius: var(--global-radius); font-size: 1.1rem; 
            cursor: pointer; transition: 0.4s; font-family: inherit; font-weight: 700;
        }
        .btn-ready { background: var(--active-highlight) !important; color: #FFF !important; }

        /* [Transitions] */
        .page-section { display: none; opacity: 0; }
        .page-section.active { display: block; animation: fadeIn 0.6s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* [Cheki Result Template] */
        #chekiWrapper { position: absolute; left: -9999px; }
        #chekiTemplate { 
            width: 480px; background: #FFF; padding: 30px 30px 140px 30px; 
            text-align: center; position: relative; border: 1px solid #DDD;
        }
        .cheki-photo-area { 
            width: 100%; aspect-ratio: 1/1; background: #F8F8F8; 
            position: relative; border: 1px solid #EEE; overflow: visible;
        }
        .cheki-result-badge { 
            position: absolute; top: -15px; left: -15px; 
            background: var(--active-highlight); color: #FFF; 
            padding: 12px 30px; font-size: 28px; font-weight: bold; 
            transform: rotate(-9deg); z-index: 100; box-shadow: 4px 4px 10px rgba(0,0,0,0.1);
        }
        .cheki-name-area { margin-top: 60px; font-family: 'Yusei Magic', sans-serif; font-size: 56px; color: #000; }
        .cheki-description-area { margin: 30px auto 0; width: 85%; font-size: 18px; line-height: 1.8; text-align: left; }
        .cheki-hashtag { position: absolute; bottom: 20px; right: 20px; font-size: 14px; color: var(--neutral-border); }

        #resultArea { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #FFF; z-index: 5000; padding: 20px; box-sizing: border-box; overflow-y: auto; display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="logOverlay">é“å…·ã‚’æ•´ãˆã¦ã„ã¾ã™...</div>

    <div class="container">
        <header class="header reveal-item" id="reveal-1">
            <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" alt="K9 Harmony" class="logo-main">
        </header>

        <main id="sectionWrap">
            <section class="page-section active" id="page-home">
                <h1 class="main-title reveal-item" id="reveal-2">æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</h1>
                <span class="sub-title-badge reveal-item" id="reveal-3">ã€ˆK9 Harmony ãƒ‰ãƒƒã‚°ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ç›£ä¿®ã€‰</span>
                
                <div class="home-card reveal-item" id="reveal-4">
                    <div class="input-group">
                        <label>æ„›çŠ¬ã®åå‰ï¼ˆæ•¬ç§°ç•¥ï¼‰</label>
                        <input type="text" id="dogName" placeholder="ä¾‹ï¼šãƒãƒ" maxlength="10">
                    </div>
                </div>
                <div class="btn-container reveal-item" id="reveal-5">
                    <button class="btn btn-ready" id="startBtn">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
                </div>
            </section>

            <section class="page-section" id="page-groupA">
                <div id="groupA-list"></div>
                <div class="btn-container"><button class="btn" id="toGroupB" disabled>æ¬¡ã¸é€²ã‚€</button></div>
            </section>

            <section class="page-section" id="page-groupB">
                <div id="groupB-list"></div>
                <div class="btn-container"><button class="btn" id="toGroupC" disabled>æ¬¡ã¸é€²ã‚€</button></div>
            </section>

            <section class="page-section" id="page-groupC">
                <div id="groupC-list"></div>
                <div class="btn-container"><button class="btn" id="finishBtn" disabled>çµæœã‚’è¦‹ã‚‹</button></div>
            </section>
        </main>
    </div>

    <div id="resultArea">
        <div style="max-width:500px; margin:0 auto; text-align:center;">
            <h2 style="color:var(--progress-track);">è¨ºæ–­å®Œäº†</h2>
            <div id="imageContainer">
                <img id="generatedImageOutput" style="width:100%; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" alt="çµæœãƒã‚§ã‚­">
            </div>
            <button class="btn btn-ready" style="margin-top:30px;" onclick="location.reload()">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
        </div>
    </div>

    <div id="chekiWrapper">
        <div id="chekiTemplate">
            <div class="cheki-photo-area">
                <div class="cheki-result-badge" id="tmpl_type">ã‚¿ã‚¤ãƒ—å</div>
                <div style="font-size:100px; margin-top:60px;">ğŸ¾</div>
                <div class="cheki-hashtag">#K9Harmony #æ€§æ ¼è¨ºæ–­</div>
            </div>
            <div class="cheki-name-area" id="tmpl_name">ãƒãƒ</div>
            <div class="cheki-description-area" id="tmpl_desc">è§£èª¬ãŒå…¥ã‚Šã¾ã™ã€‚</div>
        </div>
    </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec"
};

let MASTER_QUESTIONS = [];
let MASTER_RESULTS = [];
let state = { userId: null, dogName: "", answers: {} };

function log(msg) {
    document.getElementById('logOverlay').innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
}

async function init() {
    log("ç’°å¢ƒã‚’æº–å‚™ä¸­...");
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç«
    document.querySelectorAll('.reveal-item').forEach((el, i) => {
        setTimeout(() => el.classList.add('reveal-active'), i * 150);
    });

    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        state.userId = liff.getContext().userId;
        
        const res = await fetch(`${CONFIG.GAS_URL}?action=fetchMaster`);
        const data = await res.json();
        MASTER_QUESTIONS = data.questions;
        MASTER_RESULTS = data.results;
        
        log("æº–å‚™å®Œäº†");
    } catch (e) {
        log("èµ·å‹•ã‚¨ãƒ©ãƒ¼ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
    }
}

function showPage(id) {
    document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0, 0);
}

function buildSection(group, targetId) {
    const container = document.getElementById(targetId);
    container.innerHTML = `<h2 style="color:var(--progress-track); text-align:center;">STEP ${group}</h2>`;
    
    MASTER_QUESTIONS.filter(q => q.Section === group).forEach(q => {
        const div = document.createElement('div');
        div.className = 'q-unit';
        div.innerHTML = `<div class="q-text">${q.Text}</div>`;
        
        const optGroup = document.createElement('div');
        optGroup.className = 'opt-group';
        
        [
            {t: q.OptA_Text, s: q.OptA_Score},
            {t: q.OptB_Text, s: q.OptB_Score},
            {t: q.OptC_Text, s: q.OptC_Score}
        ].forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt.t;
            btn.onclick = () => {
                optGroup.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                state.answers[q.QuestionID] = opt.s;
                checkProgress(group);
            };
            optGroup.appendChild(btn);
        });
        div.appendChild(optGroup);
        container.appendChild(div);
    });
}

function checkProgress(group) {
    const total = MASTER_QUESTIONS.filter(q => q.Section === group).length;
    const answered = MASTER_QUESTIONS.filter(q => q.Section === group && state.answers[q.QuestionID] !== undefined).length;
    
    if (total === answered) {
        const btnMap = { 'A': 'toGroupB', 'B': 'toGroupC', 'C': 'finishBtn' };
        const btn = document.getElementById(btnMap[group]);
        btn.disabled = false;
        btn.classList.add('btn-ready');
    }
}

async function generateResult() {
    log("çµæœã‚’æãå‡ºã—ä¸­...");
    
    const sX = (state.answers[1]||0) + (state.answers[2]||0) + (state.answers[3]||0);
    const sY = (state.answers[4]||0) + (state.answers[5]||0) + (state.answers[6]||0);
    
    const getRange = (s) => (s <= 12 ? 'LOW' : s <= 111 ? 'MID' : 'HIGH');
    const result = MASTER_RESULTS.find(r => r.TypeKey === `${getRange(sX)}_${getRange(sY)}`) || MASTER_RESULTS[0];
    
    // ãƒã‚§ã‚­ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ›´æ–°
    document.getElementById('tmpl_type').innerText = result.TypeName;
    document.getElementById('tmpl_name').innerText = state.dogName;
    document.getElementById('tmpl_desc').innerText = result.Description;
    
    showPage('resultArea'); // å…ˆã«è¦‹ã›ã¦ã‹ã‚‰æç”»
    document.getElementById('resultArea').style.display = 'block';

    await document.fonts.ready;
    const canvas = await html2canvas(document.getElementById('chekiTemplate'), {
        scale: 2,
        useCORS: true,
        backgroundColor: null
    });
    
    document.getElementById('generatedImageOutput').src = canvas.toDataURL("image/png");
    log("å®Œäº†ã€‚ç”»åƒã‚’é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™ã€‚");

    // GASã¸ãƒ‡ãƒ¼ã‚¿é€ä¿¡
    fetch(CONFIG.GAS_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
            uid: state.userId,
            dogName: state.dogName,
            type: result.TypeName,
            scoreX: sX,
            scoreY: sY
        })
    });
}

// Event Listeners
document.getElementById('startBtn').onclick = () => {
    state.dogName = document.getElementById('dogName').value.trim();
    if (!state.dogName) return alert("ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„");
    buildSection('A', 'groupA-list');
    showPage('page-groupA');
};

document.getElementById('toGroupB').onclick = () => { buildSection('B', 'groupB-list'); showPage('page-groupB'); };
document.getElementById('toGroupC').onclick = () => { buildSection('C', 'groupC-list'); showPage('page-groupC'); };
document.getElementById('finishBtn').onclick = generateResult;

init();
</script>
</body>
</html>
