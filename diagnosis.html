<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony | うちの子診断</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* * [Brand Design System] 
         * ルール5：保守性のための定数定義
         */
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #F4F7F7;
            --text-main: #2C3E50;
            --luxury-transition: 0.8s cubic-bezier(0.25, 0.1, 0.25, 1.0);
        }

        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--mist-background);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .fade-in {
            animation: luxuryEaseIn var(--luxury-transition) forwards;
        }

        @keyframes luxuryEaseIn {
            0% { opacity: 0; transform: translateY(10px); filter: blur(5px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .header { text-align: center; margin-bottom: 40px; }
        /* ルール：相対パス修正 */
        .logo { width: 120px; margin-bottom: 20px; }

        .card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--neutral-border);
            padding: 30px;
            border-radius: 2px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: #E0E0E0;
            margin-bottom: 30px;
        }

        .progress-bar {
            height: 100%;
            background: var(--progress-track);
            width: 0%;
            transition: width 0.6s ease;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 18px;
            background: var(--active-highlight);
            color: #FFF;
            border: none;
            border-radius: 0;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
            text-decoration: none;
            margin-top: 10px;
        }

        .btn:disabled { background: #CCC; cursor: not-allowed; }

        .option-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 12px;
            background: #FFF;
            border: 1px solid var(--neutral-border);
            text-align: left;
            cursor: pointer;
            transition: 0.3s;
        }

        .option-btn.selected {
            background: var(--active-highlight);
            color: #FFF;
            border-color: var(--active-highlight);
        }

        .footer-note {
            font-size: 0.8rem;
            text-align: center;
            margin-top: auto;
            color: #7F8C8D;
            padding-top: 20px;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container fade-in">
    <div class="header">
        <img src="./logo.png" alt="K9 Harmony" class="logo">
    </div>

    <div id="progressSection" class="progress-container hidden">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <main id="app">
        <section id="home">
            <div class="card">
                <h2 style="text-align: center;">うちの子診断</h2>
                <p>愛犬の行動から、潜在的な悩みと最適な絆の深め方を可視化します。</p>
                <div style="margin-top: 20px;">
                    <label>愛犬の名前</label>
                    <input type="text" id="dogName" placeholder="例：ポチ" style="width: 100%; padding: 12px; margin-top: 8px; border: 1px solid var(--neutral-border); box-sizing: border-box;">
                </div>
            </div>
            <button class="btn" id="startBtn">診断を始める</button>
        </section>

        <section id="questionArea" class="hidden">
            <div class="card">
                <h3 id="questionText">質問</h3>
                <div id="options"></div>
            </div>
            <button class="btn" id="nextBtn" disabled>次へ進む</button>
        </section>

        <section id="resultArea" class="hidden">
            <div class="card">
                <h2 id="resultType">判定中...</h2>
                <div id="resultDescription"></div>
            </div>
        </section>
    </main>

    <div class="footer-note">K9 Harmony ドッグトレーナー監修</div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
/**
 * [K9 Harmony Configuration]
 * ルール5：10年後の保守性を支える定義体
 */
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec",
    GA_ID: "G-ES72ND3BPP",
    BOUNDARIES: {
        LOW_MID: 12,
        MID_HIGH: 111
    }
};

const QUESTIONS = [
    { id: 1, cat: 'X', text: "初めて行く場所での愛犬の様子は？", options: [{t: "落ち着かない", s: 1}, {t: "少し警戒する", s: 10}, {t: "すぐに馴染む", s: 100}] },
    { id: 2, cat: 'X', text: "散歩中、他の犬に出会ったら？", options: [{t: "逃げる・吠える", s: 1}, {t: "様子を伺う", s: 10}, {t: "遊びたがる", s: 100}] },
    { id: 3, cat: 'X', text: "遊びに対する意欲は？", options: [{t: "すぐ飽きる", s: 1}, {t: "程々に遊ぶ", s: 10}, {t: "エンドレスに遊ぶ", s: 100}] },
    { id: 4, cat: 'Y', text: "家の中で飼い主が動くと？", options: [{t: "寝ている", s: 1}, {t: "目で追う", s: 10}, {t: "常についてくる", s: 100}] },
    { id: 5, cat: 'Y', text: "留守番中の様子は？", options: [{t: "ずっと寝ている", s: 1}, {t: "少しソワソワする", s: 10}, {t: "破壊行動や遠吠え", s: 100}] },
    { id: 6, cat: 'Y', text: "撫でるのをやめると？", options: [{t: "去っていく", s: 1}, {t: "じっとしている", s: 10}, {t: "催促してくる", s: 100}] },
    { id: 7, cat: 'C', text: "愛犬にもっとどうなってほしい？", options: [{t: "自立してほしい", s: -1}, {t: "今のままで良い", s: 0}, {t: "もっと甘えてほしい", s: 1}] }
];

let state = {
    userId: null,
    dogName: "",
    currentStep: 0,
    answers: []
};

/**
 * [Logging Utility]
 * ルール6：永続的なログスタンプ
 */
function logger(level, message, data = "") {
    const ts = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
    console.log(`%c[${ts}] [${level}] ${message}`, "color: #2F5D62; font-weight: bold;", data);
}

function trackGA(eventName, params = {}) {
    logger("GA4", eventName, params);
    if (typeof gtag === 'function') {
        gtag('event', eventName, params);
    }
}

/**
 * [Diagnosis Logic Engine]
 * Step 3：MECEな判定と境界値シフトの実装
 */
const DIAGNOSIS_ENGINE = {
    
    // スコアからレンジ（LOW/MID/HIGH）を判定する
    getRange: (score, coeff) => {
        let range = "";
        if (score <= CONFIG.BOUNDARIES.LOW_MID) range = "LOW";
        else if (score <= CONFIG.BOUNDARIES.MID_HIGH) range = "MID";
        else range = "HIGH";

        // Q7係数による境界値の心理的シフト（境界値の±1の範囲で発動）
        const isNearLowMid = (score >= CONFIG.BOUNDARIES.LOW_MID && score <= CONFIG.BOUNDARIES.LOW_MID + 1);
        const isNearMidHigh = (score >= CONFIG.BOUNDARIES.MID_HIGH && score <= CONFIG.BOUNDARIES.MID_HIGH + 1);

        if (isNearLowMid && coeff === 1 && range === "LOW") {
            logger("DEBUG", "Q7 Shift Applied: LOW -> MID");
            range = "MID";
        } else if (isNearLowMid && coeff === -1 && range === "MID") {
            logger("DEBUG", "Q7 Shift Applied: MID -> LOW");
            range = "LOW";
        }
        
        return range;
    },

    // 9タイプマトリクス
    matrix: {
        'LOW_LOW': '哲学者タイプ', 'MID_LOW': '観察者タイプ', 'HIGH_LOW': '冒険家タイプ',
        'LOW_MID': 'のんびりタイプ', 'MID_MID': '黄金のバランス', 'HIGH_MID': 'アスリートタイプ',
        'LOW_HIGH': '内向的な守護者', 'MID_HIGH': '甘えん坊タイプ', 'HIGH_HIGH': '衝動的タイプ'
    }
};

async function initApp() {
    logger("INFO", "Initializing application...");
    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            state.userId = liff.getContext().userId;
            logger("INFO", "LIFF initialized successfully.", { userId: state.userId });
        }
    } catch (err) {
        logger("ERROR", "LIFF initialization failed.", err);
    }
}

function showScreen(screenId) {
    ['home', 'questionArea', 'resultArea'].forEach(id => document.getElementById(id).classList.add('hidden'));
    const target = document.getElementById(screenId);
    target.classList.remove('hidden');
    target.classList.add('fade-in');
}

document.getElementById('startBtn').addEventListener('click', () => {
    state.dogName = document.getElementById('dogName').value.trim();
    if (!state.dogName) return alert("愛犬のお名前を教えてください。");
    
    trackGA('diagnosis_start');
    document.getElementById('progressSection').classList.remove('hidden');
    showScreen('questionArea');
    loadQuestion();
});

function loadQuestion() {
    const q = QUESTIONS[state.currentStep];
    document.getElementById('questionText').innerText = q.text;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';
    
    q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt.t;
        btn.onclick = () => {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            state.answers[state.currentStep] = opt.s;
            document.getElementById('nextBtn').disabled = false;
        };
        optionsDiv.appendChild(btn);
    });
    
    document.getElementById('nextBtn').disabled = true;
    const progress = (state.currentStep / QUESTIONS.length) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;
}

document.getElementById('nextBtn').addEventListener('click', () => {
    trackGA('question_complete', { 'step': state.currentStep + 1 });
    state.currentStep++;
    if (state.currentStep < QUESTIONS.length) {
        loadQuestion();
    } else {
        calculateAndFinish();
    }
});

/**
 * [Result Calculation]
 * ロジックの実行とログ出力
 */
async function calculateAndFinish() {
    logger("INFO", "Starting score calculation...");
    
    const scoreX = state.answers[0] + state.answers[1] + state.answers[2];
    const scoreY = state.answers[3] + state.answers[4] + state.answers[5];
    const coeff = state.answers[6];

    logger("DEBUG", "Raw Scores", { scoreX, scoreY, coeff });

    const rangeX = DIAGNOSIS_ENGINE.getRange(scoreX, coeff);
    const rangeY = DIAGNOSIS_ENGINE.getRange(scoreY, coeff);
    
    const resultKey = `${rangeX}_${rangeY}`;
    const finalType = DIAGNOSIS_ENGINE.matrix[resultKey];

    logger("INFO", "Diagnosis Result Determined", { key: resultKey, type: finalType });

    trackGA('diagnosis_complete', { 'type': finalType });
    showScreen('resultArea');
    document.getElementById('resultType').innerText = `診断結果：${finalType}`;
    
    // バックエンドへ送信
    sendDataToGAS(scoreX, scoreY, finalType);
}

async function sendDataToGAS(x, y, type) {
    const payload = {
        uid: state.userId,
        dogName: state.dogName,
        scoreX: x,
        scoreY: y,
        resultType: type,
        timestamp: new Date().toISOString()
    };
    
    try {
        await fetch(CONFIG.GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        logger("INFO", "Data successfully sent to GAS.");
    } catch (err) {
        logger("ERROR", "GAS Communication failed.", err);
    }
}

initApp();
</script>
</body>
</html>
