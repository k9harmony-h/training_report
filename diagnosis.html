<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K9 Harmony | æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Zen+Kurenaido&display=swap" rel="stylesheet">

    <style>
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #FDFBF8;
            --text-main: #2C3E50;
            --text-black: #000000;
            --luxury-transition: 0.8s cubic-bezier(0.25, 0.1, 0.25, 1.0);
            --global-radius: 5px;
            --group-margin: 40px;
        }

        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Serif JP', serif;
            background-color: #fafafa;
            color: var(--text-main);
            display: flex; flex-direction: column;
            min-height: 100vh; overflow-x: hidden; position: relative;
        }

        #washiBg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--mist-background);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3CfeColorMatrix type='matrix' values='0.33 0.33 0.33 0 0 0.33 0.33 0.33 0 0 0.33 0.33 0.33 0 0 0 0 0 1 0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.2'/%3E%3C/svg%3E");
            opacity: 0; z-index: -1; transition: opacity 1.2s ease;
        }

        .container { 
            width: 100%; max-width: 600px; margin: 0 auto; padding: 40px 20px; 
            box-sizing: border-box; position: relative; flex: 1 0 auto;
        }

        .reveal-item { opacity: 0; transform: translateY(15px); }
        .reveal-active { animation: revealEffect 0.8s forwards cubic-bezier(0.25, 0.1, 0.25, 1.0); }
        @keyframes revealEffect { to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; margin-bottom: 50px; }
        .logo-main { width: 180px; }

        .main-title-area { text-align: center; margin-bottom: var(--group-margin); }
        .main-title { 
            font-size: 1.8rem; font-weight: 700; margin: 0; 
            color: var(--progress-track); letter-spacing: 0.08em; 
            font-family: 'Noto Serif JP', serif;
        }
        .sub-title-badge { font-size: 0.75rem; color: var(--neutral-border); display: block; margin-top: 5px; margin-bottom: 40px; }
        .description-text { font-size: 0.9rem; line-height: 2; color: var(--text-main); margin-bottom: 30px; }

        .home-card, .q-unit {
            background: rgba(255, 255, 255, 0.6); border: 1px solid var(--neutral-border);
            padding: 35px; border-radius: var(--global-radius); margin-bottom: var(--group-margin);
            backdrop-filter: blur(2px); width: 100%; box-sizing: border-box;
        }
        .q-text { font-size: 0.9rem; font-weight: bold; margin-bottom: 15px; color: var(--progress-track); }

        .input-group label { display: block; font-size: 0.8rem; font-weight: bold; color: var(--progress-track); margin-bottom: 15px; }
        .input-group input { 
            width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid var(--neutral-border); 
            background: transparent; font-size: 1.4rem; outline: none; transition: 0.4s; font-family: inherit;
        }
        .input-group input::placeholder { color: var(--neutral-border); opacity: 0.1; }

        .opt-group { display: flex; gap: 8px; justify-content: space-between; }
        .opt-btn {
            flex: 1; padding: 12px 2px; border: 1px solid var(--neutral-border); background: transparent;
            border-radius: var(--global-radius); cursor: pointer; font-size: 0.8rem; text-align: center; 
            transition: color 0.4s ease, border-color 0.4s ease; 
            position: relative; overflow: hidden; z-index: 1;
        }
        .opt-btn.selected { color: #FFF; background: var(--active-highlight); border-color: var(--active-highlight); }

        .btn-container { text-align: center; margin-top: 20px; width: 100%; }
        .btn {
            display: block; margin: 0 auto; width: 75%; padding: 20px; 
            background: rgba(199, 178, 153, 0.2); color: var(--neutral-border);
            border: 1px solid var(--neutral-border); border-radius: var(--global-radius); 
            font-size: 1rem; cursor: pointer; transition: all 0.6s ease; 
            font-family: inherit; font-weight: 700; letter-spacing: 0.1em;
        }
        .btn.btn-ready { background: var(--active-highlight); color: #FFF; border: none; box-shadow: 0 4px 15px rgba(87, 195, 194, 0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .page-section { 
            position: absolute; top: 0; left: 0; width: 100%; 
            opacity: 0; pointer-events: none; transition: var(--luxury-transition); 
        }
        .page-section.active { opacity: 1; pointer-events: auto; position: relative; }
        .hidden { display: none !important; }
        .exit-left { transform: translateX(-50px); opacity: 0; }
        .exit-right { transform: translateX(50px); opacity: 0; }
        .enter-down { animation: enterDown var(--luxury-transition) forwards; }
        @keyframes enterDown { 0% { transform: translateY(-30px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }

        .result-logo { width: 40%; margin: 0 auto 20px; display: block; }
        .result-title-main { font-size: 1.5rem; color: var(--progress-track); margin-top: 0; line-height: 1.4; }
        .save-guide { font-size: 12px; color: var(--neutral-border); margin: 10px 0; font-family: 'Noto Serif JP'; }
        
        #generatedImageOutput {
            width: 100%; border: 1px solid var(--neutral-border);
            pointer-events: auto !important;
            user-select: auto !important;
            -webkit-user-select: auto !important;
            -webkit-touch-callout: default !important;
            position: relative; z-index: 10;
        }
        
        /* å®Œäº†ç”»é¢ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-group { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .btn-share {
            width: 100%; padding: 15px; border: 1px solid var(--neutral-border);
            background: #FFF; color: var(--progress-track); font-weight: bold;
            border-radius: var(--global-radius); cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }

        #chekiWrapper { position: absolute; left: -9999px; }
        #chekiTemplate { 
            width: 500px; background: #FFF; 
            padding: 40px; border: 1px solid #EEE; text-align: center; 
        }
        .cheki-photo-area { width: 100%; aspect-ratio: 1/1; background: #F8F8F8; position: relative; border: 1px solid #EAEAEA; }
        .cheki-result-badge { 
            position: absolute; top: 60px; left: -40px; background: rgba(87, 195, 194, 0.95);
            color: #FFF; padding: 15px 45px; font-size: 36px; font-weight: bold; 
            transform: rotate(-9deg); transform-origin: top left; z-index: 2000;
        }
        .cheki-name-area { margin-top: 60px; font-family: 'Zen Kurenaido'; font-size: 68px; color: var(--text-black); font-weight: 700; line-height: 1; }
        .cheki-description-area { margin: 20px auto 0; width: 80%; font-family: 'Noto Serif JP'; font-size: 20px; line-height: 1.8; color: var(--text-main); text-align: left; }

        .site-footer { 
            flex-shrink: 0; margin-top: auto; 
            background: rgba(255, 255, 255, 0.4); border-top: 1px solid rgba(199, 178, 153, 0.2); 
            padding: 40px 20px; text-align: center; font-size: 0.8rem; color: #7F8C8D; 
        }
        .footer-logo-img { width: 120px; margin-bottom: 25px; opacity: 0.7; }
        
        /* ãƒ­ã‚°ç”¨Footer */
        #footerLog { font-size: 10px; color:#ccc; margin-bottom: 5px; font-family: monospace; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.4); display: none; z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #FFF; width: 90%; max-width: 500px; max-height: 80vh; border-radius: var(--global-radius); padding: 30px; overflow: hidden; display: flex; flex-direction: column; }
        .policy-body { flex: 1; overflow-y: auto; font-size: 0.85rem; line-height: 1.8; color: #555; text-align: left; }
    </style>
</head>
<body>
    <div id="washiBg"></div>

    <div class="container">
        <header class="header reveal-item" id="reveal-1">
            <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" alt="K9 Harmony" class="logo-main">
        </header>

        <main id="sectionWrap">
            <section class="page-section active" id="page-home">
                <div class="main-title-area reveal-item" id="reveal-2">
                    <h1 class="main-title">æ„›çŠ¬ã®æ€§æ ¼è¨ºæ–­</h1>
                    <span class="sub-title-badge">ã€ˆK9 Harmony ãƒ‰ãƒƒã‚°ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ç›£ä¿®ã€‰</span>
                    <p class="description-text" style="text-align:center;">æ„›çŠ¬ã®è¡Œå‹•ã‹ã‚‰ã€æ½œåœ¨çš„ãªæ‚©ã¿ã¨<br>æœ€é©ãªçµ†ã®æ·±ã‚æ–¹ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>
                </div>
                <div class="home-card reveal-item" id="reveal-3">
                    <div class="input-group"><label>æ„›çŠ¬ã®åå‰</label><input type="text" id="dogName" placeholder="ä¾‹ï¼šãƒãƒ" maxlength="10"></div>
                </div>
                <div class="btn-container reveal-item" id="reveal-4">
                    <button class="btn btn-ready" id="startBtn" disabled>ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­...</button>
                    <p style="margin-top:25px;"><span id="openPrivacy" style="text-decoration:underline; font-size:0.75rem; cursor:pointer; color:var(--neutral-border);">å€‹äººæƒ…å ±ä¿è­·æ–¹é‡</span></p>
                </div>
            </section>
            
            <section class="page-section" id="page-groupA"><div id="groupA-list"></div><div class="btn-container"><button class="btn" id="toGroupB" disabled style="width:75%;">æ¬¡ã¸é€²ã‚€</button></div></section>
            <section class="page-section" id="page-groupB"><div id="groupB-list"></div><div style="display:flex; justify-content:space-between; align-items:center; width:85%; margin:40px auto 0;"><span id="backToA" style="cursor:pointer; font-size:0.8rem; color:var(--neutral-border); text-decoration:underline;">æˆ»ã‚‹</span><button class="btn" id="toGroupC" disabled style="width:75%;">æ¬¡ã¸é€²ã‚€</button></div></section>
            <section class="page-section" id="page-groupC"><div id="groupC-list"></div><div style="display:flex; justify-content:space-between; align-items:center; width:85%; margin:40px auto 0;"><span id="backToB" style="cursor:pointer; font-size:0.8rem; color:var(--neutral-border); text-decoration:underline;">æˆ»ã‚‹</span><button class="btn" id="finishBtn" disabled style="width:75%;">çµæœã‚’è¦‹ã‚‹</button></div></section>

            <section class="page-section hidden" id="page-result">
                <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" alt="K9 Harmony" class="result-logo">
                <div class="q-unit" style="text-align:center; opacity:1;">
                    <h2 class="result-title-main">è¨ºæ–­çµæœ<br><span id="resultTypeTitle">---</span></h2>
                    
                    <div id="imgOutWrap" style="position:relative; margin:20px 0;">
                        <img id="generatedImageOutput" style="width:100%; border:1px solid var(--neutral-border);" alt="çµæœç”»åƒ">
                        <div class="save-guide" style="font-weight:bold; color:var(--active-highlight);">â€»IGæŠ•ç¨¿ç”¨ï¼šç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜</div>
                    </div>

                    <div class="action-group">
                        <button class="btn btn-ready" id="sendLiffBtn" style="width:100%;">LINEã§çµæœã‚’ä¿å­˜</button>
                        
                        <button class="btn-share" id="shareUniversalBtn">
                            ã‚·ã‚§ã‚¢ (Instagram / X)
                        </button>
                    </div>
                    
                    <p id="backToReload" style="margin-top:20px; cursor:pointer; font-size:0.85rem; color:var(--neutral-border); text-decoration:underline;">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</p>
                </div>
            </section>
        </main>
    </div>

    <footer class="site-footer reveal-item" id="reveal-5">
        <div id="footerLog">[2025-12-22, Strict Login/IG-Fix, Ver 5.0]</div>
        <div class="footer-logo-container"><img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" class="footer-logo-img" alt="K9 Harmony"></div>
        <div class="footer-info"><p><strong>K9 Harmony</strong></p><p>ã€’174-0063 æ±äº¬éƒ½æ¿æ©‹åŒºå‰é‡ç”º6-55-1</p><p>070-9043-1109</p></div>
        <div style="margin-top:20px;">&copy; 2025 K9 Harmony</div>
    </footer>

    <div id="chekiWrapper"><div id="chekiTemplate"><div class="cheki-photo-area"><div class="cheki-result-badge" id="tmpl_type">TYPE</div><div style="font-size:100px; margin-top:60px;">ğŸ¾</div></div><div class="cheki-name-area" id="tmpl_name">NAME</div><div class="cheki-description-area" id="tmpl_desc">DESC</div></div></div>
    <div class="modal" id="privacyModal"><div class="modal-content"><div id="policyContent" class="policy-body"><h3>å€‹äººæƒ…å ±ä¿è­·æ–¹é‡</h3><p>ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šã®ãŸã‚ã‚¢ã‚¯ã‚»ã‚¹è§£æãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p></div><div id="closePrivacy" style="margin-top:20px; text-align:center; padding:15px; cursor:pointer;">é–‰ã˜ã‚‹</div></div></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec"
};

let MASTER_QUESTIONS = [];
let MASTER_RESULTS = [];
let state = { userId: null, dogName: "", answers: {}, typeName: "" };

function log(msg) {
    const ts = new Date().toLocaleTimeString();
    console.log(`[${ts}] ${msg}`);
    // Footer log update
    const f = document.getElementById('footerLog');
    if(f) f.innerText = `[Ver 5.0] ${msg}`;
}

// ----------------------------------------------------
// 1. LIFFåˆæœŸåŒ– (å³æ ¼ãªãƒ­ã‚°ã‚¤ãƒ³ãƒ»é–‹å§‹å‰å¿…é ˆ)
// ----------------------------------------------------
async function initSystem() {
    log("Initializing...");
    
    // UIã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    document.getElementById('washiBg').style.opacity = 1;
    [1,2,3,4,5].forEach((n) => setTimeout(() => {
        const el = document.getElementById(`reveal-${n}`);
        if(el) el.classList.add('reveal-active');
    }, 200 * n));

    // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
    try {
        const res = await fetch(`${CONFIG.GAS_URL}?action=fetchMaster`);
        const data = await res.json();
        MASTER_QUESTIONS = data.questions;
        MASTER_RESULTS = data.results;
        log("Data Loaded.");
    } catch (e) {
        log("Data Error.");
        alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        return; // ç¶šè¡Œä¸å¯
    }

    // LIFFãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ (ä¸€åˆ‡å…ˆã«é€²ã¾ã›ãªã„)
        if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: window.location.href });
            return;
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— (Androidãƒã‚°å¯¾ç­–ã®1å›ãƒªãƒ­ãƒ¼ãƒ‰ã®ã¿è¨±å®¹)
        const accessToken = liff.getAccessToken();
        if (!accessToken) {
            if (!sessionStorage.getItem('retry_token')) {
                // 1å›ã ã‘ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†è©¦è¡Œ
                sessionStorage.setItem('retry_token', '1');
                liff.logout();
                location.reload();
                return;
            } else {
                // 2å›ç›®ã‚‚å¤±æ•— -> è«¦ã‚ã¦ã‚¨ãƒ©ãƒ¼è¡¨ç¤º (ã‚²ã‚¹ãƒˆè¨±å¯ã—ãªã„)
                alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶(Chrome/Safari)ã§ãŠè©¦ã—ãã ã•ã„ã€‚");
                document.getElementById('startBtn').innerText = "èªè¨¼ã‚¨ãƒ©ãƒ¼";
                return; // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–ã—ãªã„
            }
        }
        
        // æˆåŠŸ
        sessionStorage.removeItem('retry_token');
        state.userId = liff.getDecodedIDToken().sub;
        log("Auth Success.");
        
        // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
        const btn = document.getElementById('startBtn');
        btn.disabled = false;
        btn.innerText = "è¨ºæ–­ã‚’å§‹ã‚ã‚‹";

    } catch (e) {
        log("Auth Error: " + e.message);
        alert("LINEèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
}

// ----------------------------------------------------
// 2. è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯
// ----------------------------------------------------
function buildSection(group, targetId) {
    const container = document.getElementById(targetId);
    if(!container) return;
    container.innerHTML = '';
    
    MASTER_QUESTIONS.filter(q => q.Section === group).forEach(q => {
        const div = document.createElement('div');
        div.className = 'q-unit';
        div.innerHTML = `<div class="q-text">${q.Text}</div>`;
        const optGroup = document.createElement('div');
        optGroup.className = 'opt-group';
        
        [{t:q.OptA_Text,s:q.OptA_Score},{t:q.OptB_Text,s:q.OptB_Score},{t:q.OptC_Text,s:q.OptC_Score}].forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn'; btn.innerText = opt.t;
            btn.onclick = () => {
                optGroup.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                state.answers[q.QuestionID] = opt.s;
                checkReady(group);
            };
            optGroup.appendChild(btn);
        });
        div.appendChild(optGroup); container.appendChild(div);
    });
}

function checkReady(group) {
    const qCount = MASTER_QUESTIONS.filter(q => q.Section === group).length;
    const answered = MASTER_QUESTIONS.filter(q => q.Section === group && state.answers[q.QuestionID] !== undefined).length;
    if (qCount === answered) {
        const btnId = group==='A'?'toGroupB':group==='B'?'toGroupC':'finishBtn';
        const btn = document.getElementById(btnId);
        if(btn) { btn.disabled = false; btn.classList.add('btn-ready'); }
    }
}

function navigate(fromId, toId, direction) {
    const fromEl = document.getElementById(fromId);
    const toEl = document.getElementById(toId);
    if(!fromEl || !toEl) return;
    fromEl.classList.remove('active');
    
    setTimeout(() => {
        fromEl.classList.add('hidden'); 
        toEl.classList.remove('hidden'); 
        void toEl.offsetWidth; 
        toEl.classList.add('active','enter-down');
        if (toId === 'page-result') document.querySelector('.header').style.display = 'none';
    }, 400);
}

// ----------------------------------------------------
// 3. çµæœå‡¦ç†
// ----------------------------------------------------
async function processFinal() {
    log("Calculating...");
    const sX = (state.answers[1]||0) + (state.answers[2]||0) + (state.answers[3]||0);
    const sY = (state.answers[4]||0) + (state.answers[5]||0) + (state.answers[6]||0);
    const c = state.answers[7]||0;
    const getR = (s) => (s <= 12 ? 'LOW' : s <= 111 ? 'MID' : 'HIGH');
    let rX = getR(sX), rY = getR(sY);
    if ((sX === 12 || sX === 13) && c === 1) rX = 'MID';
    if ((sX === 12 || sX === 13) && c === -1) rX = 'LOW';

    const resObj = MASTER_RESULTS.find(r => r.TypeKey === `${rX}_${rY}`);
    state.typeName = resObj ? resObj.TypeName : "Unknown";

    navigate('page-groupC', 'page-result', 'next');

    // UIåæ˜ 
    document.getElementById('resultTypeTitle').innerText = state.typeName + "ã‚¿ã‚¤ãƒ—";
    document.getElementById('tmpl_type').innerText = state.typeName + "ã‚¿ã‚¤ãƒ—";
    document.getElementById('tmpl_name').innerText = state.dogName;
    document.getElementById('tmpl_desc').innerText = resObj ? resObj.Description : "";

    // ç”»åƒç”Ÿæˆ
    await document.fonts.ready;
    html2canvas(document.getElementById('chekiTemplate'), { scale: 2, useCORS: true }).then(canvas => {
        document.getElementById('generatedImageOutput').src = canvas.toDataURL();
        log("Image Ready.");
    });

    gtag('event', 'diagnosis_complete', { 'type': state.typeName });
}

// ----------------------------------------------------
// 4. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (LINEé€ä¿¡ & ã‚·ã‚§ã‚¢)
// ----------------------------------------------------
function setupActions() {
    // A. LINEé€ä¿¡ (Form Dataé€ä¿¡ã§å …ç‰¢åŒ–)
    document.getElementById('sendLiffBtn').onclick = async () => {
        const btn = document.getElementById('sendLiffBtn');
        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        // ãƒ­ã‚°ã‚¤ãƒ³ã¯Startæ™‚ã«æ¸ˆã‚“ã§ã„ã‚‹å‰æ
        const token = liff.getAccessToken();

        const formData = new URLSearchParams();
        formData.append('action', 'send_line');
        formData.append('uid', state.userId);
        formData.append('dogName', state.dogName);
        formData.append('resultType', state.typeName);
        if(token) formData.append('accessToken', token);

        try {
            await fetch(CONFIG.GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            });
            alert("é€ä¿¡ã—ã¾ã—ãŸï¼");
            btn.innerText = "é€ä¿¡å®Œäº†";
        } catch(e) {
            alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            btn.disabled = false;
            btn.innerText = "å†é€ä¿¡";
        }
    };

    // B. ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚·ã‚§ã‚¢ (Android LINEå¯¾å¿œ)
    document.getElementById('shareUniversalBtn').onclick = async () => {
        const imgEl = document.getElementById('generatedImageOutput');
        if(!imgEl.src) return;

        // BlobåŒ–
        const blob = await (await fetch(imgEl.src)).blob();
        const file = new File([blob], "result.png", { type: "image/png" });
        const text = `${state.dogName}ã¯${state.typeName}ã‚¿ã‚¤ãƒ—ï¼ #K9Harmony`;
        
        // è©¦è¡Œ: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'K9 Harmony',
                    text: text
                    // Android LINEç­‰ã§urlãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ç”»åƒã‚’æ··ãœã‚‹ã¨æ­»ã¬ãŸã‚ã€textã®ã¿ã«ã™ã‚‹
                });
                return;
            } catch(e) {
                console.log("Share API abort/error", e);
            }
        } 
        
        // å¤±æ•—æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (ã“ã‚ŒãŒAndroid LINEãƒ–ãƒ©ã‚¦ã‚¶ã§XãŒé–‹ãåŸå› ã ã£ãŸéƒ¨åˆ†ã‚’ä¿®æ­£)
        // -> ç”»åƒå…±æœ‰ãŒã§ããªã„ç’°å¢ƒã§ã¯ã€ã€Œé•·æŠ¼ã—ä¿å­˜ã€ã‚’ä¿ƒã™ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™ã ã‘ã«ç•™ã‚ã‚‹
        alert("ãŠä½¿ã„ã®ç’°å¢ƒã§ã¯ç›´æ¥ã‚·ã‚§ã‚¢ãŒã§ãã¾ã›ã‚“ã€‚\nç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã€Instagramã‚„Xã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ğŸ¾");
    };
}

// ã‚¹ã‚¿ãƒ¼ãƒˆ
initSystem();
setupActions();

// ãã®ä»–ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById('startBtn').onclick = () => {
    state.dogName = document.getElementById('dogName').value.trim();
    if (!state.dogName) return alert("ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„");
    buildSection('A', 'groupA-list'); navigate('page-home', 'page-groupA', 'next');
};
document.getElementById('toGroupB').onclick = () => { buildSection('B', 'groupB-list'); navigate('page-groupA', 'page-groupB', 'next'); };
document.getElementById('toGroupC').onclick = () => { buildSection('C', 'groupC-list'); navigate('page-groupB', 'page-groupC', 'next'); };
document.getElementById('backToA').onclick = () => navigate('page-groupB', 'page-groupA', 'back');
document.getElementById('backToB').onclick = () => navigate('page-groupC', 'page-groupB', 'back');
document.getElementById('finishBtn').onclick = processFinal;
document.getElementById('backToReload').onclick = () => location.reload();
document.getElementById('openPrivacy').onclick = () => { document.getElementById('privacyModal').style.display = 'flex'; };
document.getElementById('closePrivacy').onclick = () => { document.getElementById('privacyModal').style.display = 'none'; };

</script>
</body>
</html>
