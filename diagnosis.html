<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony | 愛犬の性格診断</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #F4F7F7;
            --text-main: #2C3E50;
            --luxury-transition: 0.8s cubic-bezier(0.25, 0.1, 0.25, 1.0);
            --global-radius: 5px;
            --group-margin: 40px; /* 指定：40px固定 */
        }

        /* [Visual Fix] 和紙テクスチャをより鮮明に */
        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--mist-background);
            background-image: url("https://www.transparenttextures.com/patterns/pinstriped-suit.png"), url("https://www.transparenttextures.com/patterns/handmade-paper.png");
            background-blend-mode: multiply;
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh;
        }

        /* [Visual Log Stamp] */
        #logOverlay {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(47, 93, 98, 0.9);
            color: #FFF; font-size: 10px; padding: 4px 10px; z-index: 9999; font-family: monospace;
            pointer-events: none; height: 1.5em; overflow: hidden;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; box-sizing: border-box; overflow: hidden; position: relative; }
        .header { text-align: center; margin-bottom: 50px; }
        .logo-main { width: 180px; }

        .main-title { font-size: 1.8rem; font-weight: 700; color: var(--progress-track); margin-bottom: 5px; text-align: center; }
        .sub-title-badge { font-size: 0.75rem; color: var(--neutral-border); margin-bottom: 40px; text-align: center; display: block; }

        .card {
            background: rgba(255, 255, 255, 0.5); border: 1px solid var(--neutral-border);
            padding: 35px; border-radius: var(--global-radius); backdrop-filter: blur(5px);
            margin-bottom: var(--group-margin);
        }

        .q-unit { margin-bottom: var(--group-margin); }
        .q-text { font-size: 0.95rem; font-weight: bold; margin-bottom: 15px; color: var(--progress-track); }
        
        /* [UI] 回答の横並び配置 */
        .opt-group { display: flex; gap: 8px; justify-content: space-between; }
        .opt-btn {
            flex: 1; padding: 12px 4px; border: 1px solid var(--neutral-border); background: #FFF;
            border-radius: var(--global-radius); cursor: pointer; font-size: 0.8rem; text-align: center; transition: 0.3s;
        }
        .opt-btn.selected { background: var(--active-highlight); color: #FFF; border-color: var(--active-highlight); }

        .btn {
            width: 75%; padding: 20px; background: var(--active-highlight); color: #FFF;
            border: none; border-radius: var(--global-radius); font-size: 1.1rem; cursor: pointer;
            font-family: inherit; font-weight: 700; letter-spacing: 0.1em;
        }
        .btn:disabled { background: #CCC; opacity: 0.5; }

        /* [Transition] イージングスライド */
        .slide-area { display: flex; width: 300%; transition: transform var(--luxury-transition); }
        .page-section { width: 33.333%; flex-shrink: 0; padding: 0 5px; box-sizing: border-box; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4);
            display: none; z-index: 1000; align-items: flex-start; justify-content: center; backdrop-filter: blur(10px);
        }
        .modal-content {
            background: #FFF; width: 92%; height: 75vh; margin-top: 5vh; border-radius: var(--global-radius);
            padding: 30px; overflow: hidden; display: flex; flex-direction: column;
        }

        .hidden { display: none !important; }
        #chekiWrapper { position: absolute; left: -9999px; }
    </style>
</head>
<body>
    <div id="logOverlay">Initializing...</div>

    <div class="container fade-in">
        <div class="header">
            <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" alt="K9 Harmony" class="logo-main">
        </div>

        <div class="slide-area" id="slideArea">
            <section class="page-section" id="page-home">
                <h1 class="main-title">愛犬の性格診断</h1>
                <span class="sub-title-badge">〈K9 Harmony ドッグトレーナー監修〉</span>
                <div class="card">
                    <label style="font-size:0.8rem; font-weight:bold; display:block; margin-bottom:10px;">愛犬の名前</label>
                    <input type="text" id="dogName" placeholder="例：ポチ" style="width:100%; border:none; border-bottom:1px solid var(--neutral-border); background:transparent; font-size:1.3rem; outline:none; padding:10px 0;">
                </div>
                <div style="text-align:center;">
                    <button class="btn" id="startBtn">診断を始める</button>
                    <p style="margin-top:20px;"><span style="text-decoration:underline; font-size:0.7rem; cursor:pointer; color:var(--neutral-border);" id="openPrivacy">個人情報保護方針</span></p>
                </div>
            </section>

            <section class="page-section" id="page-groupA">
                <div class="card" id="groupA-content">
                    </div>
                <div style="text-align:center;">
                    <button class="btn" id="toGroupB" disabled>次へ進む</button>
                </div>
            </section>

            <section class="page-section" id="page-groupB">
                <div class="card" id="groupB-content">
                    </div>
                <div style="display:flex; justify-content:space-between; align-items:center; width:75%; margin:0 auto;">
                    <span id="backToA" style="cursor:pointer; font-size:0.8rem; color:var(--neutral-border); text-decoration:underline;">戻る</span>
                    <button class="btn" id="finishBtn" disabled style="width:70%;">結果を見る</button>
                </div>
            </section>
        </div>
    </div>

    <div id="resultArea" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--mist-background); z-index:500; overflow-y:auto; padding:40px 20px; box-sizing:border-box;">
        <div class="card" style="text-align:center;">
            <h2 id="resultTypeTitle" style="color:var(--progress-track); margin-top:0;">診断結果</h2>
            <img id="generatedImageOutput" style="width:100%; border:1px solid var(--neutral-border); margin:20px 0;">
            <div id="resultDescription" style="text-align:left; font-size:0.85rem; line-height:1.7;"></div>
            <button class="btn" id="shareBtn" style="margin-top:20px;">友だちに送る</button>
            <p onclick="location.reload()" style="margin-top:20px; cursor:pointer; font-size:0.8rem; color:var(--neutral-border);">最初からやり直す</p>
        </div>
    </div>

    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <h3 style="margin:0; font-size:1rem; border-bottom:1px solid var(--mist-background); padding-bottom:10px;">プライバシーポリシー</h3>
            <div id="policyText" style="flex:1; overflow-y:auto; font-size:0.8rem; line-height:1.7; padding:20px 0;"></div>
            <div id="closePrivacy" style="text-align:center; padding:15px; background:var(--mist-background); border-radius:var(--global-radius); cursor:pointer;">閉じる</div>
        </div>
    </div>

    <footer class="site-footer" style="text-align:center; padding:40px 0; font-size:0.7rem; color:var(--neutral-border);">
        <p>K9 Harmony | 東京都板橋区前野町6-55-1</p>
        <p>&copy; 2025 K9 Harmony</p>
    </footer>

    <div id="chekiWrapper">
        <div id="chekiTemplate" style="width:400px; background:#FFF; padding:20px 20px 60px 20px;">
            <div style="width:100%; aspect-ratio:1/1; background:#F4F7F7; border:1px solid #EEE;"></div>
            <div id="tmpl_type" style="font-size:24px; font-weight:bold; margin-top:20px;"></div>
            <div id="tmpl_name" style="font-size:16px; color:#C7B299; margin-top:5px;"></div>
        </div>
    </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec",
    BOUNDARIES: { LOW_MID: 12, MID_HIGH: 111 }
};

// [Text Shortening] 意味を維持しつつ極限まで短縮
const QUESTIONS = [
    { id: 1, grp: 'A', text: "初めての場所で", opts: [{t:"不安",s:1},{t:"警戒",s:10},{t:"平気",s:100}] },
    { id: 2, grp: 'A', text: "他の犬への反応", opts: [{t:"避ける",s:1},{t:"注視",s:10},{t:"遊ぶ",s:100}] },
    { id: 3, grp: 'A', text: "遊びへの意欲", opts: [{t:"低い",s:1},{t:"普通",s:10},{t:"高い",s:100}] },
    { id: 4, grp: 'B', text: "飼い主への追従", opts: [{t:"なし",s:1},{t:"時々",s:10},{t:"常に",s:100}] },
    { id: 5, grp: 'B', text: "留守番の様子", opts: [{t:"平気",s:1},{t:"ソワソワ",s:10},{t:"パニック",s:100}] },
    { id: 6, grp: 'B', text: "撫で終えた後", opts: [{t:"去る",s:1},{t:"停止",s:10},{t:"催促",s:100}] },
    { id: 7, grp: 'B', text: "今後の希望", opts: [{t:"自立",s:-1},{t:"維持",s:0},{t:"甘え",s:1}] }
];

let state = { userId: null, dogName: "", answers: {} };

function log(msg) {
    const ts = new Date().toLocaleTimeString();
    const line = `[${ts}] ${msg}`;
    document.getElementById('logOverlay').innerText = line;
    console.log(line);
}

// [UI Generation] 質問グループの構築
function buildQuestionGroup(group, targetId) {
    const container = document.getElementById(targetId);
    container.innerHTML = '';
    QUESTIONS.filter(q => q.grp === group).forEach(q => {
        const div = document.createElement('div');
        div.className = 'q-unit';
        div.innerHTML = `<div class="q-text">${q.text}</div>`;
        const optGroup = document.createElement('div');
        optGroup.className = 'opt-group';
        q.opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt.t;
            btn.onclick = () => {
                const brothers = optGroup.querySelectorAll('.opt-btn');
                brothers.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                state.answers[q.id] = opt.s;
                checkGroupCompletion(group);
            };
            optGroup.appendChild(btn);
        });
        div.appendChild(optGroup);
        container.appendChild(div);
    });
}

function checkGroupCompletion(group) {
    const qCount = QUESTIONS.filter(q => q.grp === group).length;
    const answeredCount = QUESTIONS.filter(q => q.grp === group && state.answers[q.id] !== undefined).length;
    if (qCount === answeredCount) {
        document.getElementById(group === 'A' ? 'toGroupB' : 'finishBtn').disabled = false;
    }
}

// [App Engine]
async function init() {
    log("LIFF Initialization...");
    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        state.userId = liff.getContext().userId;
        log("LIFF Ready. User:" + state.userId);
    } catch (e) { log("LIFF Error: " + e.message); }

    // Bind Events
    document.getElementById('startBtn').onclick = () => {
        state.dogName = document.getElementById('dogName').value.trim();
        if (!state.dogName) return alert("名前を教えてね");
        log("Diagnosis Start: " + state.dogName);
        buildQuestionGroup('A', 'groupA-content');
        document.getElementById('slideArea').style.transform = 'translateX(-33.333%)';
    };

    document.getElementById('toGroupB').onclick = () => {
        log("Moving to Group B");
        buildQuestionGroup('B', 'groupB-content');
        document.getElementById('slideArea').style.transform = 'translateX(-66.666%)';
    };

    document.getElementById('backToA').onclick = () => {
        document.getElementById('slideArea').style.transform = 'translateX(-33.333%)';
    };

    document.getElementById('finishBtn').onclick = processFinal;

    // Privacy Modal
    const modal = document.getElementById('privacyModal');
    document.getElementById('openPrivacy').onclick = () => modal.style.display = 'flex';
    document.getElementById('closePrivacy').onclick = () => modal.style.display = 'none';
    document.getElementById('policyText').innerHTML = "K9 Harmony プライバシーポリシー全文...（ここに流し込み）";
}

async function processFinal() {
    log("Processing Results...");
    const sX = state.answers[1] + state.answers[2] + state.answers[3];
    const sY = state.answers[4] + state.answers[5] + state.answers[6];
    const c = state.answers[7];

    const getR = (s) => (s <= 12 ? 'LOW' : s <= 111 ? 'MID' : 'HIGH');
    let rX = getR(sX), rY = getR(sY);
    if ((sX === 12 || sX === 13) && c === 1) rX = 'MID';
    if ((sX === 12 || sX === 13) && c === -1) rX = 'LOW';

    const m = { 'LOW_LOW':'哲学者', 'MID_LOW':'観察者', 'HIGH_LOW':'冒険家', 'LOW_MID':'のんびり', 'MID_MID':'黄金バランス', 'HIGH_MID':'アスリート', 'LOW_HIGH':'内向的守護者', 'MID_HIGH':'甘えん坊', 'HIGH_HIGH':'衝動的' };
    const type = m[`${rX}_${rY}`] + "タイプ";

    document.getElementById('resultArea').classList.remove('hidden');
    document.getElementById('resultTypeTitle').innerText = type;
    
    // Image Gen
    document.getElementById('tmpl_type').innerText = type;
    document.getElementById('tmpl_name').innerText = state.dogName + "ちゃん";
    html2canvas(document.getElementById('chekiTemplate')).then(canvas => {
        document.getElementById('generatedImageOutput').src = canvas.toDataURL();
        log("Image Generated");
    });

    // GAS
    fetch(CONFIG.GAS_URL, { method:'POST', mode:'no-cors', body: JSON.stringify({ uid:state.userId, dogName:state.dogName, scoreX:sX, scoreY:sY, resultType:type }) });
}

init();
</script>
</body>
</html>
