<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony | うちの子診断</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* * [Brand Design System]
         * 仕様書に基づいたカラーパレットと高級感のあるタイポグラフィの定義 
         */
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #F4F7F7;
            --text-main: #2C3E50;
            --luxury-transition: 0.8s cubic-bezier(0.25, 0.1, 0.25, 1.0);
        }

        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--mist-background);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* [Animation] : 霧が晴れるようなフェード & スライド効果 */
        .fade-in {
            animation: luxuryEase In var(--luxury-transition) forwards;
        }

        @keyframes luxuryEaseIn {
            0% { opacity: 0; transform: translateY(10px); filter: blur(5px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .header { text-align: center; margin-bottom: 40px; }
        .logo { width: 120px; margin-bottom: 20px; }

        /* [UI Components] : 和紙の質感を意識した境界線とボタン */
        .card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--neutral-border);
            padding: 30px;
            border-radius: 2px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: #E0E0E0;
            margin-bottom: 30px;
        }

        .progress-bar {
            height: 100%;
            background: var(--progress-track);
            width: 0%;
            transition: width 0.6s ease;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 18px;
            background: var(--active-highlight);
            color: #FFF;
            border: none;
            border-radius: 0;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
            text-decoration: none;
            margin-top: 10px;
        }

        .btn:disabled { background: #CCC; cursor: not-allowed; }

        .option-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 12px;
            background: #FFF;
            border: 1px solid var(--neutral-border);
            text-align: left;
            cursor: pointer;
            transition: 0.3s;
        }

        .option-btn.selected {
            background: var(--active-highlight);
            color: #FFF;
            border-color: var(--active-highlight);
        }

        .footer-note {
            font-size: 0.8rem;
            text-align: center;
            margin-top: auto;
            color: #7F8C8D;
            padding-top: 20px;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container fade-in">
    <div class="header">
        <img src="https://path-to-your-logo.com/logo.png" alt="K9 Harmony" class="logo">
    </div>

    <div id="progressSection" class="progress-container hidden">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <main id="app">
        <section id="home">
            <div class="card">
                <h2 style="text-align: center;">うちの子診断</h2>
                <p>愛犬の行動から、潜在的な悩みと最適な絆の深め方を可視化します。</p>
                <div style="margin-top: 20px;">
                    <label>愛犬の名前</label>
                    <input type="text" id="dogName" placeholder="例：ポチ" style="width: 100%; padding: 12px; margin-top: 8px; border: 1px solid var(--neutral-border); box-sizing: border-box;">
                </div>
            </div>
            <button class="btn" id="startBtn">診断を始める</button>
        </section>

        <section id="questionArea" class="hidden">
            <div class="card">
                <h3 id="questionText">質問文がここに入ります</h3>
                <div id="options">
                    </div>
            </div>
            <button class="btn" id="nextBtn" disabled>次へ進む</button>
        </section>

        <section id="resultArea" class="hidden">
            <div class="card" id="resultCard">
                <h2 id="resultType">診断中...</h2>
                <div id="resultDescription"></div>
            </div>
        </section>
    </main>

    <div class="footer-note">
        K9 Harmony ドッグトレーナー監修
    </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
/**
 * [K9 Harmony Configuration]
 * 保守性を高めるための定数管理
 */
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec",
    GA_ID: "G-ES72ND3BPP"
};

/**
 * [Diagnosis Logic Data]
 * 3+3+1形式の質問定義
 */
const QUESTIONS = [
    { id: 1, cat: 'X', text: "初めて行く場所での愛犬の様子は？", options: [{t: "落ち着かない", s: 1}, {t: "少し警戒する", s: 10}, {t: "すぐに馴染む", s: 100}] },
    { id: 2, cat: 'X', text: "散歩中、他の犬に出会ったら？", options: [{t: "逃げる・吠える", s: 1}, {t: "様子を伺う", s: 10}, {t: "遊びたがる", s: 100}] },
    { id: 3, cat: 'X', text: "遊びに対する意欲は？", options: [{t: "すぐ飽きる", s: 1}, {t: "程々に遊ぶ", s: 10}, {t: "エンドレスに遊ぶ", s: 100}] },
    { id: 4, cat: 'Y', text: "家の中で飼い主が動くと？", options: [{t: "寝ている", s: 1}, {t: "目で追う", s: 10}, {t: "常についてくる", s: 100}] },
    { id: 5, cat: 'Y', text: "留守番中の様子は？", options: [{t: "ずっと寝ている", s: 1}, {t: "少しソワソワする", s: 10}, {t: "破壊行動や遠吠え", s: 100}] },
    { id: 6, cat: 'Y', text: "撫でるのをやめると？", options: [{t: "去っていく", s: 1}, {t: "じっとしている", s: 10}, {t: "催促してくる", s: 100}] },
    { id: 7, cat: 'C', text: "愛犬にもっとどうなってほしい？", options: [{t: "自立してほしい", s: -1}, {t: "今のままで良い", s: 0}, {t: "もっと甘えてほしい", s: 1}] }
];

/**
 * [State Management]
 * 診断の状態を管理するオブジェクト
 */
let state = {
    userId: null,
    dogName: "",
    currentStep: 0,
    answers: [],
    scoreX: 0,
    scoreY: 0,
    coeff: 0
};

/**
 * [Logging Utility]
 * ルール6：開発段階の永続的なログ出力
 */
function logger(level, message, data = "") {
    const ts = new Date().toLocaleString();
    console.log(`[${ts}] [${level}] ${message}`, data);
}

/**
 * [GA4 Tracker]
 * 仕様書に基づいたイベント計測
 */
function trackGA(eventName, params = {}) {
    logger("GA4", eventName, params);
    if (typeof gtag === 'function') {
        gtag('event', eventName, params);
    }
}

/**
 * [App Initialization]
 */
async function initApp() {
    logger("INFO", "App initialization started.");
    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            state.userId = liff.getContext().userId;
            logger("INFO", "LIFF initialized, UserID obtained.", state.userId);
        }
    } catch (err) {
        logger("ERROR", "LIFF initialization failed.", err);
    }
}

/**
 * [Navigation Logic]
 */
function showScreen(screenId) {
    const screens = ['home', 'questionArea', 'resultArea'];
    screens.forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(screenId).classList.remove('hidden');
    document.getElementById(screenId).classList.add('fade-in');
}

/**
 * [Diagnosis Start]
 */
document.getElementById('startBtn').addEventListener('click', () => {
    state.dogName = document.getElementById('dogName').value.trim();
    if (!state.dogName) {
        alert("愛犬のお名前を入力してください。");
        return;
    }
    
    trackGA('diagnosis_start');
    document.getElementById('progressSection').classList.remove('hidden');
    showScreen('questionArea');
    loadQuestion();
    logger("INFO", "Diagnosis started for:", state.dogName);
});

/**
 * [Question Logic]
 */
function loadQuestion() {
    const q = QUESTIONS[state.currentStep];
    document.getElementById('questionText').innerText = q.text;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';
    
    q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt.t;
        btn.onclick = () => selectOption(idx, opt.s);
        optionsDiv.appendChild(btn);
    });
    
    document.getElementById('nextBtn').disabled = true;
    updateProgressBar();
}

function selectOption(idx, score) {
    const btns = document.querySelectorAll('.option-btn');
    btns.forEach(b => b.classList.remove('selected'));
    btns[idx].classList.add('selected');
    
    state.answers[state.currentStep] = score;
    document.getElementById('nextBtn').disabled = false;
}

document.getElementById('nextBtn').addEventListener('click', () => {
    trackGA('question_complete', { 'step': state.currentStep + 1 });
    state.currentStep++;
    
    if (state.currentStep < QUESTIONS.length) {
        loadQuestion();
    } else {
        processResults();
    }
});

function updateProgressBar() {
    const progress = ((state.currentStep) / QUESTIONS.length) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;
}

/**
 * [Scoring & Matrix Logic]
 * 仕様書 3.1 & 3.2 準拠
 */
async function processResults() {
    logger("INFO", "Processing results...");
    
    // スコア集計
    state.scoreX = state.answers[0] + state.answers[1] + state.answers[2];
    state.scoreY = state.answers[3] + state.answers[4] + state.answers[5];
    state.coeff = state.answers[6];

    // マトリクス判定
    const getRange = (val) => {
        if (val <= 12) return 'LOW';
        if (val <= 111) return 'MID';
        return 'HIGH';
    };

    let rangeX = getRange(state.scoreX);
    let rangeY = getRange(state.scoreY);

    // Q7補正 (閾値付近の場合にシフト)
    // ここでは保守的にロジックを分離。10%程度の閾値マージンでQ7を適用。
    if (state.scoreX === 12 || state.scoreX === 13 || state.scoreX === 111 || state.scoreX === 112) {
        if (state.coeff === 1 && rangeX === 'LOW') rangeX = 'MID';
        if (state.coeff === -1 && rangeX === 'MID') rangeX = 'LOW';
    }

    const matrix = {
        'LOW_LOW': '哲学者タイプ', 'MID_LOW': '観察者タイプ', 'HIGH_LOW': '冒険家タイプ',
        'LOW_MID': 'のんびりタイプ', 'MID_MID': '黄金のバランス', 'HIGH_MID': 'アスリートタイプ',
        'LOW_HIGH': '内向的な守護者', 'MID_HIGH': '甘えん坊タイプ', 'HIGH_HIGH': '衝動的タイプ'
    };

    const finalType = matrix[`${rangeX}_${rangeY}`];
    trackGA('diagnosis_complete', { 'type': finalType });
    
    showScreen('resultArea');
    document.getElementById('resultType').innerText = `診断結果：${finalType}`;
    
    // GASへデータ送信 (Step 1 連携)
    sendDataToGAS(finalType);
}

async function sendDataToGAS(finalType) {
    const payload = {
        uid: state.userId,
        dogName: state.dogName,
        scoreX: state.scoreX,
        scoreY: state.scoreY,
        resultType: finalType,
        timestamp: new Date().toISOString()
    };

    logger("INFO", "Sending data to GAS...", payload);
    
    try {
        await fetch(CONFIG.GAS_URL, {
            method: 'POST',
            mode: 'no-cors', // GAS doPostへの簡易送信
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        logger("INFO", "Data sent to GAS successfully.");
    } catch (err) {
        logger("ERROR", "GAS submission failed.", err);
    }
}

// 起動
initApp();
</script>
</body>
</html>
