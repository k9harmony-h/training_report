<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony | ã†ã¡ã®å­è¨ºæ–­</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #F4F7F7;
            --text-main: #2C3E50;
            --luxury-transition: 0.8s cubic-bezier(0.25, 0.1, 0.25, 1.0);
        }

        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--mist-background);
            color: var(--text-main);
            margin: 0; padding: 0; overflow-x: hidden;
        }

        .fade-in { animation: luxuryEaseIn var(--luxury-transition) forwards; }
        @keyframes luxuryEaseIn {
            0% { opacity: 0; transform: translateY(10px); filter: blur(5px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 40px; }
        .logo { width: 120px; margin-bottom: 20px; }

        .card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--neutral-border);
            padding: 30px; border-radius: 2px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .btn {
            display: block; width: 100%; padding: 18px;
            background: var(--active-highlight); color: #FFF;
            border: none; font-size: 1.1rem; cursor: pointer;
            transition: 0.3s; text-align: center; text-decoration: none;
            margin-top: 10px; font-family: 'Noto Serif JP', serif;
        }
        .btn:disabled { background: #CCC; }
        .btn-outline {
            background: transparent; color: var(--active-highlight);
            border: 1px solid var(--active-highlight);
        }

        .option-btn {
            display: block; width: 100%; padding: 15px; margin-bottom: 12px;
            background: #FFF; border: 1px solid var(--neutral-border);
            text-align: left; cursor: pointer; transition: 0.3s; font-family: 'Noto Serif JP', serif;
        }
        .option-btn.selected { background: var(--active-highlight); color: #FFF; }

        .progress-container { width: 100%; height: 4px; background: #E0E0E0; margin-bottom: 30px; }
        .progress-bar { height: 100%; background: var(--progress-track); width: 0%; transition: 0.6s; }

        .hidden { display: none; }

        /* [Cheki Template Design] 
         * ç”»é¢å¤–ã§ç”»åƒç”Ÿæˆç”¨ã«æç”»ã•ã‚Œã‚‹ã‚¨ãƒªã‚¢
         */
        #chekiWrapper {
            position: absolute; left: -9999px; top: 0;
        }
        #chekiTemplate {
            width: 400px; background: #FFF; padding: 20px 20px 60px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center;
        }
        .cheki-photo-area {
            width: 100%; aspect-ratio: 1/1; background: var(--mist-background);
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #EEE; overflow: hidden; position: relative;
        }
        .cheki-type-name {
            margin-top: 25px; font-size: 24px; font-weight: bold; color: var(--progress-track);
        }
        .cheki-dog-name {
            margin-top: 5px; font-size: 16px; color: var(--neutral-border);
        }
        .cheki-footer {
            margin-top: 30px; font-size: 12px; letter-spacing: 2px; color: #BBB;
        }

        /* ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®è¡¨ç¤ºç”¨ */
        #generatedImageOutput {
            width: 100%; height: auto; border: 1px solid var(--neutral-border);
            display: block; margin: 0 auto;
        }
    </style>
</head>
<body>

<div class="container fade-in">
    <div class="header">
        <img src="./logo.png" alt="K9 Harmony" class="logo">
    </div>

    <div id="progressSection" class="progress-container hidden">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <main id="app">
        <section id="home">
            <div class="card">
                <h2 style="text-align: center;">ã†ã¡ã®å­è¨ºæ–­</h2>
                <p>æ„›çŠ¬ã®è¡Œå‹•ã‹ã‚‰ã€æ½œåœ¨çš„ãªæ‚©ã¿ã¨æœ€é©ãªçµ†ã®æ·±ã‚æ–¹ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>
                <div style="margin-top: 20px;">
                    <label>æ„›çŠ¬ã®åå‰</label>
                    <input type="text" id="dogName" placeholder="ä¾‹ï¼šãƒãƒ" style="width: 100%; padding: 12px; margin-top: 8px; border: 1px solid var(--neutral-border); box-sizing: border-box; font-family: inherit;">
                </div>
            </div>
            <button class="btn" id="startBtn">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
        </section>

        <section id="questionArea" class="hidden">
            <div class="card">
                <h3 id="questionText">è³ªå•</h3>
                <div id="options"></div>
            </div>
            <button class="btn" id="nextBtn" disabled>æ¬¡ã¸é€²ã‚€</button>
        </section>

        <section id="resultArea" class="hidden">
            <div class="card" style="text-align: center;">
                <h2 id="resultTypeTitle">è¨ºæ–­çµæœ</h2>
                <p id="saveGuide" style="font-size: 0.8rem; color: var(--neutral-border);">ç”»åƒã‚’é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™</p>
                
                <div id="imageContainer" style="margin: 20px 0;">
                    <div id="loadingPlaceholder">ç”»åƒã‚’ç”Ÿæˆä¸­...</div>
                    <img id="generatedImageOutput" class="hidden" alt="è¨ºæ–­çµæœãƒã‚§ã‚­">
                </div>

                <div id="resultDescription" style="text-align: left; line-height: 1.8;"></div>
            </div>

            <button class="btn" id="shareBtn">çµæœã‚’å‹ã ã¡ã«é€ã‚‹</button>
            <button class="btn btn-outline" onclick="location.reload()">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
        </section>
    </main>

    <div class="footer-note" style="text-align: center; font-size: 0.7rem; color: #BBB; margin-top: 40px;">
        Â© K9 Harmony | Luxury Dog Training
    </div>
</div>

<div id="chekiWrapper">
    <div id="chekiTemplate">
        <div class="cheki-photo-area">
            <div style="font-size: 40px;">ğŸ¾</div>
        </div>
        <div class="cheki-type-name" id="tmpl_typeName">ã‚¿ã‚¤ãƒ—å</div>
        <div class="cheki-dog-name" id="tmpl_dogName">æ„›çŠ¬ã®åå‰</div>
        <div class="cheki-footer">#K9Harmony #ã†ã¡ã®å­è¨ºæ–­</div>
    </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec",
    BOUNDARIES: { LOW_MID: 12, MID_HIGH: 111 }
};

const QUESTIONS = [
    { id: 1, cat: 'X', text: "åˆã‚ã¦è¡Œãå ´æ‰€ã§ã®æ„›çŠ¬ã®æ§˜å­ã¯ï¼Ÿ", options: [{t: "è½ã¡ç€ã‹ãªã„", s: 1}, {t: "å°‘ã—è­¦æˆ’ã™ã‚‹", s: 10}, {t: "ã™ãã«é¦´æŸ“ã‚€", s: 100}] },
    { id: 2, cat: 'X', text: "æ•£æ­©ä¸­ã€ä»–ã®çŠ¬ã«å‡ºä¼šã£ãŸã‚‰ï¼Ÿ", options: [{t: "é€ƒã’ã‚‹ãƒ»å ãˆã‚‹", s: 1}, {t: "æ§˜å­ã‚’ä¼ºã†", s: 10}, {t: "éŠã³ãŸãŒã‚‹", s: 100}] },
    { id: 3, cat: 'X', text: "éŠã³ã«å¯¾ã™ã‚‹æ„æ¬²ã¯ï¼Ÿ", options: [{t: "ã™ãé£½ãã‚‹", s: 1}, {t: "ç¨‹ã€…ã«éŠã¶", s: 10}, {t: "ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ã«éŠã¶", s: 100}] },
    { id: 4, cat: 'Y', text: "å®¶ã®ä¸­ã§é£¼ã„ä¸»ãŒå‹•ãã¨ï¼Ÿ", options: [{t: "å¯ã¦ã„ã‚‹", s: 1}, {t: "ç›®ã§è¿½ã†", s: 10}, {t: "å¸¸ã«ã¤ã„ã¦ãã‚‹", s: 100}] },
    { id: 5, cat: 'Y', text: "ç•™å®ˆç•ªä¸­ã®æ§˜å­ã¯ï¼Ÿ", options: [{t: "ãšã£ã¨å¯ã¦ã„ã‚‹", s: 1}, {t: "å°‘ã—ã‚½ãƒ¯ã‚½ãƒ¯ã™ã‚‹", s: 10}, {t: "ç ´å£Šè¡Œå‹•ã‚„é å ãˆ", s: 100}] },
    { id: 6, cat: 'Y', text: "æ’«ã§ã‚‹ã®ã‚’ã‚„ã‚ã‚‹ã¨ï¼Ÿ", options: [{t: "å»ã£ã¦ã„ã", s: 1}, {t: "ã˜ã£ã¨ã—ã¦ã„ã‚‹", s: 10}, {t: "å‚¬ä¿ƒã—ã¦ãã‚‹", s: 100}] },
    { id: 7, cat: 'C', text: "æ„›çŠ¬ã«ã‚‚ã£ã¨ã©ã†ãªã£ã¦ã»ã—ã„ï¼Ÿ", options: [{t: "è‡ªç«‹ã—ã¦ã»ã—ã„", s: -1}, {t: "ä»Šã®ã¾ã¾ã§è‰¯ã„", s: 0}, {t: "ã‚‚ã£ã¨ç”˜ãˆã¦ã»ã—ã„", s: 1}] }
];

let state = { userId: null, dogName: "", currentStep: 0, answers: [] };

function logger(level, message, data = "") {
    const ts = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
    console.log(`%c[${ts}] [${level}] ${message}`, "color: #2F5D62; font-weight: bold;", data);
}

/**
 * [Image Generation Engine]
 * Step 4 : html2canvasã«ã‚ˆã‚‹Base64ç”»åƒåŒ–
 */
async function generateResultImage(typeName) {
    logger("INFO", "Generating result image (Base64)...");
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å€¤ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById('tmpl_typeName').innerText = typeName;
    document.getElementById('tmpl_dogName').innerText = `${state.dogName}ã¡ã‚ƒã‚“`;

    try {
        const canvas = await html2canvas(document.getElementById('chekiTemplate'), {
            scale: 2, // é«˜è§£åƒåº¦åŒ–
            backgroundColor: null,
            logging: false
        });
        
        const base64Image = canvas.toDataURL("image/png");
        logger("INFO", "Base64 Image generated. Size:", Math.round(base64Image.length / 1024) + "KB");
        
        const outputImg = document.getElementById('generatedImageOutput');
        outputImg.src = base64Image;
        outputImg.classList.remove('hidden');
        document.getElementById('loadingPlaceholder').classList.add('hidden');
        
        return base64Image;
    } catch (err) {
        logger("ERROR", "Image generation failed.", err);
        return null;
    }
}

/**
 * [LINE Share Function]
 */
async function shareResult(typeName) {
    if (!liff.isApiAvailable('shareTargetPicker')) {
        alert("ãŠä½¿ã„ã®LINEãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã‚·ã‚§ã‚¢æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    try {
        const result = await liff.shareTargetPicker([
            {
                type: "text",
                text: `${state.dogName}ã¡ã‚ƒã‚“ã®è¨ºæ–­çµæœã¯ã€Œ${typeName}ã€ã§ã—ãŸï¼\n#K9Harmony #ã†ã¡ã®å­è¨ºæ–­`
            }
        ]);
        if (result) {
            logger("INFO", "Shared successfully.");
        }
    } catch (err) {
        logger("ERROR", "Share failed.", err);
    }
}

// --- åŸºæœ¬æ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯ (Step 1-3ã®ç¶­æŒ) ---

async function initApp() {
    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        else state.userId = liff.getContext().userId;
    } catch (err) { logger("ERROR", "LIFF init failed.", err); }
}

function showScreen(screenId) {
    ['home', 'questionArea', 'resultArea'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
    document.getElementById(screenId).classList.add('fade-in');
}

document.getElementById('startBtn').addEventListener('click', () => {
    state.dogName = document.getElementById('dogName').value.trim();
    if (!state.dogName) return alert("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    showScreen('questionArea');
    loadQuestion();
});

function loadQuestion() {
    const q = QUESTIONS[state.currentStep];
    document.getElementById('questionText').innerText = q.text;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';
    
    q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt.t;
        btn.onclick = () => {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            state.answers[state.currentStep] = opt.s;
            document.getElementById('nextBtn').disabled = false;
        };
        optionsDiv.appendChild(btn);
    });
    
    document.getElementById('nextBtn').disabled = true;
    document.getElementById('progressBar').style.width = `${(state.currentStep / QUESTIONS.length) * 100}%`;
}

document.getElementById('nextBtn').addEventListener('click', () => {
    state.currentStep++;
    if (state.currentStep < QUESTIONS.length) loadQuestion();
    else calculateAndFinish();
});

async function calculateAndFinish() {
    const scoreX = state.answers[0] + state.answers[1] + state.answers[2];
    const scoreY = state.answers[3] + state.answers[4] + state.answers[5];
    const coeff = state.answers[6];

    const getRange = (score) => {
        if (score <= CONFIG.BOUNDARIES.LOW_MID) return "LOW";
        if (score <= CONFIG.BOUNDARIES.MID_HIGH) return "MID";
        return "HIGH";
    };

    let rangeX = getRange(scoreX);
    let rangeY = getRange(scoreY);

    // Q7è£œæ­£ (å¢ƒç•Œå€¤ã‚·ãƒ•ãƒˆ)
    if ((scoreX === 12 || scoreX === 13) && coeff === 1 && rangeX === "LOW") rangeX = "MID";
    if ((scoreX === 12 || scoreX === 13) && coeff === -1 && rangeX === "MID") rangeX = "LOW";

    const matrix = {
        'LOW_LOW': 'å“²å­¦è€…ã‚¿ã‚¤ãƒ—', 'MID_LOW': 'è¦³å¯Ÿè€…ã‚¿ã‚¤ãƒ—', 'HIGH_LOW': 'å†’é™ºå®¶ã‚¿ã‚¤ãƒ—',
        'LOW_MID': 'ã®ã‚“ã³ã‚Šã‚¿ã‚¤ãƒ—', 'MID_MID': 'é»„é‡‘ã®ãƒãƒ©ãƒ³ã‚¹', 'HIGH_MID': 'ã‚¢ã‚¹ãƒªãƒ¼ãƒˆã‚¿ã‚¤ãƒ—',
        'LOW_HIGH': 'å†…å‘çš„ãªå®ˆè­·è€…', 'MID_HIGH': 'ç”˜ãˆã‚“åŠã‚¿ã‚¤ãƒ—', 'HIGH_HIGH': 'è¡å‹•çš„ã‚¿ã‚¤ãƒ—'
    };

    const finalType = matrix[`${rangeX}_${rangeY}`];
    
    showScreen('resultArea');
    
    // ç”»åƒç”Ÿæˆé–‹å§‹
    generateResultImage(finalType);
    
    document.getElementById('shareBtn').onclick = () => shareResult(finalType);

    // GASé€ä¿¡
    fetch(CONFIG.GAS_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
            uid: state.userId, dogName: state.dogName,
            scoreX, scoreY, resultType: finalType, timestamp: new Date().toISOString()
        })
    });
}

initApp();
</script>
</body>
</html>
