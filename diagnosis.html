<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Harmony | 愛犬の性格診断</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ES72ND3BPP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ES72ND3BPP');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* [Design System] */
        :root {
            --active-highlight: #57C3C2;
            --neutral-border: #C7B299;
            --progress-track: #2F5D62;
            --mist-background: #F4F7F7;
            --text-main: #2C3E50;
            --luxury-transition: 0.8s cubic-bezier(0.25, 0.1, 0.25, 1.0);
        }

        body {
            font-family: 'Noto Serif JP', serif;
            /* [Washi Texture] : 微細なノイズとグラデーションによる和紙の質感演出 */
            background-color: var(--mist-background);
            background-image: 
                linear-gradient(rgba(244, 247, 247, 0.85), rgba(244, 247, 247, 0.85)),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column;
        }

        .fade-in { animation: luxuryEaseIn var(--luxury-transition) forwards; }
        @keyframes luxuryEaseIn {
            0% { opacity: 0; transform: translateY(10px); filter: blur(5px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; flex: 1; width: 100%; box-sizing: border-box; }
        
        /* [Header] Logo */
        .header { text-align: center; margin-bottom: 40px; }
        .logo-main { width: 180px; height: auto; }

        /* [Typography] Title outside the card */
        .main-title-area { text-align: center; margin-bottom: 30px; }
        .main-title { font-size: 1.8rem; font-weight: 700; margin: 0 0 10px 0; color: var(--progress-track); letter-spacing: 0.1em; }
        .sub-title-badge { font-size: 0.85rem; color: var(--neutral-border); letter-spacing: 0.05em; display: block; margin-bottom: 15px; }
        .description-text { font-size: 0.95rem; line-height: 1.8; color: var(--text-main); margin-bottom: 30px; padding: 0 10px; }

        /* [Card] Input area only */
        .card {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--neutral-border);
            padding: 30px; border-radius: 2px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            margin-bottom: 25px;
            backdrop-filter: blur(2px);
        }

        .input-group label { display: block; font-size: 0.9rem; margin-bottom: 10px; font-weight: bold; color: var(--progress-track); }
        .input-group input { 
            width: 100%; padding: 15px; border: 1px solid var(--neutral-border); 
            background: rgba(255,255,255,0.9); box-sizing: border-box; font-family: inherit; font-size: 1rem;
        }

        .btn {
            display: block; width: 100%; padding: 20px;
            background: var(--active-highlight); color: #FFF;
            border: none; font-size: 1.1rem; cursor: pointer;
            transition: 0.4s cubic-bezier(0.25, 0.1, 0.25, 1.0); text-align: center; text-decoration: none;
            letter-spacing: 0.1em; font-family: 'Noto Serif JP', serif; font-weight: 700;
        }
        .btn:hover { background: var(--progress-track); }

        .privacy-link-container { text-align: center; margin-top: 15px; }
        .privacy-link { color: var(--neutral-border); font-size: 0.75rem; text-decoration: underline; cursor: pointer; }

        /* [Footer] Specified HTML structure */
        .site-footer {
            background: rgba(255, 255, 255, 0.5);
            border-top: 1px solid var(--neutral-border);
            padding: 40px 20px; text-align: center; font-size: 0.8rem; color: #7F8C8D;
        }
        .footer-logo-img { width: 140px; margin-bottom: 20px; }
        .footer-info p { margin: 5px 0; }

        /* [Modal] Privacy Policy */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; z-index: 1000;
            align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: #FFF; width: 90%; max-width: 500px; max-height: 80vh;
            padding: 30px; position: relative; overflow-y: auto; border: 1px solid var(--neutral-border);
        }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: var(--neutral-border); }
        .policy-body { font-size: 0.8rem; line-height: 1.6; text-align: left; }

        .hidden { display: none; }
        
        /* Question/Result placeholders for Step 4 Logic */
        #questionArea .card, #resultArea .card { background: rgba(255, 255, 255, 0.8); }
        .option-btn {
            display: block; width: 100%; padding: 15px; margin-bottom: 12px;
            background: #FFF; border: 1px solid var(--neutral-border);
            text-align: left; cursor: pointer; transition: 0.3s; font-family: inherit;
        }
        .option-btn.selected { background: var(--active-highlight); color: #FFF; }
    </style>
</head>
<body>

<div class="container fade-in">
    <div class="header">
        <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" alt="K9 Harmony" class="logo-main">
    </div>

    <main id="app">
        <section id="home">
            <div class="main-title-area">
                <h1 class="main-title">愛犬の性格診断</h1>
                <span class="sub-title-badge">〈K9 Harmony ドッグトレーナー監修〉</span>
                <p class="description-text">愛犬の行動から、潜在的な悩みと<br>最適な絆の深め方を可視化します。</p>
            </div>

            <div class="card">
                <div class="input-group">
                    <label for="dogName">愛犬の名前</label>
                    <input type="text" id="dogName" placeholder="例：ポチ" maxlength="10">
                </div>
            </div>

            <button class="btn" id="startBtn">診断を始める</button>

            <div class="privacy-link-container">
                <span class="privacy-link" id="openPrivacy">個人情報保護方針に同意して開始</span>
            </div>
        </section>

        <section id="questionArea" class="hidden">
            <div id="progressSection" style="width: 100%; height: 3px; background: #EEE; margin-bottom: 20px;">
                <div id="progressBar" style="height: 100%; background: var(--progress-track); width: 0%;"></div>
            </div>
            <div class="card">
                <h3 id="questionText" style="margin-top:0;">質問</h3>
                <div id="options"></div>
            </div>
            <button class="btn" id="nextBtn" disabled>次へ進む</button>
        </section>

        <section id="resultArea" class="hidden">
            <div class="card" style="text-align: center;">
                <h2 id="resultTypeTitle">診断結果</h2>
                <div id="imageContainer" style="margin: 20px 0;">
                    <img id="generatedImageOutput" style="width:100%; border: 1px solid var(--neutral-border);" alt="診断結果">
                </div>
            </div>
            <button class="btn" id="shareBtn">結果を友だちに送る</button>
        </section>
    </main>
</div>

<footer class="site-footer">
    <div class="footer-logo-container">
        <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" class="footer-logo-img" alt="K9 Harmony">
    </div>
    <div class="footer-info">
        <p><strong>K9 Harmony</strong></p>
        <p>東京都板橋区 (Dummy Address)</p>
        <p>03-0000-0000 (Dummy Phone)</p>
    </div>
    <div style="margin-top:20px;">&copy; 2025 K9 Harmony</div>
</footer>

<div class="modal" id="privacyModal">
    <div class="modal-content">
        <span class="close-modal" id="closePrivacy">&times;</span>
        <h3 style="margin-top:0; border-bottom: 1px solid var(--neutral-border); padding-bottom:10px;">プライバシーポリシー</h3>
        <div class="policy-body">
            <p>K9 Harmony -Paws & People Cultural Lab.-（以下「当事業者」といいます）は、お客様の個人情報保護の重要性について認識し...（中略）</p>
            <h4>1. 事業者情報</h4>
            <p>事業者名：K9 Harmony -Paws & People Cultural Lab.-<br>代表者：平田淳<br>所在地：〒174-0063 東京都板橋区前野町6-55-1</p>
            <p>※以下、提供された全文を表示...</p>
            <p style="font-size:0.7rem; color:#999; margin-top:20px;">制定日：2025年11月23日</p>
        </div>
    </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const CONFIG = {
    LIFF_ID: "2008546673-MJY7j3ox",
    GAS_URL: "https://script.google.com/macros/s/AKfycbwyzFB78jRF4skpjakJrlozJJyTUOJqUtzmnF0aQVE89_rROwwwup6bVKhkNpvK6wqPrg/exec"
};

const QUESTIONS = [
    { id: 1, cat: 'X', text: "初めて行く場所での愛犬の様子は？", options: [{t: "落ち着かない", s: 1}, {t: "少し警戒する", s: 10}, {t: "すぐに馴染む", s: 100}] },
    { id: 2, cat: 'X', text: "散歩中、他の犬に出会ったら？", options: [{t: "逃げる・吠える", s: 1}, {t: "様子を伺う", s: 10}, {t: "遊びたがる", s: 100}] },
    { id: 3, cat: 'X', text: "遊びに対する意欲は？", options: [{t: "すぐ飽きる", s: 1}, {t: "程々に遊ぶ", s: 10}, {t: "エンドレスに遊ぶ", s: 100}] },
    { id: 4, cat: 'Y', text: "家の中で飼い主が動くと？", options: [{t: "寝ている", s: 1}, {t: "目で追う", s: 10}, {t: "常についてくる", s: 100}] },
    { id: 5, cat: 'Y', text: "留守番中の様子は？", options: [{t: "ずっと寝ている", s: 1}, {t: "少しソワソワする", s: 10}, {t: "破壊行動や遠吠え", s: 100}] },
    { id: 6, cat: 'Y', text: "撫でるのをやめると？", options: [{t: "去っていく", s: 1}, {t: "じっとしている", s: 10}, {t: "催促してくる", s: 100}] },
    { id: 7, cat: 'C', text: "愛犬にもっとどうなってほしい？", options: [{t: "自立してほしい", s: -1}, {t: "今のままで良い", s: 0}, {t: "もっと甘えてほしい", s: 1}] }
];

let state = { dogName: "", currentStep: 0, answers: [], userId: null };

function logger(level, message, data = "") {
    const ts = new Date().toLocaleString();
    console.log(`[${ts}] [${level}] ${message}`, data);
}

// [Modal Logic]
const modal = document.getElementById('privacyModal');
document.getElementById('openPrivacy').onclick = () => modal.style.display = 'flex';
document.getElementById('closePrivacy').onclick = () => modal.style.display = 'none';
window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; };

// [LIFF Init]
async function initApp() {
    logger("INFO", "App init...");
    try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        else state.userId = liff.getContext().userId;
    } catch (e) { logger("ERROR", "LIFF init failed", e); }
}

// [Transition]
function showScreen(id) {
    ['home', 'questionArea', 'resultArea'].forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.getElementById(id).classList.add('fade-in');
}

// [Home Actions]
document.getElementById('startBtn').onclick = () => {
    state.dogName = document.getElementById('dogName').value.trim();
    if (!state.dogName) return alert("愛犬のお名前を教えてください。");
    trackGA('diagnosis_start');
    showScreen('questionArea');
    loadQuestion();
};

// ... (以下、Step 4までの既存ロジックを維持して実装) ...
function loadQuestion() {
    const q = QUESTIONS[state.currentStep];
    document.getElementById('questionText').innerText = q.text;
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';
    q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt.t;
        btn.onclick = () => {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            state.answers[state.currentStep] = opt.s;
            document.getElementById('nextBtn').disabled = false;
        };
        optionsDiv.appendChild(btn);
    });
    document.getElementById('progressBar').style.width = `${(state.currentStep / QUESTIONS.length)*100}%`;
}

document.getElementById('nextBtn').onclick = () => {
    state.currentStep++;
    if (state.currentStep < QUESTIONS.length) loadQuestion();
    else calculateResults();
};

function calculateResults() {
    // スコア計算・画像生成（Step 4ロジック）をここに継続
    logger("INFO", "Calculation complete.");
    showScreen('resultArea');
}

function trackGA(name) { gtag('event', name); }

initApp();
</script>
</body>
</html>
