<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="K9 Harmony -Paws & People Cultural Lab- 出張型ドッグトレーニング予約システム">
  <title>トレーニングの予約 | K9 Harmony</title>
  
  <!-- External Libraries -->
  <script src="https://web.squarecdn.com/v1/square.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <!-- K9 Harmony Styles -->
  <link href="css/common.css?v=20260127d" rel="stylesheet">
  <link href="css/reservation.css?v=20260127d" rel="stylesheet">
</head>

<body class="debug-mode">

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       デバッグログスタンプ（開発時のみ表示）
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  <div id="debug-timestamp" class="debug-timestamp">
    <span class="debug-label">🐾 K9 Harmony Debug Mode</span>
    <span id="page-load-time">Loading...</span>
    <span class="debug-version">v2026.01.27</span>
  </div>

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       ヘッダー（ロゴ常時表示）
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  <header class="site-header">
    <img 
      src="assets/K9_logoFull.png"
      alt="K9 Harmony"
      class="header-logo"
    >
  </header>

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       ローディングオーバーレイ
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-animation">
      <lottie-player
        src="https://assets-v2.lottiefiles.com/a/675504ee-1181-11ee-bcfe-cb540b492b01/NrfQwzw5Pa.json"
        background="transparent"
        speed="1"
        style="width: 150px; height: 150px;"
        loop
        autoplay
      ></lottie-player>
    </div>
    <div class="loading-text" id="loading-text">起動中...</div>
    <div class="loading-tips" id="loading-tips"></div>
  </div>

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       プログレスバー（5段階）
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  <div class="progress-container">
    <div class="progress-bg"></div>
    <div class="progress-bar-fill" id="progress-fill"></div>
    <div class="step-dot active" id="dot-1"></div>
    <div class="step-dot" id="dot-2"></div>
    <div class="step-dot" id="dot-3"></div>
    <div class="step-dot" id="dot-4"></div>
    <div class="step-dot" id="dot-5"></div>
  </div>

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       メインコンテンツ
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  <div class="container">

    <!-- ────────────────────────────────────────────────────
         View 1: 犬・コース・トレーナー選択
         ──────────────────────────────────────────────────── -->
    <div id="view-1" class="view-section active">
      <h2 class="card-title">予約内容</h2>
      
      <!-- 選択中の愛犬（新規ユーザーは非表示） -->
      <div class="card" id="dog-selection-card">
        <label class="form-label">選択中の愛犬</label>
        <div id="selected-dog-name" class="selected-dog-display">---</div>
        <button 
          class="btn btn-sm btn-secondary" 
          id="btn-change-dog" 
          onclick="showDogSelectModal()"
        >
          愛犬切替
        </button>

        <!-- 2頭目追加チェック -->
        <div class="multi-dog-check-container">
          <label class="checkbox-row">
            <input type="checkbox" id="multi-dog-check">
            <span>2頭目の追加 (+2,000円 / +30分)</span>
          </label>
        </div>
      </div>

      <!-- 新規顧客向けUID表示ボタン（既存顧客の場合は非表示） -->
      <div id="existing-customer-link-area" class="text-center hidden">
        <span class="text-link" onclick="openUidModal()">すでに契約済みのお客様はこちら</span>
      </div>

      <!-- トレーナー選択（2人以上の場合のみ表示） -->
      <div class="card" id="trainer-select-card">
        <label class="form-label">トレーナー</label>
        <select id="trainer-select" class="form-control">
          <option value="">読み込み中...</option>
        </select>
      </div>

      <!-- メニュー選択 -->
      <div class="card">
        <label class="form-label">メニュー</label>
        <select id="menu-select" class="form-control">
          <option value="">読み込み中...</option>
        </select>
        
        <!-- チケット残数表示 -->
        <div id="ticket-info" class="ticket-info hidden">
          🎫 チケット残数: <span id="ticket-count">0</span>回
        </div>
      </div>

      <!-- 次へボタン -->
      <button class="btn btn-primary btn-block" id="btn-next-view2" onclick="goToView(2)" disabled>
        次へ（日時選択）
      </button>
    </div>

    <!-- ────────────────────────────────────────────────────
         View 2: 日時選択（月間カレンダー）
         ──────────────────────────────────────────────────── -->
    <div id="view-2" class="view-section">
      <h2 class="card-title">日時の選択</h2>
      
      <!-- カレンダー -->
      <div class="card">
        <div class="calendar-controls">
          <button class="btn btn-sm btn-secondary" onclick="shiftMonth(-1)">&lt; 前月</button>
          <span id="calendar-month-label" class="calendar-month-label">2026年 1月</span>
          <button class="btn btn-sm btn-secondary" onclick="shiftMonth(1)">次月 &gt;</button>
        </div>

        <div class="calendar-wrapper">
          <div id="calendar-overlay-loader" class="calendar-overlay-loader hidden">
            <div class="spinner"></div>
            <div class="loading-text">スケジュール確認中...</div>
          </div>
          <div id="calendar-grid" class="calendar-grid">
            <!-- JavaScriptで動的生成 -->
          </div>
        </div>

        <div class="calendar-legend">
          <span><span class="symbol-available">●</span> 空きあり</span>
          <span><span class="symbol-few">◐</span> わずか</span>
          <span><span class="symbol-full">○</span> 満席</span>
        </div>
      </div>

      <!-- 別住所での実施 -->
<div class="card">
  <label class="checkbox-row">
    <input type="checkbox" id="alt-address-check" onchange="toggleAltAddress()">
    <span>申込住所と異なる場所で実施</span>
  </label>

  <div class="alt-address-area hidden" id="alt-address-area">
    <div class="form-group">
      <label class="form-label required">住所</label>
      <input type="text" id="alt-addr" class="form-control" placeholder="東京都板橋区前野町...">
    </div>
  
    <div class="form-group">
      <label class="form-label">施設名</label>
      <input type="text" id="alt-building" class="form-control" placeholder="例: ○○公園">
    </div>
  
    <div class="form-group">
      <label class="form-label required">目印</label>
      <input type="text" id="alt-landmark" class="form-control" placeholder="例: 駐車場の隣">
    </div>
  
    <div class="form-group">
      <label class="form-label">場所のタイプ</label>
      <div class="radio-group">
        <label class="radio-label">
          <input type="radio" name="alt-location-type" value="outdoor" checked>
          <span>屋外</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="alt-location-type" value="indoor">
          <span>屋内</span>
        </label>
      </div>
    </div>
  
    <div class="form-group">
      <label class="form-label">備考</label>
      <textarea 
        id="alt-remarks" 
        class="form-control" 
        rows="2" 
        placeholder="駐車場の有無、アクセス方法など"
      ></textarea>
    </div>
  </div>
</div>  <!-- ← ここで card を閉じる（追加） -->

<!-- ボタン -->
<div class="btn-row">
  <button class="btn btn-secondary" onclick="goToView(1)">戻る</button>
  <button class="btn btn-primary" id="btn-next-view3" onclick="goToView(3)" disabled>
    次へ
  </button>
</div>
</div>  <!-- ← ここで view-2 を閉じる -->

    <!-- ────────────────────────────────────────────────────
         View 3: 概算料金・場所・規約
         ──────────────────────────────────────────────────── -->
    <div id="view-3" class="view-section">
      <h2 class="card-title">確認と規約</h2>
      
      <!-- 予約内容 -->
      <div class="card">
        <label class="form-label">ご予約内容</label>
        <div class="reservation-summary">
          <div class="summary-row">
            <span class="summary-label">日時:</span>
            <span id="conf-datetime">---</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">場所:</span>
            <span id="conf-place">---</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">パートナー:</span>
            <span id="conf-dog">---</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">コース:</span>
            <span id="conf-course">---</span>
          </div>
        </div>
      </div>

      <!-- 料金内訳 -->
      <div class="card">
        <label class="form-label">料金内訳</label>
        
        <div class="price-breakdown">
          <div class="price-row">
            <span>トレーニング料金</span>
            <span id="price-lesson">¥---</span>
          </div>
          <div class="price-row" id="price-multi-row" style="display: none;">
            <span>複数頭料金</span>
            <span>¥2,000</span>
          </div>
          <div class="price-row price-subtotal">
            <span>小計</span>
            <span id="price-subtotal">¥---</span>
          </div>
        </div>

        <div class="travel-fee-section">
          <div class="price-row">
            <span>出張費</span>
            <span id="price-travel-fee" class="text-primary">計算中...</span>
          </div>
          <!-- 距離は非表示（設計方針） -->
          <div class="travel-distance hidden" id="travel-distance">
            直線距離: <span id="travel-km">-</span> km
          </div>
          
          <!-- 料金表アコーディオン -->
          <div class="accordion">
            <div class="accordion-header" onclick="toggleAccordion('travel-fee-table')">
              <span>料金表を表示</span>
              <i class="fa-solid fa-chevron-down accordion-icon"></i>
            </div>
            <div id="travel-fee-table" class="accordion-content">
              <table class="fee-table">
                <tr><td>3km以内</td><td>無料</td></tr>
                <tr><td>3km超 〜 5km以内</td><td>¥500</td></tr>
                <tr><td>5km超 〜 10km以内</td><td>¥1,000</td></tr>
                <tr><td>10km超 〜 15km以内</td><td>¥1,500</td></tr>
                <tr><td>15km超</td><td>¥1,500 + (超過距離×¥100/km)</td></tr>
              </table>
              <div class="fee-note">
                ※距離算出は弊社事務所からの直線距離で算出しております。
              </div>
            </div>
          </div>
        </div>

        <!-- Voucher / 紹介コード（合計の前） -->
        <div class="voucher-section">
          <label class="form-label">Voucher / 紹介コード</label>
          <div class="voucher-input-group">
            <input 
              type="text" 
              id="voucher-code" 
              class="form-control" 
              placeholder="コードを入力"
            >
            <button class="btn btn-secondary" onclick="applyVoucher()">適用</button>
          </div>
          <div id="voucher-result" class="voucher-result"></div>
        </div>

        <div class="price-row" id="price-discount-row" style="display: none;">
          <span>割引</span>
          <span id="price-discount" class="text-success">-¥---</span>
        </div>

        <div class="price-row price-total">
          <span>合計</span>
          <span id="price-total">¥---</span>
        </div>
      </div>

      <!-- 備考 -->
      <div class="card">
        <label class="form-label">備考</label>
        <textarea 
          id="conf-remarks" 
          class="form-control" 
          rows="3" 
          placeholder="ご質問や連絡事項がございましたらご記入ください"
        ></textarea>
      </div>

      <!-- お支払い方法 -->
      <div class="card">
        <label class="form-label">お支払い方法</label>
        <select id="payment-method" class="form-control">
          <option value="CARD">クレジットカード</option>
          <option value="QUICPAY">QUICPay</option>
          <option value="ID">iD</option>
          <option value="IC">交通系IC</option>
          <option value="CASH">当日現金払い</option>
        </select>
      </div>

      <!-- 1. 注意事項（新規ユーザー向け） -->
      <div id="notice-section-new-user" class="card notice-card hidden">
        <label class="form-label">
          <i class="fa-solid fa-circle-info"></i> ご予約にあたっての注意事項
        </label>
        <ul class="notice-list">
          <li>出張費は次のステップでお客様情報入力後に自動計算されます（3km以内無料）</li>
          <li>予約確定後のキャンセルには規定のキャンセル料が発生します</li>
        </ul>
      </div>

      <!-- 2. 重要事項説明（新規ユーザー向け） -->
      <div id="important-notice-section" class="card important-notice-card hidden">
        <label class="form-label">
          <i class="fa-solid fa-exclamation-triangle"></i> 重要事項説明
        </label>
        <div class="important-notice-content">
          <p><strong>初回トレーニングについて</strong></p>
          <ul class="notice-list">
            <li>初回トレーニングは必ず飼い主様の同席が必要です</li>
            <li>トレーニング時間は約90分を予定しています</li>
            <li>当日は動きやすい服装でお越しください</li>
          </ul>
          <p><strong>ご準備いただくもの</strong></p>
          <ul class="notice-list">
            <li>狂犬病予防接種証明書</li>
            <li>混合ワクチン接種証明書</li>
            <li>普段使用しているリード・首輪</li>
            <li>お気に入りのおやつ</li>
          </ul>
          <p><strong>免責事項</strong></p>
          <ul class="notice-list">
            <li>トレーニング中の事故について、当方の過失を除き責任を負いかねます</li>
            <li>天候等により日程変更をお願いする場合があります</li>
          </ul>
        </div>
        <div class="checkbox-row important-checkbox">
          <input type="checkbox" class="term-check" id="chk-important" onchange="checkAllTerms()">
          <label for="chk-important"><strong>上記重要事項を確認しました</strong></label>
        </div>
      </div>

      <!-- 規約等の確認 -->
      <div class="card">
        <label class="form-label">規約等の確認</label>

        <div class="checkbox-row">
          <input type="checkbox" class="term-check" id="chk-policy" onchange="checkAllTerms()">
          <label onclick="openTerms('policy')">キャンセルポリシーに同意</label>
        </div>
        
        <div class="checkbox-row">
          <input type="checkbox" class="term-check" id="chk-privacy" onchange="checkAllTerms()">
          <label onclick="openTerms('privacy')">個人情報の取扱に同意</label>
        </div>
        
        <div class="checkbox-row">
          <input type="checkbox" class="term-check" id="chk-terms" onchange="checkAllTerms()">
          <label onclick="openTerms('terms')">利用規約に同意</label>
        </div>
        
        <div class="checkbox-row">
          <input type="checkbox" class="term-check" id="chk-law" onchange="checkAllTerms()">
          <label onclick="openTerms('law')">特定商取引法に基づく表記を確認</label>
        </div>

        <div class="checkbox-divider"></div>

        <div class="checkbox-row">
          <input type="checkbox" id="chk-all" onchange="toggleAllTerms()">
          <label for="chk-all"><strong>全てに同意する</strong></label>
        </div>
      </div>

      <!-- キャンセル料について（ボタン上部） -->
      <div class="cancellation-info-box">
        <div class="cancellation-info-header">
          <i class="fa-solid fa-triangle-exclamation"></i> キャンセル料について
        </div>
        <div class="cancellation-info-body">
          <div class="cancellation-row">
            <span>予約日まで:</span>
            <span id="days-until-reservation">-</span>日
          </div>
          <div class="cancellation-row">
            <span>現在のキャンセル料:</span>
            <span id="current-cancellation-rate" class="text-primary">-</span>
          </div>
          <div class="cancellation-policy">
            4日前まで: 無料 / 3日前〜2日前: 50% / 前日〜当日: 100%
          </div>
        </div>
      </div>

      <!-- ボタン -->
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="goToView(2)">戻る</button>
        <button class="btn btn-primary" id="btn-next-view4" onclick="checkUserAndNext()" disabled>
          次へ
        </button>
      </div>
    </div>

    <!-- ────────────────────────────────────────────────────
         View 4: 決済・情報入力
         ──────────────────────────────────────────────────── -->
    <div id="view-4" class="view-section">
      <h2 class="card-title">お支払い・情報入力</h2>

      <!-- パターンA: 既存ユーザー + カード決済 -->
      <div id="view4-existing-card" class="view4-pattern hidden">
        <div class="card">
          <label class="form-label">確定料金</label>
          <div class="price-breakdown">
            <div class="price-row">
              <span>トレーニング料金</span>
              <span id="final-price-lesson">¥---</span>
            </div>
            <div class="price-row" id="final-price-multi-row">
              <span>複数頭料金</span>
              <span id="final-price-multi">¥2,000</span>  <!-- ← id追加 -->
            </div>
            <div class="price-row">
              <span>出張費</span>
              <span id="final-price-travel">¥---</span>
            </div>
            <div class="price-row" id="final-price-discount-row">
              <span id="final-price-discount-label">割引</span>
              <span id="final-price-discount">-¥---</span>
            </div>
            <div class="price-row price-total">
              <span>合計</span>
              <span id="final-price-total">¥---</span>
            </div>
          </div>

        </div>

        <div class="card">
          <label class="form-label">クレジットカード情報</label>
          <div id="square-card-container"></div>
        </div>

        <div class="btn-row">
          <button class="btn btn-secondary" onclick="goToView(3)">戻る</button>
          <button class="btn btn-primary" onclick="handleCardTokenize()">決済して予約確定</button>
        </div>
      </div>

      <!-- パターンB: 新規ユーザー（アコーディオン形式） -->
      <div id="view4-new-card" class="view4-pattern hidden">

        <!-- 犬種サジェスト用datalist -->
        <datalist id="breed-suggestions">
          <option value="トイプードル">
          <option value="チワワ">
          <option value="柴犬">
          <option value="ミニチュアダックスフンド">
          <option value="ポメラニアン">
          <option value="フレンチブルドッグ">
          <option value="ミニチュアシュナウザー">
          <option value="ヨークシャーテリア">
          <option value="シーズー">
          <option value="マルチーズ">
          <option value="パグ">
          <option value="ゴールデンレトリバー">
          <option value="ラブラドールレトリバー">
          <option value="コーギー">
          <option value="ビーグル">
          <option value="ボーダーコリー">
          <option value="ジャックラッセルテリア">
          <option value="キャバリア">
          <option value="パピヨン">
          <option value="ミックス">
        </datalist>

        <!-- ===== アコーディオン1: 飼い主情報 ===== -->
        <div class="accordion-section" id="accordion-owner">
          <div class="accordion-header-new open" onclick="toggleNewUserAccordion('owner')">
            <span class="accordion-step">1/3</span>
            <span class="accordion-title">飼い主情報</span>
            <i class="fa-solid fa-chevron-down accordion-icon"></i>
          </div>
          <div class="accordion-content-new open" id="accordion-owner-content">
            <div class="form-group">
              <label class="form-label required">お名前</label>
              <input type="text" id="reg-name" class="form-control" placeholder="山田 太郎" oninput="validateOwnerSection()">
            </div>

            <div class="form-group">
              <label class="form-label required">電話番号</label>
              <input
                type="tel"
                id="reg-phone"
                class="form-control"
                placeholder="090-1234-5678"
                inputmode="numeric"
                oninput="formatPhone(this); validateOwnerSection()"
              >
            </div>

            <div class="form-group">
              <label class="form-label required">メールアドレス</label>
              <input
                type="email"
                id="reg-email"
                class="form-control"
                placeholder="example@email.com"
                oninput="validateOwnerSection()"
              >
            </div>

            <div class="form-group">
              <label class="form-label required">郵便番号</label>
              <div class="zip-input-group">
                <input
                  type="tel"
                  id="reg-zip"
                  class="form-control"
                  placeholder="123-4567"
                  inputmode="numeric"
                  maxlength="8"
                  oninput="formatZipAndFetch(this, 'reg-addr')"
                >
                <button type="button" class="btn btn-secondary btn-sm" onclick="searchAddressByZip()">住所検索</button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label required">住所</label>
              <input
                type="text"
                id="reg-addr"
                class="form-control"
                placeholder="都道府県〜番地まで入力"
                onblur="geocodeNewUserAddress()"
                oninput="validateOwnerSection()"
              >
            </div>

            <div class="form-group">
              <label class="form-label">建物名・部屋番号</label>
              <input type="text" id="reg-building" class="form-control" placeholder="○○マンション 101号室">
            </div>

            <!-- 住所確認・出張費表示エリア -->
            <div id="address-confirmation" class="address-confirmation hidden">
              <div class="confirmation-icon"><i class="fa-solid fa-circle-check"></i></div>
              <div class="confirmation-text">
                <div id="confirmed-address">-</div>
                <div id="travel-fee-result" class="travel-fee-result">出張費: 計算中...</div>
              </div>
            </div>

            <div class="accordion-nav">
              <button class="btn btn-secondary" onclick="goToView(3)">戻る</button>
              <button class="btn btn-primary" id="btn-to-dog-section" onclick="goToAccordionSection('dog')" disabled>
                次へ：パートナー情報 →
              </button>
            </div>
          </div>
        </div>

        <!-- ===== アコーディオン2: 犬情報 ===== -->
        <div class="accordion-section" id="accordion-dog">
          <div class="accordion-header-new" onclick="toggleNewUserAccordion('dog')">
            <span class="accordion-step">2/3</span>
            <span class="accordion-title">パートナー情報</span>
            <i class="fa-solid fa-chevron-down accordion-icon"></i>
          </div>
          <div class="accordion-content-new" id="accordion-dog-content">
            <div class="form-group">
              <label class="form-label required">パートナー名</label>
              <input type="text" id="reg-dog-name" class="form-control" placeholder="ポチ" oninput="validateDogSection()">
            </div>

            <div class="form-group">
              <label class="form-label required">犬種</label>
              <input
                type="text"
                id="reg-dog-breed"
                class="form-control"
                placeholder="トイプードル"
                list="breed-suggestions"
                oninput="validateDogSection()"
              >
            </div>

            <div class="form-group">
              <label class="form-label required">年齢</label>
              <div class="age-input-group">
                <select id="reg-dog-age-year" class="form-control" onchange="validateDogSection()">
                  <option value="">--</option>
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="15">15</option>
                  <option value="16">16歳以上</option>
                </select>
                <span class="age-unit">歳</span>
                <select id="reg-dog-age-month" class="form-control" onchange="validateDogSection()">
                  <option value="">--</option>
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                </select>
                <span class="age-unit">ヶ月</span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label required">性別</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="reg-dog-gender" value="♂" onchange="validateDogSection()">
                  <span>♂ オス</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="reg-dog-gender" value="♀" onchange="validateDogSection()">
                  <span>♀ メス</span>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">避妊・去勢</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="reg-dog-neutered" value="true">
                  <span>済</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="reg-dog-neutered" value="false">
                  <span>未</span>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">ワクチン接種</label>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" name="reg-vaccine" value="rabies">
                  <span>狂犬病</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="reg-vaccine" value="mixed">
                  <span>混合ワクチン</span>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">気になること・お困りごと</label>
              <textarea
                id="reg-concerns"
                class="form-control"
                rows="3"
                placeholder="吠え癖、噛み癖、引っ張り癖など"
              ></textarea>
            </div>

            <div class="accordion-nav">
              <button class="btn btn-secondary" onclick="goToAccordionSection('owner')">← 戻る</button>
              <button class="btn btn-primary" id="btn-to-payment-section" onclick="goToAccordionSection('payment')" disabled>
                次へ：料金確認 →
              </button>
            </div>
          </div>
        </div>

        <!-- ===== アコーディオン3: 料金確認・お支払い ===== -->
        <div class="accordion-section" id="accordion-payment">
          <div class="accordion-header-new" onclick="toggleNewUserAccordion('payment')">
            <span class="accordion-step">3/3</span>
            <span class="accordion-title">料金確認・お支払い</span>
            <i class="fa-solid fa-chevron-down accordion-icon"></i>
          </div>
          <div class="accordion-content-new" id="accordion-payment-content">

            <!-- 予約内容サマリー -->
            <div class="summary-box">
              <h4 class="summary-title">ご予約内容</h4>
              <div class="summary-row">
                <span>日時:</span>
                <span id="new-user-conf-datetime">---</span>
              </div>
              <div class="summary-row">
                <span>場所:</span>
                <span id="new-user-conf-place">---</span>
              </div>
              <div class="summary-row">
                <span>パートナー:</span>
                <span id="new-user-conf-dog">---</span>
              </div>
              <div class="summary-row">
                <span>コース:</span>
                <span id="new-user-conf-course">---</span>
              </div>
            </div>

            <!-- 料金内訳 -->
            <div class="price-box">
              <h4 class="price-title">料金</h4>
              <div class="price-row">
                <span>トレーニング料金</span>
                <span id="new-user-price-lesson">¥---</span>
              </div>
              <div class="price-row">
                <span>出張費</span>
                <span id="new-user-price-travel">¥---</span>
              </div>
              <div class="price-row price-total">
                <span>合計</span>
                <span id="new-user-price-total">¥---</span>
              </div>
            </div>

            <!-- お支払い方法 -->
            <div class="form-group">
              <label class="form-label">お支払い方法</label>
              <select id="new-user-payment-method" class="form-control" onchange="toggleNewUserPaymentMethod()">
                <option value="CARD">クレジットカード</option>
                <option value="CASH">当日現金払い</option>
              </select>
            </div>

            <!-- カード入力欄 -->
            <div id="new-user-card-section">
              <div class="form-group">
                <label class="form-label">クレジットカード情報</label>
                <div id="square-card-container-new"></div>
              </div>
            </div>

            <div class="accordion-nav">
              <button class="btn btn-secondary" onclick="goToAccordionSection('dog')">← 戻る</button>
              <button class="btn btn-primary" id="btn-confirm-new-user" onclick="confirmNewUserReservation()">
                予約を確定する
              </button>
            </div>
          </div>
        </div>

      </div>

      <!-- パターンC: 現地決済（カード入力なし） -->
      <div id="view4-cash" class="view4-pattern hidden">
        <div class="card">
          <label class="form-label">確定料金</label>
          <div class="price-breakdown">
            <div class="price-row">
              <span>トレーニング料金</span>
              <span id="cash-price-lesson">¥---</span>
            </div>
            <div class="price-row" id="cash-price-multi-row">
              <span>複数頭料金</span>
              <span id="cash-price-multi">¥2,000</span>  <!-- ← id追加 -->
            </div>
            <div class="price-row">
              <span>出張費</span>
              <span id="cash-price-travel">¥---</span>
            </div>
            <div class="price-row" id="cash-price-discount-row">
              <span>割引</span>
              <span id="cash-price-discount">-¥---</span>
            </div>
            <div class="price-row price-total">
              <span>合計</span>
              <span id="cash-price-total">¥---</span>
            </div>
          </div>

          <div class="payment-method-notice">
            📌 お支払い方法: 当日現金払い
          </div>
        </div>

        <div class="card warning-card">
          <div class="warning-header">
            <i class="fa-solid fa-triangle-exclamation"></i> キャンセル規定
          </div>
          <div class="warning-body">
            <p>受付締切: 前日18:00</p>
            <p>4日前まで: 無料</p>
            <p>3日前〜2日前: 50%</p>
            <p>前日〜当日: 100%</p>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn btn-secondary" onclick="goToView(3)">戻る</button>
          <button class="btn btn-primary" onclick="submitReservation()">予約を確定する</button>
        </div>
      </div>
    </div>

    <!-- ────────────────────────────────────────────────────
         View 5: サンクスページ
         ──────────────────────────────────────────────────── -->
    <div id="view-5" class="view-section">
      <div class="thanks-container">
        <div class="thanks-icon">
          <i class="fa-regular fa-circle-check"></i>
        </div>
        <h2 class="card-title">予約完了</h2>
        <p class="thanks-message">ご予約ありがとうございます</p>

        <div class="card">
          <label class="form-label">予約内容詳細</label>
          <div class="reservation-summary">
            <div class="summary-row">
              <span class="summary-label">日時:</span>
              <span id="thanks-datetime">---</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">場所:</span>
              <span id="thanks-place">---</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">パートナー:</span>
              <span id="thanks-dog">---</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">コース:</span>
              <span id="thanks-course">---</span>
            </div>
            <div id="thanks-coupon-row" class="summary-row" style="display: none;">
              <span class="summary-label">クーポン:</span>
              <span id="thanks-coupon">---</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">合計:</span>
              <span id="thanks-total" class="text-primary">¥---</span>
            </div>
          </div>
        </div>

        <!-- 当日の注意事項 -->
        <div class="card">
          <label class="form-label">当日の注意事項</label>
          <div id="thanks-notes" class="thanks-notes">
            <!-- 後日追加予定 -->
          </div>
        </div>

        <!-- 当日の持ち物 -->
        <div class="card">
          <label class="form-label">当日の持ち物</label>
          <ul class="thanks-items-list">
            <li>リード（普段使用しているもの）</li>
            <li>首輪またはハーネス</li>
            <li>おやつ（普段食べ慣れているもの）</li>
            <li>飲み水・水入れ</li>
            <li>排泄物処理用の袋</li>
            <li>タオル（雨天・夏季は特に）</li>
          </ul>
        </div>

        <button class="btn btn-primary btn-block" onclick="shareLine()">
          <i class="fa-brands fa-line"></i> LINEでシェア
        </button>

        <button class="btn btn-secondary btn-block" onclick="addToGoogleCalendar()">
          <i class="fa-regular fa-calendar"></i> Googleカレンダー登録
        </button>

        <button class="btn btn-secondary btn-block" onclick="shareNative()">
          <i class="fa-solid fa-share-nodes"></i> シェア
        </button>

        <div class="thanks-actions">
          <button class="btn btn-primary btn-block" onclick="location.reload()">
            他の予約をする
          </button>

          <button class="btn btn-secondary btn-block" onclick="liff.closeWindow()">
            閉じる
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       フッター
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  <footer class="site-footer">
    <img 
      src="assets/K9_logoFull.png"
      alt="K9 Harmony"
      class="footer-logo"
    >
    <div class="footer-info">
      <p><strong>K9 Harmony</strong></p>
      <p>〒174-0063 東京都板橋区前野町6-55-1</p>
      <p>TEL: 070-9043-1109</p>
    </div>
    <div class="footer-copyright">
      &copy; 2026 K9 Harmony -Paws & People Cultural Lab-
    </div>
  </footer>

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       デバッグコンソール（開発時のみ表示）
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  <div id="debug-console" class="debug-console">
    <div class="debug-console-header">
      <span>📋 Debug Console</span>
      <div>
        <button id="debug-clear-btn" class="debug-btn">Clear</button>
        <button id="debug-toggle-btn" class="debug-btn">Minimize</button>
      </div>
    </div>
    <div id="debug-console-body" class="debug-console-body">
      <div class="debug-log info">Console initialized...</div>
    </div>
  </div>

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       モーダル
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->

  <!-- 犬選択モーダル -->
  <div id="dog-modal-overlay" class="modal-overlay" onclick="closeDogModal()">
    <div class="center-modal" onclick="event.stopPropagation()">
      <h3>ワンちゃんを選択</h3>
      <div id="dog-list-container" class="dog-list-container">
        <!-- JavaScriptで動的生成 -->
      </div>
      <button class="btn btn-secondary btn-block" onclick="closeDogModal()">閉じる</button>
    </div>
  </div>

  <!-- UIDモーダル（新規顧客用） -->
  <div id="uid-modal-overlay" class="modal-overlay" onclick="closeUidModal()">
    <div class="center-modal" onclick="event.stopPropagation()">
      <h3>お客様IDの確認</h3>
      <p class="uid-modal-message">
        こちらのIDをトレーナーにLINEで教えてください
      </p>
      <div id="uid-display" class="uid-display">---</div>
      <button class="btn btn-primary btn-block" onclick="copyUid()">IDをコピー</button>
      <button class="btn btn-secondary btn-block" onclick="closeUidModal()">閉じる</button>
    </div>
  </div>

<!-- 時間選択モーダル -->
<div id="time-modal-overlay" class="modal-overlay" onclick="closeTimeModal()">
  <div class="bottom-modal time-selection-modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <h3 id="time-modal-title">時間を選択してください。</h3>
    <div class="time-slot-container">
      <div id="time-slot-buttons" class="time-slot-grid">
        <!-- JavaScriptで動的生成 -->
      </div>
    </div>
    <button class="btn btn-secondary btn-block" onclick="closeTimeModal()">閉じる</button>
  </div>
</div>

  <!-- 規約モーダル -->
  <div id="terms-overlay" class="modal-overlay" onclick="closeTerms()"></div>
  <div id="terms-sheet" class="top-sheet">
    <div class="top-sheet-header">
      <span id="terms-title">規約</span>
      <button class="btn-close" onclick="closeTerms()">&times;</button>
    </div>
    <div id="terms-content" class="top-sheet-content">
      読み込み中...
    </div>
  </div>

  <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       JavaScript
       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
  
  <!-- デバッグスクリプト（最優先読み込み） -->
  <script src="js/debug.js?v=202601271600"></script>
  
  <!-- メインスクリプト -->
  <script src="js/config.js?v=202601271600"></script>
  <script src="js/reservation.js?v=202601271600"></script>

</body>
</html>