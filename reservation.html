<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>レッスンの予約 | K9 Harmony</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* =========================================
       K9 Harmony Design System (v2.2 Stable)
       ========================================= */
    :root {
      --c-main-turquoise: #57C3C2;
      --c-sub-deep-ocean: #2F5D62;
      --c-accent-copper: #C87A56;
      --c-base-washi: #FAFAFA;
      --c-bg-mist: #F4F7F7;
      --c-text-sumi: #333333;
      --c-text-gray: #666666;
      --ease-luxury: cubic-bezier(0.25, 0.1, 0.25, 1.0);
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: var(--c-base-washi);
      color: var(--c-text-sumi);
      margin: 0;
      padding: 20px;
      padding-bottom: 350px; /* デバッグログ用余白 */
    }

    h2 {
      font-size: 1.2rem;
      color: var(--c-sub-deep-ocean);
      text-align: center;
      margin-bottom: 24px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    /* --- Debug Console (Restored) --- */
    #version-stamp {
      font-size: 0.7rem; color: #aaa; text-align: center; margin-bottom: 5px; font-family: monospace;
    }
    #debug-console {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 300px;
      background: rgba(0,0,0,0.9); color: #0f0; 
      font-family: monospace; font-size: 11px;
      overflow-y: scroll; z-index: 9999; padding: 10px; box-sizing: border-box;
      border-top: 2px solid #0f0;
    }
    .log-line { border-bottom: 1px solid #333; padding: 2px 0; word-break: break-all; }
    .log-error { color: #ff4444; background: rgba(50,0,0,0.5); }

    /* --- UI Components --- */
    .card {
      background: white; border-radius: 16px; padding: 24px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04); margin-bottom: 20px;
      animation: fadeIn 0.4s var(--ease-luxury);
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .step-section { display: none; }
    .step-section.active { display: block; }

    label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; color: var(--c-sub-deep-ocean); }
    .info-value { font-size: 1.1rem; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; min-height: 24px; }

    select, input[type="text"], input[type="tel"], input[type="number"], input[type="date"] {
      width: 100%; padding: 14px; border: 1px solid #e0e0e0;
      border-radius: 8px; font-size: 1rem; box-sizing: border-box;
      margin-bottom: 15px; background: #fafafa; appearance: none;
    }
    select:focus, input:focus { border-color: var(--c-main-turquoise); outline: none; background: #fff; }

    /* Checkbox */
    .checkbox-group { background: var(--c-bg-mist); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .checkbox-label { display: flex; align-items: center; cursor: pointer; font-weight: bold; color: var(--c-sub-deep-ocean); }
    .checkbox-label input { width: 20px; height: 20px; margin-right: 10px; accent-color: var(--c-main-turquoise); }

    /* Plan Option */
    .plan-option { border: 2px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
    .plan-option.selected { border-color: var(--c-main-turquoise); background: rgba(87, 195, 194, 0.05); }
    .plan-name { font-weight: bold; font-size: 1rem; }
    .plan-price { font-size: 0.9rem; color: var(--c-text-gray); float: right; }

    /* Slots */
    #slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .slot-btn {
      padding: 12px 5px; background: white; border: 1px solid var(--c-main-turquoise);
      color: var(--c-sub-deep-ocean); border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer;
    }
    .slot-btn:active { background: var(--c-main-turquoise); color: white; }

    /* Buttons */
    .btn {
      display: block; width: 100%; padding: 16px; background: var(--c-accent-copper); color: white;
      border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; text-align: center; cursor: pointer;
      box-shadow: 0 4px 12px rgba(200, 122, 86, 0.3); margin-top: 20px;
    }
    .btn-secondary { background: transparent; color: var(--c-text-gray); box-shadow: none; font-size: 0.9rem; margin-top: 10px; }

    /* Loading & Error */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 1000; display: none;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--c-main-turquoise);
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

    .error-msg { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; display: none; margin-bottom: 20px; font-size: 0.9rem; white-space: pre-wrap; }
    
    .credit-card-mock {
      background: linear-gradient(135deg, #2F5D62, #1a3a3e); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
    }
    .cc-cvc-input { width: 80px; padding: 8px; border-radius: 4px; border: none; text-align: center; font-weight: bold; display: block; margin-left: auto; }
  </style>
</head>
<body>

  <div id="version-stamp">v2025.12.25-URL-Fix-Debug</div>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="color:var(--c-sub-deep-ocean); font-weight:bold;">Loading...</div>
  </div>

  <div id="error-box" class="error-msg"></div>

  <div id="step-1" class="step-section active">
    <div class="step-indicator">STEP 1/4: ご確認</div>
    <h2>ご登録情報の確認</h2>
    <div class="card">
      <label>出張先ご住所</label>
      <div id="display-address" class="info-value">読み込み中...</div>
      
      <label>レッスンを受けるワンちゃん</label>
      <select id="dog-select"><option>読み込み中...</option></select>

      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="multi-dog-check">
          2頭目の追加 (+2,000円 / +30分)
        </label>
      </div>
      <p style="font-size:0.85rem; color:var(--c-text-gray);">※住所変更はLINEにて直接ご相談ください。</p>
    </div>
    <button class="btn" onclick="goToStep2()">プラン選択へ進む</button>
  </div>

  <div id="step-2" class="step-section">
    <div class="step-indicator">STEP 2/4: プラン選択</div>
    <h2>プランをお選びください</h2>
    <div class="card">
      <div class="plan-option selected" onclick="selectPlan(this, 'SINGLE', 90, 4900)">
        <div class="plan-name">単発レッスン</div><div class="plan-price">4,900円 (90分)</div>
      </div>
      <div class="plan-option" onclick="selectPlan(this, 'TICKET_4', 90, 0)">
        <div class="plan-name">4回チケット利用</div><div class="plan-price">チケット消費</div>
      </div>
      <div class="plan-option" onclick="selectPlan(this, 'TICKET_8', 90, 0)">
        <div class="plan-name">8回チケット利用</div><div class="plan-price">チケット消費</div>
      </div>
    </div>
    <button class="btn" onclick="goToStep3()">日時選択へ進む</button>
    <button class="btn btn-secondary" onclick="showStep(1)">戻る</button>
  </div>

  <div id="step-3" class="step-section">
    <div class="step-indicator">STEP 3/4: 日時選択</div>
    <h2>ご希望の日時</h2>
    <div class="card">
      <label>日付</label>
      <input type="date" id="target-date" onchange="onDateChange()">
      <div id="date-msg" style="font-size:0.85rem; margin-bottom:15px; color:#e53935;"></div>
      <label>開始時間</label>
      <div id="slots-grid"><div style="grid-column:1/-1; text-align:center; color:#999; padding:20px;">日付を選択してください</div></div>
    </div>
    <button class="btn btn-secondary" onclick="showStep(2)">戻る</button>
  </div>

  <div id="step-4" class="step-section">
    <div class="step-indicator">STEP 4/4: 最終確認</div>
    <h2>ご予約内容と決済</h2>
    <div class="card">
      <label>合計金額</label>
      <div style="font-weight:bold; font-size:1.2rem; color:var(--c-accent-copper); text-align:right; margin-bottom:20px;" id="summ-total">¥---</div>
      
      <label>お支払い方法</label>
      <div class="credit-card-mock">
        <div style="font-size:0.8rem; opacity:0.8;">CREDIT CARD</div>
        <div style="font-family:monospace; font-size:1.2rem; margin:15px 0; letter-spacing:2px;">**** **** **** 1234</div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-size:0.9rem; text-transform:uppercase;">TARO YAMADA</div>
          <input type="tel" id="cvc-input" class="cc-cvc-input" placeholder="CVC" maxlength="4">
        </div>
      </div>

      <div class="checkbox-group">
        <label class="checkbox-label"><input type="checkbox" id="policy-check"> キャンセルポリシーに同意する</label>
      </div>
      <input type="text" id="referral-code" placeholder="紹介コード (任意)">
    </div>
    <button class="btn" onclick="submitReservation()">予約を確定する</button>
    <button class="btn btn-secondary" onclick="showStep(3)">戻る</button>
  </div>

  <div id="debug-console">
    <div style="border-bottom:1px solid #0f0; margin-bottom:5px;">Debug Console</div>
    <div id="debug-logs"></div>
  </div>

  <script>
    // 【重要修正】 index.html (他機能) と同じURLを使用します
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
    const LIFF_ID = '2008546673-MJY7j3ox';

    let userData = null;
    let userDogs = [];
    let selectedPlan = { code: 'SINGLE', duration: 90, price: 4900, name: '単発レッスン' };
    let selectedDate = '';
    let selectedTime = '';

    // Logger
    function log(msg, data) {
      const div = document.getElementById('debug-logs');
      const line = document.createElement('div');
      line.className = 'log-line';
      let text = msg;
      if (data) { try { text += ' ' + JSON.stringify(data); } catch(e) { text += ' [Obj]'; } }
      line.textContent = text;
      div.appendChild(line);
      document.getElementById('debug-console').scrollTop = 99999;
      console.log(msg, data);
    }
    function logError(msg) {
      const div = document.getElementById('debug-logs');
      const line = document.createElement('div');
      line.className = 'log-line log-error';
      line.textContent = '[ERROR] ' + msg;
      div.appendChild(line);
      console.error(msg);
    }

    // Init
    window.onload = async () => {
      showLoading(true, '起動中...');
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        log('User:', profile.userId);
        fetchUserData(profile.userId);
      } catch (e) {
        logError('Init Error: ' + e.message);
        showError('起動エラー: ' + e.message);
      }
    };

    // Data Fetch
    async function fetchUserData(userId) {
      showLoading(true, '情報を取得中...');
      try {
        const url = `${GAS_API_URL}?userId=${userId}&type=data&t=${new Date().getTime()}`;
        log('Fetching:', url);
        
        const res = await fetch(url);
        const json = await res.json();
        log('Response:', json);

        if (json.error) {
            if(json.error === 'Unregistered') throw new Error('会員登録が見つかりません');
            throw new Error('API Error: ' + json.error);
        }
        
        userData = json.customer;
        
        // 住所の表示 (ない場合は未登録と表示)
        // json.customer.address がない場合もあるため防御的記述
        const addr = (userData && userData.address) ? userData.address : '住所未登録';
        document.getElementById('display-address').textContent = addr;
        log('Address:', addr);

        // 犬情報の取得 (index.htmlと同じロジックで判定)
        if (json.all_dogs && json.all_dogs.length > 0) {
            userDogs = json.all_dogs;
        } else if (json.multiple_dogs && json.multiple_dogs.length > 0) {
            userDogs = json.multiple_dogs;
        } else if (json.dog) {
            userDogs = [json.dog];
        } else {
            // 犬がいない場合でもクラッシュさせない
            logError('No dog data.');
            userDogs = [];
            document.getElementById('dog-select').innerHTML = '<option value="">登録なし (ID要確認)</option>';
        }

        if (userDogs.length > 0) {
            renderDogSelect();
        }

        showLoading(false);

      } catch (e) {
        logError(e.message);
        showError(e.message);
        showLoading(false);
      }
    }

    function renderDogSelect() {
      const sel = document.getElementById('dog-select');
      sel.innerHTML = '';
      userDogs.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name_disp || d.name;
        sel.appendChild(opt);
      });
    }

    // Navigation
    function showStep(num) {
      document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
      document.getElementById(`step-${num}`).classList.add('active');
      window.scrollTo(0,0);
    }
    function goToStep2() { showStep(2); }
    
    function selectPlan(el, code, duration, price) {
      document.querySelectorAll('.plan-option').forEach(d => d.classList.remove('selected'));
      el.classList.add('selected');
      const name = el.querySelector('.plan-name').textContent;
      selectedPlan = { code, duration, price, name };
    }

    function goToStep3() {
      // 日付初期化
      const d = new Date(); d.setDate(d.getDate()+1);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const dateInput = document.getElementById('target-date');
      if(!dateInput.value) {
        dateInput.value = `${yyyy}-${mm}-${dd}`;
        onDateChange();
      }
      showStep(3);
    }

    async function onDateChange() {
      const dateVal = document.getElementById('target-date').value;
      if (!dateVal) return;
      selectedDate = dateVal;
      
      const day = new Date(dateVal).getDay();
      document.getElementById('date-msg').textContent = (day === 3) ? '水曜日は定休日です。' : '';
      if (day === 3) { document.getElementById('slots-grid').innerHTML = ''; return; }

      const grid = document.getElementById('slots-grid');
      grid.innerHTML = '<div style="text-align:center;">空き状況を確認中...</div>';
      
      try {
        const isMulti = document.getElementById('multi-dog-check').checked;
        const duration = selectedPlan.duration + (isMulti ? 30 : 0);

        const payload = {
          action: 'get_slots',
          targetDate: dateVal,
          menuDuration: duration,
          targetAddress: userData ? userData.address : ''
        };
        
        log('GetSlots:', payload);
        const res = await fetch(GAS_API_URL, { method:'POST', body:JSON.stringify(payload) });
        const json = await res.json();
        
        grid.innerHTML = '';
        if (json.status === 'success' && json.data && json.data.length > 0) {
          json.data.forEach(slot => {
            const h = parseInt(slot.start.split(':')[0]);
            if (day === 4 && h < 13) return; 

            const btn = document.createElement('div');
            btn.className = 'slot-btn';
            btn.textContent = slot.start;
            btn.onclick = () => selectSlot(slot.start);
            grid.appendChild(btn);
          });
          if(grid.children.length === 0) grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">空きなし</div>';
        } else {
          grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">空きなし</div>';
        }
      } catch(e) {
        logError('Slot Error: ' + e.message);
        grid.innerHTML = '<div style="color:red;">エラー発生</div>';
      }
    }

    function selectSlot(time) {
      selectedTime = time;
      updateSummary();
      showStep(4);
    }

    function updateSummary() {
      const isMulti = document.getElementById('multi-dog-check').checked;
      const total = selectedPlan.price + (isMulti ? 2000 : 0);
      document.getElementById('summ-total').textContent = `¥${total.toLocaleString()}`;
    }

    async function submitReservation() {
      const cvc = document.getElementById('cvc-input').value;
      if (!cvc || cvc.length < 3) return alert('CVCを入力してください');
      if (!document.getElementById('policy-check').checked) return alert('同意が必要です');

      showLoading(true, '予約中...');
      try {
         const isMulti = document.getElementById('multi-dog-check').checked;
         const payload = {
            action: 'add_reservation',
            userId: userData.unique_key || userData.id,
            targetDate: selectedDate,
            startTime: selectedTime,
            menuDuration: selectedPlan.duration + (isMulti ? 30 : 0),
            menuName: selectedPlan.name,
            productKey: selectedPlan.code,
            multiDog: isMulti,
            receiptRequired: false,
            referralCode: document.getElementById('referral-code').value,
            customerName: userData.name,
            customerPhone: userData.phone,
            dogId: document.getElementById('dog-select').value
         };
         
         const res = await fetch(GAS_API_URL, { method:'POST', body:JSON.stringify(payload) });
         const json = await res.json();
         
         if (json.status === 'success') {
             alert('予約完了');
             liff.closeWindow();
         } else {
             throw new Error(json.message);
         }
      } catch(e) {
         logError(e.message);
         alert('エラー: ' + e.message);
         showLoading(false);
      }
    }

    function showLoading(b, t) {
      document.getElementById('loading-overlay').style.display = b ? 'flex' : 'none';
      if(t) document.getElementById('loading-text').textContent = t;
    }
    function showError(msg) {
      const el = document.getElementById('error-box');
      el.textContent = msg; el.style.display = 'block';
      window.scrollTo(0,0);
    }
  </script>
</body>
</html>
