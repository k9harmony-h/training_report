<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>レッスンの予約 | K9 Harmony</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       K9 Harmony Design System (Final Fix)
       ========================================= */
    :root {
      --c-main-turquoise: #57C3C2;
      --c-sub-deep-ocean: #2F5D62;
      --c-accent-copper: #C87A56;
      --c-base-washi: #FAFAFA;
      --c-bg-mist: #F4F7F7;
      --c-text-sumi: #333333;
      --c-text-gray: #666666;
      --font-main: 'Noto Sans JP', sans-serif;
      --font-serif: 'Noto Serif JP', serif;
    }

    body {
      font-family: var(--font-main);
      background-color: var(--c-base-washi);
      color: var(--c-text-sumi);
      margin: 0; padding: 0;
      padding-bottom: 80px;
    }

    /* Header */
    header {
      background: white; padding: 15px 0; text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50;
    }
    .logo-img { width: 40%; max-width: 180px; height: auto; }

    /* Progress */
    .progress-container {
      display: flex; justify-content: space-between; padding: 20px 30px; position: relative;
      max-width: 600px; margin: 0 auto;
    }
    .progress-bg { position: absolute; top: 30px; left: 40px; right: 40px; height: 2px; background: #e0e0e0; z-index: 0; }
    .progress-bar-fill { position: absolute; top: 30px; left: 40px; height: 2px; background: var(--c-main-turquoise); z-index: 0; width: 0%; transition: width 0.3s; }
    .step-dot {
      width: 20px; height: 20px; border-radius: 50%; background: #e0e0e0; z-index: 1; position: relative;
      border: 2px solid var(--c-base-washi); transition: background 0.3s;
    }
    .step-dot.active { background: var(--c-main-turquoise); transform: scale(1.2); }
    .step-dot.done { background: var(--c-main-turquoise); }

    /* Container */
    #app-container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .view-section { display: none; animation: fadeIn 0.4s ease-out; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Elements */
    h2 {
      font-size: 1.1rem; color: var(--c-sub-deep-ocean);
      border-left: 4px solid var(--c-main-turquoise); padding-left: 10px; margin-bottom: 20px;
      font-family: var(--font-serif);
    }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    label { display: block; font-weight: bold; font-size: 0.9rem; color: var(--c-sub-deep-ocean); margin-bottom: 8px; }
    
    select, input[type="text"], input[type="tel"], input[type="number"], input[type="date"] {
      width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;
      margin-bottom: 15px; box-sizing: border-box; font-family: inherit;
    }
    select:focus, input:focus { border-color: var(--c-main-turquoise); outline: none; background: #fff; }

    /* Buttons */
    .btn {
      display: block; width: 100%; padding: 16px; border-radius: 50px; border: none;
      font-weight: bold; font-size: 1rem; cursor: pointer; text-align: center; margin-top: 15px; transition: all 0.2s;
    }
    .btn-primary { background: var(--c-main-turquoise); color: white; box-shadow: 0 4px 10px rgba(87, 195, 194, 0.3); }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

    .btn-secondary { background: white; border: 1px solid #ccc; color: var(--c-text-gray); }
    
    /* Outline Brand (Dog Select Modal) */
    .btn-outline-brand { background: white; border: 2px solid var(--c-main-turquoise); color: var(--c-main-turquoise); margin-top: 10px; }
    .btn-outline-brand:active { background: var(--c-bg-mist); }

    .btn-cancel-rsv { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-size: 0.9rem; margin-top: 30px; }
    .btn-row { display: flex; gap: 10px; } .btn-row .btn { margin-top: 0; }

    /* --- Calendar --- */
    .cal-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .cal-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid #eee; }
    .cal-table { width: 100%; border-collapse: collapse; min-width: 400px; table-layout: fixed; }
    
    .cal-table th { background: #f8f8f8; color: var(--c-sub-deep-ocean); padding: 8px 2px; font-size: 0.75rem; border-bottom: 2px solid #ddd; border-right: 1px solid #eee; text-align: center; }
    .cal-table th:first-child { width: 50px; position: sticky; left: 0; background: #f8f8f8; z-index: 2; border-right: 2px solid #ddd; }
    .cal-table td { height: 50px; border-bottom: 1px solid #eee; border-right: 1px solid #eee; text-align: center; vertical-align: middle; padding: 0; position: relative; }
    .cal-table td:first-child { position: sticky; left: 0; background: white; font-weight: bold; color: var(--c-sub-deep-ocean); font-size: 0.8rem; z-index: 1; border-right: 2px solid #ddd; }

    /* Symbols */
    .sym-ok { color: var(--c-main-turquoise); font-size: 1.2rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
    .sym-lim { color: #fbc02d; font-size: 0.9rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
    .sym-ng { background: #f0f0f0; color: #ccc; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; cursor: default; }
    
    /* Highlight Selected: Brand BG, White Text */
    td.selected-cell { background-color: var(--c-main-turquoise) !important; transition: background 0.2s; }
    td.selected-cell .sym-ok, td.selected-cell .sym-lim { color: white !important; }

    .cal-legend { display: flex; justify-content: center; gap: 15px; font-size: 0.8rem; margin-top: 10px; color: var(--c-text-gray); }

    /* --- Modals --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; display: none; opacity: 0; transition: opacity 0.3s; }
    .modal-overlay.open { display: block; opacity: 1; }

    .center-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 90%; max-width: 350px; background: white; border-radius: 12px; padding: 25px;
      z-index: 301; display: none; text-align: center;
    }
    .center-modal.open { display: block; animation: popIn 0.3s ease-out; }
    @keyframes popIn { from { transform: translate(-50%, -40%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }

    .time-modal { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; z-index: 302; transform: translateY(100%); transition: transform 0.3s; }
    .time-modal.open { transform: translateY(0); }

    /* Top Sheet (Terms) - 80% */
    .top-sheet {
      position: fixed; top: 0; left: 0; width: 100%; height: 80%;
      background: white; border-radius: 0 0 20px 20px; z-index: 302;
      transform: translateY(-100%); transition: transform 0.3s; display: flex; flex-direction: column;
    }
    .top-sheet.open { transform: translateY(0); }
    .top-sheet-content { flex: 1; overflow-y: auto; padding: 20px; font-size: 0.9rem; line-height: 1.6; }
    .top-sheet-close-area { position: fixed; top: 80%; left: 0; width: 100%; height: 20%; z-index: 301; }

    /* Footer (index.html style) */
    .site-footer {
        flex-shrink: 0; margin-top: auto;
        background: rgba(255, 255, 255, 0.4); border-top: 1px solid rgba(199, 178, 153, 0.2);
        padding: 60px 20px; text-align: center; font-size: 0.8rem; color: #7F8C8D;
    }
    .footer-logo-img { width: 40%; height: auto; display: inline-block; filter: contrast(0.95); opacity: 0.7; }

    /* Loading */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--c-main-turquoise); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .checkbox-row { display: flex; align-items: flex-start; margin-bottom: 10px; font-size: 0.9rem; color: var(--c-text-sumi); }
    .checkbox-row input { width: 18px; height: 18px; margin-right: 10px; margin-top: 3px; accent-color: var(--c-main-turquoise); }
  </style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text" style="color:var(--c-sub-deep-ocean); font-weight:bold; margin-bottom:10px;">起動中...</div>
  <div id="loading-tips" style="font-size:0.85rem; color:var(--c-text-gray); padding:0 20px; text-align:center; min-height:1.2em;"></div>
</div>

<header>
  <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" class="logo-img" alt="K9 Harmony">
</header>

<div class="progress-container">
  <div class="progress-bg"></div>
  <div class="progress-bar-fill" id="progress-fill"></div>
  <div class="step-dot active" id="dot-1"></div>
  <div class="step-dot" id="dot-2"></div>
  <div class="step-dot" id="dot-3"></div>
  <div class="step-dot" id="dot-4"></div>
  <div class="step-dot" id="dot-5"></div>
</div>

<div id="app-container">

  <div id="view-1" class="view-section active">
    <h2>予約内容</h2>
    
    <div class="card" id="dog-info-card">
      <label>選択中のワンちゃん</label>
      <div id="selected-dog-name" style="font-size:1.2rem; font-weight:bold; color:var(--c-main-turquoise); margin-bottom:10px;">---</div>
      <button class="btn btn-secondary" style="padding:8px 15px; font-size:0.8rem; width:auto; display:inline-block;" onclick="showDogSelectModal(true)">変更する</button>

      <div style="background:var(--c-bg-mist); padding:10px; border-radius:8px; margin-top:15px;">
        <label style="display:flex; align-items:center; margin:0; cursor:pointer;">
          <input type="checkbox" id="multi-dog-check" style="width:20px; height:20px; margin-right:10px; accent-color:var(--c-main-turquoise);">
          2頭目の追加 (+2,000円 / +30分)
        </label>
      </div>
    </div>

    <div class="card">
      <label>メニュー</label>
      <select id="menu-select"><option>読み込み中...</option></select>
    </div>

    <button class="btn btn-primary" onclick="goToView(2)">次へ (日時選択)</button>
    <button class="btn btn-cancel-rsv" onclick="alert('キャンセル機能実装予定')">予約のキャンセルはこちら</button>
  </div>

  <div id="view-2" class="view-section">
    <h2>日時の選択</h2>
    <div class="card" style="padding:15px 5px;">
      <div class="cal-controls" style="padding:0 10px;">
        <button class="btn btn-secondary" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="shiftWeek(-1)">&lt; 前週</button>
        <span id="cal-range-text" style="font-weight:bold; font-size:0.9rem;">--/-- 〜</span>
        <button class="btn btn-secondary" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="shiftWeek(1)">次週 &gt;</button>
      </div>

      <div class="cal-wrapper">
        <table class="cal-table">
          <thead><tr id="cal-header"><th>時間</th></tr></thead>
          <tbody id="cal-body"></tbody>
        </table>
      </div>

      <div class="cal-legend">
        <span><span style="color:var(--c-main-turquoise); font-weight:bold;">○</span> 可能</span>
        <span><span style="color:#fbc02d; font-weight:bold;">▲</span> わずか</span>
        <span><span style="background:#f0f0f0; padding:0 4px; color:#ccc;">×</span> 不可</span>
      </div>
    </div>

    <div class="card">
        <label style="display:flex; align-items:center; cursor:pointer; margin-bottom:0;">
            <input type="checkbox" id="alt-address-check" style="width:20px; height:20px; margin-right:10px; accent-color:var(--c-main-turquoise);" onchange="toggleAltAddress()">
            申込住所と異なる場所で実施
        </label>
        <div id="alt-address-area" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <label>郵便番号 <span style="color:red">*</span></label>
            <input type="text" id="alt-zip" placeholder="123-4567">
            <label>住所 <span style="color:red">*</span></label>
            <input type="text" id="alt-addr" placeholder="東京都...">
            <label>施設名</label>
            <input type="text" id="alt-building">
            <label>目印</label>
            <input type="text" id="alt-note">
        </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToView(1)">戻る</button>
      <button class="btn btn-primary" id="btn-to-step3" disabled onclick="goToView(3)">次へ</button>
    </div>
  </div>

  <div id="view-3" class="view-section">
    <h2>確認と規約</h2>
    <div class="card">
      <label>ご予約内容</label>
      <div style="line-height:1.8; font-size:0.95rem;">
        <div><strong>日時:</strong> <span id="conf-datetime">---</span></div>
        <div><strong>場所:</strong> <span id="conf-place">---</span></div>
        <div><strong>犬名:</strong> <span id="conf-dog">---</span></div>
        <div><strong>コース:</strong> <span id="conf-course">---</span></div>
      </div>
      
      <div style="border-top:1px solid #eee; margin:15px 0; padding-top:10px;">
        <div style="display:flex; justify-content:space-between;">
            <span>出張費</span>
            <span id="conf-travel-fee" style="color:var(--c-accent-copper);">計算中...</span>
        </div>
        <div id="conf-travel-msg" style="font-size:0.75rem; color:#888; margin-top:5px;">
            正確な出張費を計算しております。最終確認画面にて正式な交通費をお知らせいたします。
        </div>
        <div style="font-size:0.7rem; color:#999; margin-top:3px;">
            ※距離算出は弊社事務所からの直線距離で算出しております。
        </div>
      </div>

      <div style="border-top:1px solid #eee; margin:15px 0; padding-top:15px;">
        <label>Voucher / 紹介コード</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="voucher-code" placeholder="コードを入力" style="margin-bottom:0;">
            <button class="btn btn-secondary" style="margin-top:0; padding:10px;" onclick="applyVoucher()">適用</button>
        </div>
        <div id="voucher-result" style="font-size:0.9rem; font-weight:bold; margin-top:5px;"></div>
      </div>

      <div style="font-size:1.3rem; font-weight:bold; color:var(--c-sub-deep-ocean); text-align:right; margin-top:10px;">
        合計: <span id="conf-total">¥---</span>
      </div>
      
      <label style="margin-top:15px;">お支払い方法</label>
      <select id="payment-method">
        <option value="CARD">クレジットカード</option>
        <option value="QUICPAY">QUICPay</option>
        <option value="ID">iD</option>
        <option value="IC">交通系IC</option>
        <option value="CASH">当日現金払い</option>
      </select>
    </div>

    <div class="card">
      <label>規約等の確認</label>
      <div class="checkbox-row">
        <input type="checkbox" class="term-check" id="chk-policy" onchange="checkAllTerms()">
        <span onclick="openTerms('policy')" style="cursor:pointer; text-decoration:underline; flex:1;">キャンセルポリシーに同意</span>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" class="term-check" id="chk-privacy" onchange="checkAllTerms()">
        <span onclick="openTerms('privacy')" style="cursor:pointer; text-decoration:underline; flex:1;">個人情報の取扱に同意</span>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" class="term-check" id="chk-terms" onchange="checkAllTerms()">
        <span onclick="openTerms('terms')" style="cursor:pointer; text-decoration:underline; flex:1;">利用規約に同意</span>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" class="term-check" id="chk-law" onchange="checkAllTerms()">
        <span onclick="openTerms('law')" style="cursor:pointer; text-decoration:underline; flex:1;">特定商取引法に基づく表記を確認</span>
      </div>
      
      <div style="border-top:1px solid #eee; margin-top:10px; padding-top:10px; font-weight:bold;">
        <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="checkbox" id="chk-all" style="width:20px; height:20px; accent-color:var(--c-main-turquoise);" onchange="toggleAllTerms()">
            全てに同意する
        </label>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToView(2)">戻る</button>
      <button class="btn btn-primary" id="btn-confirm-next" disabled onclick="checkUserAndNext()">お支払いへ</button>
    </div>
  </div>

  <div id="view-4" class="view-section">
    <h2>情報入力</h2>
    
    <div id="form-existing">
        <div class="card">
          <label>クレジットカード情報</label>
          <div style="background:#eee; padding:15px; border-radius:8px; margin-bottom:15px;">
            <div style="font-size:0.8rem; margin-bottom:5px;">TARO YAMADA</div>
            <div style="font-family:monospace; font-size:1.1rem; letter-spacing:2px;">**** **** **** 1234</div>
          </div>
          <div style="text-align:right;">
            <span style="font-size:0.8rem; font-weight:bold;">CVC (3桁)</span>
            <input type="tel" id="cvc-input" maxlength="4" placeholder="123" style="width:80px; text-align:center; display:inline-block; margin-left:10px;" oninput="checkCVC()">
          </div>
          <button class="btn btn-secondary" style="font-size:0.8rem; margin-top:15px;" onclick="toggleNewCardForm()">＋ 新しいカードを使う</button>
          
          <div id="new-card-form" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
              <input type="text" placeholder="カード番号 (Mock)" style="margin-bottom:8px;">
              <div style="display:flex; gap:10px;">
                  <input type="text" placeholder="MM/YY">
                  <input type="text" placeholder="CVC">
              </div>
          </div>
        </div>
    </div>

    <div id="form-new" style="display:none;">
        <div class="card">
            <h3 style="margin-top:0; color:var(--c-main-turquoise); font-size:1rem;">会員登録</h3>
            <label>お名前 <span style="color:red">*</span></label>
            <input type="text" id="reg-name" placeholder="山田 太郎">
            <label>電話番号 <span style="color:red">*</span></label>
            <input type="tel" id="reg-phone" placeholder="090-1234-5678">
            <label>愛犬のお名前 <span style="color:red">*</span></label>
            <input type="text" id="reg-dog-name" placeholder="ポチ">
        </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToView(3)">戻る</button>
      <button class="btn btn-primary" id="btn-final-check" disabled onclick="goToView(5)">最終確認へ</button>
    </div>
  </div>

  <div id="view-5" class="view-section">
    <h2>最終確認</h2>
    <div class="card">
      <label>内容確認</label>
      <div id="final-summary" style="white-space:pre-wrap; font-size:0.9rem; line-height:1.6;"></div>
    </div>
    <div class="card" style="background:#fff3e0; border:1px solid #ffe0b2; color:#e65100;">
      <label style="color:#e65100;"><i class="fa-solid fa-triangle-exclamation"></i> キャンセル規定</label>
      <p style="font-size:0.85rem; margin:0;">
        受付締切: 前日18:00<br>
        前日: 50% / 当日: 100% のキャンセル料が発生します。
      </p>
    </div>
    <button class="btn btn-primary" onclick="submitReservation()">上記に同意して予約を確定する</button>
    <button class="btn btn-secondary" onclick="goToView(4)">修正する</button>
  </div>

  <div id="view-6" class="view-section" style="text-align:center; padding-top:30px;">
    <i class="fa-regular fa-circle-check" style="font-size:4rem; color:var(--c-main-turquoise); margin-bottom:20px;"></i>
    <h2>予約完了</h2>
    <p>ご予約ありがとうございます。</p>
    
    <div class="card">
        <button class="btn btn-primary" style="background:#06C755; box-shadow:none;" onclick="shareLine()">
            <i class="fa-brands fa-line"></i> LINEに送信
        </button>
        <button class="btn btn-secondary" onclick="addToGoogleCalendar()">
            <i class="fa-regular fa-calendar"></i> Googleカレンダー登録
        </button>
        <button class="btn btn-secondary" onclick="shareNative()">
            <i class="fa-solid fa-share-nodes"></i> シェア
        </button>
        <div style="margin-top:20px;">
            <button class="btn btn-primary" onclick="location.reload()">続けて登録</button>
        </div>
    </div>
    <button class="btn btn-secondary" style="border:none; margin-top:20px;" onclick="liff.closeWindow()">閉じる</button>
  </div>

</div>

<footer class="site-footer">
    <div class="footer-logo-container"><img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" class="footer-logo-img" alt="K9 Harmony"></div>
    <div class="footer-info"><p><strong>K9 Harmony</strong></p><p>〒174-0063 東京都板橋区前野町6-55-1</p><p>070-9043-1109</p></div>
    <div style="margin-top:20px;">&copy; 2025 K9 Harmony</div>
</footer>

<div class="modal-overlay" id="dog-modal-overlay">
  <div class="center-modal" id="dog-modal">
    <h3 style="text-align:center; color:var(--c-sub-deep-ocean); margin-bottom:15px;">ワンちゃんを選択</h3>
    <div id="dog-list-container"></div>
  </div>
</div>

<div class="modal-overlay" id="time-modal-overlay" onclick="closeTimeModal()">
  <div class="time-modal" id="time-modal">
    <h3 id="time-modal-title" style="font-size:1.1rem; text-align:center; margin-bottom:20px;">時間の選択</h3>
    <div id="time-slot-buttons" style="display:grid; gap:10px;"></div>
    <button class="btn btn-secondary" onclick="closeTimeModal()">閉じる</button>
  </div>
</div>

<div class="modal-overlay" id="terms-overlay" onclick="closeTerms()"></div>
<div class="top-sheet" id="terms-sheet">
  <div style="padding:15px; border-bottom:1px solid #eee; text-align:center; font-weight:bold; display:flex; justify-content:space-between;">
    <span id="terms-title">規約</span>
    <span onclick="closeTerms()" style="cursor:pointer; font-size:1.2rem;">&times;</span>
  </div>
  <div class="top-sheet-content" id="terms-content">読み込み中...</div>
  <div class="top-sheet-close-area" onclick="closeTerms()"></div>
</div>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
  const LIFF_ID = '2008546673-MJY7j3ox';
  const OFFICE_POS = { lat: 35.7665, lng: 139.6936 };

  // 1. Tips
  const DOG_TIPS = [
    "犬の鼻紋は一頭一頭違います。", "犬は人間の約4倍の聴力を持っています。", 
    "犬の嗅覚は人間の100万倍以上。", "犬は肉球からしか汗をかけません。", 
    "あくびはストレスサインかも？", "しっぽが右寄りなら「嬉しい」サイン。",
    "小型犬は大型犬より長生き傾向。", "犬も夢を見ます。",
    "ダルメシアンは生まれたては真っ白。", "顔を舐めるのは愛情表現です。"
  ];
  let tipsTimer;

  let userData = null;
  let userDogs = [];
  let products = [];
  let selectedDog = null;
  let selectedSlot = null; 
  let weekOffset = 0;
  let voucherData = null; 
  let weekAvailability = {}; // { "2025-01-01": ["10:00", ...], ... }

  window.onload = async () => {
    startTips();
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      fetchUserData(profile.userId);
    } catch (e) {
      document.getElementById('loading-text').innerText = 'エラー: ' + e.message;
    }
  };

  function startTips() {
      const el = document.getElementById('loading-tips');
      let i = Math.floor(Math.random()*DOG_TIPS.length);
      el.innerText = DOG_TIPS[i];
      tipsTimer = setInterval(() => {
          i = (i+1)%DOG_TIPS.length;
          el.innerText = DOG_TIPS[i];
      }, 1200);
  }

  async function fetchUserData(userId) {
    try {
      const res = await fetch(`${GAS_URL}?userId=${userId}&type=data&t=${Date.now()}`);
      const json = await res.json();
      
      if (json.customer) {
          userData = json.customer;
          userDogs = json.all_dogs || [json.dog];
      } else {
          userData = null; 
          userDogs = [];
      }
      if(json.products) products = json.products;
      renderMenuSelect();

      if (userDogs.length > 1) {
        showDogSelectModal(false);
      } else if (userDogs.length === 1) {
        selectDog(0);
      } else {
        document.getElementById('selected-dog-name').innerText = "未登録 (新規)";
      }
      clearInterval(tipsTimer);
      document.getElementById('loading-overlay').style.display = 'none';
    } catch(e) {
      alert('通信失敗');
    }
  }

  // 2. Menu Filter
  function renderMenuSelect() {
    const sel = document.getElementById('menu-select');
    sel.innerHTML = '';
    if(products && products.length > 0) {
        products.forEach(p => {
            if(p.category === 'トレーニング') { 
                const opt = document.createElement('option');
                opt.value = 90; 
                opt.setAttribute('data-price', p.price);
                opt.innerText = `${p.name} (¥${p.price.toLocaleString()})`;
                sel.appendChild(opt);
            }
        });
    } else {
        const opt = document.createElement('option');
        opt.value = 90; opt.setAttribute('data-price', 4900); opt.innerText = "単発レッスン (¥4,900)";
        sel.appendChild(opt);
    }
  }

  function showDogSelectModal(canClose) {
    const cont = document.getElementById('dog-list-container');
    cont.innerHTML = '';
    userDogs.forEach((d, idx) => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-brand'; 
      btn.innerText = d.name_disp || d.name;
      btn.onclick = () => { selectDog(idx); closeDogModal(); };
      cont.appendChild(btn);
    });
    if(userDogs.length===0 || canClose) {
        const close = document.createElement('button');
        close.className = 'btn btn-secondary';
        close.innerText = userDogs.length===0?'閉じる':'キャンセル';
        close.onclick = closeDogModal;
        cont.appendChild(close);
    }
    document.getElementById('dog-modal-overlay').classList.add('open');
    document.getElementById('dog-modal').classList.add('open');
  }
  function closeDogModal() {
    document.getElementById('dog-modal-overlay').classList.remove('open');
    document.getElementById('dog-modal').classList.remove('open');
  }
  function selectDog(idx) {
    selectedDog = userDogs[idx];
    document.getElementById('selected-dog-name').innerText = selectedDog.name_disp || selectedDog.name;
  }

  // Navigation
  function goToView(step) {
    document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
    document.getElementById(`view-${step}`).classList.add('active');
    updateProgress(step);
    window.scrollTo(0,0);
    
    // Step 2: Load Calendar Availability
    if(step===2) {
        renderCalendarStructure(); // Render table first
        fetchAvailability();       // Fetch & update cells
    }
    if(step===3) renderConfirm();
    if(step===5) renderFinal();
  }
  
  function checkUserAndNext() {
      if(userData) {
          document.getElementById('form-existing').style.display = 'block';
          document.getElementById('form-new').style.display = 'none';
          document.getElementById('btn-final-check').disabled = true; 
          if(document.getElementById('payment-method').value !== 'CARD') {
              document.getElementById('btn-final-check').disabled = false;
          }
      } else {
          document.getElementById('form-existing').style.display = 'none';
          document.getElementById('form-new').style.display = 'block';
          document.getElementById('btn-final-check').disabled = false;
      }
      goToView(4);
  }
  function updateProgress(step) {
    if(step>5) return;
    const pct = ((step-1)/4)*100;
    document.getElementById('progress-fill').style.width = pct+'%';
    for(let i=1; i<=5; i++){
      const d = document.getElementById(`dot-${i}`);
      d.classList.remove('active','done');
      if(i<step) d.classList.add('done');
      if(i===step) d.classList.add('active');
    }
  }

  // 3. Calendar with Availability
  function shiftWeek(d) { 
      weekOffset += d; 
      renderCalendarStructure(); 
      fetchAvailability(); 
  }
  
  function renderCalendarStructure() {
    const tbody = document.getElementById('cal-body');
    const thead = document.getElementById('cal-header');
    tbody.innerHTML = '<tr><td colspan="8">読み込み中...</td></tr>';
    
    const startDt = new Date(); startDt.setDate(startDt.getDate() + (weekOffset*7));
    document.getElementById('cal-range-text').innerText = `${startDt.getMonth()+1}/${startDt.getDate()} 〜`;

    let dates = [];
    let headHtml = '<th>時間</th>';
    for(let i=0; i<7; i++){
      let d = new Date(startDt); d.setDate(startDt.getDate()+i);
      let col = (d.getDay()===0)?'red':(d.getDay()===6)?'blue':'#333';
      dates.push({ date: d.toISOString().split('T')[0], day: d.getDay() });
      headHtml += `<th style="color:${col}">${d.getMonth()+1}/${d.getDate()}<br>(${['日','月','火','水','木','金','土'][d.getDay()]})</th>`;
    }
    thead.innerHTML = headHtml;
    // Tbody will be filled after fetch
  }

  async function fetchAvailability() {
      const startDt = new Date(); startDt.setDate(startDt.getDate() + (weekOffset*7));
      const sStr = startDt.toISOString().split('T')[0];
      
      try {
          const res = await fetch(GAS_URL, {
              method: 'POST',
              body: JSON.stringify({ action: 'get_week_availability', startDate: sStr, menuDuration: 90 })
          });
          const json = await res.json();
          weekAvailability = json.data || {};
          fillCalendarBody();
      } catch(e) {
          document.getElementById('cal-body').innerHTML = '<tr><td colspan="8">エラー</td></tr>';
      }
  }

  function fillCalendarBody() {
      const tbody = document.getElementById('cal-body');
      tbody.innerHTML = '';
      const startDt = new Date(); startDt.setDate(startDt.getDate() + (weekOffset*7));
      let dates = [];
      for(let i=0; i<7; i++){
          let d = new Date(startDt); d.setDate(startDt.getDate()+i);
          dates.push({ date: d.toISOString().split('T')[0], day: d.getDay() });
      }

      for(let h=10; h<=20; h++){
          let tr = document.createElement('tr');
          tr.innerHTML = `<td>${h}:00</td>`;
          dates.forEach(dt => {
              let td = document.createElement('td');
              // Check availability from fetched data
              const slots = weekAvailability[dt.date] || []; // ["10:00", "10:30"...]
              
              // 00 or 30 exists?
              const has00 = slots.includes(`${h}:00`);
              const has30 = slots.includes(`${h}:30`);
              
              // Logic: At least one slot open?
              // Simple check: if NO slots in this hour, mark NG
              if (!has00 && !has30) {
                  td.innerHTML = '<span class="sym-ng">×</span>';
              } else {
                  // Pass data for modal
                  td.innerHTML = `<span class="sym-ok" onclick="openTimeModal('${dt.date}', ${h}, this, ${has00}, ${has30})">○</span>`;
              }
              tr.appendChild(td);
          });
          tbody.appendChild(tr);
      }
  }

  let currentCell = null;
  function openTimeModal(dateStr, hour, cell, has00, has30) {
    currentCell = cell; 
    document.getElementById('time-modal-title').innerText = `${dateStr} ${hour}:00台`;
    const cont = document.getElementById('time-slot-buttons');
    cont.innerHTML = '';
    
    if(has00) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-brand'; 
        btn.innerText = `${hour}:00 開始`;
        btn.onclick = () => chooseTime(dateStr, `${hour}:00`);
        cont.appendChild(btn);
    }
    if(has30) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-brand'; 
        btn.innerText = `${hour}:30 開始`;
        btn.onclick = () => chooseTime(dateStr, `${hour}:30`);
        cont.appendChild(btn);
    }
    
    document.getElementById('time-modal-overlay').classList.add('open');
    document.getElementById('time-modal').classList.add('open');
  }
  function closeTimeModal() {
    document.getElementById('time-modal-overlay').classList.remove('open');
    document.getElementById('time-modal').classList.remove('open');
  }
  function chooseTime(d, t) {
    selectedSlot = { date: d, time: t };
    closeTimeModal();
    
    document.querySelectorAll('.selected-cell').forEach(el => el.classList.remove('selected-cell'));
    if(currentCell) {
        currentCell.classList.add('selected-cell'); 
    }
    document.getElementById('btn-to-step3').disabled = false;
  }

  // Address
  function toggleAltAddress() {
      const chk = document.getElementById('alt-address-check').checked;
      document.getElementById('alt-address-area').style.display = chk ? 'block' : 'none';
  }

  // 4. Voucher & Confirm
  function renderConfirm() {
    const isMulti = document.getElementById('multi-dog-check').checked;
    const menuEl = document.getElementById('menu-select');
    const price = parseInt(menuEl.options[menuEl.selectedIndex].getAttribute('data-price'));
    
    let place = userData ? (userData.address || "未登録") : "新規登録住所";
    if(document.getElementById('alt-address-check').checked) {
        place = document.getElementById('alt-addr').value || "指定住所";
    }

    document.getElementById('conf-datetime').innerText = `${selectedSlot.date} ${selectedSlot.time}`;
    document.getElementById('conf-place').innerText = place;
    document.getElementById('conf-dog').innerText = selectedDog ? selectedDog.name_disp : '新規登録犬';
    document.getElementById('conf-course').innerText = menuEl.options[menuEl.selectedIndex].text + (isMulti?" (+2頭目)":"");

    document.getElementById('conf-travel-fee').innerText = "計算中...";
    document.getElementById('conf-travel-msg').innerText = "正確な出張費を計算しております。最終確認画面にて正式な交通費をお知らせいたします。";
    document.getElementById('conf-total').innerText = "---";
    
    setTimeout(() => {
        let travelFee = 0;
        if (userData && userData.base_lat && !document.getElementById('alt-address-check').checked) {
            const dist = calcDistance(OFFICE_POS.lat, OFFICE_POS.lng, userData.base_lat, userData.base_lng);
            travelFee = calcTravelFee(dist);
        }
        
        const feeStr = travelFee === 0 ? "無料" : `¥${travelFee.toLocaleString()}`;
        document.getElementById('conf-travel-fee').innerText = feeStr;
        
        let total = price + (isMulti?2000:0) + travelFee;
        if(voucherData) total -= voucherData.discount_value;
        if(total < 0) total = 0;
        
        document.getElementById('conf-total').innerText = `¥${total.toLocaleString()}`;
    }, 800);
  }

  async function applyVoucher() {
      const code = document.getElementById('voucher-code').value;
      if(!code) return;
      const res = await fetch(`${GAS_URL}?type=check_voucher&code=${code}&userId=DUMMY`); 
      const json = await res.json();
      const resDiv = document.getElementById('voucher-result');
      if(json.valid) {
          resDiv.style.color = 'var(--c-main-turquoise)';
          resDiv.innerText = `適用: ${json.name} (-${json.discount_value}円)`;
          voucherData = json;
          renderConfirm();
      } else {
          resDiv.style.color = 'red';
          resDiv.innerText = json.message;
          voucherData = null;
          renderConfirm();
      }
  }

  function calcDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; 
    const dLat = (lat2-lat1) * Math.PI / 180;
    const dLon = (lon2-lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c;
  }
  function calcTravelFee(km) {
    if(km <= 3) return 0;
    if(km <= 5) return 500;
    if(km <= 10) return 1000;
    if(km <= 15) return 1500;
    return 1500 + Math.ceil(km - 15) * 100;
  }

  function toggleAllTerms() {
      const chk = document.getElementById('chk-all').checked;
      document.querySelectorAll('.term-check').forEach(c => c.checked = chk);
      checkAllTerms();
  }
  function checkAllTerms() {
      const all = document.querySelectorAll('.term-check');
      const checked = document.querySelectorAll('.term-check:checked');
      document.getElementById('btn-confirm-next').disabled = (all.length !== checked.length);
      document.getElementById('chk-all').checked = (all.length === checked.length);
  }

  // 5. Card Button Logic
  function toggleNewCardForm() {
      const f = document.getElementById('new-card-form');
      f.style.display = (f.style.display === 'none') ? 'block' : 'none';
  }
  function checkCVC() {
      const val = document.getElementById('cvc-input').value;
      document.getElementById('btn-final-check').disabled = (val.length < 3);
  }

  function renderFinal() {
    const t = document.getElementById('conf-total').innerText;
    document.getElementById('final-summary').innerText = 
        `日時: ${selectedSlot.date} ${selectedSlot.time}\n` +
        `場所: ${document.getElementById('conf-place').innerText}\n` +
        `犬: ${document.getElementById('conf-dog').innerText}\n` +
        `コース: ${document.getElementById('conf-course').innerText}\n` +
        `交通費: ${document.getElementById('conf-travel-fee').innerText}\n` +
        (voucherData ? `割引: -${voucherData.discount_value}\n` : '') + 
        `\n合計: ${t}`;
  }

  async function submitReservation() {
    document.getElementById('loading-overlay').style.display = 'flex';
    const payload = {
      action: 'add_reservation',
      userId: userData ? userData.unique_key : 'NEW_USER',
      date: selectedSlot.date,
      time: selectedSlot.time,
      dogId: selectedDog ? selectedDog.id : null,
      voucher: voucherData ? voucherData.name : null
    };
    try {
      const res = await fetch(GAS_URL, { method:'POST', body:JSON.stringify(payload) });
      const json = await res.json();
      if(json.status==='success') goToView(6);
      else alert(json.message);
    } catch(e){ alert('Error'); }
    finally { document.getElementById('loading-overlay').style.display='none'; }
  }

  function shareLine() {
    if (liff.isInClient()) {
        liff.sendMessages([{ type: 'text', text: 'レッスン予約しました！' }])
        .then(()=>alert('送信しました'))
        .catch(e=> { window.location.href = "https://line.me/R/msg/text/?レッスン予約しました！"; });
    } else { window.open("https://line.me/R/msg/text/?レッスン予約しました！"); }
  }
  function addToGoogleCalendar() {
    const title = 'K9レッスン';
    const d = selectedSlot.date.replace(/-/g,'');
    const t = selectedSlot.time.replace(':','');
    const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${d}T${t}00/${d}T${parseInt(t)+130}00`;
    window.open(url, '_blank');
  }
  function shareNative() {
    if(navigator.share) navigator.share({ title: 'K9 Harmony', text: '予約完了', url: 'https://liff.line.me/'+LIFF_ID });
  }

  const TERMS = { 'policy':'...','privacy':'...','terms':'...','law':'...' };
  function openTerms(k) {
    document.getElementById('terms-content').innerText = TERMS[k];
    document.getElementById('terms-overlay').classList.add('open');
    document.getElementById('terms-sheet').classList.add('open');
  }
  function closeTerms() {
    document.getElementById('terms-overlay').classList.remove('open');
    document.getElementById('terms-sheet').classList.remove('open');
  }
</script>
</body>
</html>
