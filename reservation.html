<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>レッスンの予約 | K9 Harmony</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* =========================================
       K9 Harmony Design System (Ver 3.0)
       ========================================= */
    :root {
      --c-main: #57C3C2;
      --c-deep: #2F5D62;
      --c-accent: #C87A56;
      --c-bg: #FAFAFA;
      --c-text: #333333;
      --c-gray: #666666;
    }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: var(--c-bg);
      color: var(--c-text);
      margin: 0; padding: 0;
      padding-bottom: 80px; /* Footer space */
    }

    /* Header */
    header { background: white; padding: 15px 0; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .logo-img { width: 40%; max-width: 180px; height: auto; }

    /* Progress Bar */
    .progress-container { display: flex; justify-content: space-between; padding: 20px 30px; position: relative; max-width: 600px; margin: 0 auto; }
    .progress-bg { position: absolute; top: 30px; left: 40px; right: 40px; height: 2px; background: #e0e0e0; z-index: 0; }
    .progress-bar-fill { position: absolute; top: 30px; left: 40px; height: 2px; background: var(--c-main); z-index: 0; width: 0%; transition: width 0.3s; }
    .step-dot { width: 20px; height: 20px; border-radius: 50%; background: #e0e0e0; z-index: 1; position: relative; border: 2px solid var(--c-bg); transition: background 0.3s; }
    .step-dot.active { background: var(--c-main); transform: scale(1.2); }
    .step-dot.done { background: var(--c-main); }

    /* Main Container */
    #app-container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .view-section { display: none; animation: fadeIn 0.4s ease-out; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* UI Elements */
    h2 { font-size: 1.1rem; color: var(--c-deep); border-left: 4px solid var(--c-main); padding-left: 10px; margin-bottom: 20px; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    label { display: block; font-weight: bold; font-size: 0.9rem; color: var(--c-deep); margin-bottom: 8px; }
    select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 15px; box-sizing: border-box; }

    /* Buttons */
    .btn { display: block; width: 100%; padding: 15px; border-radius: 50px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; text-align: center; margin-top: 15px; }
    .btn-primary { background: var(--c-accent); color: white; box-shadow: 0 4px 10px rgba(200, 122, 86, 0.3); }
    .btn-secondary { background: white; border: 1px solid #ccc; color: var(--c-gray); }
    .btn-cancel-rsv { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-size: 0.9rem; margin-top: 30px; }
    .btn-row { display: flex; gap: 10px; } .btn-row .btn { margin-top: 0; }

    /* --- Calendar (Matrix Table) --- */
    .cal-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .cal-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid #eee; }
    .cal-table { width: 100%; border-collapse: collapse; min-width: 400px; table-layout: fixed; }
    .cal-table th { background: #f8f8f8; color: var(--c-deep); padding: 8px 2px; font-size: 0.75rem; border-bottom: 2px solid #ddd; border-right: 1px solid #eee; text-align: center; }
    .cal-table th:first-child { width: 50px; position: sticky; left: 0; background: #f8f8f8; z-index: 2; border-right: 2px solid #ddd; }
    .cal-table td { height: 45px; border-bottom: 1px solid #eee; border-right: 1px solid #eee; text-align: center; vertical-align: middle; padding: 0; position: relative; }
    .cal-table td:first-child { position: sticky; left: 0; background: white; font-weight: bold; color: var(--c-deep); font-size: 0.8rem; z-index: 1; border-right: 2px solid #ddd; }
    
    /* Symbols */
    .sym-ok { color: var(--c-main); font-size: 1.2rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
    .sym-lim { color: #fbc02d; font-size: 0.9rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
    .sym-ng { background: #f0f0f0; color: #ccc; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
    .cal-legend { display: flex; justify-content: center; gap: 15px; font-size: 0.8rem; margin-top: 10px; color: var(--c-gray); }

    /* --- Modals (Common) --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; display: none; opacity: 0; transition: opacity 0.3s; }
    .modal-overlay.open { display: block; opacity: 1; }

    /* Dog Select Modal (Center) */
    .center-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 350px; background: white; border-radius: 12px; padding: 20px; z-index: 301; display: none; }
    .center-modal.open { display: block; animation: popIn 0.3s ease-out; }
    @keyframes popIn { from { transform: translate(-50%, -40%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }

    /* Time Select Modal (Bottom Sheet style for Time) */
    .time-modal { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; z-index: 302; transform: translateY(100%); transition: transform 0.3s; }
    .time-modal.open { transform: translateY(0); }

    /* Terms Modal (Top Sheet: Upper 70%) */
    .top-sheet { position: fixed; top: 0; left: 0; width: 100%; height: 70%; background: white; border-radius: 0 0 20px 20px; z-index: 302; transform: translateY(-100%); transition: transform 0.3s; display: flex; flex-direction: column; }
    .top-sheet.open { transform: translateY(0); }
    .top-sheet-content { flex: 1; overflow-y: auto; padding: 20px; font-size: 0.9rem; line-height: 1.6; }
    .top-sheet-close-area { position: fixed; top: 70%; left: 0; width: 100%; height: 30%; z-index: 301; /* Transparent area to close */ }

    /* Footer */
    footer { position: fixed; bottom: 0; width: 100%; background: #f9f9f9; padding: 15px; text-align: center; font-size: 0.7rem; color: #999; border-top: 1px solid #eee; z-index: 50; }

    /* Debug */
    #debug-console { display: none; } /* 本番は非表示、必要ならblock */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--c-main); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text" style="color:var(--c-deep); font-weight:bold;">起動中...</div>
</div>

<header>
  <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" class="logo-img" alt="K9 Harmony">
</header>

<div class="progress-container">
  <div class="progress-bg"></div>
  <div class="progress-bar-fill" id="progress-fill"></div>
  <div class="step-dot active" id="dot-1"></div>
  <div class="step-dot" id="dot-2"></div>
  <div class="step-dot" id="dot-3"></div>
  <div class="step-dot" id="dot-4"></div>
  <div class="step-dot" id="dot-5"></div>
</div>

<div id="app-container">

  <div id="view-1" class="view-section active">
    <h2>予約内容</h2>
    <div class="card">
      <label>選択中のワンちゃん</label>
      <div id="selected-dog-name" style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;">---</div>
      <button class="btn btn-secondary" style="padding:8px; font-size:0.8rem; width:auto; display:inline-block;" onclick="showDogSelectModal(true)">変更する</button>

      <div style="background:var(--c-bg); padding:10px; border-radius:8px; margin-top:15px;">
        <label style="display:flex; align-items:center; margin:0; cursor:pointer;">
          <input type="checkbox" id="multi-dog-check" style="width:20px; height:20px; margin-right:10px;">
          2頭目の追加 (+2,000円 / +30分)
        </label>
      </div>
    </div>

    <div class="card">
      <label>メニュー</label>
      <select id="menu-select">
        <option value="90" data-key="SINGLE" data-price="4900">単発レッスン (90分 ¥4,900)</option>
        <option value="90" data-key="TICKET_4" data-price="0">4回チケット利用 (残数ありの方)</option>
        <option value="90" data-key="TICKET_8" data-price="0">8回チケット利用 (残数ありの方)</option>
      </select>
    </div>

    <button class="btn btn-primary" onclick="goToView(2)">次へ (日時選択)</button>
    <button class="btn btn-cancel-rsv" onclick="location.href='cancel.html'">予約のキャンセルはこちら</button>
  </div>

  <div id="view-2" class="view-section">
    <h2>日時の選択</h2>
    <div class="card" style="padding:15px 5px;">
      <div class="cal-controls" style="padding:0 10px;">
        <button class="btn btn-secondary" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="shiftWeek(-1)">&lt; 前週</button>
        <span id="cal-range-text" style="font-weight:bold; font-size:0.9rem;">--/-- 〜</span>
        <button class="btn btn-secondary" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="shiftWeek(1)">次週 &gt;</button>
      </div>

      <div class="cal-wrapper">
        <table class="cal-table">
          <thead>
            <tr id="cal-header">
              <th>時間</th></tr>
          </thead>
          <tbody id="cal-body">
            </tbody>
        </table>
      </div>

      <div class="cal-legend">
        <span><span style="color:var(--c-main); font-weight:bold;">○</span> 予約可能</span>
        <span><span style="color:#fbc02d; font-weight:bold;">▲</span> 残りわずか</span>
        <span><span style="background:#ddd; padding:0 4px; color:#666;">×</span> 不可</span>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToView(1)">戻る</button>
      <button class="btn btn-primary" id="btn-to-step3" disabled onclick="goToView(3)">次へ</button>
    </div>
  </div>

  <div id="view-3" class="view-section">
    <h2>確認と規約</h2>
    <div class="card">
      <label>ご予約内容</label>
      <div id="conf-details" style="line-height:1.6;"></div>
      <div id="conf-total" style="font-size:1.2rem; font-weight:bold; color:var(--c-accent); text-align:right; margin-top:10px;">¥---</div>
      
      <label style="margin-top:15px;">お支払い方法</label>
      <select id="payment-method">
        <option value="CARD">クレジットカード</option>
        <option value="CASH">当日現金払い</option>
      </select>
    </div>

    <div class="card">
      <label>規約等の確認</label>
      <ul style="padding-left:20px; color:var(--c-main); font-weight:bold; font-size:0.9rem; line-height:2;">
        <li onclick="openTerms('policy')">キャンセルポリシー</li>
        <li onclick="openTerms('privacy')">個人情報の取扱について</li>
        <li onclick="openTerms('terms')">利用規約</li>
        <li onclick="openTerms('law')">特定商取引法に基づく表記</li>
      </ul>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToView(2)">戻る</button>
      <button class="btn btn-primary" onclick="goToView(4)">入力へ進む</button>
    </div>
  </div>

  <div id="view-4" class="view-section">
    <h2>情報入力</h2>
    <div class="card">
      <label>クレジットカード情報</label>
      <div style="background:#eee; padding:15px; border-radius:8px; margin-bottom:15px;">
        <div style="font-size:0.8rem; margin-bottom:5px;">TARO YAMADA</div>
        <div style="font-family:monospace; font-size:1.1rem; letter-spacing:2px;">**** **** **** 1234</div>
      </div>
      <div style="text-align:right;">
        <span style="font-size:0.8rem; font-weight:bold;">CVC (3桁)</span>
        <input type="tel" id="cvc-input" maxlength="4" placeholder="123" style="width:80px; text-align:center; display:inline-block; margin-left:10px;">
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToView(3)">戻る</button>
      <button class="btn btn-primary" onclick="goToView(5)">最終確認へ</button>
    </div>
  </div>

  <div id="view-5" class="view-section">
    <h2>最終確認</h2>
    <div class="card">
      <label>内容確認</label>
      <div id="final-summary" style="white-space:pre-wrap; font-size:0.9rem;"></div>
    </div>
    <div class="card" style="background:#fff3e0; border:1px solid #ffe0b2; color:#e65100;">
      <label style="color:#e65100;"><i class="fa-solid fa-triangle-exclamation"></i> キャンセル規定</label>
      <p style="font-size:0.85rem; margin:0;">前日キャンセル: 50% / 当日キャンセル: 100% の料金が発生します。</p>
    </div>
    <button class="btn btn-primary" onclick="submitReservation()">上記に同意して予約確定</button>
    <button class="btn btn-secondary" onclick="goToView(4)">戻る</button>
  </div>

  <div id="view-6" class="view-section" style="text-align:center; padding-top:50px;">
    <i class="fa-regular fa-circle-check" style="font-size:4rem; color:var(--c-main); margin-bottom:20px;"></i>
    <h2>予約完了</h2>
    <p>ご予約ありがとうございます。</p>
    <button class="btn btn-secondary" onclick="liff.closeWindow()">閉じる</button>
  </div>

</div>

<footer>&copy; 2025 K9 Harmony</footer>

<div class="modal-overlay" id="dog-modal-overlay">
  <div class="center-modal" id="dog-modal">
    <h3 style="text-align:center; color:var(--c-deep); margin-bottom:15px;">ワンちゃんを選択</h3>
    <div id="dog-list-container"></div>
  </div>
</div>

<div class="modal-overlay" id="time-modal-overlay" onclick="closeTimeModal()">
  <div class="time-modal" id="time-modal">
    <h3 id="time-modal-title" style="font-size:1.1rem; text-align:center; margin-bottom:20px;">10:00〜 の選択</h3>
    <div id="time-slot-buttons" style="display:grid; gap:10px;">
      </div>
    <button class="btn btn-secondary" onclick="closeTimeModal()">閉じる</button>
  </div>
</div>

<div class="modal-overlay" id="terms-overlay" onclick="closeTerms()"></div> <div class="top-sheet" id="terms-sheet">
  <div style="padding:15px; border-bottom:1px solid #eee; text-align:center; font-weight:bold; display:flex; justify-content:space-between;">
    <span id="terms-title">規約</span>
    <span onclick="closeTerms()" style="cursor:pointer; font-size:1.2rem;">&times;</span>
  </div>
  <div class="top-sheet-content" id="terms-content">
    読み込み中...
  </div>
</div>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
  const LIFF_ID = '2008546673-MJY7j3ox';

  let userData = null;
  let userDogs = [];
  let selectedDog = null;
  let selectedSlot = null; // { date: 'YYYY-MM-DD', time: '10:00' }
  let weekOffset = 0;

  // Init
  window.onload = async () => {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      fetchUserData(profile.userId);
    } catch (e) {
      document.getElementById('loading-text').innerText = 'エラー: ' + e.message;
    }
  };

  async function fetchUserData(userId) {
    try {
      const res = await fetch(`${GAS_URL}?userId=${userId}&type=data&t=${Date.now()}`);
      const json = await res.json();
      
      if(json.customer) userData = json.customer;
      if(json.all_dogs) userDogs = json.all_dogs;
      else if(json.dog) userDogs = [json.dog];

      // ① 複数犬ならモーダル、1頭なら即選択
      if (userDogs.length > 1) {
        showDogSelectModal(false); // false = cannot close without selection
      } else if (userDogs.length === 1) {
        selectDog(0);
      } else {
        alert('ワンちゃんの登録がありません');
      }
      document.getElementById('loading-overlay').style.display = 'none';
    } catch(e) {
      alert('データ取得失敗');
    }
  }

  // --- Dog Selection ---
  function showDogSelectModal(canClose) {
    const cont = document.getElementById('dog-list-container');
    cont.innerHTML = '';
    userDogs.forEach((d, idx) => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary';
      btn.style.marginTop = '10px';
      btn.innerText = d.name_disp || d.name;
      btn.onclick = () => { selectDog(idx); closeDogModal(); };
      cont.appendChild(btn);
    });
    if(canClose) {
      const close = document.createElement('button');
      close.className = 'btn btn-secondary';
      close.innerText = 'キャンセル';
      close.onclick = closeDogModal;
      cont.appendChild(close);
    }
    document.getElementById('dog-modal-overlay').classList.add('open');
    document.getElementById('dog-modal').classList.add('open');
  }
  function closeDogModal() {
    document.getElementById('dog-modal-overlay').classList.remove('open');
    document.getElementById('dog-modal').classList.remove('open');
  }
  function selectDog(idx) {
    selectedDog = userDogs[idx];
    document.getElementById('selected-dog-name').innerText = selectedDog.name_disp || selectedDog.name;
  }

  // --- Navigation ---
  function goToView(step) {
    document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
    document.getElementById(`view-${step}`).classList.add('active');
    updateProgress(step);
    window.scrollTo(0,0);
    if(step === 2) renderCalendar();
    if(step === 3) renderConfirm();
    if(step === 5) renderFinal();
  }
  function updateProgress(step) {
    if(step>5) return;
    const pct = ((step-1)/4)*100;
    document.getElementById('progress-fill').style.width = pct+'%';
    for(let i=1; i<=5; i++){
      const d = document.getElementById(`dot-${i}`);
      d.classList.remove('active','done');
      if(i<step) d.classList.add('done');
      if(i===step) d.classList.add('active');
    }
  }

  // --- Calendar (Matrix) ---
  function shiftWeek(d) { weekOffset += d; renderCalendar(); }
  
  function renderCalendar() {
    const tbody = document.getElementById('cal-body');
    const thead = document.getElementById('cal-header');
    tbody.innerHTML = '';
    
    // Dates
    const startDt = new Date();
    startDt.setDate(startDt.getDate() + (weekOffset*7));
    let dates = [];
    let headHtml = '<th>時間</th>';
    for(let i=0; i<7; i++){
      let d = new Date(startDt); d.setDate(startDt.getDate()+i);
      let ds = `${d.getMonth()+1}/${d.getDate()}`;
      let w = ['日','月','火','水','木','金','土'][d.getDay()];
      let col = (d.getDay()===0)?'red':(d.getDay()===6)?'blue':'#333';
      dates.push({ date: d.toISOString().split('T')[0], day: d.getDay() });
      headHtml += `<th style="color:${col}">${ds}<br>(${w})</th>`;
    }
    thead.innerHTML = headHtml;

    // Rows (10:00 - 20:00)
    for(let h=10; h<=20; h++){
      let tr = document.createElement('tr');
      // Time Label
      tr.innerHTML = `<td>${h}:00</td>`;
      
      dates.forEach(dt => {
        let td = document.createElement('td');
        
        // Logic: 水曜(3)=NG, 木曜(4)&<13時=NG
        let isNG = false;
        if(dt.day === 3) isNG = true;
        if(dt.day === 4 && h < 13) isNG = true;

        if(isNG) {
          td.innerHTML = '<span class="sym-ng">×</span>';
        } else {
          // Mock availability logic: 
          // 00分と30分が両方OKなら○, 片方なら▲
          // ここでは仮に全部○とする（API実装時はここで判定）
          td.innerHTML = `<span class="sym-ok" onclick="openTimeModal('${dt.date}', ${h})">○</span>`;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
  }

  // --- Time Selection Modal ---
  function openTimeModal(dateStr, hour) {
    document.getElementById('time-modal-title').innerText = `${dateStr} ${hour}:00台の選択`;
    const cont = document.getElementById('time-slot-buttons');
    cont.innerHTML = '';
    
    // 00分
    const btn00 = document.createElement('button');
    btn00.className = 'btn btn-primary'; btn00.style.marginTop='0';
    btn00.innerText = `${hour}:00 開始`;
    btn00.onclick = () => chooseTime(dateStr, `${hour}:00`);
    cont.appendChild(btn00);

    // 30分
    const btn30 = document.createElement('button');
    btn30.className = 'btn btn-primary'; btn30.style.marginTop='0';
    btn30.innerText = `${hour}:30 開始`;
    btn30.onclick = () => chooseTime(dateStr, `${hour}:30`);
    cont.appendChild(btn30);

    document.getElementById('time-modal-overlay').classList.add('open');
    document.getElementById('time-modal').classList.add('open');
  }
  function closeTimeModal() {
    document.getElementById('time-modal-overlay').classList.remove('open');
    document.getElementById('time-modal').classList.remove('open');
  }
  function chooseTime(d, t) {
    selectedSlot = { date: d, time: t };
    closeTimeModal();
    // Enable Next
    document.getElementById('btn-to-step3').innerText = `${d} ${t} で進む`;
    document.getElementById('btn-to-step3').disabled = false;
  }

  // --- Terms Modal (Top Sheet) ---
  const TERMS_TEXT = {
    'policy': '【キャンセルポリシー】\n前日: 50%\n当日: 100%\n...',
    'privacy': '【個人情報取扱】\n...',
    'terms': '【利用規約】\n...',
    'law': '【特商法】\n...'
  };
  function openTerms(key) {
    document.getElementById('terms-content').innerText = TERMS_TEXT[key];
    document.getElementById('terms-overlay').classList.add('open');
    document.getElementById('terms-sheet').classList.add('open');
  }
  function closeTerms() {
    document.getElementById('terms-overlay').classList.remove('open');
    document.getElementById('terms-sheet').classList.remove('open');
  }

  // --- Confirm & Final ---
  function renderConfirm() {
    const isMulti = document.getElementById('multi-dog-check').checked;
    const menuEl = document.getElementById('menu-select');
    const price = parseInt(menuEl.options[menuEl.selectedIndex].dataset.price);
    const total = price + (isMulti?2000:0);
    
    let html = `
      <div><strong>日時:</strong> ${selectedSlot.date} ${selectedSlot.time}</div>
      <div><strong>犬:</strong> ${selectedDog.name_disp} ${isMulti?'+1頭':''}</div>
      <div><strong>メニュー:</strong> ${menuEl.value}分</div>
    `;
    document.getElementById('conf-details').innerHTML = html;
    document.getElementById('conf-total').innerText = `¥${total.toLocaleString()}`;
  }

  function renderFinal() {
    // Clone content from step 3 for display
    document.getElementById('final-summary').innerHTML = document.getElementById('conf-details').innerHTML + 
      `<div style="margin-top:10px; font-weight:bold;">合計: ${document.getElementById('conf-total').innerText}</div>`;
  }

  async function submitReservation() {
    document.getElementById('loading-text').innerText = '予約確定中...';
    document.getElementById('loading-overlay').style.display = 'flex';
    
    // Payload
    const payload = {
      action: 'add_reservation',
      userId: userData.unique_key,
      date: selectedSlot.date,
      time: selectedSlot.time,
      dogId: selectedDog.id,
      // ... others
    };

    try {
      const res = await fetch(GAS_URL, { method:'POST', body:JSON.stringify(payload) });
      const json = await res.json();
      if(json.status === 'success') {
        goToView(6);
      } else {
        alert('エラー: '+json.message);
      }
    } catch(e) {
      alert('通信エラー');
    } finally {
      document.getElementById('loading-overlay').style.display = 'none';
    }
  }
</script>
</body>
</html>
