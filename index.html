<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <script>
    // [System] ç‰¹å®šã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€å³åº§ã«medical.htmlã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    (function() {
      if (new URLSearchParams(window.location.search).get('page') === 'medical') {
        window.location.replace('medical.html'); 
      }
    })();
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>K9 Harmony Portal</title>
  
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Lato:wght@400;700&family=Noto+Sans+JP:wght@400;500&family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       1. Foundation: Color & Typography
       ========================================= */
    :root { 
        /* Main Identity: ãƒ–ãƒ©ãƒ³ãƒ‰ã®ç²¾ç¥ */
        --c-main-turquoise: #57C3C2;
        
        /* Authority & Trust: æ§‹é€ ã¨ä¿¡é ¼ */
        --c-sub-deep-ocean: #2F5D62;
        
        /* Conversion Trigger: å”¯ä¸€ã®ã€Œè¡Œå‹•ã€è‰² */
        --c-accent-copper: #C87A56;
        
        /* Luxury Foundation: ç©ºé–“ã¨ä½™ç™½ */
        --c-base-washi: #FAFAFA;
        --c-bg-mist: #F4F7F7;
        
        /* Organic Touch: æ¸©ã‚‚ã‚Š */
        --c-sub-beige: #C7B299;
        
        /* Typography: çŸ¥æ€§ */
        --c-text-sumi: #333333;
        --c-text-gray: #666666;
        
        /* Fonts */
        --font-serif-en: 'Cormorant Garamond', serif;
        --font-serif-jp: 'Noto Serif JP', serif;
        --font-sans-jp: 'Noto Sans JP', sans-serif;
        --font-sans-en: 'Lato', sans-serif;

        /* Motion */
        --ease-luxury: cubic-bezier(0.25, 0.1, 0.25, 1.0);
    }

    body { 
        font-family: var(--font-sans-jp);
        background-color: var(--c-base-washi);
        color: var(--c-text-sumi);
        line-height: 1.8; /* ã‚†ã£ãŸã‚Šã¨ã—ãŸè¡Œé–“ */
        padding-bottom: 150px; 
        overflow-x: hidden; 
    }
    
    /* Loading Overlay (Breathing Animation) */
    #loadingOverlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: var(--c-base-washi); /* ãƒ–ãƒ©ãƒ³ãƒ‰èƒŒæ™¯è‰² */
        display: flex; flex-direction: column; justify-content: center; align-items: center; 
        z-index: 9999; color: var(--c-sub-deep-ocean); 
        transition: opacity 0.8s var(--ease-luxury), visibility 0.8s var(--ease-luxury);
    }
    .loading-content {
        text-align: center;
        animation: breathe 2.0s var(--ease-luxury) infinite;
    }
    @keyframes breathe {
        0%, 100% { opacity: 0.4; transform: scale(0.98); }
        50% { opacity: 1; transform: scale(1.0); }
    }
    .spinner-border-brand { 
        border-color: var(--c-main-turquoise); border-right-color: transparent; 
        width: 3rem; height: 3rem; margin-bottom: 20px;
    }
    #tipsText { 
        margin-top: 20px; font-weight: 500; font-size: 0.95rem; 
        font-family: var(--font-serif-jp); letter-spacing: 0.05em;
        padding: 0 20px; height: 1.5em; 
    }
    
    body.loaded #loadingOverlay { opacity: 0; visibility: hidden; pointer-events: none; }
    
    /* Main Content Fade-in */
    #mainContent { opacity: 0; transform: translateY(10px); transition: opacity 0.8s var(--ease-luxury), transform 0.8s var(--ease-luxury); }
    body.loaded #mainContent { opacity: 1; transform: translateY(0); }
    
    /* =========================================
       2. UI Component Styles (Refined)
       ========================================= */
    .header-area { 
        padding: 20px 20px 10px; 
        background: #fff; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ç´”ç™½ã§åŒºåˆ‡ã‚Š */
        box-shadow: 0 1px 0 rgba(0,0,0,0.03); 
    }

    /* ãƒ­ã‚´ */
    .logo-container { 
        display: flex; justify-content: center; 
        margin-bottom: 15px; margin-top: 5px; 
    }
    .logo-img { width: 35%; height: auto; display: block; filter: contrast(0.95); }

    .brand-title { 
        color: var(--c-sub-deep-ocean); 
        font-family: var(--font-serif-en);
        font-weight: 700; 
        letter-spacing: 0.08em; 
        font-size: 1.4rem; 
        text-align: center; 
    }
    
    /* Profile Card (Soft Depth) */
    .profile-card { 
        margin-top: 30px; display: flex; align-items: center; 
    }
    
    #dogImgContainer {
        width: 140px; height: 140px; 
        border-radius: 50%; 
        border: 3px solid var(--c-main-turquoise); /* æ ç·šã‚’å°‘ã—ç¹Šç´°ã« */
        background: #fff; 
        flex-shrink: 0; 
        display: flex; align-items: center; justify-content: center;
        overflow: hidden;
        font-size: 0.8rem; color: #aaa; text-align: center;
        box-shadow: 0 10px 30px -10px rgba(87, 195, 194, 0.3); /* æœ‰æ©Ÿçš„ãªå½± */
    }
    .dog-img { width: 100%; height: 100%; object-fit: cover; }
    
    .profile-info { margin-left: 25px; flex-grow: 1; }
    .birthday-msg { color: var(--c-accent-copper); font-family: var(--font-serif-en); font-weight: 700; font-size: 0.85rem; display: none; animation: pulse 2s infinite var(--ease-luxury); }
    @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.02); } 100% { opacity: 0.8; } }
    
    .cust-name { font-size: 0.85rem; color: var(--c-text-gray); margin: 0; line-height: 1.4; letter-spacing: 0.05em; }
    .dog-name { 
        font-family: var(--font-serif-jp); 
        font-size: 1.8rem; font-weight: 600; 
        line-height: 1.2; margin: 5px 0; color: var(--c-text-sumi); 
    }
    .lesson-meta { font-size: 0.85rem; color: var(--c-main-turquoise); font-weight: 600; font-family: var(--font-sans-en); letter-spacing: 0.05em; }
    .history-link { text-decoration: none; color: var(--c-sub-deep-ocean); font-weight: 500; font-size: 0.9rem; margin-left: auto; display: block; text-align: right; margin-top: 10px; opacity: 0.8; transition: opacity 0.3s; }
    
    .medical-btn-card { 
        cursor: pointer; border-radius: 12px; border: 1px solid rgba(0,0,0,0.03); 
        background: #fff;
        box-shadow: 0 10px 40px -10px rgba(47, 93, 98, 0.08); /* Soft Depth */
        transition: transform 0.3s var(--ease-luxury), box-shadow 0.3s var(--ease-luxury); 
    }
    .medical-btn-card:active { transform: scale(0.98); box-shadow: 0 2px 10px -5px rgba(47, 93, 98, 0.1); }

    .chart-section { margin-top: 30px; padding: 0 10px; display: flex; justify-content: space-between; }
    .chart-box { width: 48%; text-align: center; }
    .chart-caption { font-size: 0.8rem; color: var(--c-sub-deep-ocean); margin-top: 10px; font-weight: 600; font-family: var(--font-serif-jp); letter-spacing: 0.05em; }
    
    /* Headings (Luxury) */
    .section-title { 
        font-family: var(--font-serif-jp); 
        font-size: 1.05rem; font-weight: 600; 
        color: var(--c-sub-deep-ocean); 
        margin: 40px 20px 15px; 
        display: flex; align-items: center; gap: 10px; 
        letter-spacing: 0.08em;
    }
    .section-title::before { content: ''; display: block; width: 3px; height: 18px; background: var(--c-main-turquoise); border-radius: 1px; }
    
    .section-title.accent { color: var(--c-accent-copper); }
    .section-title.accent::before { background: var(--c-accent-copper); }
    
    .next-goal-box { 
        margin: 0 20px; background: #fff; 
        border: 1px solid var(--c-accent-copper); border-radius: 12px; 
        padding: 20px; font-weight: 600; color: var(--c-text-sumi); 
        box-shadow: 0 10px 30px -10px rgba(200, 122, 86, 0.15); 
        line-height: 1.8;
    }

    .feedback-box { margin: 0 20px; background: var(--c-bg-mist); border-radius: 12px; padding: 20px; font-size: 0.95rem; color: var(--c-text-sumi); line-height: 1.8; }
    .homework-box { margin: 0 20px; border: 1px solid var(--c-main-turquoise); border-radius: 12px; padding: 20px; background: #fff; position: relative; margin-top: 35px; }
    .homework-badge { position: absolute; top: -12px; left: 20px; background: var(--c-main-turquoise); color: #fff; font-size: 0.75rem; padding: 3px 12px; border-radius: 20px; font-weight: 600; letter-spacing: 0.05em; }
    
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 0 20px; }
    .detail-card { background: var(--c-bg-mist); border-radius: 12px; padding: 15px; }
    .detail-head { font-size: 0.75rem; font-weight: 600; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px; margin-bottom: 8px; text-align: center; color: var(--c-sub-deep-ocean); letter-spacing: 0.05em; }
    .detail-body { font-size: 0.85rem; color: var(--c-text-sumi); white-space: pre-wrap; line-height: 1.6; }
    
    .photo-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 0 20px; margin-top: 15px; padding-bottom: 20px; }
    .photo-item { height: 130px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.3s; }
    .photo-item:active { transform: scale(0.98); }
    
    .footer-action { margin: 50px 20px 20px; text-align: center; }
    
    /* Buttons */
    .btn-pdf { 
        background: #fff; color: var(--c-sub-deep-ocean); 
        border: 1px solid var(--c-sub-deep-ocean); 
        width: 100%; padding: 14px; border-radius: 50px; 
        font-weight: 600; font-size: 1rem; margin-bottom: 15px; 
        display: block; text-decoration: none; 
        transition: all 0.3s var(--ease-luxury); cursor: pointer; letter-spacing: 0.05em;
    }
    .btn-pdf:active { background: var(--c-bg-mist); transform: scale(0.98); }

    /* The Sanctuary Button (Copper) */
    .btn-reserve { 
        background: var(--c-accent-copper); 
        color: #fff; border: none; width: 100%; padding: 16px; border-radius: 50px; 
        font-weight: 700; font-size: 1.05rem; 
        box-shadow: 0 4px 12px rgba(200, 122, 86, 0.4); /* Haptic Visual */
        display: block; text-decoration: none; letter-spacing: 0.05em;
        transition: all 0.3s var(--ease-luxury);
    }
    .btn-reserve:active { transform: scale(0.96); box-shadow: 0 2px 6px rgba(200, 122, 86, 0.3); }
    
    .reminder-box { background: #fff8f4; border: 1px solid #f2e0d5; color: var(--c-accent-copper); padding: 12px; border-radius: 12px; margin-top: 20px; font-size: 0.9rem; font-weight: 600; letter-spacing: 0.05em; }

    #errorView { text-align: center; margin-top: 80px; display: none; padding: 20px; }
    .line-id-box { background: #eee; padding: 10px; border-radius: 5px; margin: 15px 0; font-family: var(--font-sans-en); font-weight: bold; word-break: break-all; }
    
    /* Switch Dog Button (Not Copper) */
    .dog-select-btn { 
        width: 100%; margin-bottom: 12px; padding: 16px; 
        font-weight: 600; font-size: 1.05rem; 
        border-radius: 12px; background: #fff; 
        border: 1px solid var(--c-main-turquoise); color: var(--c-main-turquoise); 
        transition: all 0.3s var(--ease-luxury); 
        box-shadow: 0 4px 10px rgba(87, 195, 194, 0.1);
    }
    .dog-select-btn:active { background: var(--c-bg-mist); transform: scale(0.98); }

    /* =========================================
       3. Milestone CSS (Integrated & Refined)
       ========================================= */
    .milestone-section { margin: 40px 20px 10px; }
    
    .tier-container { 
        margin-bottom: 25px; position: relative; border-radius: 12px; background: #fff; 
        padding: 20px; box-shadow: 0 10px 40px -10px rgba(47, 93, 98, 0.08); 
        z-index: 1; overflow: hidden;
    }
    
    .tier-header { font-size: 0.95rem; font-weight: 600; color: var(--c-text-gray); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; font-family: var(--font-serif-jp); letter-spacing: 0.05em; }
    
    .tier-badge-scroll { 
        display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 18px; 
        padding-bottom: 10px; scroll-snap-type: x mandatory; 
        -webkit-overflow-scrolling: touch; min-height: 110px;
    }
    .tier-badge-scroll::-webkit-scrollbar { display: none; }
    
    /* Badge Item */
    .ms-badge { flex: 0 0 auto; width: 75px; display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; text-decoration: none; scroll-snap-align: start; transition: transform 0.1s; }
    .ms-badge:active { transform: scale(0.95); }
    
    @keyframes shake-refuse {
        0%, 100% { transform: translateX(0); } 25%, 75% { transform: translateX(-4px); } 50% { transform: translateX(4px); }
    }
    .anim-shake .ms-icon-box { animation: shake-refuse 0.4s ease-in-out; }

    .ms-badge.teaser { pointer-events: none; opacity: 0.7; }
    .ms-badge.teaser .ms-icon-box { clip-path: inset(0 0 50% 0); background: var(--c-sub-beige); box-shadow: none; opacity: 0.5; }
    .ms-badge.teaser .ms-label { display: none; }

    /* Sealing Wax (Matched to new Palette) */
    .ms-icon-box { 
        width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; 
        margin-bottom: 10px; position: relative; overflow: hidden;
        box-shadow: inset 0 0 8px rgba(0,0,0,0.2), inset 2px 2px 4px rgba(255,255,255,0.4), 0 4px 10px rgba(0,0,0,0.15);
        border: none;
    }
    .ms-icon-box::before {
        content: ''; position: absolute; top: 8px; left: 8px; right: 8px; bottom: 8px; border-radius: 50%; 
        border: 2px double rgba(0,0,0,0.1); box-shadow: inset 1px 1px 2px rgba(0,0,0,0.05); pointer-events: none; z-index: 1;
    }
    .ms-icon-box::after {
        content: ''; position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px; border-radius: 50%;
        border: 0.5px solid rgba(255,255,255,0.5); pointer-events: none; z-index: 1;
    }

    .ms-icon-box i { font-size: 1.8rem; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2)); color: #fff; z-index: 2; position: relative; }
    .ms-icon-box img { width: 55%; height: 55%; object-fit: contain; z-index: 2; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1)); position: relative; }
    
    .ms-label { font-size: 0.7rem; font-weight: 500; color: var(--c-text-sumi); text-align: center; line-height: 1.3; width: 100%; height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

    .ms-badge.locked .ms-icon-box { background: #e0e0e0 !important; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
    .ms-badge.locked .ms-label { color: #aaa; }
    
    .tier-lock-icon-small {
        font-size: 1.2rem;
        background: linear-gradient(to bottom, #d4af37 0%, #a67c00 100%); /* Gold Gradient */
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3)); z-index: 3;
    }

    /* Colors (Mapped to new identity if needed, otherwise kept as logic) */
    .bg-trust { background: #A8D8B9; }
    .bg-bond { background: linear-gradient(135deg, #e0e0e0, #ffffff, #b0b0b0); color: #333; }
    .bg-harmony { background: linear-gradient(45deg, #FFD700, #FDB931, #FFD700); }
    /* DB Colors */
    .bg-pastel-sage { background: #A8D8B9; } .bg-pastel-apricot { background: #FFDAB9; }
    .bg-pastel-sky { background: #87CEEB; } .bg-pastel-rose { background: #FFB7B2; }
    .bg-pastel-lilac { background: #C8A2C8; } .bg-pastel-mint { background: #98FF98; }
    .bg-pastel-coral { background: #FF7F50; } .bg-pastel-cocoa { background: #D2691E; }
    .bg-metallic-silver { background: linear-gradient(135deg, #e0e0e0, #ffffff, #b0b0b0); color: #333; }
    .bg-metallic-bronze { background: linear-gradient(135deg, #cd7f32, #ffcc99, #8b4513); }
    .bg-metallic-champagne { background: linear-gradient(135deg, #fad6a5, #fff8e7, #d2b48c); color: #5d4037; }
    .bg-metallic-slate { background: linear-gradient(135deg, #708090, #b0c4de, #2f4f4f); }
    .bg-metallic-pearl { background: linear-gradient(135deg, #f0f8ff, #ffffff, #dcdcdc); color: #333; border: 1px solid #ddd; }
    .bg-metallic-rose-gold { background: linear-gradient(135deg, #b76e79, #ffd1dc, #a0522d); }
    .bg-metallic-coffee { background: linear-gradient(135deg, #6f4e37, #d2b48c, #3e2723); }
    .bg-metallic-ice { background: linear-gradient(135deg, #a5f2f3, #e0ffff, #00ced1); color: #00695c; }
    .bg-luxury-gold { background: linear-gradient(45deg, #FFD700, #FDB931, #FFD700); }
    .bg-luxury-platinum { background: linear-gradient(45deg, #E5E4E2, #ffffff, #BCC6CC); color:#333; }
    .bg-luxury-ruby { background: linear-gradient(45deg, #9b111e, #ff0000, #800000); }
    .bg-luxury-sapphire { background: linear-gradient(45deg, #0F52BA, #4169E1, #000080); }
    .bg-luxury-onyx { background: linear-gradient(45deg, #353839, #000000, #2c2c2c); }
    .bg-luxury-diamond { background: linear-gradient(45deg, #b9f2ff, #ffffff, #e0ffff); color:#000; border:1px solid #aaa; }

    .tier-container::after {
        content: ''; position: absolute; top: 0; right: 0; width: 40px; height: 100%;
        background: linear-gradient(to left, rgba(255,255,255,1), rgba(255,255,255,0)); pointer-events: none; z-index: 5; border-radius: 0 12px 12px 0;
    }

    .tier-locked {
        position: relative; height: 150px; border-radius: 12px; background: var(--c-bg-mist); 
        display:flex; align-items:center; justify-content:center; overflow: hidden;
    }
    .tier-lock-overlay {
        position: absolute; inset: 0; background-color: rgba(0, 0, 0, 0.85); 
        background-image: 
            radial-gradient(circle at 50% 50%, rgba(255,255,255,0.03) 0%, transparent 40%),
            repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 10px);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 10; color: #fff;
    }
    .tier-lock-icon {
        font-size: 3.5rem; margin-bottom: 10px;
        background: linear-gradient(to bottom, #fbf5b7 0%, #bf953f 40%, #b38728 60%, #fbf5b7 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.9)); 
    }
    .tier-lock-text {
        font-family: var(--font-serif-en); font-size: 1.2rem; letter-spacing: 0.15em; color: #fbf5b7; text-shadow: 0 2px 4px rgba(0,0,0,1);
    }

    .ms-list-link {
        display: block; text-align: center; color: var(--c-sub-deep-ocean); 
        font-weight: 600; font-size: 0.9rem; text-decoration: none; 
        margin: 15px 0 25px 0; cursor: pointer; letter-spacing: 0.05em; opacity: 0.8;
    }
    .ms-list-link:hover { text-decoration: underline; }

    /* Modals */
    .modal-content { border-radius: 12px; border: none; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
    .modal-header { border-bottom: none; padding-bottom: 0; }
    #msModalIconBox { 
        width: 100px; height: 100px; border-radius: 50%; margin: 0 auto; 
        display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.3), 0 10px 20px rgba(0,0,0,0.1); position: relative;
    }
    #msModalIconBox::before {
        content: ''; position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px;
        border-radius: 50%; border: 1px solid rgba(0,0,0,0.15); box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); pointer-events: none; z-index: 1;
    }
    #msModalTipsBox { background-color: var(--c-bg-mist); border-radius: 12px; padding: 20px; margin-top: 20px; color: var(--c-sub-deep-ocean); font-size: 0.9rem; line-height: 1.8; }
    
    .full-list-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 30px; }
    .full-list-section { margin-bottom: 30px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .full-list-title { font-size: 1.1rem; font-family: var(--font-serif-jp); font-weight: 600; margin-bottom: 20px; color: var(--c-sub-deep-ocean); border-left: 3px solid var(--c-main-turquoise); padding-left: 12px; letter-spacing: 0.05em; }
    
    #log-stamp { background: #333; color: #666; text-align: center; font-size: 0.7rem; padding: 2px; }
    #debug-console { display: none; } /* Hide in production look */

    /* [Moment of Joy Styles - Keeping logic, refining z-index] */
    #celebrationOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: none; pointer-events: auto; }
    #celebNightSky { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center bottom, #00143c 0%, #000 90%); opacity: 0; transition: opacity 0.5s ease-out; z-index: 10001; }
    #celebrationOverlay.active #celebNightSky { opacity: 1; }
    #celebStars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10002; pointer-events: none; opacity: 0; }
    #celebrationOverlay.active #celebStars { opacity: 1; transition: opacity 0.5s 0.5s; }
    .twinkling-star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s infinite ease-in-out; }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 4px gold; } }
    #celebLightContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; z-index: 10003; }
    #celebLightCore { position: absolute; z-index: 3; width: 10px; height: 10px; border-radius: 50%; background: radial-gradient(circle, #fff 0%, #fff 80%, rgba(255,255,255,0.8) 90%, transparent 100%); opacity: 0; transform: scale(0); filter: none; }
    #celebLightRing { position: absolute; z-index: 1; width: 10px; height: 10px; border-radius: 50%; margin-top: -32.5px; background: radial-gradient(circle, transparent 50%, rgba(255,255,255,1.0) 55%, transparent 60%); filter: blur(0.2px); opacity: 0; transform: scale(0); }
    #celebLightOval { position: absolute; z-index: 2; width: 10px; height: 10px; border-radius: 50%; margin-top: 65px; background: radial-gradient(circle, transparent 50%, rgba(255,255,255,1.0) 55%, transparent 60%); filter: blur(0.2px); opacity: 0; transform: scale(0); }
    .anim-light { animation: light-bloom 2.0s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes light-bloom { 0% { transform: scale(0); opacity: 0; } 15% { transform: scale(300); opacity: 1; } 100% { transform: scale(17.5); opacity: 0.6; } }
    .anim-ring { animation: ring-bloom 2.0s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes ring-bloom { 0% { transform: scale(0); opacity: 0; } 15% { transform: scale(300); opacity: 1; } 100% { transform: scale(24); opacity: 0.4; } }
    .anim-oval { animation: oval-bloom 2.0s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes oval-bloom { 0% { transform: scale(0); opacity: 0; } 15% { transform: scale(300); opacity: 1; } 100% { transform: scale(30, 10.5); opacity: 0.8; } }
    #celebFireworksCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10004; }
    #celebBadgeContainer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; z-index: 10005; }
    .anim-badge-appear { animation: badge-sequence 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    @keyframes badge-sequence { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; filter: brightness(0); } 100% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; filter: brightness(1); } }
    
    .celeb-badge-inner { width: 140px; height: 140px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; box-shadow: inset 0 0 16px rgba(0,0,0,0.3), inset 4px 4px 8px rgba(255,255,255,0.4), 0 8px 12px rgba(0,0,0,0.3); border: none; }
    .celeb-badge-inner::before { content: ''; position: absolute; top: 16px; left: 16px; right: 16px; bottom: 16px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.15); box-shadow: inset 2px 2px 4px rgba(0,0,0,0.2), 0 0 0 40px rgba(0,0,0,0.02); pointer-events: none; z-index: 1; }
    .celeb-badge-inner::after { content: ''; position: absolute; top: 21px; left: 21px; right: 21px; bottom: 21px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.4); pointer-events: none; z-index: 1; }

    .celeb-badge-inner i { font-size: 3.6rem; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); color: #fff; z-index: 2; position: relative; }
    .celeb-badge-inner img { width: 55%; height: 55%; object-fit: contain; z-index: 2; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); position: relative; }
    #fairyDustCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10010; display: none; }
    #celebCloseArea { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10006; cursor: pointer; }
    .btn-secondary { background-color: var(--c-sub-deep-ocean); border-color: var(--c-sub-deep-ocean); color: white; }
    
    #milestoneModal { z-index: 2000; }
  </style>
</head>
<body>

  <div id="celebrationOverlay">
      <div id="celebNightSky"></div>
      <div id="celebStars"></div>
      <div id="celebLightContainer">
          <div id="celebLightCore"></div>
          <div id="celebLightRing"></div>
          <div id="celebLightOval"></div>
      </div>
      <canvas id="celebFireworksCanvas"></canvas>
      <div id="celebBadgeContainer">
      </div>
      <div id="celebCloseArea" onclick="closeCelebration()"></div>
      <div style="position:absolute; bottom:50px; width:100%; text-align:center; color:white; z-index:10007; pointer-events:none; font-weight:bold; letter-spacing:0.1em; text-shadow:0 2px 5px black; font-family: 'Lato', sans-serif;">
          Tap to Close
      </div>
  </div>
  
  <canvas id="fairyDustCanvas"></canvas>

  <div id="log-stamp">v2025.12.17-BRAND-REFRESH-V1</div>

  <div id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border spinner-border-brand" role="status"></div>
        <p id="tipsText">ãŸã ã„ã¾æº–å‚™ã—ã¦ãŠã‚Šã¾ã™...</p>
    </div>
  </div>

  <div id="errorView">
    <div class="container">
      <div class="alert alert-warning text-center" style="border-radius:12px; background:#fff3cd; border:1px solid #ffeeba;">
        <h5 class="fw-bold" id="errorTitle" style="color:#856404; font-family:var(--font-serif-jp);">ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“</h5>
        <p class="small" id="errorMessage" style="color:#856404;">ã†ã¾ãå‡¦ç†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ</p>
        <div class="line-id-box" id="dispLineId" style="display:none;"></div>
        <button class="btn btn-secondary btn-sm w-100 mt-2" onclick="location.reload()">å†èª­ã¿è¾¼ã¿</button>
      </div>
    </div>
  </div>

  <div id="mainContent">
    <div class="header-area">
      <div class="logo-container">
          <img src="https://raw.githubusercontent.com/k9harmony-h/training_report/main/K9_logoFull.png" class="logo-img" alt="K9 Harmony Logo" onerror="this.style.display='none'">
      </div>
      
      <h1 class="brand-title">K9 Harmony</h1>
      
      <div class="profile-card">
        <div id="dogImgContainer"></div>
        <div class="profile-info">
          <div id="custBirthdayMsg" class="birthday-msg">ğŸ‰ Happy Birthday</div>
          <p id="custName" class="cust-name">Loading...</p>
          <div style="height: 5px;"></div>
          <div id="dogBirthdayMsg" class="birthday-msg">ğŸ‰ Happy Birthday</div>
          <h2 id="dogName" class="dog-name">---</h2>
          <div class="lesson-meta"><span id="lessonDate">Last: --/--/--</span></div>
          <a href="#" id="historyLinkBtn" class="history-link">History &gt;</a>
        </div>
      </div>

      <div class="mt-4">
        <div onclick="openMedicalPage()" class="card shadow-sm medical-btn-card">
            <div class="card-body py-3 d-flex align-items-center">
                <div class="rounded-circle d-flex align-items-center justify-content-center me-3" 
                     style="width: 48px; height: 48px; min-width: 48px; background-color: var(--c-bg-mist); color: var(--c-main-turquoise);">
                    <span style="font-size: 1.5rem;">â›‘ï¸</span>
                </div>
                
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0" style="font-size: 1rem; color: var(--c-text-sumi); font-family: var(--font-serif-jp);">åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</h6>
                    <small class="text-muted" style="font-size: 0.75rem; letter-spacing: 0.05em;">ç·Šæ€¥æ™‚ãƒ»ç½å®³æ™‚ã®èº«åˆ†è¨¼ã‚«ãƒ«ãƒ†</small>
                </div>
                
                <div style="color: var(--c-main-turquoise); font-size: 1.2rem;">
                    &gt;
                </div>
            </div>
        </div>
      </div>
      </div>

    <div class="chart-section">
      <div class="chart-box"><canvas id="chart1"></canvas><div class="chart-caption">åŸºç¤ãƒ»é›†ä¸­</div></div>
      <div class="chart-box"><canvas id="chart2"></canvas><div class="chart-caption">å¿œç”¨ãƒ»å¯¾å¿œ</div></div>
    </div>

    <div class="section-title">æœ¬æ—¥ã®ãƒ†ãƒ¼ãƒãƒ»ç›®æ¨™</div>
    <div class="feedback-box" id="goalText">---</div>
    <div class="section-title">ã§ããŸã“ã¨ (Done)</div>
    <div class="feedback-box" id="doneText">---</div>
    <div class="section-title">èª²é¡Œ (Unable)</div>
    <div class="feedback-box" id="unableText">---</div>
    
    <div class="section-title">å®¿é¡Œ (Homework)</div>
    <div class="homework-box">
      <div class="homework-badge">HOMEWORK</div>
      <div id="homeworkText">---</div>
    </div>

    <div class="section-title accent">æ¬¡å›ç›®æ¨™ (Next Goal)</div>
    <div class="next-goal-box" id="nextGoalText">---</div>
    
    <div class="section-title">è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
    <div class="detail-grid">
      <div class="detail-card"><div class="detail-head">é …ç›®1-5</div><div class="detail-body" id="detail1">---</div></div>
      <div class="detail-card"><div class="detail-head">é …ç›®6-10</div><div class="detail-body" id="detail2">---</div></div>
    </div>
    <div class="feedback-box mt-4" style="background:#fff; border:1px solid rgba(0,0,0,0.05);">
      <strong style="color:var(--c-sub-deep-ocean); font-family:var(--font-serif-jp);">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:</strong><br><span id="trainerComment">---</span>
    </div>

    <div class="section-title">æœ¬æ—¥ã®ã‚·ãƒ§ãƒƒãƒˆ</div>
    <div class="photo-scroll" id="photoArea"><div class="text-muted small ms-3" id="photoLoadingMsg">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</div></div>
    
    <div class="milestone-section">
        <div class="section-title" style="margin: 0 0 15px;">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ (K9 Harmony)</div>
        
        <div class="tier-container" id="milestone-container">
            <div class="tier-header" id="tier-header">Loading...</div>
            <div class="tier-badge-scroll" id="tier-scroll">
                </div>
        </div>

        <a class="ms-list-link" onclick="openAllMilestonesModal()">ç²å¾—ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¸€è¦§ã‚’è¦‹ã‚‹ &gt;</a>
    </div>

    <div class="footer-action">
      <button onclick="handleDownloadPdf()" class="btn-pdf" id="pdfBtn">
          ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆã‚’PDFã§ä¿å­˜
      </button>

      <button id="btnSwitchDog" class="dog-select-btn" style="display:none;" onclick="showDogSelectModal(globalDogList)">
          æ„›çŠ¬æƒ…å ±ã®åˆ‡æ›¿
      </button>

      <a href="#" class="btn-reserve">äºˆç´„ã™ã‚‹ / Reserve</a>
      <div id="reminderArea" class="reminder-box" style="display:none;">æ¬¡å›äºˆç´„ç›®å®‰: <span id="reminderDate">--/-- ã€œ --/--</span></div>
      <div class="text-muted small mt-2" style="font-family:var(--font-sans-en);">Ticket Balance: <span id="ticketCount" class="fw-bold" style="font-size:1.2rem; color:var(--c-main-turquoise);">-</span></div>
    </div>
  </div>

  <div class="modal fade" id="milestoneModal" tabindex="-1" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center pt-0">
            <div id="msModalIconBox">
            </div>
            <h4 class="fw-bold mt-3 mb-2" id="msModalTitle" style="color: var(--c-sub-deep-ocean); font-family:var(--font-serif-jp);">Title</h4>
            <p class="text-muted small mb-3" id="msModalDesc">Description</p>
            
            <div id="msModalTipsBox">
                <strong style="font-family:var(--font-serif-en); letter-spacing:0.05em;"><i class="fa-solid fa-lightbulb"></i> Practical Tips</strong><br>
                <span id="msModalTips">Tips text here</span>
            </div>
        </div>
        <div class="modal-footer justify-content-center border-0 pb-4">
            <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal" style="background:var(--c-text-gray); border:none;">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="allMilestonesModal" tabindex="-1" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title fw-bold" style="color:var(--c-sub-deep-ocean); font-family:var(--font-serif-jp);">ç²å¾—ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¸€è¦§</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="allMilestonesBody" style="background: var(--c-base-washi);">
        </div>
        <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="dogSelectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0"><h5 class="modal-title fw-bold w-100 text-center" style="color:var(--c-sub-deep-ocean); font-family:var(--font-serif-jp);">æ„›çŠ¬æƒ…å ±ã®åˆ‡æ›¿</h5></div>
        <div class="modal-body" id="dogSelectBody"></div>
      </div>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008546673-MJY7j3ox'; 
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';

    function log(msg) {
        /* console.log(msg); */
    }

    const dogTips = [
      "çŠ¬ã®é¼»ç´‹ã¯äººé–“ã®æŒ‡ç´‹ã¨åŒã˜ã§ã€ä¸€é ­ä¸€é ­é•ã„ã¾ã™ã€‚", "çŠ¬ã¯äººé–“ã®ç´„4å€ã®è´åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚", "çŠ¬ã®å—…è¦šã¯äººé–“ã®100ä¸‡å€ã€œ1å„„å€ã¨ã‚‚è¨€ã‚ã‚Œã¾ã™ã€‚", "çŠ¬ã¯æ±—ã‚’è‚‰çƒã‹ã‚‰ã—ã‹ã‹ã‘ã¾ã›ã‚“ã€‚", "çŠ¬ãŒã‚ãã³ã‚’ã™ã‚‹ã®ã¯ã€ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã¦è½ã¡ç€ã“ã†ã¨ã—ã¦ã„ã‚‹æ™‚ã‚‚ã‚ã‚Šã¾ã™ã€‚", "çŠ¬ã®ã—ã£ã½ã®æŒ¯ã‚Šæ–¹ã¯ã€å³å¯„ã‚Šã ã¨ã€Œå¬‰ã—ã„ã€ã€å·¦å¯„ã‚Šã ã¨ã€Œä¸å®‰ã€ãªæ™‚ãŒã‚ã‚Šã¾ã™ã€‚", "å°å‹çŠ¬ã®æ–¹ãŒå¤§å‹çŠ¬ã‚ˆã‚Šã‚‚é•·ç”Ÿãã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚", "çŠ¬ã¯å¤¢ã‚’è¦‹ã¾ã™ã€‚å¯è¨€ã‚’è¨€ã£ãŸã‚Šè¶³ã‚’å‹•ã‹ã™ã®ã¯ãã®è¨¼æ‹ ã§ã™ã€‚", "ãƒ€ãƒ«ãƒ¡ã‚·ã‚¢ãƒ³ã¯ç”Ÿã¾ã‚ŒãŸæ™‚ã¯çœŸã£ç™½ã§ã€å¾Œã‹ã‚‰æ–‘ç‚¹ãŒå‡ºã¦ãã¾ã™ã€‚", "çŠ¬ãŒé£¼ã„ä¸»ã®é¡”ã‚’èˆã‚ã‚‹ã®ã¯ã€æ„›æƒ…è¡¨ç¾ã‚„ã”é£¯ã®å‚¬ä¿ƒã§ã™ã€‚"
    ];

    const TIER_CONFIG = {
        '1_Beginner': { code: 'TRUST', name: 'TRUST (åˆç´š)', colorClass: 'bg-trust', count: 8 },
        '2_Intermediate': { code: 'BOND', name: 'BOND (ä¸­ç´š)', colorClass: 'bg-bond', count: 8 },
        '3_Advanced': { code: 'HARMONY', name: 'HARMONY (ä¸Šç´š)', colorClass: 'bg-harmony', count: 6 }
    };

    let tipsTimer;
    let currentUserId = null;
    let currentDogId = null;
    let chartInstance1 = null; 
    let chartInstance2 = null;
    let currentLessonData = null;
    let milestoneModal = null;
    let allMilestonesModal = null;
    let cachedMilestones = [];
    let cachedMeta = {};
    let globalDogList = []; 

    function startCelebrationSequence(badge) {
        const overlay = document.getElementById('celebrationOverlay');
        const badgeCont = document.getElementById('celebBadgeContainer');
        const starsCont = document.getElementById('celebStars');
        const lightCore = document.getElementById('celebLightCore');
        const lightRing = document.getElementById('celebLightRing');
        const lightOval = document.getElementById('celebLightOval');
        
        lightCore.className = ''; lightRing.className = ''; lightOval.className = ''; badgeCont.className = '';
        
        let iconHtml = '<i class="fa-solid fa-paw"></i>';
        if (badge && badge.icon) {
             const fileId = extractFileId(badge.icon);
             if(fileId) {
                 const thumbUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w200`;
                 iconHtml = `<img src="${thumbUrl}" onerror="this.style.display='none';this.parentElement.innerHTML='<i class=\\'fa-solid fa-paw\\'></i>'">`;
             }
        }
        
        const title = badge ? badge.title : 'Congratulations!';
        const tierClass = badge ? (TIER_CONFIG[badge.tier]?.colorClass || 'bg-trust') : 'bg-trust';
        const randomBorderRadius = getRandomWaxBorder();

        badgeCont.innerHTML = `
            <div class="celeb-badge-inner ${tierClass}" style="border-radius: ${randomBorderRadius};">
                ${iconHtml}
            </div>
            <div style="position:absolute; bottom:-50px; width:250px; text-align:center; color:white; font-weight:bold; font-size:1.4rem; text-shadow:0 0 10px gold; font-family:'Noto Serif JP', serif;">
                ${title} ç²å¾—!
            </div>
        `;
        
        starsCont.innerHTML = '';
        for(let i=0; i<30; i++) {
            const s = document.createElement('div');
            s.className = 'twinkling-star';
            const size = Math.random() * 3 + 1;
            s.style.width = size + 'px'; s.style.height = size + 'px';
            s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 80 + '%';
            s.style.animationDelay = (Math.random() * 2) + 's';
            starsCont.appendChild(s);
        }

        overlay.style.display = 'block';
        
        setTimeout(() => {
            overlay.classList.add('active'); 
            setTimeout(() => { lightCore.classList.add('anim-light'); lightRing.classList.add('anim-ring'); lightOval.classList.add('anim-oval'); }, 1000);
            setTimeout(() => { triggerFairyDust(); }, 1200);
            setTimeout(() => { badgeCont.classList.add('anim-badge-appear'); }, 1500);
            setTimeout(() => { launchCelebrationFireworks(); }, 2000);
        }, 50);
    }
    
    function closeCelebration() {
        const overlay = document.getElementById('celebrationOverlay');
        overlay.classList.remove('active');
        document.getElementById('celebLightCore').classList.remove('anim-light');
        document.getElementById('celebLightRing').classList.remove('anim-ring');
        document.getElementById('celebLightOval').classList.remove('anim-oval'); 
        document.getElementById('celebBadgeContainer').classList.remove('anim-badge-appear');
        setTimeout(() => { overlay.style.display = 'none'; }, 500);
    }

    function triggerFairyDust() {
        const canvas = document.getElementById('fairyDustCanvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.style.display = 'block';
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        let startTime = null;
        const duration = 5000;
        const particles = [];
        const w = canvas.width; const h = canvas.height; const padding = 50;
        const startSides = ['top', 'bottom', 'left', 'right'];
        const side = startSides[Math.floor(Math.random()*4)];
        let currentPos = { x: w/2, y: h/2 }; 
        if(side==='top') currentPos = {x: Math.random()*w, y: -50};
        else if(side==='bottom') currentPos = {x: Math.random()*w, y: h+50};
        else if(side==='left') currentPos = {x: -50, y: Math.random()*h};
        else currentPos = {x: w+50, y: Math.random()*h};
        
        let targetPos = getRandomSafePoint();
        let velocity = { x: 0, y: 0 };
        const speed = 8;
        
        function getRandomSafePoint() {
            return { x: padding + Math.random() * (w - padding*2), y: padding + Math.random() * (h - padding*2) };
        }
        
        const loop = (timestamp) => {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            ctx.clearRect(0, 0, w, h);
            
            if (elapsed < duration) {
                const dx = targetPos.x - currentPos.x; const dy = targetPos.y - currentPos.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 20) { targetPos = getRandomSafePoint(); } 
                else { velocity.x = (dx / dist) * speed; velocity.y = (dy / dist) * speed; currentPos.x += velocity.x; currentPos.y += velocity.y; }
            } else {
                if (elapsed < duration + 100) { 
                     const exits = [{x:w/2, y:-100}, {x:w/2, y:h+100}, {x:-100, y:h/2}, {x:w+100, y:h/2}];
                     targetPos = exits[Math.floor(Math.random()*4)];
                }
                const dx = targetPos.x - currentPos.x; const dy = targetPos.y - currentPos.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > 10) { velocity.x = (dx / dist) * speed * 1.5; velocity.y = (dy / dist) * speed * 1.5; currentPos.x += velocity.x; currentPos.y += velocity.y; }
            }
            
            if (elapsed < duration + 1000) {
                for(let i=0; i<6; i++) { 
                    particles.push({ x: currentPos.x + (Math.random()-0.5)*10, y: currentPos.y + (Math.random()-0.5)*10, vx: (Math.random()-0.5)*1, vy: Math.random()*0.5 + 0.2, life: 1.0, color: Math.random() > 0.3 ? '#FFD700' : '#FFFFFF', size: Math.random()*0.8 + 0.2 });
                }
                const tVal = elapsed * 0.005; const swirlR = 60 + Math.sin(tVal * 5) * 30;
                const sx1 = currentPos.x + Math.cos(tVal * 10) * swirlR; const sy1 = currentPos.y + Math.sin(tVal * 10) * swirlR;
                const sx2 = currentPos.x + Math.cos(tVal * 10 + Math.PI) * swirlR; const sy2 = currentPos.y + Math.sin(tVal * 10 + Math.PI) * swirlR;
                for(let i=0; i<3; i++) {
                    particles.push({ x: sx1 + (Math.random()-0.5)*5, y: sy1 + (Math.random()-0.5)*5, vx: (Math.random()-0.5)*0.5, vy: Math.random()*0.3, life: 0.8, color: '#A8D8B9', size: Math.random()*0.5+0.1 });
                    particles.push({ x: sx2 + (Math.random()-0.5)*5, y: sy2 + (Math.random()-0.5)*5, vx: (Math.random()-0.5)*0.5, vy: Math.random()*0.3, life: 0.8, color: '#87CEEB', size: Math.random()*0.5+0.1 });
                }
            }

            for(let i=0; i<particles.length; i++) {
                const p = particles[i]; ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                p.x += p.vx; p.y += p.vy; p.life -= 0.005; 
            }
            
            let aliveParticles = false;
            for(let i=particles.length-1; i>=0; i--) { if(particles[i].life <= 0) particles.splice(i, 1); else aliveParticles = true; }
            
            if (elapsed < duration + 3000 || aliveParticles) { requestAnimationFrame(loop); } else { canvas.style.display = 'none'; }
        };
        requestAnimationFrame(loop);
    }

    class Firework {
        constructor(ctx, w, h) {
            this.ctx = ctx; this.w = w; this.h = h;
            this.x = Math.random() * w; this.y = h;
            this.targetY = h * 0.2 + Math.random() * (h * 0.4);
            this.speed = 8 + Math.random() * 4;
            this.angle = -Math.PI / 2 + (Math.random() - 0.5) * 0.5;
            this.vx = Math.cos(this.angle) * this.speed; this.vy = Math.sin(this.angle) * this.speed;
            this.particles = []; this.exploded = false; this.dead = false;
        }
        update() {
            if (!this.exploded) { this.x += this.vx; this.y += this.vy; this.vy += 0.1; if (this.vy >= 0 || this.y <= this.targetY) this.explode(); } 
            else { this.particles.forEach(p => p.update()); this.particles = this.particles.filter(p => p.alpha > 0); if (this.particles.length === 0) this.dead = true; }
        }
        draw() {
            if (!this.exploded) { this.ctx.fillStyle = '#fff'; this.ctx.beginPath(); this.ctx.arc(this.x, this.y, 3, 0, Math.PI*2); this.ctx.fill(); } 
            else { this.particles.forEach(p => p.draw(this.ctx)); }
        }
        explode() {
            this.exploded = true;
            const colors = ['#FFD700', '#F7E7CE', '#C0C0C0', '#FFFFFF', '#FFC1C1', '#BBDEFB']; 
            for(let i=0; i<60; i++) { this.particles.push(new Particle(this.x, this.y, colors[Math.floor(Math.random()*colors.length)])); }
        }
    }
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 4 + 1;
            this.vx = Math.cos(this.angle) * this.speed; this.vy = Math.sin(this.angle) * this.speed; this.alpha = 1; this.decay = Math.random() * 0.02 + 0.01;
        }
        update() { this.x += this.vx; this.y += this.vy; this.vy += 0.05; this.alpha -= this.decay; }
        draw(ctx) { ctx.save(); ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill(); ctx.restore(); }
    }

    function launchCelebrationFireworks() {
        const canvas = document.getElementById('celebFireworksCanvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let fireworks = []; let launchCount = 0; const totalLaunches = 9;
        try { navigator.vibrate([100, 50, 100]); } catch(e){}
        const loop = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (launchCount < totalLaunches && Math.random() < 0.05) { fireworks.push(new Firework(ctx, canvas.width, canvas.height)); launchCount++; }
            fireworks.forEach(f => f.update()); fireworks.forEach(f => f.draw()); fireworks = fireworks.filter(f => !f.dead);
            if (launchCount >= totalLaunches && fireworks.length === 0) { /* finish */ } else { requestAnimationFrame(loop); }
        };
        loop();
    }

    function startTipsSlider() {
      const tipsText = document.getElementById('tipsText');
      if(!tipsText) return;
      let currentTipIndex = Math.floor(Math.random() * dogTips.length);
      tipsText.innerText = dogTips[currentTipIndex];
      tipsTimer = setInterval(() => {
        currentTipIndex = (currentTipIndex + 1) % dogTips.length;
        tipsText.innerText = dogTips[currentTipIndex];
      }, 2500); 
    }

    function finishLoading() {
      clearInterval(tipsTimer);
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) { overlay.style.visibility = ''; overlay.style.opacity = ''; }
      document.body.classList.add('loaded');
      mediumZoom('.zoomable', { margin: 24, background: 'rgba(0,0,0,0.8)' });
    }

    window.onload = function() {
      startTipsSlider();
      if (typeof liff === 'undefined') { showError('SDK Error', 'LIFF SDK not loaded.'); return; }
      main();
    };

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        log(`User: ${currentUserId}`);
        
        milestoneModal = new bootstrap.Modal(document.getElementById('milestoneModal'));
        allMilestonesModal = new bootstrap.Modal(document.getElementById('allMilestonesModal'));

        const urlParams = new URLSearchParams(window.location.search);
        const urlDogId = urlParams.get('dogId');
        
        fetchTextData(currentUserId, urlDogId);

      } catch (err) {
        log('Init Error: ' + err.message);
        showError('LIFF Init Error', err.message);
      }
    }

    function fetchTextData(userId, dogId = null) {
      let url = `${GAS_URL}?userId=${userId}&t=${new Date().getTime()}`;
      if (dogId) url += `&dogId=${dogId}`;

      log('Fetching main data...');
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.multiple_dogs) {
              showDogSelectModal(data.multiple_dogs);
              return;
          }
          if (data.error) {
              log('API Error: ' + data.error);
              if (data.error === 'Unregistered') {
                  showError('æœªç™»éŒ²ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™', 'IDã‚’ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã«ãŠä¼ãˆãã ã•ã„', userId);
              } else {
                  showError('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼', data.error);
              }
              return;
          }

          try {
              currentLessonData = data;
              renderTextData(data);
              
              currentDogId = data.dog.id || null;
              updateHistoryLink();
              log(`DogID: ${currentDogId}`);

              fetchProfileImage(userId, currentDogId);
              if (data.latest && data.latest.has_photos) {
                  fetchLessonImages(userId, currentDogId);
              } else {
                  document.getElementById('photoArea').innerHTML = '<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>';
              }

              if (currentDogId) {
                  fetchMilestones(userId, currentDogId);
              }
              
              if (data.all_dogs && data.all_dogs.length > 1) {
                  globalDogList = data.all_dogs;
                  document.getElementById('btnSwitchDog').style.display = 'block';
              } else {
                  document.getElementById('btnSwitchDog').style.display = 'none';
              }

          } catch (e) {
              console.error(e);
              log('Render Error: ' + e.message);
              showError('æç”»ã‚¨ãƒ©ãƒ¼', 'ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
          }
        })
        .catch(err => {
          log('Network Error: ' + err.message);
          showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼', err.message);
        });
    }

    // --- Milestone Functions ---

    function fetchMilestones(userId, dogId) {
        log('Fetching Milestones...');
        let url = `${GAS_URL}?userId=${userId}&dogId=${dogId}&type=milestone`;
        
        fetch(url)
            .then(res => res.json())
            .then(data => {
                log(`MS Response: ${JSON.stringify(data).substring(0,50)}...`);
                if (data.error) {
                    log('MS Backend Error: ' + data.error);
                    document.getElementById('tier-header').innerText = 'æº–å‚™ä¸­';
                    document.getElementById('tier-scroll').innerHTML = '<div class="text-center w-100 small" style="flex:1;">ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼</div>';
                    return;
                }
                
                if (data.status === 'success' && data.badges) {
                    cachedMilestones = data.badges;
                    cachedMeta = data.meta;
                    renderMilestones(data);
                } else {
                    log('MS Failed or Empty');
                    document.getElementById('tier-header').innerText = 'æº–å‚™ä¸­';
                    document.getElementById('tier-scroll').innerHTML = '<div class="text-center w-100 small" style="flex:1;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                }
            })
            .catch(e => {
                log('MS Fetch Error: ' + e.message);
                document.getElementById('tier-header').innerText = 'ã‚¨ãƒ©ãƒ¼';
                document.getElementById('tier-scroll').innerHTML = '<div class="text-center w-100 small" style="flex:1;">èª­è¾¼ã‚¨ãƒ©ãƒ¼</div>';
            });
    }

    function renderMilestones(data) {
        const badges = data.badges;
        const container = document.getElementById('tier-scroll');
        const header = document.getElementById('tier-header');
        
        container.innerHTML = '';

        let counts = { '1_Beginner': 0, '2_Intermediate': 0, '3_Advanced': 0 };
        badges.forEach(b => {
            if (b.is_acquired && counts[b.tier] !== undefined) counts[b.tier]++;
        });

        let currentTierKey = '1_Beginner';
        let prevTierKey = null;

        if (counts['1_Beginner'] < TIER_CONFIG['1_Beginner'].count) {
            currentTierKey = '1_Beginner';
        } else if (counts['2_Intermediate'] < TIER_CONFIG['2_Intermediate'].count) {
            currentTierKey = '2_Intermediate';
            prevTierKey = '1_Beginner';
        } else {
            currentTierKey = '3_Advanced';
            prevTierKey = '2_Intermediate';
        }

        const tierInfo = TIER_CONFIG[currentTierKey];
        const tierColor = getTierColor(currentTierKey);
        header.innerHTML = `<span style="color:#555;">ç¾åœ¨æŒ‘æˆ¦ä¸­:</span> <span class="${tierColor.textClass}">${tierInfo.name}</span>`;

        const acquiredAll = badges.filter(b => b.is_acquired);
        const unacquiredCurrent = badges.filter(b => !b.is_acquired && b.tier === currentTierKey);
        
        let teaserBadges = [];
        const nextTierKey = getNextTier(currentTierKey);
        
        if (counts[currentTierKey] >= 6 && nextTierKey) {
            teaserBadges = badges.filter(b => !b.is_acquired && b.tier === nextTierKey).slice(0, 4);
        }

        let displayList = [...acquiredAll, ...unacquiredCurrent, ...teaserBadges];
        
        let hasNewBadge = false;
        displayList.forEach(badge => {
            const isTeaser = teaserBadges.includes(badge);
            const html = createBadgeHtml(badge, isTeaser);
            container.insertAdjacentHTML('beforeend', html);
            if (badge.is_new) hasNewBadge = true;
        });

        if (displayList.length === 0) container.innerHTML = '<div class="text-center w-100 small" style="flex:1;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
        
        if (hasNewBadge) setupMilestoneObserver();

        log('Milestones Rendered: ' + currentTierKey);
    }

    function createBadgeHtml(badge, isTeaser = false) {
        const isLocked = !badge.is_acquired && !isTeaser;
        const lockedClass = isLocked ? 'locked' : '';
        const teaserClass = isTeaser ? 'teaser' : '';
        
        let colorClass = 'bg-trust';
        if (!isLocked && !isTeaser) {
            if (badge.color) {
                colorClass = `bg-${badge.color}`;
            } else {
                const tierConfig = TIER_CONFIG[badge.tier];
                if(tierConfig) colorClass = tierConfig.colorClass;
            }
        }
        
        const randomBorderRadius = getRandomWaxBorder();
        const randomRot = (Math.random() * 20 - 10) + 'deg';

        let newClass = badge.is_new ? 'ms-badge-new' : '';
        
        let iconHtml = '<i class="fa-solid fa-paw"></i>';
        if (isLocked) {
            iconHtml = '<i class="fa-solid fa-lock tier-lock-icon-small"></i>';
        } else if (badge.icon) {
             const fileId = extractFileId(badge.icon);
             const thumbUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w200`;
             iconHtml = `<img src="${thumbUrl}" onerror="this.style.display='none';this.parentElement.innerHTML='<i class=\\'fa-solid fa-paw\\'></i>'">`;
        }

        const clickAction = isLocked ? 'triggerShake(this)' : (isTeaser ? '' : `showMilestoneDetail('${badge.id}')`);

        return `
            <div class="ms-badge ${lockedClass} ${teaserClass} ${newClass}" data-id="${badge.id}" onclick="${clickAction}">
                <div class="ms-icon-box ${colorClass}" style="border-radius:${randomBorderRadius}; transform: rotate(${randomRot});">
                    ${iconHtml}
                </div>
                <div class="ms-label">${badge.title}</div>
            </div>
        `;
    }
    
    function triggerShake(el) {
        if(el.classList.contains('anim-shake')) return; 
        el.classList.add('anim-shake');
        setTimeout(() => {
            el.classList.remove('anim-shake');
        }, 400); 
    }

    function getRandomWaxBorder() {
        const r = () => Math.floor(Math.random() * (60 - 40) + 40) + "%";
        return `${r()} ${r()} ${r()} ${r()}`; 
    }

    function getTierColor(tierKey) {
        if(tierKey === '1_Beginner') return { bgClass: 'bg-trust', textClass: 'text-success' };
        if(tierKey === '2_Intermediate') return { bgClass: 'bg-bond', textClass: 'text-secondary' };
        if(tierKey === '3_Advanced') return { bgClass: 'bg-harmony', textClass: 'text-warning' };
        return { bgClass: 'bg-trust', textClass: 'text-dark' };
    }

    function getNextTier(currentKey) {
        if (currentKey === '1_Beginner') return '2_Intermediate';
        if (currentKey === '2_Intermediate') return '3_Advanced';
        return null;
    }
    
    function setupMilestoneObserver() {
        const options = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const el = entry.target;
                    const badgeId = el.getAttribute('data-id');
                    const badgeData = cachedMilestones.find(b => b.id === badgeId);

                    if (badgeData) {
                        log('Observer Triggered for: ' + badgeData.title);
                        startCelebrationSequence(badgeData);
                        markAsSeen(badgeId);
                        observer.unobserve(el);
                        el.classList.remove('ms-badge-new');
                    }
                }
            });
        }, options);

        document.querySelectorAll('.ms-badge-new').forEach(el => {
            observer.observe(el);
        });
    }

    function openAllMilestonesModal() {
        const modalBody = document.getElementById('allMilestonesBody');
        modalBody.innerHTML = '';
        
        const allAcquired = cachedMilestones.filter(b => b.is_acquired);
        if (allAcquired.length > 0) {
            let html = '';
            allAcquired.forEach(b => html += createBadgeHtml(b).replace('ms-badge-new',''));
            modalBody.insertAdjacentHTML('beforeend', `
                <div class="full-list-section">
                    <div class="full-list-title">ç²å¾—æ¸ˆã¿ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</div>
                    <div class="full-list-grid">${html}</div>
                </div>
            `);
        }

        let counts = { '1_Beginner': 0, '2_Intermediate': 0, '3_Advanced': 0 };
        cachedMilestones.forEach(b => { if(b.is_acquired) counts[b.tier]++; });

        const renderUnacquiredSection = (tierKey, title, isUnlocked, isTeaser) => {
            let tierBadges = cachedMilestones.filter(b => b.tier === tierKey && !b.is_acquired);
            if (tierBadges.length === 0 && isUnlocked) return;

            if (isUnlocked) {
                let html = '';
                tierBadges.forEach(b => html += createBadgeHtml(b).replace('ms-badge-new',''));
                modalBody.insertAdjacentHTML('beforeend', `
                    <div class="full-list-section">
                        <div class="full-list-title">${title}</div>
                        <div class="full-list-grid">${html}</div>
                    </div>
                `);
            } else if (isTeaser) {
                let html = '';
                tierBadges.slice(0, 4).forEach(b => html += createBadgeHtml(b, true).replace('ms-badge-new',''));
                modalBody.insertAdjacentHTML('beforeend', `
                    <div class="full-list-section">
                        <div class="full-list-title">${title}</div>
                        <div class="full-list-grid">${html}</div>
                    </div>
                `);
            } else {
                modalBody.insertAdjacentHTML('beforeend', createLockHtml('Coming Soon'));
            }
        };

        renderUnacquiredSection('1_Beginner', 'æœªç²å¾—: TRUST', true, false);

        const bondUnlocked = counts['1_Beginner'] >= 8;
        const bondTeaser = counts['1_Beginner'] >= 6;
        renderUnacquiredSection('2_Intermediate', 'æœªç²å¾—: BOND', bondUnlocked, bondTeaser);

        const harmonyUnlocked = counts['2_Intermediate'] >= 8;
        const harmonyTeaser = counts['2_Intermediate'] >= 6;
        if (bondUnlocked || bondTeaser) {
             renderUnacquiredSection('3_Advanced', 'æœªç²å¾—: HARMONY', harmonyUnlocked, harmonyTeaser);
        }
        
        allMilestonesModal.show();
    }
    
    function createLockHtml(text) {
        return `
            <div class="tier-locked" onclick="shakeLockIcon(this)">
                <div class="tier-lock-overlay">
                    <div class="tier-lock-icon"><i class="fa-solid fa-lock"></i></div>
                    <div class="tier-lock-text">${text}</div>
                </div>
            </div>
        `;
    }

    function shakeLockIcon(el) {
        const icon = el.querySelector('.tier-lock-icon');
        if(icon) {
            icon.style.animation = 'none';
            icon.offsetHeight;
            icon.style.animation = 'shake-refuse 0.4s ease-in-out';
        }
    }

    function markAsSeen(badgeId) {
        if(!currentUserId || !currentDogId) return;
        const payload = {
            action: 'markMilestoneSeen',
            dogId: currentDogId,
            milestoneId: badgeId
        };
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        }).then(r=>r.json()).then(d=>log('Marked seen: '+badgeId)).catch(e=>log('MarkErr:'+e));
    }

    function showMilestoneDetail(badgeId) {
        const badge = cachedMilestones.find(b => b.id === badgeId);
        if (!badge) return;

        const isLocked = !badge.is_acquired;
        const iconBox = document.getElementById('msModalIconBox');
        
        iconBox.className = '';
        if (isLocked) {
            iconBox.classList.add('bg-secondary');
        } else {
            let colorClass = 'bg-trust';
            if (badge.color) {
                colorClass = `bg-${badge.color}`;
            } else {
                const tierConfig = TIER_CONFIG[badge.tier];
                if(tierConfig) colorClass = tierConfig.colorClass;
            }
            iconBox.classList.add(colorClass);
        }
        iconBox.style.borderRadius = getRandomWaxBorder();
        
        iconBox.innerHTML = badge.icon 
            ? `<img src="https://drive.google.com/thumbnail?id=${extractFileId(badge.icon)}&sz=w200" style="width:60%;height:60%;object-fit:contain;">`
            : `<i class="fa-solid fa-paw"></i>`;
        
        const img = iconBox.querySelector('img');
        if(img) {
            img.onerror = function() {
                this.style.display='none';
                iconBox.innerHTML = '<i class="fa-solid fa-paw"></i>';
            };
        }

        document.getElementById('msModalTitle').innerText = badge.title + (isLocked ? ' (æœªç²å¾—)' : '');
        document.getElementById('msModalDesc').innerText = badge.desc;
        document.getElementById('msModalTips').innerText = badge.tips || '---';

        milestoneModal.show();
    }
    
    function extractFileId(urlOrPath) {
        if (!urlOrPath) return '';
        const match = urlOrPath.match(/id=([-\w]{25,})/) || urlOrPath.match(/\/d\/([-\w]{25,})/);
        return match ? match[1] : ''; 
    }

    function showDogSelectModal(dogs) {
        const body = document.getElementById('dogSelectBody');
        body.innerHTML = '';
        dogs.forEach(dog => {
            const btn = document.createElement('button');
            btn.className = 'dog-select-btn';
            btn.innerText = dog.name_disp; 
            btn.onclick = () => selectDog(dog.id);
            body.appendChild(btn);
        });
        
        document.getElementById('loadingOverlay').style.opacity = 0;
        setTimeout(() => { document.getElementById('loadingOverlay').style.visibility = 'hidden'; }, 500);
        
        new bootstrap.Modal(document.getElementById('dogSelectModal')).show();
    }

    function selectDog(dogId) {
        const modalEl = document.getElementById('dogSelectModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
        
        document.getElementById('loadingOverlay').style.visibility = 'visible';
        document.getElementById('loadingOverlay').style.opacity = 1;
        
        currentDogId = dogId;
        fetchTextData(currentUserId, dogId);
    }

    function updateHistoryLink() {
        const link = document.getElementById('historyLinkBtn');
        if (currentDogId) {
            link.href = `history.html?dogId=${currentDogId}`;
        } else {
            link.href = `history.html`;
        }
    }

    function openMedicalPage() {
        let url = 'medical.html';
        if (currentDogId) {
            url += `?dogId=${currentDogId}`;
        }
        window.location.href = url;
    }

    function handleDownloadPdf() {
        if (!currentLessonData || !currentLessonData.latest) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }

        const btn = document.getElementById('pdfBtn');
        const originalText = btn.innerText;
        btn.innerText = "ä½œæˆä¸­...";
        btn.disabled = true;

        const formData = {
            training_unique_key: currentLessonData.latest.id || '', 
            dog_name: currentLessonData.dog.name,
            training_date: currentLessonData.latest.date,
            customer_unique_key: currentLessonData.customer.id,
            dog_unique_key: currentLessonData.dog.id,
            
            goal: currentLessonData.latest.goal,
            done: currentLessonData.latest.done,
            unable: currentLessonData.latest.unable,
            next_homework: currentLessonData.latest.homework, 
            next_goal: currentLessonData.latest.next_goal,
            comment_trainer: currentLessonData.latest.comment,
            training_remarks: '', 

            score_1: currentLessonData.latest.scores[0], score_detail_1: currentLessonData.latest.details[0],
            score_2: currentLessonData.latest.scores[1], score_detail_2: currentLessonData.latest.details[1],
            score_3: currentLessonData.latest.scores[2], score_detail_3: currentLessonData.latest.details[2],
            score_4: currentLessonData.latest.scores[3], score_detail_4: currentLessonData.latest.details[3],
            score_5: currentLessonData.latest.scores[4], score_detail_5: currentLessonData.latest.details[4],
            score_6: currentLessonData.latest.scores[5], score_detail_6: currentLessonData.latest.details[5],
            score_7: currentLessonData.latest.scores[6], score_detail_7: currentLessonData.latest.details[6],
            score_8: currentLessonData.latest.scores[7], score_detail_8: currentLessonData.latest.details[7],
            score_9: currentLessonData.latest.scores[8], score_detail_9: currentLessonData.latest.details[8],
            score_10: currentLessonData.latest.scores[9], score_detail_10: currentLessonData.latest.details[9],
            
            training_photo_1: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[0] : '',
            training_photo_2: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[1] : '',
            training_photo_3: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[2] : '',
            training_photo_4: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[3] : '',
            training_photo_5: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[4] : ''
        };

        if (typeof google === 'undefined' || !google.script) {
            alert('ã“ã®æ©Ÿèƒ½ã¯GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªä¸Šã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚');
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }

        google.script.run
            .withSuccessHandler(function(response) {
                btn.innerText = originalText;
                btn.disabled = false;

                if (response.status === 'success') {
                    const isIos = /iP(ad|hone|od)/.test(navigator.userAgent);
                    if (isIos) {
                        window.open(response.url, '_blank');
                    } else {
                        const a = document.createElement('a');
                        a.href = response.url;
                        a.download = `LessonReport_${formData.training_date}.pdf`; 
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                    alert(response.message);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + response.message);
                }
            })
            .withFailureHandler(function(e) {
                btn.innerText = originalText;
                btn.disabled = false;
                alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + e);
            })
            .createPdfFromSlide(formData);
    }

    function fetchProfileImage(userId, dogId) {
      let url = `${GAS_URL}?userId=${userId}&type=img_profile`;
      if(dogId) url += `&dogId=${dogId}`;
      
      fetch(url)
        .then(res => res.json())
        .then(data => {
           const container = document.getElementById('dogImgContainer');
           if(data.image) {
               container.innerHTML = `<img src="${data.image}" class="dog-img" alt="Dog Photo">`;
           } else {
               container.innerHTML = 'No Image';
           }
        })
        .catch(e => console.log('Profile Image Error', e));
    }

    function fetchLessonImages(userId, dogId) {
      let url = `${GAS_URL}?userId=${userId}&type=img_latest`;
      if(dogId) url += `&dogId=${dogId}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
           const pArea = document.getElementById('photoArea');
           pArea.innerHTML = ''; 
           if (data.images && data.images.length > 0) {
             data.images.forEach(b64 => {
               const img = document.createElement('img');
               img.src = b64; img.className = 'photo-item zoomable'; pArea.appendChild(img);
             });
             mediumZoom('.zoomable', { margin: 24, background: 'rgba(0,0,0,0.8)' });
           } else {
             pArea.innerHTML = '<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>';
           }
        })
        .catch(e => console.log('Lesson Image Error', e));
    }

    function renderTextData(data) {
      const c = data.customer || {};
      const d = data.dog || {};
      document.getElementById('custName').innerText = c.name + ' æ§˜';
      document.getElementById('dogName').innerText = d.name_disp || d.name || 'Your Dog';
      document.getElementById('ticketCount').innerText = data.ticket_count;

      checkBirthday(c.birth_date, 'custBirthdayMsg'); 
      checkBirthday(d.birth_date, 'dogBirthdayMsg'); 

      const l = data.latest;
      if (l) {
        document.getElementById('lessonDate').innerText = 'Last: ' + l.date;
        document.getElementById('goalText').innerText = l.goal;
        document.getElementById('doneText').innerText = l.done;
        document.getElementById('unableText').innerText = l.unable;
        document.getElementById('homeworkText').innerText = l.homework;
        document.getElementById('trainerComment').innerText = l.comment;
        document.getElementById('nextGoalText').innerText = l.next_goal || 'ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã¨ç›¸è«‡ã—ã¾ã—ã‚‡ã†';

        if (l.recommend_date) {
            document.getElementById('reminderDate').innerText = l.recommend_date;
            document.getElementById('reminderArea').style.display = 'block';
        } else {
            document.getElementById('reminderArea').style.display = 'none';
        }

        let d1 = '', d2 = '';
        for(let i=0; i<5; i++) { d1 += `[${i+1}] ${l.details[i] || 'ãªã—'}\n`; }
        for(let i=5; i<10; i++) { d2 += `[${i+1}] ${l.details[i] || 'ãªã—'}\n`; }
        document.getElementById('detail1').innerText = d1 || 'ç‰¹ã«ãªã—';
        document.getElementById('detail2').innerText = d2 || 'ç‰¹ã«ãªã—';

        if (chartInstance1) chartInstance1.destroy();
        if (chartInstance2) chartInstance2.destroy();

        if (l.scores) {
            /* [UPDATE] Charts with Brand Colors */
            chartInstance1 = renderChart('chart1', l.scores.slice(0, 5), ['æŒ‡ç¤ºç†è§£','é›†ä¸­åŠ›','å ±é…¬','ãƒœãƒ‡ã‚£','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ'], 'rgba(87, 195, 194, 0.2)', '#57C3C2'); // Turquoise
            chartInstance2 = renderChart('chart2', l.scores.slice(5, 10), ['æŒ‡ç¤ºå‡ºã—','å¯¾å¿œåŠ›','ãƒªãƒ¼ãƒ‰','ãƒœãƒ‡ã‚£','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ'], 'rgba(47, 93, 98, 0.1)', '#2F5D62'); // Deep Ocean
        }
      } else {
          document.getElementById('lessonDate').innerText = 'ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´ãªã—';
      }
      
      finishLoading();
    }

    function checkBirthday(dateStr, elementId) {
        if (!dateStr) return;
        const today = new Date(); const bDate = new Date(dateStr); bDate.setFullYear(today.getFullYear());
        const diffTime = bDate.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (Math.abs(diffDays) <= 14 || Math.abs(diffDays - 365) <= 14 || Math.abs(diffDays + 365) <= 14) {
            document.getElementById(elementId).style.display = 'block';
        }
    }

    function renderChart(id, data, labels, bgColor, borderColor) {
      const ctx = document.getElementById(id);
      return new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: bgColor, borderColor: borderColor, pointBackgroundColor: borderColor, borderWidth: 2
          }]
        },
        options: {
          scales: { r: { min: 0, max: 5, ticks: { display: false }, pointLabels: { font: { size: 11, family: "'Noto Sans JP', sans-serif" } } } },
          plugins: { legend: { display: false } }
        }
      });
    }

    function showError(title, msg, userId) {
        finishLoading();
        document.getElementById('mainContent').style.display = 'none';
        
        const errDiv = document.getElementById('errorView');
        errDiv.style.display = 'block';
        document.getElementById('errorTitle').innerText = title;
        document.getElementById('errorMessage').innerText = msg;
        
        if (userId) {
            const idBox = document.getElementById('dispLineId');
            idBox.innerText = userId;
            idBox.style.display = 'block';
        }
    }
    
    function copyLineId() {
        const idText = document.getElementById('dispLineId').innerText;
        navigator.clipboard.writeText(idText).then(() => alert('IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
    }
  </script>
</body>
</html>
