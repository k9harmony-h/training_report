<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Debug v0003</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    #version { position: fixed; top: 0; right: 0; background: green; color: white; padding: 5px; font-weight: bold; }
    
    .section { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h3 { margin-top: 0; color: #57C3C2; }
    
    .profile-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #57C3C2; display: block; margin: 0 auto; }
    
    .gallery { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; }
    .gallery img { height: 150px; border-radius: 8px; border: 1px solid #ddd; }
    
    .status { text-align: center; margin: 10px 0; font-weight: bold; }
    .log-box { background: #333; color: #0f0; padding: 10px; font-family: monospace; height: 100px; overflow-y: scroll; font-size: 0.8rem; }
  </style>
</head>
<body>
  <div id="version">v0003</div>

  <div class="status" id="statusMsg">Initializing...</div>

  <div class="section">
    <h3>Dog Profile</h3>
    <div id="dogContainer">loading...</div>
  </div>

  <div class="section">
    <h3>Lesson Photos</h3>
    <div id="lessonContainer" class="gallery">loading...</div>
  </div>

  <div id="appLog" class="log-box"></div>
  
  <script>
    const LIFF_ID = '2008546673-MJY7j3ox'; 
    // ★GAS URLは変更なし★
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzheC-9sqA4TjIRD3mYYZlbhU7HAkpg2eis2YR9saNZqPCn_aklmjchErKRKyAfEhgA/exec';

    function log(msg) {
      const box = document.getElementById('appLog');
      const time = new Date().toLocaleTimeString();
      box.innerHTML += `[${time}] ${msg}<br>`;
      console.log(msg);
    }

    window.onload = function() {
      if (typeof liff === 'undefined') {
        document.getElementById('statusMsg').innerText = 'SDK Load Error';
        return;
      }
      main();
    };

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        fetchData(profile.userId);
      } catch (err) {
        log('Error: ' + err);
        document.getElementById('statusMsg').innerText = 'LIFF Error';
      }
    }

    function fetchData(userId) {
      document.getElementById('statusMsg').innerText = 'Downloading Photos...';
      const url = `${GAS_URL}?userId=${userId}&t=${new Date().getTime()}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          document.getElementById('statusMsg').innerText = 'Rendering...';
          
          // 1. 犬の写真表示
          const dogBox = document.getElementById('dogContainer');
          if (data.dogPhoto) {
            dogBox.innerHTML = `<img src="${data.dogPhoto}" class="profile-img">`;
            log('Dog photo loaded.');
          } else {
            dogBox.innerHTML = 'No Dog Photo';
          }

          // 2. レッスン写真表示
          const lessonBox = document.getElementById('lessonContainer');
          if (data.lessonPhotos && data.lessonPhotos.length > 0) {
            lessonBox.innerHTML = ''; // クリア
            data.lessonPhotos.forEach((b64, index) => {
              const img = document.createElement('img');
              img.src = b64;
              lessonBox.appendChild(img);
            });
            log(`Lesson photos loaded: ${data.lessonPhotos.length}枚`);
          } else {
            lessonBox.innerHTML = 'No Lesson Photos';
          }
          
          document.getElementById('statusMsg').innerText = 'Done!';
        })
        .catch(err => {
          log('Fetch Error: ' + err);
          document.getElementById('statusMsg').innerText = 'Network Error';
        });
    }
  </script>
</body>
</html>
