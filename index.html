<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>犬画像表示テスト（Base64埋め込み）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    body { font-family: var(--sans); margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .row { margin-bottom: 12px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input[type="text"] { width: 100%; padding: 8px; border: 1px solid #d0d7de; border-radius: 6px; font-family: var(--mono); }
    button { padding: 8px 12px; margin-right: 8px; border-radius: 6px; border: 1px solid #c9d1d9; background: #f6f8fa; cursor: pointer; }
    button.primary { background: #0969da; color: #fff; border: 1px solid #0969da; }
    #status { font-weight: 700; }
    .status-ok { color: #0f766e; }
    .status-ng { color: #b91c1c; }
    #preview {
      max-width: 100%;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background: #fff;
    }
    #meta, #log {
      font-family: var(--mono);
      white-space: pre-wrap;
      background: #f6f8fa;
      border: 1px solid #d0d7de;
      padding: 8px;
      border-radius: 6px;
    }
    .tips { font-size: 12px; color: #57606a; }
  </style>
</head>
<body>
  <h1>犬画像表示テスト（Base64埋め込み）</h1>

  <div class="row">
    <label>APIエンドポイント（GASデプロイURL）</label>
    <input id="endpoint" type="text"
           value="https://script.google.com/macros/s/AKfycbzlFbJpqnYLmNWPA6tlO1-JyAnnFLJfxZVYjSPoWkJHViEplc0ZCeDauJU4SSmL3ZBH/exec">
    <div class="tips">例: https://script.google.com/macros/s/XXXX/exec</div>
  </div>

  <div class="row">
    <label>dogKey（A列の dog_unique_key）</label>
    <input id="dogKey" type="text" value="da12c3a5">
  </div>

  <div class="row">
    <button id="loadBtn" class="primary">画像を読み込む</button>
    <button id="clearBtn">クリア</button>
  </div>

  <div class="row">
    <span><strong>ステータス:</strong> <span id="status" class="status-ng">未実行</span></span>
  </div>

  <div class="row">
    <label>メタ情報</label>
    <div id="meta"></div>
  </div>

  <div class="row">
    <label>画像プレビュー</label>
    <img id="preview" alt="プレビュー画像" />
  </div>

  <div class="row">
    <label>ログ</label>
    <div id="log"></div>
  </div>

  <script>
    // DOM utils
    const $ = (id) => document.getElementById(id);
    const ts = () => new Date().toISOString();
    const log = (msg) => {
      $('log').textContent += `[${ts()}] ${msg}\n`;
      console.log(`[${ts()}] ${msg}`);
    };
    const setStatus = (ok, text) => {
      const el = $('status');
      el.textContent = text;
      el.className = ok ? 'status-ok' : 'status-ng';
    };
    const setMeta = (obj) => {
      $('meta').textContent = obj ? JSON.stringify(obj, null, 2) : '';
    };

    // Render helpers
    const renderDataUrl = (mimeType, base64) => `data:${mimeType};base64,${base64}`;

    // Main actions
    $('loadBtn').addEventListener('click', async () => {
      const endpoint = $('endpoint').value.trim();
      const dogKey = $('dogKey').value.trim();
      if (!endpoint) { setStatus(false, 'endpoint未設定'); log('ERROR: endpoint未設定'); return; }
      if (!dogKey) { setStatus(false, 'dogKey未入力'); log('ERROR: dogKey未入力'); return; }

      const url = `${endpoint}?dogKey=${encodeURIComponent(dogKey)}`;
      log(`REQUEST: ${url}`);

      const t0 = performance.now();
      try {
        const res = await fetch(url, { method: 'GET' });
        const ct = res.headers.get('content-type') || '';
        log(`HTTP: ${res.status} ${res.statusText} content-type=${ct}`);

        let data;
        try {
          data = await res.json();
        } catch (e) {
          setStatus(false, 'JSON解析エラー');
          log(`FAIL: JSON parse error: ${e.message}`);
          return;
        }

        if (!data || data.ok !== true) {
