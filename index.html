<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K9 Harmony Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* CSSã¯ã”æç¤ºã„ãŸã ã„ãŸã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™ */
    :root {
      --brand-color: #57C3C2;
      --brand-bg: #E0F7FA;
      --text-main: #333333;
    }
    body {
      font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
      background-color: #ffffff;
      color: var(--text-main);
      padding-bottom: 80px;
    }
    .header-area { padding: 20px 20px 10px; background: #fff; }
    .brand-title { color: var(--text-main); font-weight: 700; letter-spacing: 0.05em; margin: 0; font-size: 1.2rem; text-align: center; }
    .profile-card { margin-top: 20px; display: flex; align-items: center; }
    /* è¨ºæ–­ç”¨: dog-imgã¯JSã§éè¡¨ç¤ºã«ã—ã€è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º */
    .dog-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--brand-color); padding: 2px; background: #fff; }
    
    .profile-info { margin-left: 15px; flex-grow: 1; }
    .lesson-meta { margin-top: 5px; font-size: 0.85rem; color: var(--brand-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .section-title { font-size: 0.9rem; font-weight: 700; color: var(--brand-color); margin: 25px 20px 10px; display: flex; align-items: center; gap: 8px; }
    .feedback-box, .homework-box { margin: 0 20px; border-radius: 10px; padding: 15px; font-size: 0.9rem; line-height: 1.6; }
    .photo-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px; margin-top: 10px; padding-bottom: 10px; }

    #loading, #errorView { text-align: center; margin-top: 80px; }
    #mainContent { display: none; }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner-border" style="color: var(--brand-color);" role="status"></div>
  <p class="mt-3 text-muted small">Loading K9 Portal...</p>
</div>

<div id="errorView" style="display:none;">
  <div class="container">
    <div class="alert alert-warning text-center">
      <h5 class="fw-bold">ç™»éŒ²ãŒå¿…è¦ã§ã™</h5>
      <p class="small">ä»¥ä¸‹ã®IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€<br>ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã®LINEã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
      <input type="text" id="userIdDisplay" class="form-control text-center fw-bold mb-3" readonly>
      <button class="btn btn-secondary w-100" onclick="copyId()">IDã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
</div>

<div id="mainContent">
  <div class="header-area">
    <h1 class="brand-title">K9 Harmony</h1>
    
    <div class="profile-card">
      <div id="dogImgDiagnosisWrapper">
          <img id="dogImg" src="https://via.placeholder.com/150?text=No+Img" class="dog-img" onerror="this.src='https://via.placeholder.com/150?text=No+Img';" style="display:none;">
      </div>
      <div class="profile-info">
        <div id="birthdayMsg" class="birthday-msg">Happy Birthday <span id="bdName"></span>ã¡ã‚ƒã‚“ğŸ‰</div>
        
        <p id="custName" class="cust-name">Loading...</p>
        <h2 id="dogName" class="dog-name">Your Dog</h2>
        
        <div class="lesson-meta">
          <span id="lessonDate">--/--/--</span>
          <a href="history.html" class="history-btn">éå»å±¥æ­´ ></a>
        </div>
      </div>
    </div>
  </div>

  <div class="chart-section">
    <div class="chart-box">
      <div class="chart-container"><canvas id="chart1"></canvas></div>
      <div class="chart-caption">åŸºç¤ãƒ»é›†ä¸­</div>
    </div>
    <div class="chart-box">
      <div class="chart-container"><canvas id="chart2"></canvas></div>
      <div class="chart-caption">å¿œç”¨ãƒ»å¯¾å¿œ</div>
    </div>
  </div>

  <div class="section-title">æœ¬æ—¥ã®ãƒ†ãƒ¼ãƒãƒ»ç›®æ¨™</div>
  <div class="feedback-box" id="goalText">---</div>

  <div class="section-title">ã§ããŸã“ã¨ (Done)</div>
  <div class="feedback-box" id="doneText">---</div>

  <div class="section-title">èª²é¡Œ (Unable)</div>
  <div class="feedback-box" id="unableText">---</div>

  <div class="section-title">å®¿é¡Œ (Homework)</div>
  <div class="homework-box">
    <div class="homework-badge">HOMEWORK</div>
    <div id="homeworkText">---</div>
  </div>

  <div class="section-title">è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
  <div class="detail-grid">
    <div class="detail-card">
      <div class="detail-head">é …ç›®1-5</div>
      <div class="detail-body" id="detail1">---</div>
    </div>
    <div class="detail-card">
      <div class="detail-head">é …ç›®6-10</div>
      <div class="detail-body" id="detail2">---</div>
    </div>
  </div>
  
  <div class="feedback-box mt-2" style="background:#fff; border:1px solid #eee;">
    <strong>ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:</strong><br>
    <span id="trainerComment">---</span>
  </div>

  <div class="section-title">æœ¬æ—¥ã®ã‚·ãƒ§ãƒƒãƒˆ</div>
  <div class="photo-scroll" id="photoArea">
    <div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>
  </div>

  <div class="meta-info">
    æ‹…å½“ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼: <span id="trainerName" class="fw-bold">---</span>
  </div>

  <div class="footer-action">
    <a href="#" class="btn-reserve">äºˆç´„ã™ã‚‹ / Reserve</a>
    <div class="text-muted small mt-2">ãƒã‚±ãƒƒãƒˆæ®‹æ•°: <span id="ticketCount" class="fw-bold">è¨ˆç®—ä¸­</span> å›</div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // â˜…â˜…â˜… IDè¨­å®šã‚¨ãƒªã‚¢ (å›ºå®š) â˜…â˜…â˜…
  const LIFF_IDÂ  Â  Â = '2008546673-MJY7j3ox';Â 
  const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxG1rLg6t_jlBWy4KTFqVPYmRK-aEleUQR_yqCiNwsWhvDp7I-suBEsYnDHymVNmURO/exec'; 

  // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

  async function main() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      fetchData(profile.userId);
    } catch (err) {
      alert('Start Error: ' + err.message);
    }
  }

  function fetchData(userId) {
    fetch(`${GAS_API_URL}?userId=${userId}`)
      .then(res => res.json())
      .then(data => render(data, userId))
      .catch(err => alert('Network Error: ' + err));
  }

  function formatDate(dateString) {
    if (!dateString) return '--/--/--';
    const d = new Date(dateString);
    if (isNaN(d.getTime())) return dateString;
    const year = d.getFullYear().toString().slice(-2);
    const month = ('0' + (d.getMonth() + 1)).slice(-2);
    const day = ('0' + d.getDate()).slice(-2);
    return `${year}/${month}/${day}`;
  }

  function render(data, currentUserId) {
    document.getElementById('loading').style.display = 'none';

    if (data.error === 'Unregistered') {
      document.getElementById('errorView').style.display = 'block';
      document.getElementById('userIdDisplay').value = currentUserId;
      return;
    }

    if (data.error) {
      alert('System Error: ' + data.error);
      return;
    }

    document.getElementById('mainContent').style.display = 'block';
    
    // 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« & çŠ¬æƒ…å ±
    const c = data.customer || {};
    const d = data.dog || {};
    document.getElementById('custName').innerText = c.name + " æ§˜";
    document.getElementById('dogName').innerText = d.name || "Your Dog";
    
    // ğŸš¨ è¨ºæ–­ã‚³ãƒ¼ãƒ‰ 1: çŠ¬ã®å†™çœŸ (ç”»åƒè¡¨ç¤ºã‚’å®Œå…¨ã«æ’é™¤ã—ã€URLæ–‡å­—åˆ—ã‚’è¡¨ç¤º) ğŸš¨
    const dogImgWrapper = document.getElementById('dogImgDiagnosisWrapper');
    const dogPhotoUrl = d.photo;
    
    if (dogPhotoUrl && dogPhotoUrl.startsWith('http')) {
      // è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
      const diagnosisDiv = document.createElement('div');
      diagnosisDiv.style.color = 'green';
      diagnosisDiv.style.fontWeight = 'bold';
      diagnosisDiv.style.padding = '10px';
      diagnosisDiv.style.border = '2px solid green';
      diagnosisDiv.style.borderRadius = '8px';
      diagnosisDiv.style.wordBreak = 'break-all'; // URLãŒé•·ã„å ´åˆã«æŠ˜ã‚Šè¿”ã™
      diagnosisDiv.innerText = `âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ URLå–å¾—OK (ç”»åƒè¡¨ç¤ºã¯åœæ­¢ä¸­): ${dogPhotoUrl}`;
      
      // å…ƒã®imgã‚¿ã‚°ã‚’éè¡¨ç¤ºã«ã—ã€è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      dogImgWrapper.innerHTML = ''; 
      dogImgWrapper.appendChild(diagnosisDiv);

    } else {
      dogImgWrapper.innerHTML = `<div style="color:red; padding:10px; border:1px solid red;">âŒ å†™çœŸURLå–å¾—å¤±æ•—</div>`;
    }
    // -------------------------------------------------------------------


    // ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼åˆ¤å®š (ä¸­ç•¥)
    if (d.birth_date && d.name) {
      checkBirthday(d.birth_date, d.name);
    }

    // ãƒã‚±ãƒƒãƒˆæ®‹æ•°
    if (data.ticket_count !== undefined) {
      document.getElementById('ticketCount').innerText = data.ticket_count;
    } else {
      document.getElementById('ticketCount').innerText = "-";
    }

    // 2. æœ€æ–°ãƒ¬ãƒƒã‚¹ãƒ³æƒ…å ±
    const l = data.latest;
    if (l) {
      // æ—¥ä»˜ã€ã‚³ãƒ¡ãƒ³ãƒˆã€å®¿é¡Œãªã© (ä¸­ç•¥)
      document.getElementById('lessonDate').innerText = formatDate(l.date);
      document.getElementById('goalText').innerText = l.goal || 'ãªã—';
      document.getElementById('doneText').innerText = l.done || 'ãªã—';
      document.getElementById('unableText').innerText = l.unable || 'ãªã—';
      document.getElementById('homeworkText').innerText = l.homework || 'ãªã—';
      document.getElementById('trainerComment').innerText = l.comment || 'ãªã—';
      document.getElementById('trainerName').innerText = l.trainer_name || 'Staff';

      // è©³ç´°ã‚³ãƒ¡ãƒ³ãƒˆã®çµåˆè¡¨ç¤º (ä¸­ç•¥)
      const d1 = l.details.slice(0, 5).filter(t => t).map((t, i) => `[${i+1}] ${t}`).join('<br>');
      document.getElementById('detail1').innerHTML = d1 || 'ç‰¹ã«ãªã—';
      const d2 = l.details.slice(5, 10).filter(t => t).map((t, i) => `[${i+6}] ${t}`).join('<br>');
      document.getElementById('detail2').innerHTML = d2 || 'ç‰¹ã«ãªã—';

      // ãƒãƒ£ãƒ¼ãƒˆæç”» (ä¸­ç•¥)
      if (l.scores && l.scores.length >= 10) {
        renderChart('chart1', l.scores.slice(0, 5), ['æŒ‡ç¤ºç†è§£','ãƒœãƒ‡ã‚£ãƒ©ãƒ³','å ±é…¬','é›†ä¸­åŠ›','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ']);
        renderChart('chart2', l.scores.slice(5, 10), ['æŒ‡ç¤ºå‡ºã—','ãƒœãƒ‡ã‚£ãƒ©ãƒ³','ãƒªãƒ¼ãƒ‰','å¯¾å¿œåŠ›','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ']);
      }

      // ğŸš¨ è¨ºæ–­ã‚³ãƒ¼ãƒ‰ 2: ãƒ¬ãƒƒã‚¹ãƒ³å†™çœŸè¡¨ç¤º (ç”»åƒè¡¨ç¤ºã‚’å®Œå…¨ã«æ’é™¤ã—ã€URLæ–‡å­—åˆ—ã‚’è¡¨ç¤º) ğŸš¨
      const pArea = document.getElementById('photoArea');
      pArea.innerHTML = ''; // ã‚¯ãƒªã‚¢
      
      if (l.photos && l.photos.length > 0) {
        l.photos.forEach(url => {
          if(url && url.startsWith('http')) {
            const diagnosisItem = document.createElement('div');
            diagnosisItem.style.color = 'green';
            diagnosisItem.style.fontWeight = 'bold';
            diagnosisItem.style.padding = '5px';
            diagnosisItem.style.border = '1px dashed green';
            diagnosisItem.style.borderRadius = '4px';
            diagnosisItem.style.marginBottom = '5px';
            diagnosisItem.style.wordBreak = 'break-all';
            diagnosisItem.innerText = `âœ… ãƒ¬ãƒƒã‚¹ãƒ³å†™çœŸ URLå–å¾—OK (ç”»åƒè¡¨ç¤ºã¯åœæ­¢ä¸­): ${url.substring(0, 50)}...`;
            pArea.appendChild(diagnosisItem);
          }
        });
        
        if (pArea.innerHTML === '') {
             pArea.innerHTML = `<div class="text-muted small ms-3">URLãŒç©ºã¾ãŸã¯ä¸æ­£ã§ã™</div>`;
        }
        
      } else {
        pArea.innerHTML = `<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
      }
      // -----------------------------------------------------------------------

    } else {
      document.getElementById('lessonDate').innerText = 'å±¥æ­´ãªã—';
    }
  }

  // ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã€Chart.jsã€copyIdé–¢æ•°ã¯å¤‰æ›´ãªã— (ä¸­ç•¥)
  function checkBirthday(birthDateStr, name) { /*...*/ }
  function renderChart(canvasId, dataPoints, labels) { /*...*/ }
  function copyId() { /*...*/ }

  main();
</script>
</body>
</html>
