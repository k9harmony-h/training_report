<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K9 Harmony Portal</title>
  
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --brand-color: #57C3C2;
      --brand-bg: #E0F7FA;
      --text-main: #333333;
    }
    body {
      font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
      background-color: #fafafa;
      color: var(--text-main);
      padding-bottom: 80px;
      overflow-x: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
    }
    
    /* ğŸŒŸ å…¨é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ ğŸŒŸ */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--brand-color); /* å…¨é¢ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    }
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚µãƒ¼ã‚¯ãƒ« (ç™½è‰²) */
    .spinner-border-white { border-color: white; border-right-color: transparent; }
    /* Tipsãƒ†ã‚­ã‚¹ãƒˆ */
    #tipsText {
      margin-top: 20px; font-weight: 500; font-size: 1rem; text-align: center; padding: 0 20px; height: 1.5em;
    }
    /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼†ã‚ºãƒ¼ãƒ ã‚¤ãƒ³åŠ¹æœ */
    body.loaded #loadingOverlay {
      opacity: 0; visibility: hidden;
    }
    #mainContent {
      opacity: 0;
      transform: scale(0.95); /* åˆæœŸçŠ¶æ…‹ã¯å°‘ã—ç¸®å° */
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    body.loaded #mainContent {
      opacity: 1;
      transform: scale(1); /* ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ã—ã¦å…ƒã®ã‚µã‚¤ã‚ºã¸ */
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ & ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
    .header-area { padding: 20px 20px 10px; background: #fff; }
    .brand-title { color: var(--text-main); font-weight: 700; letter-spacing: 0.05em; font-size: 1.2rem; text-align: center; }
    
    .profile-card { margin-top: 20px; display: flex; align-items: center; }
    /* ğŸŒŸ çŠ¬å†™çœŸã®ã‚µã‚¤ã‚ºæ‹¡å¤§ (å·¦1/3ç¨‹åº¦) ğŸŒŸ */
    .dog-img { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--brand-color); padding: 2px; background: #fff; flex-shrink: 0; }
    
    .profile-info { margin-left: 20px; flex-grow: 1; }
    /* ğŸŒŸ èª•ç”Ÿæ—¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ğŸŒŸ */
    .birthday-msg { color: #FF6B6B; font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; display: none; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    
    .cust-name { font-size: 0.85rem; color: #666; margin: 0; }
    .dog-name { font-size: 1.8rem; font-weight: 700; line-height: 1.2; margin: 0; }
    .lesson-meta { margin-top: 5px; font-size: 0.85rem; color: var(--brand-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    /* ğŸŒŸ å±¥æ­´ãƒªãƒ³ã‚¯ (å³æƒãˆ) ğŸŒŸ */
    .history-link { text-decoration: none; color: var(--brand-color); font-weight: bold; font-size: 0.9rem; margin-left: auto; display: block; text-align: right; margin-top: 10px;}

    /* ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
    .chart-section { margin-top: 20px; padding: 0 10px; display: flex; justify-content: space-between; }
    .chart-box { width: 49%; text-align: center; }
    .chart-caption { font-size: 0.75rem; color: #888; margin-top: 5px; font-weight: 600; }

    /* å„ç¨®ãƒœãƒƒã‚¯ã‚¹ */
    .section-title { font-size: 0.9rem; font-weight: 700; color: var(--brand-color); margin: 25px 20px 10px; display: flex; align-items: center; gap: 8px; }
    .section-title::before { content: ''; display: block; width: 4px; height: 16px; background: var(--brand-color); border-radius: 2px; }
    .feedback-box { margin: 0 20px; background: #f8f9fa; border-radius: 10px; padding: 15px; font-size: 0.9rem; line-height: 1.6; }
    .homework-box { margin: 0 20px; border: 2px solid var(--brand-color); border-radius: 10px; padding: 15px; background: #fff; position: relative; margin-top: 30px; }
    .homework-badge { position: absolute; top: -12px; left: 15px; background: var(--brand-color); color: #fff; font-size: 0.75rem; padding: 2px 10px; border-radius: 10px; font-weight: bold; }

    /* è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 0 20px; }
    .detail-card { background: #f8f9fa; border-radius: 8px; padding: 10px; }
    .detail-head { font-size: 0.75rem; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 5px; text-align: center; color: #555; }
    .detail-body { font-size: 0.8rem; color: #333; white-space: pre-wrap; }

    /* å†™çœŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    .photo-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px; margin-top: 10px; padding-bottom: 10px; }
    .photo-item { height: 120px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; /* ã‚¿ãƒƒãƒ—ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ */ }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer-action { margin: 30px 20px 10px; text-align: center; }
    .btn-reserve { background: var(--brand-color); color: #fff; border: none; width: 100%; padding: 14px; border-radius: 30px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(87, 195, 194, 0.4); display: block; text-decoration: none; }

    #errorView { text-align: center; margin-top: 100px; display: none; }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner-border spinner-border-white" role="status"></div>
    <p id="tipsText">Loading...</p> </div>

  <div id="errorView">
    <div class="container">
      <div class="alert alert-warning text-center">
        <h5 class="fw-bold">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</h5>
        <p class="small">åˆå›ã”åˆ©ç”¨æ™‚ã¯ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã«ã‚ˆã‚‹ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚</p>
      </div>
    </div>
  </div>

  <div id="mainContent">
    <div class="header-area">
      <h1 class="brand-title">K9 Harmony</h1>
      
      <div class="profile-card">
        <img id="dogImg" src="https://via.placeholder.com/150?text=No+Img" class="dog-img">
        <div class="profile-info">
          <div id="custBirthdayMsg" class="birthday-msg">ğŸ‰Happy BirthdayğŸ°</div>
          <div id="dogBirthdayMsg" class="birthday-msg">ğŸ‰Happy BirthdayğŸ¶</div>

          <p id="custName" class="cust-name">Loading...</p>
          <h2 id="dogName" class="dog-name">---</h2>
          <div class="lesson-meta">
            <span id="lessonDate">Last: --/--/--</span>
          </div>
          <a href="history.html" class="history-link">å±¥æ­´ ></a>
        </div>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-box">
        <canvas id="chart1"></canvas>
        <div class="chart-caption">åŸºç¤ãƒ»é›†ä¸­</div>
      </div>
      <div class="chart-box">
        <canvas id="chart2"></canvas>
        <div class="chart-caption">å¿œç”¨ãƒ»å¯¾å¿œ</div>
      </div>
    </div>

    <div class="section-title">æœ¬æ—¥ã®ãƒ†ãƒ¼ãƒãƒ»ç›®æ¨™</div>
    <div class="feedback-box" id="goalText">---</div>
    <div class="section-title">ã§ããŸã“ã¨ (Done)</div>
    <div class="feedback-box" id="doneText">---</div>
    <div class="section-title">èª²é¡Œ (Unable)</div>
    <div class="feedback-box" id="unableText">---</div>
    <div class="section-title">å®¿é¡Œ (Homework)</div>
    <div class="homework-box">
      <div class="homework-badge">HOMEWORK</div>
      <div id="homeworkText">---</div>
    </div>
    <div class="section-title">è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
    <div class="detail-grid">
      <div class="detail-card">
        <div class="detail-head">é …ç›®1-5</div>
        <div class="detail-body" id="detail1">---</div>
      </div>
      <div class="detail-card">
        <div class="detail-head">é …ç›®6-10</div>
        <div class="detail-body" id="detail2">---</div>
      </div>
    </div>
    <div class="feedback-box mt-4" style="background:#fff; border:1px solid #eee;">
      <strong style="color:var(--brand-color);">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:</strong><br>
      <span id="trainerComment">---</span>
    </div>

    <div class="section-title">æœ¬æ—¥ã®ã‚·ãƒ§ãƒƒãƒˆ</div>
    <div class="photo-scroll" id="photoArea">
      <div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>
    </div>

    <div class="footer-action">
      <a href="#" class="btn-reserve">äºˆç´„ã™ã‚‹ / Reserve</a>
      <div class="text-muted small mt-2">
        ãƒã‚±ãƒƒãƒˆæ®‹æ•°: <span id="ticketCount" class="fw-bold" style="font-size:1.2rem;">-</span> å›
      </div>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008546673-MJY7j3ox'; 
    // â˜…æœ€æ–°ã®GAS URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„â˜…
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzheC-9sqA4TjIRD3mYYZlbhU7HAkpg2eis2YR9saNZqPCn_aklmjchErKRKyAfEhgA/exec';

    // ğŸŒŸ çŠ¬ã«é–¢ã™ã‚‹Tipsé›† (10å€‹) ğŸŒŸ
    const dogTips = [
      "çŠ¬ã®é¼»ç´‹ã¯äººé–“ã®æŒ‡ç´‹ã¨åŒã˜ã§ã€ä¸€é ­ä¸€é ­é•ã„ã¾ã™ã€‚",
      "çŠ¬ã¯äººé–“ã®ç´„4å€ã®è´åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
      "çŠ¬ã®å—…è¦šã¯äººé–“ã®100ä¸‡å€ã€œ1å„„å€ã¨ã‚‚è¨€ã‚ã‚Œã¾ã™ã€‚",
      "çŠ¬ã¯æ±—ã‚’è‚‰çƒã‹ã‚‰ã—ã‹ã‹ã‘ã¾ã›ã‚“ã€‚",
      "çŠ¬ãŒã‚ãã³ã‚’ã™ã‚‹ã®ã¯ã€ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã¦è½ã¡ç€ã“ã†ã¨ã—ã¦ã„ã‚‹æ™‚ã‚‚ã‚ã‚Šã¾ã™ã€‚",
      "çŠ¬ã®ã—ã£ã½ã®æŒ¯ã‚Šæ–¹ã¯ã€å³å¯„ã‚Šã ã¨ã€Œå¬‰ã—ã„ã€ã€å·¦å¯„ã‚Šã ã¨ã€Œä¸å®‰ã€ãªæ™‚ãŒã‚ã‚Šã¾ã™ã€‚",
      "å°å‹çŠ¬ã®æ–¹ãŒå¤§å‹çŠ¬ã‚ˆã‚Šã‚‚é•·ç”Ÿãã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚",
      "çŠ¬ã¯å¤¢ã‚’è¦‹ã¾ã™ã€‚å¯è¨€ã‚’è¨€ã£ãŸã‚Šè¶³ã‚’å‹•ã‹ã™ã®ã¯ãã®è¨¼æ‹ ã§ã™ã€‚",
      "ãƒ€ãƒ«ãƒ¡ã‚·ã‚¢ãƒ³ã¯ç”Ÿã¾ã‚ŒãŸæ™‚ã¯çœŸã£ç™½ã§ã€å¾Œã‹ã‚‰æ–‘ç‚¹ãŒå‡ºã¦ãã¾ã™ã€‚",
      "çŠ¬ãŒé£¼ã„ä¸»ã®é¡”ã‚’èˆã‚ã‚‹ã®ã¯ã€æ„›æƒ…è¡¨ç¾ã‚„ã”é£¯ã®å‚¬ä¿ƒã§ã™ã€‚"
    ];

    // Tipsã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼
    let tipsTimer;
    function startTipsSlider() {
      const tipsText = document.getElementById('tipsText');
      let currentTipIndex = Math.floor(Math.random() * dogTips.length);
      tipsText.innerText = dogTips[currentTipIndex]; // æœ€åˆã®1ã¤ã‚’è¡¨ç¤º

      tipsTimer = setInterval(() => {
        currentTipIndex = (currentTipIndex + 1) % dogTips.length;
        tipsText.innerText = dogTips[currentTipIndex];
      }, 2500); // 2.5ç§’ã”ã¨ã«åˆ‡ã‚Šæ›¿ãˆ
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†æ™‚ã®å‡¦ç† (ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹)
    function finishLoading() {
      clearInterval(tipsTimer); // Tipsã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
      document.body.classList.add('loaded'); // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç™ºå‹•
      
      // ğŸŒŸ ç”»åƒæ‹¡å¤§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é©ç”¨ ğŸŒŸ
      mediumZoom('.zoomable', { margin: 24, background: 'rgba(0,0,0,0.8)' });
    }

    window.onload = function() {
      startTipsSlider(); // Tipsè¡¨ç¤ºé–‹å§‹
      if (typeof liff === 'undefined') {
        alert('LIFF SDK Load Error'); finishLoading(); return;
      }
      main();
    };

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        fetchData(profile.userId);
      } catch (err) {
        alert('LIFF Error: ' + err);
        finishLoading();
      }
    }

    function fetchData(userId) {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ãŸã‚ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã¤ã‘ã‚‹
      fetch(`${GAS_URL}?userId=${userId}&t=${new Date().getTime()}`)
        .then(res => res.json())
        .then(data => render(data))
        .catch(err => {
          alert('Network Error: ' + err);
          finishLoading();
        });
    }

    function render(data) {
      if (data.error) {
        finishLoading();
        document.getElementById('loadingOverlay').style.display = 'none'; // å³æ™‚éè¡¨ç¤º
        document.getElementById('errorView').style.display = 'block';
        return;
      }

      // 1. åŸºæœ¬æƒ…å ±
      const c = data.customer || {};
      const d = data.dog || {};
      document.getElementById('custName').innerText = c.name + ' æ§˜';
      document.getElementById('dogName').innerText = d.name || 'Your Dog';
      document.getElementById('ticketCount').innerText = data.ticket_count;

      // ğŸŒŸ èª•ç”Ÿæ—¥åˆ¤å®š (å‰å¾Œ2é€±é–“) ğŸŒŸ
      checkBirthday(c.birth_date, 'custBirthdayMsg'); // é£¼ã„ä¸»
      checkBirthday(d.birth_date, 'dogBirthdayMsg');  // çŠ¬

      // 2. çŠ¬ã®å†™çœŸ
      if (d.photo) document.getElementById('dogImg').src = d.photo;

      // 3. æœ€æ–°ãƒ¬ãƒƒã‚¹ãƒ³æƒ…å ±
      const l = data.latest;
      if (l) {
        document.getElementById('lessonDate').innerText = 'Last: ' + l.date;
        document.getElementById('goalText').innerText = l.goal;
        document.getElementById('doneText').innerText = l.done;
        document.getElementById('unableText').innerText = l.unable;
        document.getElementById('homeworkText').innerText = l.homework;
        document.getElementById('trainerComment').innerText = l.comment;

        // ãƒ¬ãƒƒã‚¹ãƒ³å†™çœŸ
        const pArea = document.getElementById('photoArea');
        if (l.photos && l.photos.length > 0) {
          pArea.innerHTML = '';
          l.photos.forEach(b64 => {
            const img = document.createElement('img');
            img.src = b64;
            img.className = 'photo-item zoomable'; // ğŸŒŸ æ‹¡å¤§ç”¨ã‚¯ãƒ©ã‚¹ä»˜ä¸ ğŸŒŸ
            pArea.appendChild(img);
          });
        }

        // è©³ç´°ã‚³ãƒ¡ãƒ³ãƒˆ
        let d1 = '', d2 = '';
        for(let i=0; i<5; i++) if(l.details[i]) d1 += `[${i+1}] ${l.details[i]}\n`;
        for(let i=5; i<10; i++) if(l.details[i]) d2 += `[${i+1}] ${l.details[i]}\n`;
        document.getElementById('detail1').innerText = d1 || 'ç‰¹ã«ãªã—';
        document.getElementById('detail2').innerText = d2 || 'ç‰¹ã«ãªã—';

        // ğŸŒŸ ãƒãƒ£ãƒ¼ãƒˆæç”» (èƒŒæ™¯è‰²è¿½åŠ ) ğŸŒŸ
        // ä»¥å‰ã®è‰²(èµ¤/é’)ã¯å°‘ã—ãã¤ã„ã®ã§ã€ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã«åˆã†æŸ”ã‚‰ã‹ã„è‰²ã‚’æ¡ç”¨
        renderChart('chart1', l.scores.slice(0, 5), ['æŒ‡ç¤ºç†è§£','é›†ä¸­åŠ›','å ±é…¬','ãƒœãƒ‡ã‚£','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ'], 'rgba(255, 99, 132, 0.2)', 'rgba(255, 99, 132, 1)'); // èµ¤ç³»
        renderChart('chart2', l.scores.slice(5, 10), ['æŒ‡ç¤ºå‡ºã—','å¯¾å¿œåŠ›','ãƒªãƒ¼ãƒ‰','ãƒœãƒ‡ã‚£','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ'], 'rgba(54, 162, 235, 0.2)', 'rgba(54, 162, 235, 1)'); // é’ç³»
      }
      
      // å…¨ã¦ã®æç”»ãŒçµ‚ã‚ã£ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’çµ‚äº†ã•ã›ã‚‹
      finishLoading();
    }

    // èª•ç”Ÿæ—¥ãƒã‚§ãƒƒã‚«ãƒ¼ (å‰å¾Œ14æ—¥)
    function checkBirthday(dateStr, elementId) {
        if (!dateStr) return;
        const today = new Date();
        const bDate = new Date(dateStr);
        bDate.setFullYear(today.getFullYear()); // å¹´ã‚’ä»Šå¹´ã«æƒãˆã‚‹

        // å¹´ã¾ãŸãã®è¨ˆç®— (ä¾‹: 12/31ã¨1/1)
        const diffTime = bDate.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        // å‰å¾Œ14æ—¥ä»¥å†…ãªã‚‰è¡¨ç¤º
        if (Math.abs(diffDays) <= 14 || Math.abs(diffDays - 365) <= 14 || Math.abs(diffDays + 365) <= 14) {
            document.getElementById(elementId).style.display = 'block';
        }
    }

    function renderChart(id, data, labels, bgColor, borderColor) {
      new Chart(document.getElementById(id), {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: bgColor,
            borderColor: borderColor,
            pointBackgroundColor: borderColor,
            borderWidth: 2
          }]
        },
        options: {
          scales: {
            r: { min: 0, max: 5, ticks: { display: false }, pointLabels: { font: { size: 11 } } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }
  </script>
</body>
</html>
