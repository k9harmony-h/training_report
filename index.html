<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>K9 Harmony Portal</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --brand-color: #57C3C2;
      --text-main: #333333;
    }
    body {
      font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
      background-color: #ffffff;
      color: var(--text-main);
      padding-bottom: 80px;
    }
    .header-area { padding: 20px 20px 10px; background: #fff; }
    .brand-title { color: var(--text-main); font-weight: 700; letter-spacing: 0.05em; margin: 0; font-size: 1.2rem; text-align: center; }
    .profile-card { margin-top: 20px; display: flex; align-items: center; }
    .dog-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--brand-color); padding: 2px; background: #fff; }
    .profile-info { margin-left: 15px; flex-grow: 1; }
    .cust-name { font-size: 0.85rem; color: #666; margin: 0; }
    .dog-name { font-size: 1.6rem; font-weight: 700; line-height: 1.2; margin: 0; }
    .birthday-msg { font-size: 0.8rem; color: #ff6b6b; font-weight: bold; animation: pulse 2s infinite; display: none; margin-bottom: 4px; }
    @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.02); } 100% { opacity: 0.8; } }
    .lesson-meta { margin-top: 5px; font-size: 0.85rem; color: var(--brand-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .history-btn { font-size: 0.8rem; color: #999; text-decoration: none; border: 1px solid #ddd; padding: 2px 8px; border-radius: 12px; }
    .chart-section { margin-top: 20px; padding: 0 10px; display: flex; justify-content: space-between; }
    .chart-box { width: 49%; text-align: center; position: relative; }
    .chart-container { height: 160px; width: 100%; }
    .chart-caption { font-size: 0.75rem; color: #888; margin-top: 5px; font-weight: 600; }
    .section-title { font-size: 0.9rem; font-weight: 700; color: var(--brand-color); margin: 25px 20px 10px; display: flex; align-items: center; gap: 8px; }
    .section-title::before { content: ''; display: block; width: 4px; height: 16px; background: var(--brand-color); border-radius: 2px; }
    .feedback-box { margin: 0 20px; background: #f8f9fa; border-radius: 10px; padding: 15px; font-size: 0.9rem; line-height: 1.6; }
    .homework-box { margin: 0 20px; border: 2px solid var(--brand-color); border-radius: 10px; padding: 15px; background: #fff; position: relative; }
    .homework-badge { position: absolute; top: -10px; left: 15px; background: var(--brand-color); color: #fff; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 0 20px; }
    .detail-card { background: #f8f9fa; border-radius: 8px; padding: 10px; }
    .detail-head { font-size: 0.75rem; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 5px; text-align: center; color: #555; }
    .detail-body { font-size: 0.8rem; color: #333; }
    .photo-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px; margin-top: 10px; padding-bottom: 10px; }
    .photo-item { width: 120px; height: 120px; border-radius: 8px; object-fit: cover; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #eee; }
    .meta-info { margin: 20px; padding: 15px; background: #fff; border: 1px dashed #ccc; border-radius: 10px; font-size: 0.85rem; color: #555; }
    .footer-action { margin: 30px 20px 10px; text-align: center; }
    .btn-reserve { background: var(--brand-color); color: #fff; border: none; width: 100%; padding: 14px; border-radius: 30px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(87, 195, 194, 0.4); display: block; text-decoration: none; }
    #loading, #errorView { text-align: center; margin-top: 80px; }
    #mainContent { display: none; }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner-border" style="color: var(--brand-color);" role="status"></div>
  <p class="mt-3 text-muted small">Loading K9 Portal...</p>
</div>

<div id="errorView" style="display:none;">
  <div class="container">
    <div class="alert alert-warning text-center">
      <h5 class="fw-bold">ç™»éŒ²ãŒå¿…è¦ã§ã™</h5>
      <p class="small">ä»¥ä¸‹ã®IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€<br>ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã®LINEã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
      <input type="text" id="userIdDisplay" class="form-control text-center fw-bold mb-3" readonly>
      <button class="btn btn-secondary w-100" onclick="copyId()">IDã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
</div>

<div id="mainContent">
  <div class="header-area">
    <h1 class="brand-title">K9 Harmony</h1>

    <div class="profile-card">
      <img id="dogImg" src="https://via.placeholder.com/150?text=No+Img" class="dog-img" alt="Dog Image">
      <div class="profile-info">
        <div id="birthdayMsg" class="birthday-msg">Happy Birthday <span id="bdName"></span>ã¡ã‚ƒã‚“ğŸ‰</div>
        <p id="custName" class="cust-name">Loading...</p>
        <h2 id="dogName" class="dog-name">Your Dog</h2>
        <div class="lesson-meta">
          <span id="lessonDate">--/--/--</span>
          <a href="history.html" class="history-btn">éå»å±¥æ­´ ></a>
        </div>
      </div>
    </div>
  </div>

  <div class="chart-section">
    <div class="chart-box">
      <div class="chart-container"><canvas id="chart1"></canvas></div>
      <div class="chart-caption">åŸºç¤ãƒ»é›†ä¸­</div>
    </div>
    <div class="chart-box">
      <div class="chart-container"><canvas id="chart2"></canvas></div>
      <div class="chart-caption">å¿œç”¨ãƒ»å¯¾å¿œ</div>
    </div>
  </div>

  <div class="section-title">æœ¬æ—¥ã®ãƒ†ãƒ¼ãƒãƒ»ç›®æ¨™</div>
  <div class="feedback-box" id="goalText">---</div>

  <div class="section-title">ã§ããŸã“ã¨ (Done)</div>
  <div class="feedback-box" id="doneText">---</div>

  <div class="section-title">èª²é¡Œ (Unable)</div>
  <div class="feedback-box" id="unableText">---</div>

  <div class="section-title">å®¿é¡Œ (Homework)</div>
  <div class="homework-box">
    <div class="homework-badge">HOMEWORK</div>
    <div id="homeworkText">---</div>
  </div>

  <div class="section-title">è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
  <div class="detail-grid">
    <div class="detail-card">
      <div class="detail-head">é …ç›®1-5</div>
      <div class="detail-body" id="detail1">---</div>
    </div>
    <div class="detail-card">
      <div class="detail-head">é …ç›®6-10</div>
      <div class="detail-body" id="detail2">---</div>
    </div>
  </div>

  <div class="feedback-box mt-2" style="background:#fff; border:1px solid #eee;">
    <strong>ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:</strong><br>
    <span id="trainerComment">---</span>
  </div>

  <div class="section-title">æœ¬æ—¥ã®ã‚·ãƒ§ãƒƒãƒˆ</div>
  <div class="photo-scroll" id="photoArea">
    <div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>
  </div>

  <div class="meta-info">
    æ‹…å½“ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼: <span id="trainerName" class="fw-bold">---</span>
  </div>

  <div class="footer-action">
    <a href="#" class="btn-reserve">äºˆç´„ã™ã‚‹ / Reserve</a>
    <div class="text-muted small mt-2">ãƒã‚±ãƒƒãƒˆæ®‹æ•°: <span id="ticketCount" class="fw-bold">è¨ˆç®—ä¸­</span> å›</div>
  </div>
</div>

<script>
  // LIFFã¨GASã®è¨­å®š
  const LIFF_ID     = '2008546673-MJY7j3ox';
  const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxG1rLg6t_jlBWy4KTFqVPYmRK-aEleUQR_yqCiNwsWhvDp7I-suBEsYnDHymVNmURO/exec';

  async function main() {
    try {
      await liff.init({ liffId: LIFF_ID }); // â† liffï¼ˆã‚¹ãƒšãƒ«ä¿®æ­£æ¸ˆã¿ï¼‰
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      fetchData(profile.userId);
    } catch (err) {
      alert('Start Error: ' + err.message);
    }
  }

  function fetchData(userId) {
    fetch(`${GAS_API_URL}?userId=${userId}`)
      .then(res => res.json())
      .then(data => render(data, userId))
      .catch(err => alert('Network Error: ' + err));
  }

  function formatDate(dateString) {
    if (!dateString) return '--/--/--';
    const d = new Date(dateString);
    if (isNaN(d.getTime())) return dateString;
    const year = d.getFullYear().toString().slice(-2);
    const month = ('0' + (d.getMonth() + 1)).slice(-2);
    const day = ('0' + d.getDate()).slice(-2);
    return `${year}/${month}/${day}`;
  }

  function render(data, currentUserId) {
    document.getElementById('loading').style.display = 'none';

    if (data.error === 'Unregistered') {
      document.getElementById('errorView').style.display = 'block';
      document.getElementById('userIdDisplay').value = currentUserId;
      return;
    }

    if (data.error) {
      alert('System Error: ' + data.error);
      return;
    }

    document.getElementById('mainContent').style.display = 'block';

    // é¡§å®¢ãƒ»çŠ¬æƒ…å ±
    const c = data.customer || {};
    const d = data.dog || {};
    document.getElementById('custName').innerText = (c.name || '') + ' æ§˜';
    document.getElementById('dogName').innerText = d.name || 'Your Dog';

    if (d.photo && d.photo.startsWith('http')) {
      const dogImg = document.getElementById('dogImg');
      dogImg.src = d.photo;
      dogImg.onerror = function () {
        this.alt = 'ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆã‚µã‚¤ã‚ºè¶…éã¾ãŸã¯å½¢å¼ä¸æ­£ï¼‰';
        this.style.opacity = 0.5;
      };
    }

    // èª•ç”Ÿæ—¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if (d.birth_date && d.name) {
      checkBirthday(d.birth_date, d.name);
    }

    // ãƒã‚±ãƒƒãƒˆæ®‹æ•°
    document.getElementById('ticketCount').innerText = (data.ticket_count ?? '-');

    // ãƒ¬ãƒƒã‚¹ãƒ³æƒ…å ±
    const l = data.latest;
    if (l) {
      document.getElementById('lessonDate').innerText = formatDate(l.date);
      document.getElementById('goalText').innerText = l.goal || 'ãªã—';
      document.getElementById('doneText').innerText = l.done || 'ãªã—';
      document.getElementById('unableText').innerText = l.unable || 'ãªã—';
      document.getElementById('homeworkText').innerText = l.homework || 'ãªã—';
      document.getElementById('trainerComment').innerText = l.comment || 'ãªã—';
      document.getElementById('trainerName').innerText = l.trainer_name || 'Staff';

      const d1 = (l.details || []).slice(0, 5).filter(t => t).map((t, i) => `[${i + 1}] ${t}`).join('<br>');
      document.getElementById('detail1').innerHTML = d1 || 'ç‰¹ã«ãªã—';
      const d2 = (l.details || []).slice(5, 10).filter(t => t).map((t, i) => `[${i + 6}] ${t}`).join('<br>');
      document.getElementById('detail2').innerHTML = d2 || 'ç‰¹ã«ãªã—';

      // ãƒãƒ£ãƒ¼ãƒˆ
      if (l.scores && l.scores.length >= 10) {
        renderChart('chart1', l.scores.slice(0, 5), ['æŒ‡ç¤ºç†è§£', 'ãƒœãƒ‡ã‚£ãƒ©ãƒ³', 'å ±é…¬', 'é›†ä¸­åŠ›', 'ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ']);
        renderChart('chart2', l.scores.slice(5, 10), ['æŒ‡ç¤ºå‡ºã—', 'ãƒœãƒ‡ã‚£ãƒ©ãƒ³', 'ãƒªãƒ¼ãƒ‰', 'å¯¾å¿œåŠ›', 'ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ']);
      }

      // å†™çœŸ
      const pArea = document.getElementById('photoArea');
      pArea.innerHTML = '';
      if (l.photos && l.photos.length > 0) {
        l.photos.forEach(url => {
          if (url && url.startsWith('http')) {
            const img = document.createElement('img');
            img.src = url;
            img.className = 'photo-item';
            img.alt = 'lesson-photo';
            img.onerror = function () {
              this.alt = 'ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—';
              this.style.opacity = 0.5;
            };
            pArea.appendChild(img);
          }
        });
      } else {
        pArea.innerHTML = '<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      }
    } else {
      document.getElementById('lessonDate').innerText = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
    }
  }

  function checkBirthday(birthDateStr, name) {
    const today = new Date();
    const bDate = new Date(birthDateStr);
    bDate.setFullYear(today.getFullYear());
    const diffTime = bDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (Math.abs(diffDays) <= 14) {
      document.getElementById('bdName').innerText = name;
      document.getElementById('birthdayMsg').style.display = 'block';
    }
  }

  function renderChart(canvasId, dataPoints, labels) {
    new Chart(document.getElementById(canvasId), {
      type: 'radar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Score',
          data: dataPoints,
          backgroundColor: 'rgba(87, 195, 194, 0.2)',
          borderColor: '#57C3C2',
          borderWidth: 2,
          pointBackgroundColor: '#57C3C2',
          pointRadius: 2
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          r: {
            min: 0, max: 5,
            ticks: { stepSize: 1, display: false },
            pointLabels: { font: { size: 9 }, color: '#555' }
          }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  function copyId() {
    const el = document.getElementById('userIdDisplay');
    el.select();
    navigator.clipboard.writeText(el.value);
    alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }

  // èµ·å‹•
  main();
</script>
</body>
</html>
