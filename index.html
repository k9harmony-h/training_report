<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K9 Harmony Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
      background-color: #fff;
      color: #333;
      padding-bottom: 80px;
    }
    .dog-img {
      width: 90px; height: 90px; border-radius: 50%;
      object-fit: cover; border: 3px solid #57C3C2;
    }
    .photo-item {
      width: 120px; height: 120px; border-radius: 8px;
      object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<div id="loading" class="text-center mt-5">
  <div class="spinner-border text-info"></div>
  <p class="mt-3 text-muted">Loading K9 Portal...</p>
</div>

<div id="errorView" style="display:none;" class="container mt-5">
  <div class="alert alert-warning text-center">
    <h5 class="fw-bold">登録が必要です</h5>
    <p class="small">以下のIDをコピーして、<br>トレーナーのLINEに送信してください。</p>
    <input type="text" id="userIdDisplay" class="form-control text-center fw-bold mb-3" readonly>
    <button class="btn btn-secondary w-100" onclick="copyId()">IDをコピー</button>
  </div>
</div>

<div id="mainContent" style="display:none;">
  <div class="container mt-4">
    <h1 class="text-center fw-bold">K9 Harmony</h1>

    <div class="d-flex align-items-center mt-4">
      <img id="dogImg" src="https://via.placeholder.com/150?text=No+Img" class="dog-img" alt="Dog Image">
      <div class="ms-3">
        <p id="custName" class="mb-1 text-muted">Loading...</p>
        <h2 id="dogName" class="fw-bold">Your Dog</h2>
        <p id="lessonDate" class="text-info">--/--/--</p>
      </div>
    </div>

    <div class="mt-4">
      <h5 class="text-primary">本日のテーマ・目標</h5>
      <div id="goalText" class="border p-2 rounded">---</div>
    </div>

    <div class="mt-3">
      <h5 class="text-success">できたこと</h5>
      <div id="doneText" class="border p-2 rounded">---</div>
    </div>

    <div class="mt-3">
      <h5 class="text-danger">課題</h5>
      <div id="unableText" class="border p-2 rounded">---</div>
    </div>

    <div class="mt-3">
      <h5 class="text-warning">宿題</h5>
      <div id="homeworkText" class="border p-2 rounded">---</div>
    </div>

    <div class="mt-4 row">
      <div class="col">
        <h6 class="text-secondary text-center">項目1-5</h6>
        <div id="detail1" class="border p-2 rounded small">---</div>
      </div>
      <div class="col">
        <h6 class="text-secondary text-center">項目6-10</h6>
        <div id="detail2" class="border p-2 rounded small">---</div>
      </div>
    </div>

    <div class="mt-4">
      <strong>トレーナーコメント:</strong>
      <div id="trainerComment" class="border p-2 rounded">---</div>
    </div>

    <div class="mt-4">
      <h5 class="text-info">本日のショット</h5>
      <div id="photoArea" class="d-flex gap-2 overflow-auto"></div>
    </div>

    <div class="mt-4 text-muted">
      担当トレーナー: <span id="trainerName" class="fw-bold">---</span><br>
      チケット残数: <span id="ticketCount" class="fw-bold">計算中</span> 回
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID = '2008546673-MJY7j3ox';
  const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxG1rLg6t_jlBWy4KTFqVPYmRK-aEleUQR_yqCiNwsWhvDp7I-suBEsYnDHymVNmURO/exec';

  async function main() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      fetchData(profile.userId);
    } catch (err) {
      alert('Start Error: ' + err.message);
    }
  }

  function fetchData(userId) {
    fetch(`${GAS_API_URL}?userId=${userId}`)
      .then(res => res.json())
      .then(data => render(data, userId))
      .catch(err => alert('Network Error: ' + err));
  }

  function formatDate(dateString) {
    if (!dateString) return '--/--/--';
    const d = new Date(dateString);
    if (isNaN(d.getTime())) return dateString;
    return `${d.getFullYear().toString().slice(-2)}/${('0'+(d.getMonth()+1)).slice(-2)}/${('0'+d.getDate()).slice(-2)}`;
  }

  function render(data, userId) {
    document.getElementById('loading').style.display = 'none';

    if (data.error === 'Unregistered') {
      document.getElementById('errorView').style.display = 'block';
      document.getElementById('userIdDisplay').value = userId;
      return;
    }

    document.getElementById('mainContent').style.display = 'block';

    const c = data.customer || {};
    const d = data.dog || {};
    const l = data.latest;

    document.getElementById('custName').innerText = c.name + " 様";
    document.getElementById('dogName').innerText = d.name || "Your Dog";
    document.getElementById('lessonDate').innerText = formatDate(l?.date);

    if (d.photo && d.photo.startsWith('http')) {
      const dogImg = document.getElementById('dogImg');
      dogImg.src = d.photo;
      dogImg.onerror = function() {
        this.alt = '画像読み込み失敗（サイズ超過または形式不正）';
        this.style.opacity = 0.5;
      };
    }

    document.getElementById('goalText').innerText = l?.goal || 'なし';
    document.getElementById('doneText').innerText = l?.done || 'なし';
    document.getElementById('unableText').innerText = l?.unable || 'なし';
    document.getElementById('homeworkText').innerText = l?.homework || 'なし';
    document.getElementById('trainerComment').innerText = l?.comment || 'なし';
    document.getElementById('trainerName').innerText = l?.trainer_name || 'Staff';
    document.getElementById('ticketCount').innerText = data.ticket_count ?? '-';

    const d1 = l?.details?.slice(0, 5).filter(t => t).map((t, i) => `[${i+1}] ${t}`).join('<br>') || '特になし';
    const d2 = l?.details?.slice(5, 10).filter(t => t).map((t, i) => `[${i+6}] ${t}`).join('<br>') || '特になし';
    document.getElementById('detail1').innerHTML = d1;
