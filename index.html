<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <script>
    // [System] ÁâπÂÆö„ÅÆ„ÇØ„Ç®„É™„Éë„É©„É°„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÂç≥Â∫ß„Å´medical.html„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
    (function() {
      if (new URLSearchParams(window.location.search).get('page') === 'medical') {
        window.location.replace('medical.html'); 
      }
    })();
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>K9 Harmony Portal</title>
  
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       Global Styles & Variables
       ========================================= */
    :root { 
        --brand-color: #57C3C2; 
        --brand-bg: #E0F7FA; 
        --text-main: #333333; 
        --accent-color: #F2A679; 
    }
    body { 
        font-family: 'Montserrat', 'Noto Sans JP', sans-serif; 
        background-color: #fafafa; 
        color: var(--text-main); 
        padding-bottom: 150px; /* Footer overlap prevention */
        overflow-x: hidden; 
    }
    
    /* Loading Overlay */
    #loadingOverlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: var(--brand-color); 
        display: flex; flex-direction: column; justify-content: center; align-items: center; 
        z-index: 9999; color: white; 
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out; 
    }
    .spinner-border-white { border-color: white; border-right-color: transparent; }
    #tipsText { margin-top: 20px; font-weight: 500; font-size: 1rem; text-align: center; padding: 0 20px; height: 1.5em; }
    
    body.loaded #loadingOverlay { opacity: 0; visibility: hidden; pointer-events: none; }
    
    /* Main Content Fade-in */
    #mainContent { opacity: 0; transform: scale(0.95); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
    body.loaded #mainContent { opacity: 1; transform: scale(1); }
    
    /* =========================================
       UI Component Styles
       ========================================= */
    .header-area { padding: 20px 20px 10px; background: #fff; }
    .brand-title { color: var(--text-main); font-weight: 700; letter-spacing: 0.05em; font-size: 1.2rem; text-align: center; }
    
    .profile-card { margin-top: 20px; display: flex; align-items: center; }
    
    #dogImgContainer {
        width: 150px; height: 150px; 
        border-radius: 50%; 
        border: 4px solid var(--brand-color); 
        background: #fff; 
        flex-shrink: 0; 
        display: flex; align-items: center; justify-content: center;
        overflow: hidden;
        font-size: 0.8rem; color: #aaa; text-align: center;
    }
    .dog-img { width: 100%; height: 100%; object-fit: cover; }
    
    .profile-info { margin-left: 20px; flex-grow: 1; }
    .birthday-msg { color: #FF6B6B; font-weight: bold; font-size: 0.8rem; margin-bottom: 0px; display: none; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    
    .cust-name { font-size: 0.85rem; color: #666; margin: 0; line-height: 1.2; }
    .dog-name { font-size: 1.6rem; font-weight: 700; line-height: 1.2; margin: 0; }
    .lesson-meta { margin-top: 5px; font-size: 0.85rem; color: var(--brand-color); font-weight: 600; }
    .history-link { text-decoration: none; color: var(--brand-color); font-weight: bold; font-size: 0.9rem; margin-left: auto; display: block; text-align: right; margin-top: 10px;}
    
    .medical-btn-card { cursor: pointer; border-radius: 12px; border: 1px solid #eee; transition: transform 0.1s; }
    .medical-btn-card:active { transform: scale(0.98); background-color: #f8f9fa; }

    .chart-section { margin-top: 20px; padding: 0 10px; display: flex; justify-content: space-between; }
    .chart-box { width: 49%; text-align: center; }
    .chart-caption { font-size: 0.75rem; color: #888; margin-top: 5px; font-weight: 600; }
    
    .section-title { font-size: 0.9rem; font-weight: 700; color: var(--brand-color); margin: 25px 20px 10px; display: flex; align-items: center; gap: 8px; }
    .section-title::before { content: ''; display: block; width: 4px; height: 16px; background: var(--brand-color); border-radius: 2px; }
    
    .section-title.accent { color: var(--accent-color); }
    .section-title.accent::before { background: var(--accent-color); }
    .next-goal-box { margin: 0 20px; background: #fff; border: 2px solid var(--accent-color); border-radius: 10px; padding: 15px; font-weight: 700; color: #555; box-shadow: 0 2px 8px rgba(242, 166, 121, 0.15); }

    .feedback-box { margin: 0 20px; background: #f8f9fa; border-radius: 10px; padding: 15px; font-size: 0.9rem; line-height: 1.6; }
    .homework-box { margin: 0 20px; border: 2px solid var(--brand-color); border-radius: 10px; padding: 15px; background: #fff; position: relative; margin-top: 30px; }
    .homework-badge { position: absolute; top: -12px; left: 15px; background: var(--brand-color); color: #fff; font-size: 0.75rem; padding: 2px 10px; border-radius: 10px; font-weight: bold; }
    
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 0 20px; }
    .detail-card { background: #f8f9fa; border-radius: 8px; padding: 10px; }
    .detail-head { font-size: 0.75rem; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 5px; text-align: center; color: #555; }
    .detail-body { font-size: 0.8rem; color: #333; white-space: pre-wrap; }
    
    .photo-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px; margin-top: 10px; padding-bottom: 10px; }
    .photo-item { height: 120px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; }
    
    .footer-action { margin: 30px 20px 10px; text-align: center; }
    
    .btn-pdf { background: #fff; color: var(--brand-color); border: 2px solid var(--brand-color); width: 100%; padding: 12px; border-radius: 30px; font-weight: 700; font-size: 1rem; margin-bottom: 15px; display: block; text-decoration: none; transition: background 0.2s; cursor: pointer; }
    .btn-pdf:active { background: #E0F7FA; transform: scale(0.98); }

    .btn-reserve { background: var(--brand-color); color: #fff; border: none; width: 100%; padding: 14px; border-radius: 30px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(87, 195, 194, 0.4); display: block; text-decoration: none; }
    
    .reminder-box { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9rem; font-weight: bold; }

    #errorView { text-align: center; margin-top: 50px; display: none; padding: 20px; }
    .line-id-box { background: #eee; padding: 10px; border-radius: 5px; margin: 15px 0; font-family: monospace; font-weight: bold; word-break: break-all; }
    
    .dog-select-btn { width: 100%; margin-bottom: 10px; padding: 15px; font-weight: bold; font-size: 1.1rem; border-radius: 12px; background: #f8f9fa; border: 2px solid var(--brand-color); color: var(--brand-color); transition: all 0.2s; }
    .dog-select-btn:active { background: var(--brand-color); color: #fff; transform: scale(0.98); }

    /* =========================================
       Milestone CSS (Refined Visuals v2)
       ========================================= */
    .milestone-section { margin: 30px 20px 10px; }
    
    .tier-container { 
        margin-bottom: 20px; 
        position: relative; 
        border-radius: 12px; 
        background: #fff; 
        padding: 15px 15px 20px 15px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        z-index: 1; 
        overflow: hidden;
    }
    
    .tier-header { font-size: 0.9rem; font-weight: 700; color: #666; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
    
    /* Horizontal Scroll Layout */
    .tier-badge-scroll { 
        display: flex; 
        flex-wrap: nowrap;
        overflow-x: auto; 
        gap: 15px; 
        padding-bottom: 5px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        min-height: 100px;
    }
    .tier-badge-scroll::-webkit-scrollbar { display: none; }
    .tier-badge-scroll { -ms-overflow-style: none; scrollbar-width: none; }

    /* Badge Item */
    .ms-badge { 
        flex: 0 0 auto; 
        width: 75px; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        cursor: pointer; 
        position: relative; 
        text-decoration: none; 
        scroll-snap-align: start;
        transition: transform 0.1s;
    }
    .ms-badge:active { transform: scale(0.95); }
    
    /* Shake Animation for Locked Items (Feedback) */
    @keyframes shake-refuse {
        0% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        50% { transform: translateX(4px); }
        75% { transform: translateX(-4px); }
        100% { transform: translateX(0); }
    }
    .ms-badge.locked:active .ms-icon-box {
        animation: shake-refuse 0.3s ease-in-out;
    }

    /* Teaser Style (Upper Half Only) */
    .ms-badge.teaser {
        pointer-events: none; /* No interaction */
        opacity: 0.7;
    }
    .ms-badge.teaser .ms-icon-box {
        clip-path: inset(0 0 50% 0); /* Show top 50% */
        background: #eee;
        box-shadow: none; /* Flat look for teaser */
    }
    .ms-badge.teaser .ms-label { display: none; } /* Hide label */

    /* Sealing Wax Style Icon Box (70px x 70px) */
    .ms-icon-box { 
        width: 70px; height: 70px; 
        /* border-radius set dynamically via JS */
        display: flex; align-items: center; justify-content: center; 
        margin-bottom: 8px; 
        position: relative; overflow: hidden;
        box-shadow: 
            inset 0 0 8px rgba(0,0,0,0.3), 
            inset 2px 2px 4px rgba(255,255,255,0.4), 
            0 4px 6px rgba(0,0,0,0.3);
        border: none;
    }
    
    /* Inner Double Line (8px gap + 2px double line) */
    .ms-icon-box::before {
        content: '';
        position: absolute;
        top: 8px; left: 8px; right: 8px; bottom: 8px; 
        border-radius: 50%; /* Perfect circle */
        border: 2px double rgba(0,0,0,0.15); /* Thinner double line */
        box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1); 
        pointer-events: none;
        z-index: 1;
    }

    .ms-icon-box i { font-size: 1.8rem; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3)); color: #fff; z-index: 2; position: relative; }
    .ms-icon-box img { width: 55%; height: 55%; object-fit: contain; z-index: 2; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2)); position: relative; }
    
    .ms-label { 
        font-size: 0.65rem; font-weight: 700; color: #555; 
        text-align: center; line-height: 1.2; 
        width: 100%; height: 2.4em; 
        overflow: hidden; 
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }

    /* Unacquired & Locked */
    .ms-badge.locked .ms-icon-box { background: #e0e0e0 !important; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }
    .ms-badge.locked .ms-label { color: #aaa; }
    .ms-badge.locked .ms-icon-box::after { content: 'üîí'; position: absolute; font-size: 1.2rem; color: #999; z-index: 3; }
    .ms-badge.locked .ms-icon-box img { opacity: 0.1; filter: grayscale(100%); }

    /* Colors (Fully Imported) */
    .bg-pastel-sage { background: #A8D8B9; } .bg-pastel-apricot { background: #FFDAB9; }
    .bg-pastel-sky { background: #87CEEB; } .bg-pastel-rose { background: #FFB7B2; }
    .bg-pastel-lilac { background: #C8A2C8; } .bg-pastel-mint { background: #98FF98; }
    .bg-pastel-coral { background: #FF7F50; } .bg-pastel-cocoa { background: #D2691E; }
    .bg-metallic-silver { background: linear-gradient(135deg, #e0e0e0, #ffffff, #b0b0b0); color: #333; }
    .bg-metallic-bronze { background: linear-gradient(135deg, #cd7f32, #ffcc99, #8b4513); }
    .bg-metallic-champagne { background: linear-gradient(135deg, #fad6a5, #fff8e7, #d2b48c); color: #5d4037; }
    .bg-metallic-slate { background: linear-gradient(135deg, #708090, #b0c4de, #2f4f4f); }
    .bg-metallic-pearl { background: linear-gradient(135deg, #f0f8ff, #ffffff, #dcdcdc); color: #333; border: 1px solid #ddd; }
    .bg-metallic-rose-gold { background: linear-gradient(135deg, #b76e79, #ffd1dc, #a0522d); }
    .bg-metallic-coffee { background: linear-gradient(135deg, #6f4e37, #d2b48c, #3e2723); }
    .bg-metallic-ice { background: linear-gradient(135deg, #a5f2f3, #e0ffff, #00ced1); color: #00695c; }
    .bg-luxury-gold { background: linear-gradient(45deg, #FFD700, #FDB931, #FFD700); }
    .bg-luxury-platinum { background: linear-gradient(45deg, #E5E4E2, #ffffff, #BCC6CC); color:#333; }
    .bg-luxury-ruby { background: linear-gradient(45deg, #9b111e, #ff0000, #800000); }
    .bg-luxury-sapphire { background: linear-gradient(45deg, #0F52BA, #4169E1, #000080); }
    .bg-luxury-onyx { background: linear-gradient(45deg, #353839, #000000, #2c2c2c); }
    .bg-luxury-diamond { background: linear-gradient(45deg, #b9f2ff, #ffffff, #e0ffff); color:#000; border:1px solid #aaa; }

    /* Default Tier Fallbacks (Used if no color specified) */
    .bg-trust { background: #A8D8B9; }
    .bg-bond { background: linear-gradient(135deg, #e0e0e0, #ffffff, #b0b0b0); color: #333; }
    .bg-harmony { background: linear-gradient(45deg, #FFD700, #FDB931, #FFD700); }

    /* Scroll Hint Fade */
    .tier-container::after {
        content: ''; position: absolute; top: 0; right: 0; width: 30px; height: 100%;
        background: linear-gradient(to left, rgba(255,255,255,1), rgba(255,255,255,0));
        pointer-events: none; z-index: 5; border-radius: 0 12px 12px 0;
    }

    /* Locked Overlay */
    .tier-lock-overlay {
        position: absolute; inset: 0; 
        background-color: rgba(30, 30, 30, 0.95);
        background-image: radial-gradient(circle at 50% 50%, #2a2a2a 20%, transparent 20%), radial-gradient(circle at 0% 0%, #2a2a2a 20%, transparent 20%);
        background-size: 40px 40px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 10; color: #fff;
        opacity: 1; transition: opacity 1.5s ease-out, transform 1.5s ease-in;
    }
    .tier-lock-icon {
        font-size: 3.5rem; margin-bottom: 10px;
        background: linear-gradient(to bottom, #fbf5b7 0%, #bf953f 40%, #b38728 60%, #fbf5b7 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 4px 4px rgba(0,0,0,0.8));
    }
    .tier-lock-text {
        font-family: 'Times New Roman', serif;
        font-size: 1.1rem; letter-spacing: 0.15em; color: #fbf5b7;
        text-shadow: 0 2px 4px rgba(0,0,0,1);
    }
    
    /* Unlock Animation Keyframes */
    @keyframes lock-shake-fall {
        0%, 10%, 20%, 30%, 40% { transform: translateX(-5px); }
        5%, 15%, 25%, 35% { transform: translateX(5px); }
        45% { transform: translateX(0); }
        50% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(100px); opacity: 0; }
    }
    .anim-unlock {
        animation: lock-shake-fall 2.5s forwards;
    }

    /* All List Link */
    .ms-list-link {
        display: block; text-align: center; color: var(--brand-color); 
        font-weight: bold; font-size: 0.9rem; text-decoration: none; 
        margin: 10px 0 20px 0; cursor: pointer;
    }
    .ms-list-link:hover { text-decoration: underline; }

    /* Modals - Branded */
    .modal-header { border-bottom: none; padding-bottom: 0; }
    #msModalIconBox { 
        width: 100px; height: 100px; 
        border-radius: 50%; margin: 0 auto; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 3rem; color: white;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.3), 0 4px 10px rgba(0,0,0,0.2);
        position: relative;
    }
    #msModalIconBox::before {
        content: ''; position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px;
        border-radius: 50%; border: 1px solid rgba(0,0,0,0.15); 
        box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); pointer-events: none; z-index: 1;
    }
    #msModalTipsBox { background-color: #E0F7FA; border-radius: 8px; padding: 15px; margin-top: 15px; color: #006064; font-size: 0.9rem; }
    
    /* Full List Modal Grid */
    .full-list-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; row-gap: 20px; margin-bottom: 20px; }
    .full-list-section { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .full-list-title { font-size: 1rem; font-weight: bold; margin-bottom: 15px; color: var(--brand-color); border-left: 4px solid var(--brand-color); padding-left: 10px; }
    
    #log-stamp { background: #d32f2f; color: white; text-align: center; font-weight: bold; padding: 5px; font-size: 0.8rem; }
    #debug-console { background: #111; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 8px; height: 150px; overflow-y: scroll; margin: 20px; }

    /* =========================================================================
       [Moment of Joy] Celebration Overlay Styles
       ========================================================================= */
    #celebrationOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 10000; 
        display: none; 
        pointer-events: auto;
    }

    /* 1. Night Sky Background */
    #celebNightSky {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle at center bottom, #00143c 0%, #000 90%);
        opacity: 0; transition: opacity 0.5s ease-out;
        z-index: 10001;
    }
    #celebrationOverlay.active #celebNightSky { opacity: 1; }

    /* 2. Stars */
    #celebStars {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 10002; pointer-events: none; opacity: 0;
    }
    #celebrationOverlay.active #celebStars { opacity: 1; transition: opacity 0.5s 0.5s; }
    
    .twinkling-star {
        position: absolute; background: white; border-radius: 50%;
        animation: twinkle 2s infinite ease-in-out;
    }
    @keyframes twinkle { 
        0%, 100% { opacity: 0.3; transform: scale(0.8); } 
        50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 4px gold; } 
    }

    /* 3. Light Flash & Pedestal */
    #celebLightContainer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
        pointer-events: none; z-index: 10003;
    }
    
    /* 3.1 Light Core (Pedestal) - Front */
    #celebLightCore {
        position: absolute;
        z-index: 3;
        width: 10px; height: 10px; border-radius: 50%;
        /* Core visual: Solid white center fading to transparent */
        background: radial-gradient(circle, #fff 0%, #fff 80%, rgba(255,255,255,0.8) 90%, transparent 100%);
        opacity: 0; transform: scale(0);
        filter: none; /* No Blur */
        box-shadow: none;
    }

    /* 3.2 Donut Ring - Back (Adjusted for alignment) */
    #celebLightRing {
        position: absolute;
        z-index: 1;
        width: 10px; height: 10px; border-radius: 50%;
        margin-top: -32.5px;
        /* Visual: Tight white band */
        background: radial-gradient(circle, transparent 50%, rgba(255,255,255,1.0) 55%, transparent 60%);
        filter: blur(0.2px); 
        opacity: 0; transform: scale(0);
    }

    /* 3.3 Oval Ring - Back (Adjusted for size and alignment) */
    #celebLightOval {
        position: absolute;
        z-index: 2; /* Between Core and Ring */
        width: 10px; height: 10px; border-radius: 50%;
        margin-top: 65px;
        background: radial-gradient(circle, transparent 50%, rgba(255,255,255,1.0) 55%, transparent 60%);
        filter: blur(0.2px);
        opacity: 0; transform: scale(0);
    }
    
    /* Core Animation (FINAL SIZE: 175px) */
    .anim-light { animation: light-bloom 2.0s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes light-bloom {
        0% { transform: scale(0); opacity: 0; }
        15% { transform: scale(300); opacity: 1; }
        100% { transform: scale(17.5); opacity: 0.6; } /* Opacity 0.6 */
    }

    /* Ring Animation (FINAL SIZE: 240px) */
    .anim-ring { animation: ring-bloom 2.0s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes ring-bloom {
        0% { transform: scale(0); opacity: 0; }
        15% { transform: scale(300); opacity: 1; }
        100% { transform: scale(24); opacity: 0.4; } /* Opacity 0.4, Size 240px */
    }

    /* Oval Animation (FINAL SIZE: 300px x 105px) */
    .anim-oval { animation: oval-bloom 2.0s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes oval-bloom {
        0% { transform: scale(0); opacity: 0; }
        15% { transform: scale(300); opacity: 1; }
        /* Final scaleX 30 (300px), ScaleY 10.5 (105px), Opacity 0.8 */
        100% { transform: scale(30, 10.5); opacity: 0.8; } 
    }

    /* 4. Fireworks Canvas */
    #celebFireworksCanvas {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 10004;
    }

    /* 5. Badge Appearance */
    #celebBadgeContainer {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 180px; height: 180px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        opacity: 0;
        z-index: 10005; /* Top element */
    }
    
    .anim-badge-appear {
        animation: badge-sequence 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes badge-sequence {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; filter: brightness(0); }
        100% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; filter: brightness(1); }
    }
    
    /* Celebration Badge Inner - Strict Sealing Wax Style */
    .celeb-badge-inner {
        width: 140px; height: 140px; 
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        position: relative; overflow: hidden;
        box-shadow: 
            inset 0 0 16px rgba(0,0,0,0.3), 
            inset 4px 4px 8px rgba(255,255,255,0.4), 
            0 8px 12px rgba(0,0,0,0.3);
        border: none;
    }
    
    .celeb-badge-inner::before {
        content: '';
        position: absolute;
        top: 16px; left: 16px; right: 16px; bottom: 16px; /* Scaled margin */
        border-radius: 50%; 
        border: 2px solid rgba(0,0,0,0.15); 
        box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); 
        pointer-events: none; z-index: 1;
    }

    .celeb-badge-inner i { font-size: 3.5rem; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); color: #fff; z-index: 2; position: relative; }
    .celeb-badge-inner img { width: 55%; height: 55%; object-fit: contain; z-index: 2; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); position: relative; }
    
    .celeb-badge-label {
        margin-top: 15px; font-size: 1.2rem; font-weight: 700; color: #fff;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        text-align: center; letter-spacing: 0.05em;
    }
    .celeb-badge-sub {
        font-size: 0.8rem; color: #ccc; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.1em;
    }

    #celebCloseNote {
        position: absolute; bottom: 50px; left: 0; width: 100%;
        text-align: center; color: rgba(255,255,255,0.5); font-size: 0.8rem;
        pointer-events: none; z-index: 10006;
    }

    /* Modal Image & Lock Icon */
    #msModalImage { width: 60%; height: 60%; object-fit: contain; z-index: 5; }
    #msModalIcon { font-size: 3rem; z-index: 5; }

  </style>
</head>
<body>

  <div id="celebrationOverlay" onclick="closeCelebration()">
    <div id="celebNightSky"></div>
    <div id="celebStars"></div>
    <canvas id="celebFireworksCanvas"></canvas>

    <div id="celebLightContainer">
       <div id="celebLightCore"></div>
       <div id="celebLightRing"></div>
       <div id="celebLightOval"></div>
    </div>

    <div id="celebBadgeContainer">
        <div id="celebBadgeIconBox" class="celeb-badge-inner">
             </div>
        <div id="celebBadgeTitle" class="celeb-badge-label"></div>
        <div id="celebBadgeTier" class="celeb-badge-sub"></div>
    </div>
    
    <div id="celebCloseNote">Tap to Close</div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner-border spinner-border-white" role="status"></div>
    <p id="tipsText">Loading...</p>
  </div>

  <div id="mainContent">
      <div class="header-area">
          <div class="brand-title">K9 Harmony</div>
          
          <div class="profile-card" onclick="openProfileModal()">
              <div id="dogImgContainer">
                  <span class="small">No Photo</span>
              </div>
              <div class="profile-info">
                  <p class="cust-name"><span id="custName">Guest</span> Êßò</p>
                  <p id="birthdayMsg" class="birthday-msg"><i class="fa-solid fa-cake-candles"></i> Happy Birthday!</p>
                  <h1 class="dog-name" id="dogName">No Dog</h1>
                  <div class="lesson-meta">
                      <i class="fa-solid fa-graduation-cap"></i> Ê¨°Âõû: <span id="nextLessonDate">Êú™ÂÆö</span>
                  </div>
              </div>
          </div>
          <a href="history.html" class="history-link">Â±•Ê≠¥„ÇíË¶ã„Çã &gt;</a>
      </div>

      <div class="d-flex justify-content-between px-3 mt-3">
          <div class="medical-btn-card p-2 d-flex align-items-center" onclick="openMedicalPage()" style="width:100%;">
             <div class="me-3 text-center" style="width:40px;"><i class="fa-solid fa-notes-medical fa-2x text-danger"></i></div>
             <div>
                 <div style="font-size:0.8rem; font-weight:bold; color:#555;">ÂåªÁôÇ„ÉªÈò≤ÁÅΩÊâãÂ∏≥</div>
                 <div style="font-size:0.65rem; color:#888;">Á∑äÊÄ•ÊôÇ„ÉªÈÄöÈô¢ÊôÇ„Å´Ê¥ªÁî®</div>
             </div>
             <div class="ms-auto"><i class="fa-solid fa-chevron-right text-muted"></i></div>
          </div>
      </div>
      
      <div class="chart-section">
        <div class="chart-box">
            <canvas id="chart1" height="100"></canvas>
            <div class="chart-caption">Âü∫Á§é„ÉªÈõÜ‰∏≠</div>
        </div>
        <div class="chart-box">
            <canvas id="chart2" height="100"></canvas>
            <div class="chart-caption">ÂøúÁî®„ÉªÂØæÂøú</div>
        </div>
      </div>

      <h3 class="section-title accent">Next Goal</h3>
      <div class="next-goal-box" id="nextGoal">
          ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Çá„ÅÜ
      </div>
      
      <div id="milestoneArea" class="milestone-section"></div>
      <h3 class="section-title">Trainer's Feedback</h3>
      <div class="feedback-box" id="feedbackComment">
          („Åæ„Å†„Ç≥„É°„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì)
      </div>

      <div class="homework-box">
          <span class="homework-badge">HOMEWORK</span>
          <div id="homeworkText">ÂÆøÈ°å„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
      </div>

      <div class="detail-grid mt-4">
           <div class="detail-card">
               <div class="detail-head">„Åß„Åç„Åü„Åì„Å®</div>
               <div class="detail-body" id="doneText">-</div>
           </div>
           <div class="detail-card">
               <div class="detail-head">Á∑¥Áøí‰∏≠</div>
               <div class="detail-body" id="unableText">-</div>
           </div>
      </div>

      <h3 class="section-title">Êú¨Êó•„ÅÆ„Ç∑„Éß„ÉÉ„Éà</h3>
      <div class="photo-scroll" id="photoScroll">
          <div class="text-muted small ms-3">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>

      <div class="footer-action">
           <a href="#" class="btn-pdf" onclick="openHistoryPdf(); return false;">
               <i class="fa-regular fa-file-pdf"></i> PDF„É¨„Éù„Éº„Éà„ÇíË¶ã„Çã
           </a>
           
           <div class="reminder-box" id="reminderBox" style="display:none;">
               <i class="fa-solid fa-bell"></i> <span id="reminderText"></span>
           </div>

           <a href="https://liff.line.me/2006387060-p16x5j4A" class="btn-reserve mt-3">
               <i class="fa-solid fa-calendar-check"></i> Ê¨°Âõû‰∫àÁ¥Ñ„ÇíÂÖ•„Çå„Çã
           </a>
      </div>
      
      <div class="text-center mt-4 mb-4">
          <button class="btn btn-sm btn-outline-secondary" onclick="showDogSelectModal(window.cachedDogs || [])">
              <i class="fa-solid fa-paw"></i> ‰ªñ„ÅÆ„ÉØ„É≥„Å°„ÇÉ„Çì„Å´Âàá„ÇäÊõø„Åà
          </button>
      </div>

      <div id="debug-console" style="display:none;"></div>
  </div>
  
  <div id="errorView">
      <div class="alert alert-danger">
          <h4 class="alert-heading">Connection Error</h4>
          <p id="errorMsg">„Éá„Éº„Çø„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
          <hr>
          <p class="mb-0">„É™„É≠„Éº„Éâ„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
      </div>
  </div>

  <div class="modal fade" id="milestoneModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
             <h5 class="modal-title fw-bold" id="msModalTitle">Title</h5>
             <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
             <div id="msModalIconBox">
                 <img id="msModalImage" src="" style="display:none;">
                 <i id="msModalIcon" class="fa-solid fa-star" style="display:none;"></i>
             </div>
             <p class="mt-3 text-muted small" id="msModalTier">Tier Name</p>
             <p class="mt-2" id="msModalDesc">Description goes here.</p>
             <div id="msModalTipsBox">
                 <strong><i class="fa-regular fa-lightbulb"></i> Tips</strong><br>
                 <span id="msModalTips">Tips content.</span>
             </div>
          </div>
        </div>
      </div>
  </div>

  <div class="modal fade" id="dogSelectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header border-0"><h5 class="modal-title fw-bold w-100 text-center">„Çè„Çì„Å°„ÇÉ„Çì„ÇíÈÅ∏Êäû</h5></div>
              <div class="modal-body" id="dogSelectBody"></div>
          </div>
      </div>
  </div>

  <script>
    const LIFF_ID = '2008546673-MJY7j3ox'; 
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
    
    // Tips Array
    const dogTips = [
        "Áä¨„ÅÆÈºªÁ¥ã„ÅØ‰∫∫Èñì„ÅÆÊåáÁ¥ã„Å®Âêå„Åò„Åß„ÄÅ‰∏ÄÈ†≠„Åî„Å®„Å´Áï∞„Å™„Çä„Åæ„Åô„ÄÇ",
        "Áä¨„ÅØ‰∫∫Èñì„ÅÆÁ¥Ñ4ÂÄç„ÅÆÈÄü„Åï„ÅßÈü≥„ÇíËÅû„ÅçÂèñ„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ",
        "Áä¨„ÅÆÂóÖË¶ö„ÅØ‰∫∫Èñì„ÅÆ100‰∏áÂÄç„Äú1ÂÑÑÂÄç„Å®„ÅÑ„Çè„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
        "Áä¨„ÅØËÇâÁêÉ„Åã„Çâ„ÅÆ„ÅøÊ±ó„Çí„Åã„Åç„Åæ„Åô„ÄÇ",
        "Áä¨„Åå„ÅÇ„Åè„Å≥„Çí„Åô„Çã„ÅÆ„ÅØ„ÄÅËá™ÂàÜ„ÇÑÁõ∏Êâã„ÇíËêΩ„Å°ÁùÄ„Åã„Åõ„Çà„ÅÜ„Å®„Åô„Çã„Ç´„Éº„Éü„É≥„Ç∞„Ç∑„Ç∞„Éä„É´„Åß„Åô„ÄÇ",
        "Áä¨„ÅÆ„Åó„Å£„ÅΩ„ÅÆÊåØ„ÇäÊñπ„ÅØ„ÄÅÂè≥„Å´ÊåØ„Çã„Å®Â•ΩÊÑè„ÄÅÂ∑¶„Å†„Å®‰∏çÂÆâ„ÇíË°®„Åô„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
        "Â∞èÂûãÁä¨„ÅÆÊñπ„ÅåÂ§ßÂûãÁä¨„Çà„ÇäÂøÉÊãçÊï∞„ÅåÊó©„ÅÑ„Åß„Åô„ÄÇ",
        "Áä¨„ÅØ„É¨„É†Áù°Áú†‰∏≠„Å´Â§¢„ÇíË¶ã„Åæ„Åô„ÄÇ",
        "„ÉÄ„É´„É°„Ç∑„Ç¢„É≥„ÅØÁîü„Åæ„Çå„ÅüÊôÇ„ÅØÁúü„Å£ÁôΩ„Åß„Åô„ÄÇ",
        "Áä¨„ÅåÈ£º„ÅÑ‰∏ª„ÅÆ„ÅÇ„Åè„Å≥„Çí„ÅÜ„Å§„Åï„Çå„Çã„ÅÆ„ÅØ„ÄÅÂÖ±ÊÑüËÉΩÂäõ„ÅÆË°®„Çå„Åß„Åô„ÄÇ"
    ];

    let currentUserId = null;
    let currentDogId = null;
    let cachedData = null; 
    let tipsTimer = null;
    window.cachedDogs = [];

    // --- Milestone Globals ---
    let fireworksLoop = null;
    const MILESTONE_TIERS = {
        1: { name: 'TRUST', class: 'bg-trust' },
        2: { name: 'BOND', class: 'bg-bond' },
        3: { name: 'HARMONY', class: 'bg-harmony' }
    };

    function startTipsSlider() {
        const el = document.getElementById('tipsText');
        if(!el) return;
        let idx = Math.floor(Math.random() * dogTips.length);
        el.innerText = dogTips[idx];
        tipsTimer = setInterval(() => {
            idx = (idx + 1) % dogTips.length;
            el.innerText = dogTips[idx];
        }, 2500);
    }
    
    function stopTipsSlider() {
        if(tipsTimer) clearInterval(tipsTimer);
    }

    window.onload = async function() {
        startTipsSlider();
        if (typeof liff === 'undefined') { showError('LIFF SDK not loaded.'); return; }
        
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            const profile = await liff.getProfile();
            currentUserId = profile.userId;
            
            const params = new URLSearchParams(window.location.search);
            currentDogId = params.get('dogId');
            
            // Generate Stars for Overlay once
            generateStars();

            fetchTextData(currentUserId, currentDogId);
            
        } catch (e) { showError('Init Error: ' + e.message); }
    };

    function fetchTextData(userId, dogId) {
        let url = `${GAS_URL}?userId=${userId}&t=${new Date().getTime()}`;
        if(dogId) url += `&dogId=${dogId}`;
        // Milestone data included in 'data' type response now
        
        fetch(url)
            .then(res => res.json())
            .then(data => {
                if(data.multiple_dogs) {
                    window.cachedDogs = data.multiple_dogs;
                    showDogSelectModal(data.multiple_dogs);
                    stopTipsSlider();
                    return;
                }
                
                if(data.error) { showError(data.error); return; }
                
                cachedData = data;
                if(data.dog && data.dog.id) currentDogId = data.dog.id;
                
                renderMain(data);
                
                // Render Milestones
                if(data.milestone_data) {
                    renderMilestones(data.milestone_data);
                } else {
                    // Fallback: Try fetching milestone separately if not included
                    fetchMilestoneData(currentDogId);
                }
                
                document.body.classList.add('loaded');
                stopTipsSlider();
                
                // Async image fetch
                setTimeout(() => {
                    fetchImages(userId, currentDogId);
                }, 100);
            })
            .catch(e => showError(e.message));
    }

    function fetchMilestoneData(dogId) {
        // Âà•ÈÄîÂèñÂæó„Åô„ÇãÂ†¥Âêà„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ (Âøµ„ÅÆ„Åü„ÇÅ)
        const url = `${GAS_URL}?userId=${currentUserId}&dogId=${dogId}&type=milestone`;
        fetch(url).then(r=>r.json()).then(d => {
            if(d.status === 'success') renderMilestones(d);
        });
    }

    // --- Main Rendering ---
    function renderMain(data) {
        const c = data.customer || {};
        const d = data.dog || {};
        const l = data.latest || {};
        
        setText('custName', c.name);
        setText('dogName', d.name_disp || d.name);
        setText('nextLessonDate', l.recommend_date || 'Êú™ÂÆö');
        setText('nextGoal', l.next_goal || 'ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Çá„ÅÜ');
        setText('feedbackComment', l.comment || '(„Åæ„Å†„Ç≥„É°„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì)');
        setText('homeworkText', l.homework || 'ÂÆøÈ°å„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
        setText('doneText', l.done);
        setText('unableText', l.unable);
        
        // Reminder
        if (d.caution) {
            document.getElementById('reminderText').innerText = d.caution;
            document.getElementById('reminderBox').style.display = 'block';
        }

        // Birthday
        if (d.birth_date) {
            const today = new Date();
            const birth = new Date(d.birth_date);
            if (today.getMonth() === birth.getMonth() && today.getDate() === birth.getDate()) {
                document.getElementById('birthdayMsg').style.display = 'block';
            }
        }
        
        // Chart
        renderChart('chart1', [l.scores ? Number(l.scores[0]) : 0], 'Âü∫Á§é', 'rgba(87, 195, 194, 0.6)');
        renderChart('chart2', [l.scores ? Number(l.scores[5]) : 0], 'ÂøúÁî®', 'rgba(242, 166, 121, 0.6)');
    }
    
    function setText(id, txt) {
        const el = document.getElementById(id);
        if(el) el.innerText = txt || '-';
    }

    // --- Milestone Logic (Implemented Here) ---
    
    // 30% - 60% Wax Shape Generator
    function generateWaxShape() {
        let values = [];
        for(let i=0; i<8; i++) {
            // Random between 30 and 60
            values.push(Math.floor(Math.random() * 31) + 30); 
        }
        return `${values[0]}% ${values[1]}% ${values[2]}% ${values[3]}% / ${values[4]}% ${values[5]}% ${values[6]}% ${values[7]}%`;
    }

    function renderMilestones(msData) {
        const area = document.getElementById('milestoneArea');
        if(!area) return;
        area.innerHTML = ''; // clear

        const badges = msData.badges || [];
        const meta = msData.meta || {};
        
        // Group by Tier
        const tiers = { 1: [], 2: [], 3: [] };
        badges.forEach(b => {
            if(tiers[b.tier_id || getTierIdFromCode(b.tier)]) {
                tiers[b.tier_id || getTierIdFromCode(b.tier)].push(b);
            }
        });

        // Render Tiers
        for (let t = 1; t <= 3; t++) {
            const list = tiers[t];
            if (!list || list.length === 0) continue;
            
            // Visibility Check (Phase 4 Logic)
            let isLocked = false;
            let showOverlay = false;
            
            // Tier 2 Logic
            if (t === 2) {
                if (!meta.show_intermediate_full && !meta.show_intermediate_peek) continue; // Hide completely
                if (meta.show_intermediate_peek && !meta.show_intermediate_full) {
                    isLocked = true; // Peek mode (Teaser) logic applied per badge
                    showOverlay = true;
                }
            }
            // Tier 3 Logic
            if (t === 3) {
                if (!meta.show_advanced_peek) continue; 
                if (meta.show_advanced_peek) { // Assuming full unlock logic is similar
                     isLocked = true;
                     showOverlay = true;
                }
            }

            const tierDiv = document.createElement('div');
            tierDiv.className = 'tier-container';
            
            // Header
            const header = document.createElement('div');
            header.className = 'tier-header';
            header.innerHTML = `<span>${MILESTONE_TIERS[t].name}</span>`;
            tierDiv.appendChild(header);

            // Scroll Area
            const scrollDiv = document.createElement('div');
            scrollDiv.className = 'tier-badge-scroll';

            list.forEach(badge => {
                const bEl = document.createElement('div');
                bEl.className = 'ms-badge';
                
                // Phase 4: Teaser / Locked state
                if (isLocked && !badge.is_acquired) {
                    bEl.classList.add('teaser'); // Clip-path applied
                    bEl.classList.add('locked'); // Grayed out
                } else if (!badge.is_acquired) {
                    bEl.classList.add('locked');
                }

                // Shape & Color
                const shape = generateWaxShape();
                const colorClass = badge.color || MILESTONE_TIERS[t].class;
                
                // Icon (FontAwesome or Image)
                let iconHtml = '';
                if(badge.icon && badge.icon.includes('.')) {
                    iconHtml = `<img src="https://drive.google.com/thumbnail?id=${extractFileId(badge.icon)}&sz=w200">`;
                } else {
                    iconHtml = `<i class="fa-solid fa-${badge.icon || 'star'}"></i>`;
                }

                bEl.innerHTML = `
                    <div class="ms-icon-box ${colorClass}" style="border-radius: ${shape};">
                        ${iconHtml}
                    </div>
                    <div class="ms-label">${badge.title}</div>
                `;
                
                // Click Event
                bEl.onclick = () => {
                   if (bEl.classList.contains('locked') || bEl.classList.contains('teaser')) {
                       // Reject animation is handled by CSS :active
                       return;
                   }
                   openMilestoneModal(badge);
                };

                // Celebration Trigger
                if (badge.is_new) {
                    // Observe this element
                    observeForCelebration(bEl, badge);
                }

                scrollDiv.appendChild(bEl);
            });

            tierDiv.appendChild(scrollDiv);

            // Lock Overlay (Phase 4)
            if (showOverlay) {
                const overlay = document.createElement('div');
                overlay.className = 'tier-lock-overlay';
                // Unlock animation if just unlocked? (Logic omitted for simplicity, stick to static state first)
                overlay.innerHTML = `
                    <div class="tier-lock-icon"><i class="fa-solid fa-lock"></i></div>
                    <div class="tier-lock-text">Coming Soon</div>
                `;
                // If it's a peek, we might want to click to see overlay? 
                // Specs say "Overlay: Dark black... with Damask pattern". 
                // Implementation: If it's truly locked (not peek), overlay covers all.
                // However, "Peek" means we see half. So overlay should NOT cover the badges in Peek mode.
                // Re-reading specs: "Trigger... Reveal... but ONLY the top 50% (half-peek)".
                // So Overlay is for "Locked" state, Peek is for "Teaser" state.
                // If Peek is active, we do NOT show full overlay, but badges are cut.
                // If logic says "Hide completely" -> standard logic.
                // We only add overlay if it is completely locked but visible? No, usually hidden.
                // Let's assume Overlay is for future "Tap to unlock" or visual flair. 
                // For now, Teaser CSS handles the visual.
            }
            
            area.appendChild(tierDiv);
        }
        
        // Link to full list
        const link = document.createElement('a');
        link.className = 'ms-list-link';
        link.innerText = 'ÂÖ®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥‰∏ÄË¶ß„ÇíË¶ã„Çã';
        // link.onclick = ... (Modal logic if needed)
        area.appendChild(link);
    }
    
    function getTierIdFromCode(code) {
        if(!code) return 1;
        if(code.includes('Beginner')) return 1;
        if(code.includes('Intermediate')) return 2;
        if(code.includes('Advanced')) return 3;
        return 1;
    }

    function openMilestoneModal(badge) {
        document.getElementById('msModalTitle').innerText = badge.title;
        document.getElementById('msModalTier').innerText = badge.tier || '';
        document.getElementById('msModalDesc').innerText = badge.desc || '';
        document.getElementById('msModalTips').innerText = badge.tips || '';
        
        const iconBox = document.getElementById('msModalIconBox');
        iconBox.className = ''; // reset
        iconBox.classList.add('celeb-badge-inner'); // Reuse style
        iconBox.classList.add(badge.color || 'bg-trust');
        iconBox.style.borderRadius = generateWaxShape(); // Random shape for modal too

        const img = document.getElementById('msModalImage');
        const icon = document.getElementById('msModalIcon');
        
        if(badge.icon && badge.icon.includes('.')) {
            img.src = `https://drive.google.com/thumbnail?id=${extractFileId(badge.icon)}&sz=w400`;
            img.style.display = 'block';
            icon.style.display = 'none';
        } else {
            icon.className = `fa-solid fa-${badge.icon || 'star'}`;
            img.style.display = 'none';
            icon.style.display = 'block';
        }

        new bootstrap.Modal(document.getElementById('milestoneModal')).show();
    }

    // --- Celebration Logic (Phase 4) ---
    
    function observeForCelebration(element, badge) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    triggerCelebration(badge);
                    observer.unobserve(element);
                    
                    // Mark as seen API
                    markAsSeen(badge.id);
                }
            });
        }, { threshold: 0.6 });
        observer.observe(element);
    }

    function triggerCelebration(badge) {
        const overlay = document.getElementById('celebrationOverlay');
        overlay.style.display = 'block';
        
        // Vibration
        try { navigator.vibrate([100, 50, 100]); } catch(e){}

        // Update Badge in Overlay
        const box = document.getElementById('celebBadgeIconBox');
        box.className = 'celeb-badge-inner ' + (badge.color || 'bg-trust');
        box.style.borderRadius = generateWaxShape();
        
        let content = '';
        if(badge.icon && badge.icon.includes('.')) {
             content = `<img src="https://drive.google.com/thumbnail?id=${extractFileId(badge.icon)}&sz=w400">`;
        } else {
             content = `<i class="fa-solid fa-${badge.icon || 'star'}"></i>`;
        }
        box.innerHTML = content;
        
        document.getElementById('celebBadgeTitle').innerText = badge.title;
        document.getElementById('celebBadgeTier').innerText = badge.tier || 'New Milestone!';

        // Start Animations
        setTimeout(() => { overlay.classList.add('active'); }, 10); // Fade in Sky
        
        // Light Animations
        document.getElementById('celebLightCore').classList.add('anim-light');
        document.getElementById('celebLightRing').classList.add('anim-ring');
        document.getElementById('celebLightOval').classList.add('anim-oval');
        
        // Badge Appear
        setTimeout(() => {
            document.getElementById('celebBadgeContainer').style.opacity = 1;
            document.getElementById('celebBadgeContainer').classList.add('anim-badge-appear');
        }, 1200);

        // Fireworks (Canvas)
        const canvas = document.getElementById('celebFireworksCanvas');
        if(canvas) {
            initFireworks(canvas);
            setTimeout(() => { launchFireworks(9); }, 2500); // 9 shots
        }
    }

    function closeCelebration() {
        const overlay = document.getElementById('celebrationOverlay');
        overlay.classList.remove('active');
        setTimeout(() => { overlay.style.display = 'none'; }, 500);
        if(fireworksLoop) cancelAnimationFrame(fireworksLoop);
    }
    
    function markAsSeen(msId) {
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'markMilestoneSeen',
                dogId: currentDogId,
                milestoneId: msId
            })
        });
    }

    // --- Canvas Fireworks Logic ---
    let particles = [];
    function initFireworks(canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        particles = [];
        fireworksLoop = requestAnimationFrame(updateFireworks);
    }

    function launchFireworks(count) {
        let launched = 0;
        const interval = setInterval(() => {
            createFirework(
                window.innerWidth * 0.2 + Math.random() * window.innerWidth * 0.6,
                window.innerHeight * 0.3 + Math.random() * window.innerHeight * 0.4
            );
            launched++;
            if(launched >= count) clearInterval(interval);
        }, 300);
    }

    function createFirework(x, y) {
        const colors = ['#FFD700', '#F0E68C', '#E6E6FA', '#FFFFFF']; // Gold, Champagne, Silver
        for(let i=0; i<60; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 8,
                vy: (Math.random() - 0.5) * 8,
                alpha: 1,
                color: colors[Math.floor(Math.random() * colors.length)],
                decay: 0.01 + Math.random() * 0.02
            });
        }
    }

    function updateFireworks() {
        const canvas = document.getElementById('celebFireworksCanvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height); // clear

        particles.forEach((p, i) => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.05; // gravity
            p.alpha -= p.decay;
            
            ctx.globalAlpha = p.alpha;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
            ctx.fill();
        });
        
        particles = particles.filter(p => p.alpha > 0);
        if(document.getElementById('celebrationOverlay').style.display === 'block') {
            fireworksLoop = requestAnimationFrame(updateFireworks);
        }
    }

    function extractFileId(url) {
        const m = url.match(/id=([-\w]{25,})/) || url.match(/\/d\/([-\w]{25,})/);
        return m ? m[1] : '';
    }

    // --- Other Fetch Logic ---
    function fetchImages(userId, dogId) {
        // Profile
        fetch(`${GAS_URL}?userId=${userId}&dogId=${dogId}&type=img_profile`)
            .then(r=>r.json()).then(d=>{
                 if(d.image) document.getElementById('dogImgContainer').innerHTML = `<img src="${d.image}" class="dog-img">`;
            });

        // Gallery
        fetch(`${GAS_URL}?userId=${userId}&dogId=${dogId}&type=img_latest`)
            .then(r=>r.json()).then(d=>{
                const g = document.getElementById('photoScroll');
                g.innerHTML = '';
                if(d.images && d.images.length) {
                    d.images.forEach(img => {
                        g.insertAdjacentHTML('beforeend', `<div class="me-2"><img src="${img}" class="photo-item zoomable"></div>`);
                    });
                    mediumZoom('.zoomable', { margin: 24, background: 'rgba(0,0,0,0.8)' });
                } else {
                    g.innerHTML = '<div class="text-muted small ms-3">ÂÜôÁúü„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                }
            });
    }

    function renderChart(id, data, label, color) {
        new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: {
                labels: ['Score', 'Remaining'],
                datasets: [{ data: [data[0], 5 - data[0]], backgroundColor: [color, '#eee'], borderWidth: 0 }]
            },
            options: { cutout: '70%', plugins: { legend: { display: false } } }
        });
        // Center text plugin or overlay could be added, simplified here
    }

    function openProfileModal() { /* ... */ }
    function openMedicalPage() { window.location.href = `medical.html?userId=${currentUserId}&dogId=${currentDogId}`; }
    function openHistoryPdf() { /* ... */ }
    
    function showDogSelectModal(dogs) {
        const body = document.getElementById('dogSelectBody');
        body.innerHTML = '';
        dogs.forEach(d => {
            const btn = document.createElement('button');
            btn.className = 'dog-select-btn';
            btn.innerText = d.name_disp;
            btn.onclick = () => {
                currentDogId = d.id;
                document.getElementById('loadingOverlay').style.opacity = 1;
                document.getElementById('loadingOverlay').style.visibility = 'visible';
                window.location.search = `?dogId=${d.id}`;
            };
            body.appendChild(btn);
        });
        new bootstrap.Modal(document.getElementById('dogSelectModal')).show();
    }
    
    function showError(msg) {
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('errorView').style.display = 'block';
        document.getElementById('errorMsg').innerText = msg;
    }

    // Generate static stars for CSS animation
    function generateStars() {
        const sky = document.getElementById('celebStars');
        for(let i=0; i<30; i++) {
            const s = document.createElement('div');
            s.className = 'twinkling-star';
            s.style.left = Math.random() * 100 + '%';
            s.style.top = Math.random() * 60 + '%';
            s.style.width = Math.random() * 3 + 'px';
            s.style.height = s.style.width;
            s.style.animationDelay = Math.random() * 2 + 's';
            sky.appendChild(s);
        }
    }
  </script>
</body>
</html>
