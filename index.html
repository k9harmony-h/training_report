<!-- index.html（GitHub Pagesで公開中のLIFFエンドポイント） -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>犬画像表示テスト（Base64）</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 12px; }
    .row { margin-bottom: 12px; }
    #preview { max-width: 100%; border: 1px solid #ccc; }
    #log { white-space: pre-wrap; font-family: ui-monospace, monospace; background: #f6f8fa; padding: 8px; border-radius: 6px; }
    .status-ok { color: #0a7; }
    .status-ng { color: #c33; }
  </style>
</head>
<body>
  <h1>犬画像表示テスト（Base64）</h1>

  <div class="row">
    <div class="label"><strong>APIエンドポイント:</strong> GASデプロイURL</div>
    <input id="endpoint" value="https://script.google.com/macros/s/AKfycbzlFbJpqnYLmNWPA6tlO1-JyAnnFLJfxZVYjSPoWkJHViEplc0ZCeDauJU4SSmL3ZBH/exec" style="width:100%;">
  </div>

  <div class="row">
    <div class="label"><strong>dogKey:</strong> A列の dog_unique_key</div>
    <input id="dogKey" placeholder="da12c3a5" style="width:100%;">
  </div>

  <div class="row">
    <button id="loadBtn">画像を読み込む</button>
    <button id="clearBtn">クリア</button>
  </div>

  <div class="row">
    <div><strong>ステータス:</strong> <span id="status" class="status-ng">未実行</span></div>
  </div>

  <div class="row">
    <div><strong>画像プレビュー:</strong></div>
    <img id="preview" alt="プレビュー" />
  </div>

  <div class="row">
    <div><strong>ログ:</strong></div>
    <div id="log"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (msg) => {
      const ts = new Date().toISOString();
      $('log').textContent += `[${ts}] ${msg}\n`;
      console.log(`[${ts}] ${msg}`);
    };
    const setStatus = (ok, text) => {
      const el = $('status');
      el.textContent = text;
      el.className = ok ? 'status-ok' : 'status-ng';
    };

    $('loadBtn').addEventListener('click', async () => {
      const endpoint = $('endpoint').value.trim();
      const dogKey = $('dogKey').value.trim();
      if (!endpoint) { setStatus(false, 'endpoint未設定'); log('ERROR: endpoint未設定'); return; }
      if (!dogKey) { setStatus(false, 'dogKey未入力'); log('ERROR: dogKey未入力'); return; }

      const url = `${endpoint}?dogKey=${encodeURIComponent(dogKey)}`;
      log(`REQUEST: ${url}`);

      try {
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        const ct = res.headers.get('content-type') || '';
        log(`HTTP: ${res.status} ${res.statusText} content-type=${ct}`);
        const data = await res.json();

        if (!data.ok) {
          setStatus(false, `失敗: ${data.reason}`);
          log(`FAIL: reason=${data.reason} message=${data.message || ''} detail=${JSON.stringify(data.detail || {})}`);
          return;
        }

        if (!data.base64 || !data.mimeType) {
          setStatus(false, '失敗: base64レスポンス不備');
          log(`FAIL: base64 or mimeType missing`);
          return;
        }

        const src = `data:${data.mimeType};base64,${data.base64}`;
        $('preview').src = src;
        setStatus(true, `成功: ${data.mimeType} ${data.bytes} bytes`);
        log(`SUCCESS: set img src (bytes=${data.bytes}) meta=${JSON.stringify(data.meta || {})}`);
      } catch (err) {
        setStatus(false, '例外: fetch失敗');
        log(`EXCEPTION: ${err.message}`);
      }
    });

    $('clearBtn').addEventListener('click', () => {
      $('preview').src = '';
      $('log').textContent = '';
      setStatus(false, 'クリア');
    });
  </script>
</body>
</html>
