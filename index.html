<!-- 省略された<head>部分はそのままでOK。以下は<body>以降の主要部分 -->

<script>
  const LIFF_ID     = '2008546673-MJY7j3ox'; 
  const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxG1rLg6t_jlBWy4KTFqVPYmRK-aEleUQR_yqCiNwsWhvDp7I-suBEsYnDHymVNmURO/exec';

  async function main() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      fetchData(profile.userId);
    } catch (err) {
      alert('Start Error: ' + err.message);
    }
  }

  function fetchData(userId) {
    fetch(`${GAS_API_URL}?userId=${userId}`)
      .then(res => res.json())
      .then(data => render(data, userId))
      .catch(err => alert('Network Error: ' + err));
  }

  function formatDate(dateString) {
    if (!dateString) return '--/--/--';
    const d = new Date(dateString);
    if (isNaN(d.getTime())) return dateString;
    const year = d.getFullYear().toString().slice(-2);
    const month = ('0' + (d.getMonth() + 1)).slice(-2);
    const day = ('0' + d.getDate()).slice(-2);
    return `${year}/${month}/${day}`;
  }

  function render(data, currentUserId) {
    document.getElementById('loading').style.display = 'none';

    if (data.error === 'Unregistered') {
      document.getElementById('errorView').style.display = 'block';
      document.getElementById('userIdDisplay').value = currentUserId;
      return;
    }

    if (data.error) {
      alert('System Error: ' + data.error);
      return;
    }

    document.getElementById('mainContent').style.display = 'block';

    const c = data.customer || {};
    const d = data.dog || {};
    document.getElementById('custName').innerText = c.name + " 様";
    document.getElementById('dogName').innerText = d.name || "Your Dog";

    if (d.photo && d.photo.startsWith('http')) {
      document.getElementById('dogImg').src = d.photo;
    }

    if (d.birth_date && d.name) {
      checkBirthday(d.birth_date, d.name);
    }

    document.getElementById('ticketCount').innerText = data.ticket_count ?? "-";

    const l = data.latest;
    if (l) {
      document.getElementById('lessonDate').innerText = formatDate(l.date);
      document.getElementById('goalText').innerText = l.goal || 'なし';
      document.getElementById('doneText').innerText = l.done || 'なし';
      document.getElementById('unableText').innerText = l.unable || 'なし';
      document.getElementById('homeworkText').innerText = l.homework || 'なし';
      document.getElementById('trainerComment').innerText = l.comment || 'なし';
      document.getElementById('trainerName').innerText = l.trainer_name || 'Staff';

      const d1 = l.details.slice(0, 5).filter(t => t).map((t, i) => `[${i+1}] ${t}`).join('<br>');
      document.getElementById('detail1').innerHTML = d1 || '特になし';
      const d2 = l.details.slice(5, 10).filter(t => t).map((t, i) => `[${i+6}] ${t}`).join('<br>');
      document.getElementById('detail2').innerHTML = d2 || '特になし';

      if (l.scores && l.scores.length >= 10) {
        renderChart('chart1', l.scores.slice(0, 5), ['指示理解','ボディラン','報酬','集中力','コンタクト']);
        renderChart('chart2', l.scores.slice(5, 10), ['指示出し','ボディラン','リード','対応力','コンタクト']);
      }

      const pArea = document.getElementById('photoArea');
      pArea.innerHTML = '';
      if (l.photos && l.photos.length > 0) {
        l.photos.forEach(url => {
          if(url && url.startsWith('http')) {
            const img = document.createElement('img');
            img.src = url;
            img.className = 'photo-item';
            pArea.appendChild(img);
          }
        });
      } else {
        pArea.innerHTML = '<div class="text-muted small ms-3">写真はありません</div>';
      }
    } else {
      document.getElementById('lessonDate').innerText = 'データなし';
    }
  }

  function checkBirthday(birthDateStr, name) {
    const today = new Date();
    const bDate = new Date(birthDateStr);
    bDate.setFullYear(today.getFullYear());
    const diffTime = bDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (Math.abs(diffDays) <= 14) {
      document.getElementById('bdName').innerText = name;
      document.getElementById('birthdayMsg').style.display = 'block';
    }
  }

  function renderChart(canvasId, dataPoints, labels) {
    new Chart(document.getElementById(canvasId), {
      type: 'radar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Score',
          data: dataPoints,
          backgroundColor: 'rgba(87, 195, 194, 0.2)',
          borderColor: '#57C3C2',
          borderWidth: 2,
          pointBackgroundColor: '#57C3C2',
          pointRadius: 2
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          r: {
            min: 0, max: 5,
            ticks: { stepSize: 1, display: false },
            pointLabels: { font: { size: 9 }, color: '#555' }
          }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  function copyId() {
    const el = document.getElementById('userIdDisplay');
    el.select();
    navigator.clipboard.writeText(el.value);
    alert('コピーしました');
  }

  main();
</script>
