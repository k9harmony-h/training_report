<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>レッスン履歴 | K9 Harmony</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,600;1,700&family=Lato:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --c-main-turquoise: #57C3C2; --c-sub-deep-ocean: #2F5D62; --c-accent-copper: #C87A56;
            --c-base-washi: #FAFAFA; --c-bg-mist: #F4F7F7; --c-text-sumi: #333333;
            --font-serif-en: 'Cormorant Garamond', serif; --font-serif-jp: 'Noto Serif JP', serif;
            --font-sans-jp: 'Noto Sans JP', sans-serif; --ease-luxury: cubic-bezier(0.25, 0.1, 0.25, 1.0);
        }

        body { font-family: var(--font-sans-jp); background-color: var(--c-base-washi); color: var(--c-text-sumi); line-height: 1.8; padding-bottom: 80px; }

        /* Mastery Seal (Chrono-Seal) */
        .mastery-seal {
            width: 36px; height: 36px; border-radius: 50%; position: relative; overflow: hidden;
            display: inline-flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;
            background-color: #e8eeee; box-shadow: inset 2px 2px 4px rgba(0,0,0,0.08);
        }
        .mastery-seal.acquired {
            /* ギョーシェ彫り: 密度を上げて視認性を向上 */
            background: repeating-radial-gradient(circle, #ced4d4 0, #ced4d4 0.5px, #e2e8e8 0.5px, #e2e8e8 1.5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1), inset 0 0 8px rgba(255,255,255,0.5);
            border: 0.5px solid rgba(0,0,0,0.1);
        }
        .mastery-seal.acquired::before, .mastery-seal.acquired::after {
            content: ''; position: absolute; inset: -150%; pointer-events: none;
        }
        .mastery-seal.acquired::before {
            background: linear-gradient(135deg, transparent 45%, rgba(255,255,255,0.9) 50%, transparent 55%);
            z-index: 2; transform: translate(var(--posA, -100%), var(--posA, -100%));
        }
        .mastery-seal.acquired::after {
            background: linear-gradient(45deg, transparent 40%, rgba(250, 235, 215, 0.4) 50%, transparent 60%);
            z-index: 1; transform: translate(var(--posB, -100%), var(--posB, -100%));
        }

        .seal-number {
            font-family: var(--font-serif-en); font-style: italic; font-weight: 700; font-size: 1.15rem;
            position: relative; z-index: 3; color: transparent; -webkit-text-stroke: 0.8px rgba(0,0,0,0.15);
        }
        .acquired .seal-number {
            color: var(--c-sub-deep-ocean); -webkit-text-stroke: 1px rgba(255,255,255,0.6); /* 袋文字の強化 */
        }

        .chart-card { background: #fff; border-radius: 12px; margin: 20px; padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.04); }
        .chart-header { display: flex; align-items: center; margin-bottom: 15px; }
        .chart-title { font-family: var(--font-serif-jp); font-weight: 600; color: var(--c-sub-deep-ocean); font-size: 1rem; margin: 0; }
        
        /* グラフの高さを200pxに固定 */
        .chart-container { position: relative; height: 200px; width: 100%; }

        .dog-profile-large { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 3px solid var(--c-main-turquoise); background: #eee; }
        .section-title { font-family: var(--font-serif-jp); color: var(--c-sub-deep-ocean); margin: 40px 20px 15px; border-left: 3px solid var(--c-main-turquoise); padding-left: 12px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="text-center"><div class="spinner-border text-info mb-3"></div><p>Loading Archives...</p></div></div>

    <div id="mainWrapper">
        <div class="text-center py-4 bg-white border-bottom position-relative">
            <a href="index.html" class="position-absolute start-0 top-0 p-4 text-decoration-none text-dark" style="font-weight:700;">&lt;</a>
            <img id="dogProfileImg" src="" class="dog-profile-large" alt="Profile">
            <h1 id="dogNameTitle" class="mt-3 h5 fw-bold text-secondary">---</h1>
        </div>

        <div id="performanceArea"></div>

        <h3 class="section-title">Gallery</h3>
        <div id="mainGalleryContainer" class="d-flex overflow-auto gap-2 px-3 pb-3"></div>

        <h3 class="section-title">History Logs</h3>
        <div id="lessonList"></div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';
        const scoreLabels = ['指示理解', '集中力', '報酬', 'ボディ', 'コンタクト', '指示出し', '対応力', 'リード', 'ボディ', 'コンタクト'];

        window.addEventListener('scroll', () => {
            const scrollPercent = window.scrollY / (document.documentElement.scrollHeight - window.innerHeight);
            document.querySelectorAll('.mastery-seal.acquired').forEach((seal, idx) => {
                seal.style.setProperty('--posA', `${(scrollPercent * 240) - 120 + (idx * 5)}%`);
                seal.style.setProperty('--posB', `${(scrollPercent * 180) - 90}%`);
            });
        });

        async function init() {
            await liff.init({ liffId: '2008546673-MJY7j3ox' });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            const dogId = new URLSearchParams(window.location.search).get('dogId');
            
            fetch(`${GAS_URL}?userId=${profile.userId}&dogId=${dogId || ''}`)
                .then(res => res.json())
                .then(data => {
                    const dog = data.dog || {};
                    const history = data.score_history || [];
                    
                    // 画像の読み込み（複数のパス候補に対応）
                    const profileImg = document.getElementById('dogProfileImg');
                    profileImg.src = dog.img || dog.img_url || 'https://via.placeholder.com/150?text=K9';
                    document.getElementById('dogNameTitle').innerText = `${dog.name_disp || 'Partner'}'s Archives`;

                    // マスタリー判定（直近3回が全て5点）
                    const mastered = [];
                    if (history.length >= 3) {
                        const recent = history.slice(-3);
                        for(let i=0; i<10; i++) {
                            if(recent.every(h => Number(h.scores[i]) === 5)) mastered.push(i);
                        }
                    }

                    // グラフ描画
                    const perfArea = document.getElementById('performanceArea');
                    const chartHistory = [...history].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-8);

                    for(let i=0; i<10; i++) {
                        const isAcquired = mastered.includes(i);
                        perfArea.insertAdjacentHTML('beforeend', `
                            <div class="chart-card">
                                <div class="chart-header">
                                    <div class="mastery-seal ${isAcquired?'acquired':''}">
                                        <span class="seal-number">${i+1}</span>
                                    </div>
                                    <h4 class="chart-title">${scoreLabels[i]}</h4>
                                </div>
                                <div class="chart-container"><canvas id="chart-${i}"></canvas></div>
                            </div>
                        `);
                        new Chart(document.getElementById(`chart-${i}`), {
                            type: 'line',
                            data: {
                                labels: chartHistory.map(h => h.date.split('/').slice(1).join('/')),
                                datasets: [{
                                    data: chartHistory.map(h => h.scores[i]),
                                    borderColor: i < 5 ? '#57C3C2' : '#2F5D62',
                                    backgroundColor: 'rgba(87, 195, 194, 0.1)',
                                    fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: { y: { min: 0, max: 5, ticks: { stepSize: 1 } }, x: { grid: { display: false } } },
                                plugins: { legend: { display: false } }
                            }
                        });
                    }

                    // ギャラリー（画像URLの配列を想定）
                    const gal = document.getElementById('mainGalleryContainer');
                    const images = data.latest?.images || [];
                    if(images.length) {
                        images.forEach(src => {
                            gal.insertAdjacentHTML('beforeend', `<img src="${src}" class="zoomable rounded" style="height:120px; object-fit:cover;">`);
                        });
                        mediumZoom('.zoomable');
                    } else {
                        gal.innerHTML = '<p class="small text-muted ms-3">No recent photos available.</p>';
                    }

                    // ログ
                    const list = document.getElementById('lessonList');
                    history.forEach(h => {
                        list.insertAdjacentHTML('beforeend', `
                            <div class="list-group-item bg-white m-3 p-3 rounded shadow-sm">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span class="fw-bold">${h.date}</span>
                                    <span class="text-info">Score Avg: ${(h.scores.reduce((a,b)=>Number(a)+Number(b),0)/10).toFixed(1)}</span>
                                </div>
                                <div class="small text-muted text-truncate">${h.comment || ''}</div>
                            </div>
                        `);
                    });

                    document.body.classList.add('loaded');
                });
        }
        init();
    </script>
</body>
</html>
