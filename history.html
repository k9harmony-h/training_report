<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レッスン履歴</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-color: #57C3C2;
            --text-main: #333333;
        }
        body {
            font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
            background-color: #fafafa;
            color: var(--text-main);
            padding-bottom: 80px;
        }
        .header-area { 
            background: #fff; padding: 20px 20px 10px; border-bottom: 1px solid #eee;
        }
        .brand-title { color: var(--text-main); font-weight: 700; letter-spacing: 0.05em; font-size: 1.2rem; text-align: center; }
        .back-link { 
            color: var(--brand-color); font-weight: bold; text-decoration: none; display: block; margin-top: 10px;
        }
        .content-container { padding: 0 15px; }
        
        /* グラフ描画はしないため、CSSは最小限に */
        
        /* レッスン一覧 */
        .lesson-list { margin-top: 30px; }
        .list-group-item { 
            border: none; margin-bottom: 8px; border-radius: 8px;
            background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .list-header { font-weight: 700; color: var(--brand-color); }
        .list-date { font-size: 0.85rem; color: #888; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--brand-color); display: flex; justify-content: center; align-items: center;
            z-index: 9999; color: white;
        }
        .spinner-border-white { border-color: white; border-right-color: transparent; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border spinner-border-white" role="status"></div>
    </div>

    <div class="header-area">
        <div class="d-flex justify-content-between align-items-center">
            <a href="index.html" class="back-link">&lt; 戻る</a>
            <h1 class="brand-title">レッスン履歴</h1>
        </div>
        <h2 id="dogNameTitle" class="text-center mt-2" style="font-size: 1.5rem; font-weight: 600;">---</h2>
    </div>

    <div class="content-container py-3">
        
        <p class="text-muted small text-center mt-3">過去のレッスン評価の推移です。</p>
        
        <div id="chartArea">
            <div class="text-center text-muted small mt-4">（デバッグ中：グラフ描画は一時停止しています）</div>
        </div>

        <div class="lesson-list">
            <h3 class="section-title" style="font-size: 1.2rem; color: #555;">過去のレッスン一覧</h3>
            <div id="lessonList" class="list-group">
                <div class="text-center text-muted small mt-4">履歴がありません。</div>
            </div>
        </div>

    </div>

    <script>
        // LIFF IDとGAS URLはindex.htmlと同じものを設定
        const LIFF_ID = '2008546673-MJY7j3ox'; 
        // ユーザー情報から取得したGAS URLを使用
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec'; 
        
        // グラフ関連の変数は使用しない
        // const scoreLabels = [...]
        // const chartColors = [...]

        window.onload = function() {
            main();
        };

        async function main() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return; 
                }
                const profile = await liff.getProfile();
                console.log('LIFF Success. User ID:', profile.userId); 
                fetchData(profile.userId);
            } catch (err) {
                console.error('LIFF/Init Error:', err);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('アプリの起動エラーが発生しました。コンソールを確認してください。');
            }
        }

        function fetchData(userId) {
            const url = `${GAS_URL}?userId=${userId}&t=${new Date().getTime()}`;
            console.log('--- Fetching Data ---');
            console.log('Request URL:', url);
            
            fetch(url)
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => {
                            console.error('Fetch HTTP Error Status:', res.status);
                            console.error('Fetch HTTP Error Response Text:', text);
                            throw new Error(`HTTP error! status: ${res.status}`);
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Fetch Success! Data:', data);
                    renderHistory(data);
                })
                .catch(err => {
                    console.error('Fetch/GAS Error Details:', err);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    alert('データ取得エラーが発生しました。コンソールで詳細を確認してください。Load failed');
                });
        }

        // ★★★ 最小機能の renderHistory 関数 ★★★
        function renderHistory(data) {
            document.getElementById('loadingOverlay').style.display = 'none';
            const lessonList = document.getElementById('lessonList');
            lessonList.innerHTML = ''; // リストエリアをクリア

            // 1. 犬の名前を表示
            const dogData = data.dog || {}; 
            const dogName = dogData.name || '愛犬';
            // 敬称は、デバッグのため一旦「(名前を表示できた)」という文字列にする
            document.getElementById('dogNameTitle').innerText = dogName + ' (名前を表示できた) のレッスン履歴';

            // 2. データがない場合の処理
            if (data.error || !data.score_history || data.score_history.length < 1) {
                lessonList.innerHTML = `<div class="text-center text-muted small mt-4">履歴がありません。（データなし）</div>`;
                return;
            }

            // 3. 過去のレッスン一覧を表示
            const history = data.score_history;
            
            history.reverse().forEach(h => {
                 const listItem = `
                    <a href="index.html?date=${h.date}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between list-header">
                            レッスン日: ${h.date}
                            <span class="list-date">データ取得成功</span>
                        </div>
                        <p class="mb-0 small text-muted">タップで詳細を表示 (未実装)</p>
                    </a>
                `;
                lessonList.insertAdjacentHTML('beforeend', listItem);
            });
        }
    </script>
</body>
</html>
