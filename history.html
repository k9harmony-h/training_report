<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レッスン履歴</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-color: #57C3C2;
            --text-main: #333333;
        }
        body {
            font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
            background-color: #fafafa;
            color: var(--text-main);
            padding-bottom: 80px;
        }
        .header-area { 
            background: #fff; padding: 20px 20px 10px; border-bottom: 1px solid #eee;
        }
        .brand-title { color: var(--text-main); font-weight: 700; letter-spacing: 0.05em; font-size: 1.2rem; text-align: center; }
        .back-link { 
            color: var(--brand-color); font-weight: bold; text-decoration: none; display: block; margin-top: 10px;
        }
        .content-container { padding: 0 15px; }
        
        /* 履歴表示用スタイル */
        .score-history-card {
            background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-top: 20px; padding: 15px;
        }
        .score-title { font-size: 1.1rem; font-weight: 700; color: var(--brand-color); margin-bottom: 5px; }
        .score-list-item { 
            display: block; padding: 5px 0; border-bottom: 1px dashed #eee; font-size: 1rem;
        }
        .score-list-item:last-child { border-bottom: none; }
        
        /* レッスン一覧 */
        .lesson-list { margin-top: 30px; }
        .list-group-item { 
            border: none; margin-bottom: 8px; border-radius: 8px;
            background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .list-header { font-weight: 700; color: var(--brand-color); }
        .list-date { font-size: 0.85rem; color: #888; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--brand-color); display: flex; justify-content: center; align-items: center;
            z-index: 9999; color: white;
        }
        .spinner-border-white { border-color: white; border-right-color: transparent; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border spinner-border-white" role="status"></div>
    </div>

    <div class="header-area">
        <div class="d-flex justify-content-between align-items-center">
            <a href="index.html" class="back-link">&lt; 戻る</a>
            <h1 class="brand-title">レッスン履歴</h1>
        </div>
        <h2 id="dogNameTitle" class="text-center mt-2" style="font-size: 1.5rem; font-weight: 600;">---</h2>
    </div>

    <div class="content-container py-3">
        
        <p class="text-muted small text-center mt-3">各項目のスコア履歴です。</p>
        
        <div id="chartArea" class="row">
            </div>
        <div class="lesson-list">
            <h3 class="section-title" style="font-size: 1.2rem; color: #555;">過去のレッスン日一覧</h3>
            <div id="lessonList" class="list-group">
                <div class="text-center text-muted small mt-4">履歴がありません。</div>
            </div>
        </div>

    </div>

    <script>
        // LIFF IDとGAS URLはindex.htmlと同じものを設定
        const LIFF_ID = '2008546673-MJY7j3ox'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJ2j7iNeojVPB8SeRozbh9WIH0CLkwb8Q67300WK2ydsxt8nKdZmLbNQq1Wuu9zX0/exec'; 
        
        // ★ スコア項目のラベルを定義（グラフ描画時にも使用） ★
        const scoreLabels = [
            '指示理解', '集中力', '報酬', 'ボディ', 'コンタクト',
            '指示出し', '対応力', 'リード', 'ボディ', 'コンタクト'
        ];

        window.onload = function() {
            main();
        };

        async function main() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return; 
                }
                const profile = await liff.getProfile();
                console.log('LIFF Success. User ID:', profile.userId); 
                fetchData(profile.userId);
            } catch (err) {
                console.error('LIFF/Init Error:', err);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('アプリの起動エラーが発生しました。コンソールを確認してください。');
            }
        }

        function fetchData(userId) {
            const url = `${GAS_URL}?userId=${userId}&t=${new Date().getTime()}`;
            console.log('--- Fetching Data ---');
            console.log('Request URL:', url);
            
            fetch(url)
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => {
                            console.error('Fetch HTTP Error Status:', res.status);
                            console.error('Fetch HTTP Error Response Text:', text);
                            throw new Error(`HTTP error! status: ${res.status}`);
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Fetch Success! Data:', data);
                    renderHistory(data);
                })
                .catch(err => {
                    console.error('Fetch/GAS Error Details:', err);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    alert('データ取得エラーが発生しました。コンソールで詳細を確認してください。Load failed');
                });
        }

        // ★ 修正点 2: スコア履歴表示ロジックの追加 ★
        function renderHistory(data) {
            document.getElementById('loadingOverlay').style.display = 'none';
            const chartArea = document.getElementById('chartArea');
            const lessonList = document.getElementById('lessonList');
            
            chartArea.innerHTML = ''; 
            lessonList.innerHTML = ''; 

            // 1. 犬の名前を表示
            const dogData = data.dog || {}; 
            const dogName = dogData.name || '愛犬';
            document.getElementById('dogNameTitle').innerText = dogName + 'ちゃん/くん のレッスン履歴';

            // 2. データがない場合の処理
            if (data.error || !data.score_history || data.score_history.length < 1) {
                chartArea.innerHTML = `<div class="text-center text-muted small mt-4">まだレッスン履歴がありません。</div>`;
                lessonList.innerHTML = `<div class="text-center text-muted small mt-4">履歴がありません。</div>`;
                return;
            }

            const history = data.score_history;
            const dates = history.map(h => h.date); // 日付リスト
            
            // 3. 10項目分のスコア履歴を表示
            for (let i = 0; i < 10; i++) {
                const itemLabel = scoreLabels[i];
                
                // 全履歴から i 番目のスコアを抽出 (例: scores[0] = Score_1 の全履歴)
                const scores = history.map(h => h.scores[i]);
                
                // スコアリストのHTMLを作成
                let scoreListHtml = scores.map((score, index) => {
                    return `<span class="score-list-item">(${dates[index]}) スコア: ${score}</span>`;
                }).join('');

                const cardHtml = `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="score-history-card">
                            <h4 class="score-title">[${i + 1}] ${itemLabel}</h4>
                            <div class="score-list">
                                ${scoreListHtml}
                            </div>
                        </div>
                    </div>
                `;
                chartArea.insertAdjacentHTML('beforeend', cardHtml);
            }

            // 4. 過去のレッスン日一覧を表示 (前回成功したロジック)
            history.reverse().forEach(h => {
                 const listItem = `
                    <a href="index.html?date=${h.date}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between list-header">
                            レッスン日: ${h.date}
                            <span class="list-date">スコア確認済</span>
                        </div>
                        <p class="mb-0 small text-muted">タップで詳細を表示 (未実装)</p>
                    </a>
                `;
                lessonList.insertAdjacentHTML('beforeend', listItem);
            });
        }
    </script>
</body>
</html>
