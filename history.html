<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ãƒƒã‚¹ãƒ³ã®å±¥æ­´</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-color: #57C3C2;
            --text-main: #333333;
        }
        body {
            font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
            background-color: #fafafa;
            color: var(--text-main);
            padding-bottom: 80px;
        }
        .header-area { 
            background: #fff; padding: 20px 20px 10px; border-bottom: 1px solid #eee;
        }
        .brand-title { color: var(--text-main); font-weight: 700; letter-spacing: 0.05em; font-size: 1.2rem; text-align: center; }
        .back-link { 
            color: var(--brand-color); font-weight: bold; text-decoration: none; display: block; margin-top: 10px;
        }
        .content-container { padding: 0 15px; }
        
        /* ã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ */
        .chart-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-top: 20px;
            padding: 15px;
        }
        .chart-title { 
            font-size: 1.1rem; font-weight: 700; color: var(--brand-color); margin-bottom: 5px; 
        }
        .chart-meta {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .chart-status {
            font-size: 0.9rem; font-weight: 600;
        }
        /* æ¯”è¼ƒã‚³ãƒ¡ãƒ³ãƒˆè‰² */
        .status-great { color: #FF6B6B; } /* ç´ æ™´ã‚‰ã—ã„ */
        .status-steady { color: #555555; } /* ã˜ã£ãã‚Š */
        .status-slow { color: #3A89FF; } /* ã‚†ã£ãã‚Š */
        
        /* ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§ */
        .lesson-list { margin-top: 30px; }
        .list-group-item { 
            border: none; margin-bottom: 8px; border-radius: 8px;
            background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .list-header { font-weight: 700; color: var(--brand-color); }
        .list-date { font-size: 0.85rem; color: #888; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--brand-color); display: flex; justify-content: center; align-items: center;
            z-index: 9999; color: white;
        }
        .spinner-border-white { border-color: white; border-right-color: transparent; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border spinner-border-white" role="status"></div>
    </div>

    <div class="header-area">
        <div class="d-flex justify-content-between align-items-center">
            <a href="index.html" class="back-link">&lt; æˆ»ã‚‹</a>
            <h1 class="brand-title">ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´</h1>
        </div>
        <h2 id="dogNameTitle" class="text-center mt-2" style="font-size: 1.5rem; font-weight: 600;">---</h2>
    </div>
11292002
    <div class="content-container py-3">
        
        <p class="text-muted small text-center mt-3">éå»ã®ãƒ¬ãƒƒã‚¹ãƒ³è©•ä¾¡ã®æ¨ç§»ã§ã™ã€‚</p>
        
        <div id="chartArea">
            </div>

        <div class="lesson-list">
            <h3 class="section-title" style="font-size: 1.2rem; color: #555;">éå»ã®ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§</h3>
            <div id="lessonList" class="list-group">
                <div class="text-center text-muted small mt-4">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
            </div>
        </div>

    </div>

    <script>
        // LIFF IDã¨GAS URLã¯index.htmlã¨åŒã˜ã‚‚ã®ã‚’è¨­å®š
        const LIFF_ID = '2008546673-MJY7j3ox'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzheC-9sqA4TjIRD3mYYZlbhU7HAkpg2eis2YR9saNZqPCn_aklmjchErKRKyAfEhgA/exec'; // â˜…ãƒ¡ã‚¤ãƒ³GAS URLâ˜…
        
        const scoreLabels = [
            'æŒ‡ç¤ºç†è§£', 'é›†ä¸­åŠ›', 'å ±é…¬', 'ãƒœãƒ‡ã‚£', 'ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ', // 1-5 (åŸºç¤ãƒ»é›†ä¸­)
            'æŒ‡ç¤ºå‡ºã—', 'å¯¾å¿œåŠ›', 'ãƒªãƒ¼ãƒ‰', 'ãƒœãƒ‡ã‚£', 'ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ'  // 6-10 (å¿œç”¨ãƒ»å¯¾å¿œ)
        ];
        const chartColors = [
            'rgba(255, 99, 132, 1)', 'rgba(255, 159, 64, 1)', 'rgba(255, 205, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(54, 162, 235, 1)',
            'rgba(153, 102, 255, 1)', 'rgba(201, 203, 207, 1)', 'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)'
        ];

        window.onload = function() {
            main();
        };

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                fetchData(profile.userId);
            } catch (err) {
                alert('LIFF Error: ' + err);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function fetchData(userId) {
            fetch(`${GAS_URL}?userId=${userId}&t=${new Date().getTime()}`)
                .then(res => res.json())
                .then(data => renderHistory(data))
                .catch(err => {
                    alert('Network Error: ' + err);
                    document.getElementById('loadingOverlay').style.display = 'none';
                });
        }

//        function renderHistory(data) {
            document.getElementById('loadingOverlay').style.display = 'none';

            if (data.error || !data.score_history || data.score_history.length === 0) {
                document.getElementById('dogNameTitle').innerText = data.dog ? data.dog.name : 'å±¥æ­´ãªã—';
                return;
            }

            const history = data.score_history;
            document.getElementById('dogNameTitle').innerText = data.dog.name + ' ã®ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´';
            
            // 1. 10å€‹ã®ã‚°ãƒ©ãƒ•ã‚’å‹•çš„ã«ç”Ÿæˆ
            const chartArea = document.getElementById('chartArea');

            for (let i = 0; i < 10; i++) {
                const itemLabel = scoreLabels[i];
                const color = chartColors[i];
                
                // éå»ã®ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º (score_1ãªã‚‰ scores[0], score_2ãªã‚‰ scores[1]...)
                const scores = history.map(h => h.scores[i]);
                const dates = history.map(h => h.date);

                // å‰å›ã‚¹ã‚³ã‚¢ã¨ã®æ¯”è¼ƒ
                const latestScore = scores[scores.length - 1];
                const previousScore = scores.length > 1 ? scores[scores.length - 2] : null;
                
                let comparisonText = '';
                let comparisonClass = '';
                let specialComment = '';

                // æº€ç‚¹ã‚³ãƒ¡ãƒ³ãƒˆ
                if (latestScore === 5) {
                    specialComment = 'â­ï¸ğŸ¶â­ï¸';
                }

                // å‰å›æ¯”è¼ƒã‚³ãƒ¡ãƒ³ãƒˆ
                if (previousScore !== null) {
                    const diff = latestScore - previousScore;
                    if (diff >= 1) {
                        comparisonText = 'ç´ æ™´ã‚‰ã—ã„ï¼æˆé•·ã—ã¦ã¾ã™ğŸ¶';
                        comparisonClass = 'status-great';
                    } else if (diff === 0) {
                        comparisonText = 'ã˜ã£ãã‚Šé ‘å¼µã£ã¦ã¾ã™ğŸ¶';
                        comparisonClass = 'status-steady';
                    } else if (diff <= -1) {
                        comparisonText = 'ã‚†ã£ãã‚Šã„ãã¾ã—ã‚‡ã†ğŸ¶';
                        comparisonClass = 'status-slow';
                    }
                } else {
                    comparisonText = 'åˆå›è©•ä¾¡ã§ã™ï¼';
                    comparisonClass = 'status-steady';
                }

function renderHistory(data) {
    document.getElementById('loadingOverlay').style.display = 'none';

    // æ•¬ç§°ã®åˆ¤å®šã¨è¨­å®š
    const dogName = data.dog ? data.dog.name : 'Your Dog';
    // â€» æ€§åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒGASã‹ã‚‰æ¸¡ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã“ã“ã§ã¯ä»®ã«æ€§åˆ¥ã‚’åˆ¤æ–­ã§ãã¾ã›ã‚“ã€‚
    //    GASã‹ã‚‰æ€§åˆ¥ãƒ‡ãƒ¼ã‚¿(ä¾‹: data.dog.gender)ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹å‰æã§ã€ä»¥ä¸‹ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã‚“ã§ã„ã¾ã™ã€‚
    //    ä»Šå›ã¯ã€GASã®ã€ŒçŠ¬æƒ…å ±ã€ã‚·ãƒ¼ãƒˆã« `dog_gender` ã®åˆ—ãŒã‚ã‚Šã€'ã‚ªã‚¹'/'ãƒ¡ã‚¹'ãŒå…¥ã‚‹ã¨ä»®å®šã—ã¾ã™ã€‚
    //    ä»Šå›ã¯ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ä¸€æ—¦ã€Œãã‚“ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¾ã™ã€‚
    const honorific = data.dog && data.dog.gender === 'ãƒ¡ã‚¹' ? 'ã¡ã‚ƒã‚“' : 'ãã‚“'; 
    
    document.getElementById('dogNameTitle').innerText = dogName + honorific + ' ã®ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´';

    // â˜…â˜…â˜… ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®æ¡ä»¶ã‚’ä¿®æ­£ã—ã€ã‚°ãƒ©ãƒ•æç”»å‡¦ç†ã‚’ç¢ºå®Ÿã«è¡Œã† â˜…â˜…â˜…
    if (!data.score_history || data.score_history.length < 1) {
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        document.getElementById('chartArea').innerHTML = `
            <div class="text-center text-muted small mt-4">
                ã¾ã ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¬¡å›ã®ãƒ¬ãƒƒã‚¹ãƒ³å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </div>
        `;
        document.getElementById('lessonList').innerHTML = `<div class="text-center text-muted small mt-4">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
    }

    const history = data.score_history;
    const chartArea = document.getElementById('chartArea');
    chartArea.innerHTML = ''; // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
    
    // ... (ä»¥ä¸‹ã€ã‚°ãƒ©ãƒ•æç”»ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›æç¤ºã—ãŸå†…å®¹ã¨åŸºæœ¬çš„ã«åŒã˜) ...
    // ... (ã‚°ãƒ©ãƒ•æç”»ãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥ã›ãšã«ä¸‹éƒ¨ã«è¨˜è¼‰ã—ã¾ã™) ...

    for (let i = 0; i < 10; i++) {
        const itemLabel = scoreLabels[i];
        const color = chartColors[i];
        
        // éå»ã®ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º (score_1ãªã‚‰ scores[0], score_2ãªã‚‰ scores[1]...)
        const scores = history.map(h => h.scores[i]);
        const dates = history.map(h => h.date);

        // å‰å›ã‚¹ã‚³ã‚¢ã¨ã®æ¯”è¼ƒ
        const latestScore = scores[scores.length - 1];
        const previousScore = scores.length > 1 ? scores[scores.length - 2] : null;
        
        let comparisonText = '';
        let comparisonClass = '';
        let specialComment = '';

        // æº€ç‚¹ã‚³ãƒ¡ãƒ³ãƒˆ
        if (latestScore === 5) {
            specialComment = 'â­ï¸ğŸ¶â­ï¸';
        }

        // å‰å›æ¯”è¼ƒã‚³ãƒ¡ãƒ³ãƒˆ
        if (previousScore !== null) {
            const diff = latestScore - previousScore;
            if (diff >= 1) {
                comparisonText = 'ç´ æ™´ã‚‰ã—ã„ï¼æˆé•·ã—ã¦ã¾ã™ğŸ¶';
                comparisonClass = 'status-great';
            } else if (diff === 0) {
                comparisonText = 'ã˜ã£ãã‚Šé ‘å¼µã£ã¦ã¾ã™ğŸ¶';
                comparisonClass = 'status-steady';
            } else if (diff <= -1) {
                comparisonText = 'ã‚†ã£ãã‚Šã„ãã¾ã—ã‚‡ã†ğŸ¶';
                comparisonClass = 'status-slow';
            }
        } else {
            comparisonText = 'åˆå›è©•ä¾¡ã§ã™ï¼';
            comparisonClass = 'status-steady';
        }

        // HTMLã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆ
        const cardHtml = `
            <div class="chart-card">
                <div class="chart-meta">
                    <h4 class="chart-title">[${i + 1}] ${itemLabel}</h4>
                    <div class="text-end">
                        <span class="chart-status ${comparisonClass}">${comparisonText}</span>
                        ${specialComment ? `<div style="font-size:1.2rem; font-weight:bold; color:gold; line-height:1;">${specialComment}</div>` : ''}
                    </div>
                </div>
                <canvas id="chart-${i}"></canvas>
            </div>
        `;
        chartArea.insertAdjacentHTML('beforeend', cardHtml);

        // Chart.jsã§æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã‚’æç”»
        new Chart(document.getElementById(`chart-${i}`), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: itemLabel,
                    data: scores,
                    borderColor: color,
                    backgroundColor: color.replace('1)', '0.1)'),
                    borderWidth: 2,
                    pointRadius: 5,
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        min: 0,
                        max: 5,
                        ticks: { stepSize: 1, font: { size: 10 } },
                        title: { display: true, text: 'è©•ä¾¡ç‚¹', font: { size: 10 } }
                    },
                    x: {
                        ticks: { font: { size: 10 } }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
    
    // 2. éå»ã®ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§
    const lessonList = document.getElementById('lessonList');
    lessonList.innerHTML = '';
    
    history.reverse().forEach(h => {
         const listItem = `
            <a href="index.html?date=${h.date}" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between list-header">
                    ãƒ¬ãƒƒã‚¹ãƒ³æ—¥: ${h.date}
                    <span class="list-date">ã‚¹ã‚³ã‚¢ç¢ºèªæ¸ˆ</span>
                </div>
                <p class="mb-0 small text-muted">ã‚¿ãƒƒãƒ—ã§è©³ç´°ã‚’è¡¨ç¤º (æœªå®Ÿè£…)</p>
            </a>
        `;
        lessonList.insertAdjacentHTML('beforeend', listItem);
    });
}
    </script>
</body>
</html>
