<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <script>
    (function() {
      // URLã« ?page=medical ãŒã¤ã„ã¦ã„ãŸã‚‰ã€å³åº§ã«æ‰‹å¸³ãƒšãƒ¼ã‚¸ã¸è»¢é€
      if (new URLSearchParams(window.location.search).get('page') === 'medical') {
        window.location.replace('medical.html'); 
      }
    })();
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K9 Harmony Portal</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root { --brand-color: #57C3C2; --brand-bg: #E0F7FA; --text-main: #333333; --accent-color: #F2A679; }
    body { font-family: 'Montserrat', 'Noto Sans JP', sans-serif; background-color: #fafafa; color: var(--text-main); padding-bottom: 80px; overflow-x: hidden; }
    
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--brand-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; transition: opacity 0.5s ease-out, visibility 0.5s ease-out; }
    .spinner-border-white { border-color: white; border-right-color: transparent; }
    #tipsText { margin-top: 20px; font-weight: 500; font-size: 1rem; text-align: center; padding: 0 20px; height: 1.5em; }
    
    body.loaded #loadingOverlay { opacity: 0; visibility: hidden; pointer-events: none; }
    
    #mainContent { opacity: 0; transform: scale(0.95); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
    body.loaded #mainContent { opacity: 1; transform: scale(1); }
    
    .header-area { padding: 20px 20px 10px; background: #fff; }
    .brand-title { color: var(--text-main); font-weight: 700; letter-spacing: 0.05em; font-size: 1.2rem; text-align: center; }
    
    .profile-card { margin-top: 20px; display: flex; align-items: center; }
    
    #dogImgContainer {
        width: 150px; height: 150px; 
        border-radius: 50%; 
        border: 4px solid var(--brand-color); 
        background: #fff; 
        flex-shrink: 0; 
        display: flex; align-items: center; justify-content: center;
        overflow: hidden;
        font-size: 0.8rem; color: #aaa; text-align: center;
    }
    .dog-img { width: 100%; height: 100%; object-fit: cover; }
    
    .profile-info { margin-left: 20px; flex-grow: 1; }
    .birthday-msg { color: #FF6B6B; font-weight: bold; font-size: 0.8rem; margin-bottom: 0px; display: none; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    
    .cust-name { font-size: 0.85rem; color: #666; margin: 0; line-height: 1.2; }
    .dog-name { font-size: 1.6rem; font-weight: 700; line-height: 1.2; margin: 0; }
    .lesson-meta { margin-top: 5px; font-size: 0.85rem; color: var(--brand-color); font-weight: 600; }
    .history-link { text-decoration: none; color: var(--brand-color); font-weight: bold; font-size: 0.9rem; margin-left: auto; display: block; text-align: right; margin-top: 10px;}
    
    /* Medical Button Style */
    .medical-btn-card {
        cursor: pointer; 
        border-radius: 12px; 
        border: 1px solid #eee; 
        transition: transform 0.1s;
    }
    .medical-btn-card:active { transform: scale(0.98); background-color: #f8f9fa; }

    .chart-section { margin-top: 20px; padding: 0 10px; display: flex; justify-content: space-between; }
    .chart-box { width: 49%; text-align: center; }
    .chart-caption { font-size: 0.75rem; color: #888; margin-top: 5px; font-weight: 600; }
    
    .section-title { font-size: 0.9rem; font-weight: 700; color: var(--brand-color); margin: 25px 20px 10px; display: flex; align-items: center; gap: 8px; }
    .section-title::before { content: ''; display: block; width: 4px; height: 16px; background: var(--brand-color); border-radius: 2px; }
    
    .section-title.accent { color: var(--accent-color); }
    .section-title.accent::before { background: var(--accent-color); }
    .next-goal-box { 
        margin: 0 20px; background: #fff; 
        border: 2px solid var(--accent-color); 
        border-radius: 10px; padding: 15px; 
        font-weight: 700; color: #555; 
        box-shadow: 0 2px 8px rgba(242, 166, 121, 0.15);
    }

    .feedback-box { margin: 0 20px; background: #f8f9fa; border-radius: 10px; padding: 15px; font-size: 0.9rem; line-height: 1.6; }
    .homework-box { margin: 0 20px; border: 2px solid var(--brand-color); border-radius: 10px; padding: 15px; background: #fff; position: relative; margin-top: 30px; }
    .homework-badge { position: absolute; top: -12px; left: 15px; background: var(--brand-color); color: #fff; font-size: 0.75rem; padding: 2px 10px; border-radius: 10px; font-weight: bold; }
    
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 0 20px; }
    .detail-card { background: #f8f9fa; border-radius: 8px; padding: 10px; }
    .detail-head { font-size: 0.75rem; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 5px; text-align: center; color: #555; }
    .detail-body { font-size: 0.8rem; color: #333; white-space: pre-wrap; }
    
    .photo-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px; margin-top: 10px; padding-bottom: 10px; }
    .photo-item { height: 120px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; }
    
    .footer-action { margin: 30px 20px 10px; text-align: center; }
    
    /* PDF Button */
    .btn-pdf {
        background: #fff; color: var(--brand-color); border: 2px solid var(--brand-color);
        width: 100%; padding: 12px; border-radius: 30px; font-weight: 700; font-size: 1rem;
        margin-bottom: 15px; display: block; text-decoration: none; transition: background 0.2s;
        cursor: pointer;
    }
    .btn-pdf:active { background: #E0F7FA; transform: scale(0.98); }

    .btn-reserve { background: var(--brand-color); color: #fff; border: none; width: 100%; padding: 14px; border-radius: 30px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(87, 195, 194, 0.4); display: block; text-decoration: none; }
    
    .reminder-box {
        background: #fff3cd; border: 1px solid #ffeeba; color: #856404;
        padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9rem; font-weight: bold;
    }

    #errorView { text-align: center; margin-top: 50px; display: none; padding: 20px; }
    .line-id-box { background: #eee; padding: 10px; border-radius: 5px; margin: 15px 0; font-family: monospace; font-weight: bold; word-break: break-all; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒœã‚¿ãƒ³ */
    .dog-select-btn { width: 100%; margin-bottom: 10px; padding: 15px; font-weight: bold; font-size: 1.1rem; border-radius: 12px; background: #f8f9fa; border: 2px solid var(--brand-color); color: var(--brand-color); transition: all 0.2s; }
    .dog-select-btn:active { background: var(--brand-color); color: #fff; transform: scale(0.98); }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner-border spinner-border-white" role="status"></div>
    <p id="tipsText">Loading...</p>
  </div>

  <div id="errorView">
    <div class="container">
      <div class="alert alert-warning text-center">
        <h5 class="fw-bold" id="errorTitle">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h5>
        <p class="small" id="errorMessage">---</p>
        <div class="line-id-box" id="dispLineId" style="display:none;"></div>
        <button class="btn btn-secondary btn-sm w-100 mt-2" onclick="location.reload()">å†èª­ã¿è¾¼ã¿</button>
      </div>
    </div>
  </div>

  <div id="mainContent">
    <div class="header-area">
      <h1 class="brand-title">K9 Harmony</h1>
      
      <div class="profile-card">
        <div id="dogImgContainer">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="profile-info">
          <div id="custBirthdayMsg" class="birthday-msg">ğŸ‰Happy BirthdayğŸ°</div>
          <p id="custName" class="cust-name">Loading...</p>
          <div style="height: 5px;"></div>
          <div id="dogBirthdayMsg" class="birthday-msg">ğŸ‰Happy BirthdayğŸ¶</div>
          <h2 id="dogName" class="dog-name">---</h2>
          <div class="lesson-meta"><span id="lessonDate">Last: --/--/--</span></div>
          <a href="#" id="historyLinkBtn" class="history-link">å±¥æ­´ ></a>
        </div>
      </div>

      <div class="mt-4">
        <div onclick="openMedicalPage()" class="card shadow-sm medical-btn-card">
            <div class="card-body py-2 d-flex align-items-center">
                <div class="rounded-circle d-flex align-items-center justify-content-center me-3" 
                     style="width: 42px; height: 42px; min-width: 42px; background-color: #f0fcfc; color: var(--brand-color);">
                    <span style="font-size: 1.4rem;">â›‘ï¸</span>
                </div>
                
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0 text-dark" style="font-size: 0.95rem;">åŒ»ç™‚ãƒ»é˜²ç½æ‰‹å¸³</h6>
                    <small class="text-muted" style="font-size: 0.7rem;">ç·Šæ€¥æ™‚ãƒ»ç½å®³æ™‚ã®èº«åˆ†è¨¼ã‚«ãƒ«ãƒ†</small>
                </div>
                
                <div class="text-muted" style="font-size: 0.9rem;">
                    &gt;
                </div>
            </div>
        </div>
      </div>
      </div>

    <div class="chart-section">
      <div class="chart-box"><canvas id="chart1"></canvas><div class="chart-caption">åŸºç¤ãƒ»é›†ä¸­</div></div>
      <div class="chart-box"><canvas id="chart2"></canvas><div class="chart-caption">å¿œç”¨ãƒ»å¯¾å¿œ</div></div>
    </div>

    <div class="section-title">æœ¬æ—¥ã®ãƒ†ãƒ¼ãƒãƒ»ç›®æ¨™</div>
    <div class="feedback-box" id="goalText">---</div>
    <div class="section-title">ã§ããŸã“ã¨ (Done)</div>
    <div class="feedback-box" id="doneText">---</div>
    <div class="section-title">èª²é¡Œ (Unable)</div>
    <div class="feedback-box" id="unableText">---</div>
    
    <div class="section-title">å®¿é¡Œ (Homework)</div>
    <div class="homework-box">
      <div class="homework-badge">HOMEWORK</div>
      <div id="homeworkText">---</div>
    </div>

    <div class="section-title accent">æ¬¡å›ç›®æ¨™ (Next Goal)</div>
    <div class="next-goal-box" id="nextGoalText">---</div>
    
    <div class="section-title">è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
    <div class="detail-grid">
      <div class="detail-card"><div class="detail-head">é …ç›®1-5</div><div class="detail-body" id="detail1">---</div></div>
      <div class="detail-card"><div class="detail-head">é …ç›®6-10</div><div class="detail-body" id="detail2">---</div></div>
    </div>
    <div class="feedback-box mt-4" style="background:#fff; border:1px solid #eee;">
      <strong style="color:var(--brand-color);">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:</strong><br><span id="trainerComment">---</span>
    </div>

    <div class="section-title">æœ¬æ—¥ã®ã‚·ãƒ§ãƒƒãƒˆ</div>
    <div class="photo-scroll" id="photoArea"><div class="text-muted small ms-3" id="photoLoadingMsg">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</div></div>

    <div class="footer-action">
      <button onclick="handleDownloadPdf()" class="btn-pdf" id="pdfBtn">
         ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆã‚’PDFã§ä¿å­˜
      </button>

      <a href="#" class="btn-reserve">äºˆç´„ã™ã‚‹ / Reserve</a>
      <div id="reminderArea" class="reminder-box" style="display:none;">æ¬¡å›äºˆç´„ç›®å®‰: <span id="reminderDate">--/-- ã€œ --/--</span></div>
      <div class="text-muted small mt-2">ãƒã‚±ãƒƒãƒˆæ®‹æ•°: <span id="ticketCount" class="fw-bold" style="font-size:1.2rem;">-</span> å›</div>
    </div>
  </div>

  <div class="modal fade" id="dogSelectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0"><h5 class="modal-title fw-bold w-100 text-center">ã‚ã‚“ã¡ã‚ƒã‚“ã‚’é¸æŠ</h5></div>
        <div class="modal-body" id="dogSelectBody"></div>
      </div>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008546673-MJY7j3ox'; 
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';

    const dogTips = [
      "çŠ¬ã®é¼»ç´‹ã¯äººé–“ã®æŒ‡ç´‹ã¨åŒã˜ã§ã€ä¸€é ­ä¸€é ­é•ã„ã¾ã™ã€‚", "çŠ¬ã¯äººé–“ã®ç´„4å€ã®è´åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚", "çŠ¬ã®å—…è¦šã¯äººé–“ã®100ä¸‡å€ã€œ1å„„å€ã¨ã‚‚è¨€ã‚ã‚Œã¾ã™ã€‚", "çŠ¬ã¯æ±—ã‚’è‚‰çƒã‹ã‚‰ã—ã‹ã‹ã‘ã¾ã›ã‚“ã€‚", "çŠ¬ãŒã‚ãã³ã‚’ã™ã‚‹ã®ã¯ã€ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã¦è½ã¡ç€ã“ã†ã¨ã—ã¦ã„ã‚‹æ™‚ã‚‚ã‚ã‚Šã¾ã™ã€‚", "çŠ¬ã®ã—ã£ã½ã®æŒ¯ã‚Šæ–¹ã¯ã€å³å¯„ã‚Šã ã¨ã€Œå¬‰ã—ã„ã€ã€å·¦å¯„ã‚Šã ã¨ã€Œä¸å®‰ã€ãªæ™‚ãŒã‚ã‚Šã¾ã™ã€‚", "å°å‹çŠ¬ã®æ–¹ãŒå¤§å‹çŠ¬ã‚ˆã‚Šã‚‚é•·ç”Ÿãã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚", "çŠ¬ã¯å¤¢ã‚’è¦‹ã¾ã™ã€‚å¯è¨€ã‚’è¨€ã£ãŸã‚Šè¶³ã‚’å‹•ã‹ã™ã®ã¯ãã®è¨¼æ‹ ã§ã™ã€‚", "ãƒ€ãƒ«ãƒ¡ã‚·ã‚¢ãƒ³ã¯ç”Ÿã¾ã‚ŒãŸæ™‚ã¯çœŸã£ç™½ã§ã€å¾Œã‹ã‚‰æ–‘ç‚¹ãŒå‡ºã¦ãã¾ã™ã€‚", "çŠ¬ãŒé£¼ã„ä¸»ã®é¡”ã‚’èˆã‚ã‚‹ã®ã¯ã€æ„›æƒ…è¡¨ç¾ã‚„ã”é£¯ã®å‚¬ä¿ƒã§ã™ã€‚"
    ];

    let tipsTimer;
    let currentUserId = null;
    let currentDogId = null;
    let chartInstance1 = null; 
    let chartInstance2 = null;
    // PDFç”Ÿæˆç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentLessonData = null;

    function startTipsSlider() {
      const tipsText = document.getElementById('tipsText');
      if(!tipsText) return;
      let currentTipIndex = Math.floor(Math.random() * dogTips.length);
      tipsText.innerText = dogTips[currentTipIndex];
      tipsTimer = setInterval(() => {
        currentTipIndex = (currentTipIndex + 1) % dogTips.length;
        tipsText.innerText = dogTips[currentTipIndex];
      }, 2500); 
    }

    function finishLoading() {
      clearInterval(tipsTimer);
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
          overlay.style.visibility = '';
          overlay.style.opacity = '';
      }
      document.body.classList.add('loaded');
      mediumZoom('.zoomable', { margin: 24, background: 'rgba(0,0,0,0.8)' });
    }

    window.onload = function() {
      startTipsSlider();
      if (typeof liff === 'undefined') { showError('SDK Error', 'LIFF SDK not loaded.'); return; }
      main();
    };

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        
        // â˜… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰dogIdã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const urlDogId = urlParams.get('dogId');
        
        // â˜… dogIdãŒã‚ã‚Œã°ãã‚Œã‚’æŒ‡å®šã—ã¦ãƒ•ã‚§ãƒƒãƒ
        fetchTextData(currentUserId, urlDogId);

      } catch (err) {
        showError('LIFF Init Error', err.message);
      }
    }

    function fetchTextData(userId, dogId = null) {
      let url = `${GAS_URL}?userId=${userId}&t=${new Date().getTime()}&n=${Math.random()}`;
      if (dogId) url += `&dogId=${dogId}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.multiple_dogs) {
              showDogSelectModal(data.multiple_dogs);
              return;
          }
          if (data.error) {
              if (data.error === 'Unregistered') {
                  showError('æœªç™»éŒ²ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™', 'IDã‚’ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã«ãŠä¼ãˆãã ã•ã„', userId);
              } else {
                  showError('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼', data.error);
              }
              return;
          }

          try {
              // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆPDFç”¨ï¼‰
              currentLessonData = data;
            
              renderTextData(data);
              
              currentDogId = data.dog.id || null;
              updateHistoryLink();

              fetchProfileImage(userId, currentDogId);
              if (data.latest && data.latest.has_photos) {
                  fetchLessonImages(userId, currentDogId);
              } else {
                  document.getElementById('photoArea').innerHTML = '<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>';
              }
          } catch (e) {
              console.error(e);
              showError('æç”»ã‚¨ãƒ©ãƒ¼', 'ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
          }
        })
        .catch(err => {
          showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼', err.message);
        });
    }

    function showDogSelectModal(dogs) {
        const body = document.getElementById('dogSelectBody');
        body.innerHTML = '';
        dogs.forEach(dog => {
            const btn = document.createElement('button');
            btn.className = 'dog-select-btn';
            // â˜…ä¿®æ­£: æ•¬ç§°ä»˜ãã®åå‰ã‚’ä½¿ç”¨
            btn.innerText = dog.name_disp; 
            btn.onclick = () => selectDog(dog.id);
            body.appendChild(btn);
        });
        
        document.getElementById('loadingOverlay').style.opacity = 0;
        setTimeout(() => { document.getElementById('loadingOverlay').style.visibility = 'hidden'; }, 500);
        
        new bootstrap.Modal(document.getElementById('dogSelectModal')).show();
    }

    function selectDog(dogId) {
        const modalEl = document.getElementById('dogSelectModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
        
        document.getElementById('loadingOverlay').style.visibility = 'visible';
        document.getElementById('loadingOverlay').style.opacity = 1;
        
        currentDogId = dogId;
        fetchTextData(currentUserId, dogId);
    }

    function updateHistoryLink() {
        const link = document.getElementById('historyLinkBtn');
        if (currentDogId) {
            link.href = `history.html?dogId=${currentDogId}`;
        } else {
            link.href = `history.html`;
        }
    }

    // â˜… NEW: Medical Page Navigation Helper
    function openMedicalPage() {
        let url = 'medical.html';
        if (currentDogId) {
            url += `?dogId=${currentDogId}`;
        }
        window.location.href = url;
    }

    // â˜… NEW: PDF Download Handler
    function handleDownloadPdf() {
        if (!currentLessonData || !currentLessonData.latest) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }

        const btn = document.getElementById('pdfBtn');
        const originalText = btn.innerText;
        btn.innerText = "ä½œæˆä¸­...";
        btn.disabled = true;

        // APIãƒ‡ãƒ¼ã‚¿ã‹ã‚‰PDFä½œæˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
        // â€»ç”»åƒãƒ‘ã‚¹(path)ãŒAPIã«å«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€PDFã«ç”»åƒã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚
        // å¿…è¦ã«å¿œã˜ã¦APIå´ã§ãƒ‘ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
        const formData = {
            training_unique_key: currentLessonData.latest.id || '', // IDãŒãªã„å ´åˆã¯ç©º
            dog_name: currentLessonData.dog.name,
            training_date: currentLessonData.latest.date,
            customer_unique_key: currentLessonData.customer.id,
            dog_unique_key: currentLessonData.dog.id,
            
            goal: currentLessonData.latest.goal,
            done: currentLessonData.latest.done,
            unable: currentLessonData.latest.unable,
            next_homework: currentLessonData.latest.homework, // ã‚­ãƒ¼åã®ãƒãƒƒãƒ”ãƒ³ã‚°ã«æ³¨æ„
            next_goal: currentLessonData.latest.next_goal,
            comment_trainer: currentLessonData.latest.comment,
            training_remarks: '', // å¿…è¦ãªã‚‰APIã«è¿½åŠ 

            // ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ”ãƒ³ã‚°
            score_1: currentLessonData.latest.scores[0], score_detail_1: currentLessonData.latest.details[0],
            score_2: currentLessonData.latest.scores[1], score_detail_2: currentLessonData.latest.details[1],
            score_3: currentLessonData.latest.scores[2], score_detail_3: currentLessonData.latest.details[2],
            score_4: currentLessonData.latest.scores[3], score_detail_4: currentLessonData.latest.details[3],
            score_5: currentLessonData.latest.scores[4], score_detail_5: currentLessonData.latest.details[4],
            score_6: currentLessonData.latest.scores[5], score_detail_6: currentLessonData.latest.details[5],
            score_7: currentLessonData.latest.scores[6], score_detail_7: currentLessonData.latest.details[6],
            score_8: currentLessonData.latest.scores[7], score_detail_8: currentLessonData.latest.details[7],
            score_9: currentLessonData.latest.scores[8], score_detail_9: currentLessonData.latest.details[8],
            score_10: currentLessonData.latest.scores[9], score_detail_10: currentLessonData.latest.details[9],
            
            // ç”»åƒç”¨ãƒ‘ã‚¹ (APIãŒè¿”ã—ã¦ã„ãªã„å ´åˆã¯ç©ºã«ãªã‚Šã¾ã™)
            training_photo_1: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[0] : '',
            training_photo_2: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[1] : '',
            training_photo_3: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[2] : '',
            training_photo_4: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[3] : '',
            training_photo_5: currentLessonData.latest.image_paths ? currentLessonData.latest.image_paths[4] : ''
        };

        if (typeof google === 'undefined' || !google.script) {
            alert('ã“ã®æ©Ÿèƒ½ã¯GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªä¸Šã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚');
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }

        google.script.run
            .withSuccessHandler(function(response) {
                btn.innerText = originalText;
                btn.disabled = false;

                if (response.status === 'success') {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¤å®š
                    const isIos = /iP(ad|hone|od)/.test(navigator.userAgent);

                    if (isIos) {
                        // iOS: åˆ¥ã‚¿ãƒ–ã§é–‹ã (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯å›é¿ã®ãŸã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹ãŒã€ã¾ãšã¯ã“ã‚Œã§è©¦è¡Œ)
                        window.open(response.url, '_blank');
                    } else {
                        // PC/Android: å¼·åˆ¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        const a = document.createElement('a');
                        a.href = response.url;
                        a.download = `LessonReport_${formData.training_date}.pdf`; 
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                    alert(response.message);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + response.message);
                }
            })
            .withFailureHandler(function(e) {
                btn.innerText = originalText;
                btn.disabled = false;
                alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + e);
            })
            .createPdfFromSlide(formData);
    }

    function fetchProfileImage(userId, dogId) {
      let url = `${GAS_URL}?userId=${userId}&type=img_profile`;
      if(dogId) url += `&dogId=${dogId}`;
      
      fetch(url)
        .then(res => res.json())
        .then(data => {
           const container = document.getElementById('dogImgContainer');
           if(data.image) {
               container.innerHTML = `<img src="${data.image}" class="dog-img" alt="Dog Photo">`;
           } else {
               container.innerHTML = 'No Image';
           }
        })
        .catch(e => console.log('Profile Image Error', e));
    }

    function fetchLessonImages(userId, dogId) {
      let url = `${GAS_URL}?userId=${userId}&type=img_latest`;
      if(dogId) url += `&dogId=${dogId}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
           const pArea = document.getElementById('photoArea');
           pArea.innerHTML = ''; 
           if (data.images && data.images.length > 0) {
             data.images.forEach(b64 => {
               const img = document.createElement('img');
               img.src = b64; img.className = 'photo-item zoomable'; pArea.appendChild(img);
             });
             mediumZoom('.zoomable', { margin: 24, background: 'rgba(0,0,0,0.8)' });
           } else {
             pArea.innerHTML = '<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>';
           }
        })
        .catch(e => console.log('Lesson Image Error', e));
    }

    function renderTextData(data) {
      const c = data.customer || {};
      const d = data.dog || {};
      document.getElementById('custName').innerText = c.name + ' æ§˜';
      document.getElementById('dogName').innerText = d.name_disp || d.name || 'Your Dog';
      document.getElementById('ticketCount').innerText = data.ticket_count;

      checkBirthday(c.birth_date, 'custBirthdayMsg'); 
      checkBirthday(d.birth_date, 'dogBirthdayMsg'); 

      const l = data.latest;
      if (l) {
        document.getElementById('lessonDate').innerText = 'Last: ' + l.date;
        document.getElementById('goalText').innerText = l.goal;
        document.getElementById('doneText').innerText = l.done;
        document.getElementById('unableText').innerText = l.unable;
        document.getElementById('homeworkText').innerText = l.homework;
        document.getElementById('trainerComment').innerText = l.comment;
        document.getElementById('nextGoalText').innerText = l.next_goal || 'ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã¨ç›¸è«‡ã—ã¾ã—ã‚‡ã†';

        if (l.recommend_date) {
            document.getElementById('reminderDate').innerText = l.recommend_date;
            document.getElementById('reminderArea').style.display = 'block';
        } else {
            document.getElementById('reminderArea').style.display = 'none';
        }

        let d1 = '', d2 = '';
        for(let i=0; i<5; i++) { d1 += `[${i+1}] ${l.details[i] || 'ãªã—'}\n`; }
        for(let i=5; i<10; i++) { d2 += `[${i+1}] ${l.details[i] || 'ãªã—'}\n`; }
        document.getElementById('detail1').innerText = d1 || 'ç‰¹ã«ãªã—';
        document.getElementById('detail2').innerText = d2 || 'ç‰¹ã«ãªã—';

        if (chartInstance1) chartInstance1.destroy();
        if (chartInstance2) chartInstance2.destroy();

        if (l.scores) {
            chartInstance1 = renderChart('chart1', l.scores.slice(0, 5), ['æŒ‡ç¤ºç†è§£','é›†ä¸­åŠ›','å ±é…¬','ãƒœãƒ‡ã‚£','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ'], 'rgba(255, 99, 132, 0.2)', 'rgba(255, 99, 132, 1)');
            chartInstance2 = renderChart('chart2', l.scores.slice(5, 10), ['æŒ‡ç¤ºå‡ºã—','å¯¾å¿œåŠ›','ãƒªãƒ¼ãƒ‰','ãƒœãƒ‡ã‚£','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ'], 'rgba(54, 162, 235, 0.2)', 'rgba(54, 162, 235, 1)');
        }
      } else {
          document.getElementById('lessonDate').innerText = 'ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´ãªã—';
      }
      
      finishLoading();
    }

    function checkBirthday(dateStr, elementId) {
        if (!dateStr) return;
        const today = new Date(); const bDate = new Date(dateStr); bDate.setFullYear(today.getFullYear());
        const diffTime = bDate.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (Math.abs(diffDays) <= 14 || Math.abs(diffDays - 365) <= 14 || Math.abs(diffDays + 365) <= 14) {
            document.getElementById(elementId).style.display = 'block';
        }
    }

    function renderChart(id, data, labels, bgColor, borderColor) {
      const ctx = document.getElementById(id);
      return new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: bgColor, borderColor: borderColor, pointBackgroundColor: borderColor, borderWidth: 2
          }]
        },
        options: {
          scales: { r: { min: 0, max: 5, ticks: { display: false }, pointLabels: { font: { size: 11 } } } },
          plugins: { legend: { display: false } }
        }
      });
    }

    function showError(title, msg, userId) {
        finishLoading();
        document.getElementById('mainContent').style.display = 'none';
        
        const errDiv = document.getElementById('errorView');
        errDiv.style.display = 'block';
        document.getElementById('errorTitle').innerText = title;
        document.getElementById('errorMessage').innerText = msg;
        
        if (userId) {
            const idBox = document.getElementById('dispLineId');
            idBox.innerText = userId;
            idBox.style.display = 'block';
        }
    }
    
    function copyLineId() {
        const idText = document.getElementById('dispLineId').innerText;
        navigator.clipboard.writeText(idText).then(() => alert('IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
    }
  </script>
</body>
</html>


history.html
<!DOCTYPE html>
<html lang="ja">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´</title>
Â  Â  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js"></script>
Â  Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
Â  Â  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --brand-color: #57C3C2;
Â  Â  Â  Â  Â  Â  --text-main: #333333;
Â  Â  Â  Â  Â  Â  --badge-gray: #E0E0E0;
Â  Â  Â  Â  }
Â  Â  Â  Â  body { font-family: 'Montserrat', 'Noto Sans JP', sans-serif; background-color: #fafafa; color: var(--text-main); padding-bottom: 80px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .header-area { background: #fff; padding: 15px 20px 20px; border-bottom: 1px solid #eee; position: relative; }
Â  Â  Â  Â  .back-link { color: var(--brand-color); font-weight: bold; text-decoration: none; font-size: 0.9rem; position: absolute; top: 15px; left: 20px; z-index: 10; }
Â  Â  Â  Â  .profile-img-container { display: flex; justify-content: center; margin-top: 10px; }
Â  Â  Â  Â  .dog-profile-large { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--brand-color); padding: 2px; background: #fff; }
Â  Â  Â  Â  .page-title { text-align: center; font-weight: 700; font-size: 1.2rem; color: var(--text-main); margin-top: 15px; margin-bottom: 0; }

Â  Â  Â  Â  .content-container { padding: 0 15px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒƒã‚¸ --- */
Â  Â  Â  Â  .badge-section { background: #fff; margin-top: 20px; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; min-height: 80px;}
Â  Â  Â  Â  .badge-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .badge-item { width: 50px; height: 75px; display: flex; flex-direction: column; align-items: center; transition: transform 0.3s; }
Â  Â  Â  Â  .badge-item:hover { transform: scale(1.1); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .badge-icon {Â 
Â  Â  Â  Â  Â  Â  width: 40px; height: 40px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 50%;Â 
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;Â 
Â  Â  Â  Â  Â  Â  color: #fff; font-size: 1.2rem; margin-bottom: 5px;Â 
Â  Â  Â  Â  Â  Â  position: relative; overflow: hidden;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @keyframes sparkle {
Â  Â  Â  Â  Â  Â  0% { transform: translateX(-100%) rotate(45deg); opacity: 0; }
Â  Â  Â  Â  Â  Â  50% { opacity: 1; }
Â  Â  Â  Â  Â  Â  100% { transform: translateX(100%) rotate(45deg); opacity: 0; }
Â  Â  Â  Â  }
Â  Â  Â  Â  .badge-icon::after {
Â  Â  Â  Â  Â  Â  content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%);
Â  Â  Â  Â  Â  Â  animation: sparkle 3s infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .badge-label { font-size: 0.6rem; color: #555; font-weight: bold; line-height: 1.1; }

Â  Â  Â  Â  /* Chart */
Â  Â  Â  Â  .chart-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 20px; padding: 15px; }
Â  Â  Â  Â  .chart-card canvas { height: 180px !important; }
Â  Â  Â  Â  .chart-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
Â  Â  Â  Â  .chart-title { font-size: 1.1rem; font-weight: 700; color: var(--brand-color); margin-bottom: 5px; }
Â  Â  Â  Â  .chart-status { font-size: 0.9rem; font-weight: 600; }
Â  Â  Â  Â  .status-great { color: #FF6B6B; } .status-steady { color: #555555; }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Gallery */
Â  Â  Â  Â  .gallery-section { margin-top: 30px; }
Â  Â  Â  Â  .section-title { font-size: 1.2rem; color: #555; margin-bottom: 10px; font-weight: 600; }
Â  Â  Â  Â  .photo-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; padding-right: 20px; -webkit-overflow-scrolling: touch; }
Â  Â  Â  Â  .photo-scroll::-webkit-scrollbar { display: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gallery-img-wrapper { flex: 0 0 28vw; width: 28vw; height: 28vw; border-radius: 8px; border: 1px solid #ddd; flex-shrink: 0; overflow: hidden; position: relative; background: #f8f9fa; }
Â  Â  Â  Â  .gallery-img { width: 100%; height: 100%; object-fit: cover; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .see-more-card { display: flex; flex-direction: column; justify-content: center; align-items: center; text-decoration: none; background: linear-gradient(135deg, rgba(87, 195, 194, 0.9), rgba(87, 195, 194, 0.3)); border: 2px solid var(--brand-color); }
Â  Â  Â  Â  .see-more-icon { font-size: 1.5rem; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
Â  Â  Â  Â  .see-more-text { font-size: 0.8rem; font-weight: 700; color: #fff; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

Â  Â  Â  Â  .btn-drive-link { display: inline-block; font-size: 0.9rem; color: var(--brand-color); text-decoration: none; font-weight: bold; margin-top: 5px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* List */
Â  Â  Â  Â  .lesson-list { margin-top: 30px; }
Â  Â  Â  Â  .list-group-item { border: none; margin-bottom: 8px; border-radius: 8px; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.05); padding: 15px; cursor: pointer; }
Â  Â  Â  Â  .list-header { font-weight: 700; color: var(--brand-color); }
Â  Â  Â  Â  .list-date { font-size: 0.85rem; color: #888; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Utils */
Â  Â  Â  Â  #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--brand-color); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; flex-direction: column; }
Â  Â  Â  Â  body.loaded #loadingOverlay { display: none !important; }
Â  Â  Â  Â  .spinner-border-white { border-color: white; border-right-color: transparent; }
Â  Â  Â  Â  #tipsText { margin-top: 20px; font-weight: 500; font-size: 1rem; text-align: center; padding: 0 20px; height: 1.5em; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #errorContainer { display: none; padding: 20px; text-align: center; margin-top: 20px; }
Â  Â  Â  Â  .error-box { background: #fff; padding: 20px; border-radius: 12px; border: 2px solid #ffcccc; color: #d9534f; }

Â  Â  Â  Â  .modal-score-item { margin-bottom: 5px; font-size: 1rem; }
Â  Â  Â  Â  .modal-score-item strong { color: var(--brand-color); width: 80px; display: inline-block; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .modal-avg-box { display: flex; gap: 10px; margin-bottom: 20px; }
Â  Â  Â  Â  .avg-item { flex: 1; background: #E0F7FA; border-radius: 8px; padding: 10px; text-align: center; }
Â  Â  Â  Â  .avg-label { font-size: 0.7rem; color: #666; font-weight: bold; display: block; }
Â  Â  Â  Â  .avg-val { font-size: 1.4rem; color: var(--brand-color); font-weight: 700; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒœã‚¿ãƒ³ */
Â  Â  Â  Â  .dog-select-btn { width: 100%; margin-bottom: 10px; padding: 15px; font-weight: bold; font-size: 1.1rem; border-radius: 12px; background: #f8f9fa; border: 2px solid var(--brand-color); color: var(--brand-color); transition: all 0.2s; }
Â  Â  Â  Â  .dog-select-btn:active { background: var(--brand-color); color: #fff; transform: scale(0.98); }
Â  Â  </style>
</head>
<body>

Â  Â  <div id="loadingOverlay">
Â  Â  Â  Â  <div class="spinner-border spinner-border-white" role="status"></div>
Â  Â  Â  Â  <p id="tipsText">Loading...</p>
Â  Â  </div>

Â  Â  <div id="errorContainer">
Â  Â  Â  Â  <div class="error-box">
Â  Â  Â  Â  Â  Â  <h5 class="fw-bold">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</h5>
Â  Â  Â  Â  Â  Â  <p id="errorMsg" class="small text-dark"></p>
Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary btn-sm mt-2" onclick="location.reload()">å†èª­ã¿è¾¼ã¿</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="mainWrapper">
Â  Â  Â  Â  <div class="header-area">
Â  Â  Â  Â  Â  Â  <a href="index.html" id="backLinkBtn" class="back-link">&lt; æˆ»ã‚‹</a>
Â  Â  Â  Â  Â  Â  <div class="profile-img-container">
Â  Â  Â  Â  Â  Â  Â  Â  <img id="dogProfileImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="dog-profile-large" alt="æ„›çŠ¬">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <h1 id="pageTitle" class="page-title">...ã®ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´</h1>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="content-container py-3">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="badge-section">
Â  Â  Â  Â  Â  Â  Â  Â  <h6 style="color:#888; font-size:0.8rem; font-weight:bold;">ãƒã‚¹ã‚¿ãƒªãƒ¼ãƒãƒƒã‚¸ (5ç‚¹Ã—3é€£ç¶š)</h6>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="badgeContainer" class="badge-grid"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="noBadgeMsg" class="text-muted small mt-3" style="display:none;">ã¾ã ç²å¾—ã—ãŸãƒãƒƒã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <p class="text-muted small text-center mt-3">éå»ã®ãƒ¬ãƒƒã‚¹ãƒ³è©•ä¾¡ã®æ¨ç§»ã§ã™ã€‚</p>
Â  Â  Â  Â  Â  Â  <div id="chartArea"></div>

Â  Â  Â  Â  Â  Â  <div class="gallery-section">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="section-title">ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="mainGalleryContainer" class="photo-scroll">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-muted small ms-3">èª­ã¿è¾¼ã¿ä¸­...</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="lesson-list">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="section-title">éå»ã®ãƒ¬ãƒƒã‚¹ãƒ³æ—¥ä¸€è¦§ (æ–°ã—ã„é †)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="lessonList" class="list-group"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="modal fade" id="historyDetailModal" tabindex="-1" aria-hidden="true">
Â  Â  Â  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  <h5 class="modal-title">ãƒ¬ãƒƒã‚¹ãƒ³è©³ç´°: <span id="modalDate"></span></h5>
Â  Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="modalAvgArea"></div>

Â  Â  Â  Â  Â  Â  <h6 class="mt-2 text-muted">è©•ä¾¡ã‚¹ã‚³ã‚¢</h6>
Â  Â  Â  Â  Â  Â  <div id="modalScores"></div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <h6 class="mt-4 text-muted">ã‚³ãƒ¡ãƒ³ãƒˆ</h6>
Â  Â  Â  Â  Â  Â  <p id="modalComment" style="white-space: pre-wrap; background:#f7f7f7; padding:10px; border-radius:5px;"></p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <h6 class="mt-4 text-muted">å®¿é¡Œ</h6>
Â  Â  Â  Â  Â  Â  <p id="modalHomework" style="white-space: pre-wrap; background:#f7f7f7; padding:10px; border-radius:5px;"></p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="text-end mt-3">
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="driveLink" class="btn-drive-link" target="_blank" style="display:none;">å…ƒãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã¸ &gt;</a>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="modal fade" id="dogSelectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
Â  Â  Â  Â  <div class="modal-dialog modal-dialog-centered">
Â  Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <div class="modal-header border-0"><h5 class="modal-title fw-bold w-100 text-center">ã‚ã‚“ã¡ã‚ƒã‚“ã‚’é¸æŠ</h5></div>
Â  Â  Â  Â  Â  Â  <div class="modal-body" id="dogSelectBody"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const LIFF_ID = '2008546673-MJY7j3ox';Â 
Â  Â  Â  Â  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzWkpA6bvAETxV34lE05e5SSW34CvjoxOH6K8V9oSAGMCZbUR7ar6g84FcHihICsK2F/exec';Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const scoreLabels = [ 'æŒ‡ç¤ºç†è§£', 'é›†ä¸­åŠ›', 'å ±é…¬', 'ãƒœãƒ‡ã‚£', 'ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ', 'æŒ‡ç¤ºå‡ºã—', 'å¯¾å¿œåŠ›', 'ãƒªãƒ¼ãƒ‰', 'ãƒœãƒ‡ã‚£', 'ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ' ];
Â  Â  Â  Â  const chartColors = [ 'rgba(255, 99, 132, 1)', 'rgba(255, 159, 64, 1)', 'rgba(255, 205, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(54, 162, 235, 1)', 'rgba(153, 102, 255, 1)', 'rgba(201, 203, 207, 1)', 'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)' ];

Â  Â  Â  Â  const dogTips = [
Â  Â  Â  Â  Â  "çŠ¬ã®é¼»ç´‹ã¯äººé–“ã®æŒ‡ç´‹ã¨åŒã˜ã§ã€ä¸€é ­ä¸€é ­é•ã„ã¾ã™ã€‚", "çŠ¬ã¯äººé–“ã®ç´„4å€ã®è´åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚", "çŠ¬ã®å—…è¦šã¯äººé–“ã®100ä¸‡å€ã€œ1å„„å€ã¨ã‚‚è¨€ã‚ã‚Œã¾ã™ã€‚", "çŠ¬ã¯æ±—ã‚’è‚‰çƒã‹ã‚‰ã—ã‹ã‹ã‘ã¾ã›ã‚“ã€‚", "çŠ¬ãŒã‚ãã³ã‚’ã™ã‚‹ã®ã¯ã€ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã¦è½ã¡ç€ã“ã†ã¨ã—ã¦ã„ã‚‹æ™‚ã‚‚ã‚ã‚Šã¾ã™ã€‚", "çŠ¬ã®ã—ã£ã½ã®æŒ¯ã‚Šæ–¹ã¯ã€å³å¯„ã‚Šã ã¨ã€Œå¬‰ã—ã„ã€ã€å·¦å¯„ã‚Šã ã¨ã€Œä¸å®‰ã€ãªæ™‚ãŒã‚ã‚Šã¾ã™ã€‚", "å°å‹çŠ¬ã®æ–¹ãŒå¤§å‹çŠ¬ã‚ˆã‚Šã‚‚é•·ç”Ÿãã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚", "çŠ¬ã¯å¤¢ã‚’è¦‹ã¾ã™ã€‚å¯è¨€ã‚’è¨€ã£ãŸã‚Šè¶³ã‚’å‹•ã‹ã™ã®ã¯ãã®è¨¼æ‹ ã§ã™ã€‚", "ãƒ€ãƒ«ãƒ¡ã‚·ã‚¢ãƒ³ã¯ç”Ÿã¾ã‚ŒãŸæ™‚ã¯çœŸã£ç™½ã§ã€å¾Œã‹ã‚‰æ–‘ç‚¹ãŒå‡ºã¦ãã¾ã™ã€‚", "çŠ¬ãŒé£¼ã„ä¸»ã®é¡”ã‚’èˆã‚ã‚‹ã®ã¯ã€æ„›æƒ…è¡¨ç¾ã‚„ã”é£¯ã®å‚¬ä¿ƒã§ã™ã€‚"
Â  Â  Â  Â  ];

Â  Â  Â  Â  let tipsTimer;
Â  Â  Â  Â  let allHistoryData = []; let customerData = {}; let currentUserId = ''; let currentDogId = null;

Â  Â  Â  Â  function startTipsSlider() {
Â  Â  Â  Â  Â  const tipsText = document.getElementById('tipsText');
Â  Â  Â  Â  Â  if(!tipsText) return;
Â  Â  Â  Â  Â  let currentTipIndex = Math.floor(Math.random() * dogTips.length);
Â  Â  Â  Â  Â  tipsText.innerText = dogTips[currentTipIndex];
Â  Â  Â  Â  Â  tipsTimer = setInterval(() => {
Â  Â  Â  Â  Â  Â  currentTipIndex = (currentTipIndex + 1) % dogTips.length;
Â  Â  Â  Â  Â  Â  tipsText.innerText = dogTips[currentTipIndex];
Â  Â  Â  Â  Â  }, 2500);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function finishLoading() {
Â  Â  Â  Â  Â  Â  clearInterval(tipsTimer);
Â  Â  Â  Â  Â  Â  // ã‚¹ã‚¿ã‚¤ãƒ«å‰Šé™¤
Â  Â  Â  Â  Â  Â  const overlay = document.getElementById('loadingOverlay');
Â  Â  Â  Â  Â  Â  if (overlay) { overlay.style.visibility = ''; overlay.style.opacity = ''; }
Â  Â  Â  Â  Â  Â  document.body.classList.add('loaded');
Â  Â  Â  Â  }

Â  Â  Â  Â  window.onload = function() {
Â  Â  Â  Â  Â  Â  startTipsSlider();Â 
Â  Â  Â  Â  Â  Â  if (typeof liff === 'undefined') { showError('LIFF SDK not loaded.'); return; }Â 
Â  Â  Â  Â  Â  Â  main();Â 
Â  Â  Â  Â  };

Â  Â  Â  Â  async function main() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await liff.init({ liffId: LIFF_ID });
Â  Â  Â  Â  Â  Â  Â  Â  if (!liff.isLoggedIn()) { liff.login(); return; }
Â  Â  Â  Â  Â  Â  Â  Â  const profile = await liff.getProfile();
Â  Â  Â  Â  Â  Â  Â  Â  currentUserId = profile.userId;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // â˜… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰dogIdã‚’å–å¾—
Â  Â  Â  Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  Â  Â  currentDogId = urlParams.get('dogId');

Â  Â  Â  Â  Â  Â  Â  Â  fetchTextData(profile.userId, currentDogId);
Â  Â  Â  Â  Â  Â  } catch (err) { showError('ã‚¢ãƒ—ãƒªèµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err.message); }
Â  Â  Â  Â  }

Â  Â  Â  Â  function fetchTextData(userId, dogId = null) {
Â  Â  Â  Â  Â  Â  let url = `${GAS_URL}?userId=${userId}&t=${new Date().getTime()}&n=${Math.random()}`;
Â  Â  Â  Â  Â  Â  if (dogId) url += `&dogId=${dogId}`;

Â  Â  Â  Â  Â  Â  fetch(url).then(res => { if (!res.ok) throw new Error(res.statusText); return res.json(); })
Â  Â  Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.multiple_dogs) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDogSelectModal(data.multiple_dogs);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.error) { showError('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + data.error); return; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allHistoryData = data.score_history || []; customerData = data.customer || {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // IDã‚’æ›´æ–° (GASãŒé¸ã‚“ã ID)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentDogId = data.dog.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateBackLink(); // â˜… æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®æ›´æ–°

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderHistory(data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderBadges(data.badges || []);Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finishLoading();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (allHistoryData.length > 0 || (data.latest && data.latest.has_photos)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { fetchGalleryImages(userId, currentDogId, data); fetchProfileImage(userId, currentDogId); }, 100);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { document.getElementById('mainGalleryContainer').innerHTML = '<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>'; }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + err.message);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finishLoading();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // â˜… Backãƒªãƒ³ã‚¯æ›´æ–°
Â  Â  Â  Â  function updateBackLink() {
Â  Â  Â  Â  Â  Â  const link = document.getElementById('backLinkBtn');
Â  Â  Â  Â  Â  Â  if (currentDogId) {
Â  Â  Â  Â  Â  Â  Â  Â  link.href = `index.html?dogId=${currentDogId}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  link.href = `index.html`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showDogSelectModal(dogs) {
Â  Â  Â  Â  Â  Â  const body = document.getElementById('dogSelectBody');
Â  Â  Â  Â  Â  Â  body.innerHTML = '';
Â  Â  Â  Â  Â  Â  dogs.forEach(dog => {
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  btn.className = 'dog-select-btn';
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = dog.name;Â 
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => selectDog(dog.id);
Â  Â  Â  Â  Â  Â  Â  Â  body.appendChild(btn);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('loadingOverlay').style.opacity = 0;
Â  Â  Â  Â  Â  Â  setTimeout(() => { document.getElementById('loadingOverlay').style.visibility = 'hidden'; }, 500);
Â  Â  Â  Â  Â  Â  new bootstrap.Modal(document.getElementById('dogSelectModal')).show();
Â  Â  Â  Â  }

Â  Â  Â  Â  function selectDog(dogId) {
Â  Â  Â  Â  Â  Â  const modalEl = document.getElementById('dogSelectModal');
Â  Â  Â  Â  Â  Â  const modal = bootstrap.Modal.getInstance(modalEl);
Â  Â  Â  Â  Â  Â  modal.hide();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('loadingOverlay').style.visibility = 'visible';
Â  Â  Â  Â  Â  Â  document.getElementById('loadingOverlay').style.opacity = 1;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  window.location.search = `?dogId=${dogId}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function showError(msg) {
Â  Â  Â  Â  Â  Â  finishLoading();
Â  Â  Â  Â  Â  Â  document.getElementById('mainWrapper').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('errorContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('errorMsg').innerText = msg;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderBadges(earnedIndices) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('badgeContainer');
Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!earnedIndices || earnedIndices.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('noBadgeMsg').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('noBadgeMsg').style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  scoreLabels.forEach((label, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  const badgeNum = idx + 1;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!earnedIndices.includes(badgeNum)) return;

Â  Â  Â  Â  Â  Â  Â  Â  const color = chartColors[idx];Â 
Â  Â  Â  Â  Â  Â  Â  Â  const iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  div.className = 'badge-item';
Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `<div class="badge-icon" style="background:${color}; box-shadow: 0 2px 5px ${color.replace('1)','0.4)')};">${iconHtml}</div><div class="badge-label">${label}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function fetchProfileImage(userId, dogId) {
Â  Â  Â  Â  Â  Â  Â let url = `${GAS_URL}?userId=${userId}&type=img_profile`;
Â  Â  Â  Â  Â  Â  Â if(dogId) url += `&dogId=${dogId}`;
Â  Â  Â  Â  Â  Â  Â fetch(url).then(res => res.json()).then(data => { if(data.image) document.getElementById('dogProfileImg').src = data.image; });
Â  Â  Â  Â  }
Â  Â  Â  Â  function fetchGalleryImages(userId, dogId, data) {
Â  Â  Â  Â  Â  Â  if (!(data.latest && data.latest.has_photos)) { document.getElementById('mainGalleryContainer').innerHTML = '<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let url = `${GAS_URL}?userId=${userId}&type=img_latest`;
Â  Â  Â  Â  Â  Â  if(dogId) url += `&dogId=${dogId}`;

Â  Â  Â  Â  Â  Â  fetch(url).then(res => res.json()).then(d => {
Â  Â  Â  Â  Â  Â  Â  Â  const gallery = document.getElementById('mainGalleryContainer'); gallery.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (d.images && d.images.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const displayCount = Math.min(d.images.length, 3);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let i=0; i<displayCount; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gallery.insertAdjacentHTML('beforeend', `<div class="gallery-img-wrapper"><img src="${d.images[i]}" class="gallery-img zoomable" alt="Photo"></div>`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mediumZoom('.zoomable', { margin: 24, background: 'rgba(0,0,0,0.8)' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (customerData.shared_folder_url) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gallery.insertAdjacentHTML('beforeend', `<a href="${customerData.shared_folder_url}" target="_blank" class="gallery-img-wrapper see-more-card"><div class="see-more-icon">ğŸ“‚</div><div class="see-more-text">ã‚‚ã£ã¨è¦‹ã‚‹</div></a>`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else { gallery.innerHTML = '<div class="text-muted small ms-3">å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>'; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  function renderHistory(data) {
Â  Â  Â  Â  Â  Â  const chartArea = document.getElementById('chartArea'); const lessonList = document.getElementById('lessonList');
Â  Â  Â  Â  Â  Â  chartArea.innerHTML = ''; lessonList.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  const dogData = data.dog || {};Â 
Â  Â  Â  Â  Â  Â  document.getElementById('pageTitle').innerText = `${dogData.name_disp || dogData.name || 'æ„›çŠ¬'}ã®ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´`;Â 

Â  Â  Â  Â  Â  Â  if (!allHistoryData || allHistoryData.length < 1) { chartArea.innerHTML = `<div class="text-center text-muted small mt-4">ã¾ã ãƒ¬ãƒƒã‚¹ãƒ³å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`; lessonList.innerHTML = `<div class="text-center text-muted small mt-4">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`; return; }

Â  Â  Â  Â  Â  Â  const listHistory = [...allHistoryData].sort((a, b) => new Date(a.full_date||a.date).getTime() - new Date(b.full_date||b.date).getTime()).reverse();
Â  Â  Â  Â  Â  Â  const chartHistory = [...allHistoryData].sort((a, b) => new Date(a.full_date||a.date).getTime() - new Date(b.full_date||b.date).getTime());
Â  Â  Â  Â  Â  Â  const recent10Chart = chartHistory.slice(-10);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (let i = 0; i < 10; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const itemLabel = scoreLabels[i]; const color = chartColors[i];
Â  Â  Â  Â  Â  Â  Â  Â  const scores = recent10Chart.map(h => h.scores[i]); const dates = recent10Chart.map(h => h.date);
Â  Â  Â  Â  Â  Â  Â  Â  const latestScore = scores[scores.length - 1]; const previousScore = scores.length > 1 ? scores[scores.length - 2] : null;
Â  Â  Â  Â  Â  Â  Â  Â  let comparisonText = '', comparisonClass = 'status-steady', specialComment = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (latestScore === 5) specialComment = 'â­ï¸ğŸ¶â­ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  if (previousScore !== null) { const diff = latestScore - previousScore; if (diff >= 1 && latestScore < 5) { comparisonText = 'æˆé•·ä¸­ï¼'; comparisonClass = 'status-great'; } } else { comparisonText = 'åˆå›'; }
Â  Â  Â  Â  Â  Â  Â  Â  chartArea.insertAdjacentHTML('beforeend', `<div class="chart-card"><div class="chart-meta"><h4 class="chart-title">[${i + 1}] ${itemLabel}</h4><div class="text-end"><span class="chart-status ${comparisonClass}">${comparisonText}</span>${specialComment ? `<div style="font-size:1.2rem; line-height:1;">${specialComment}</div>` : ''}</div></div><canvas id="chart-${i}"></canvas></div>`);
Â  Â  Â  Â  Â  Â  Â  Â  new Chart(document.getElementById(`chart-${i}`), { type: 'line', data: { labels: dates, datasets: [{ label: itemLabel, data: scores, borderColor: color, backgroundColor: color.replace('1)', '0.1)'), borderWidth: 2, pointRadius: 5, fill: true, tension: 0.2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 5, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  listHistory.forEach(h => {
Â  Â  Â  Â  Â  Â  Â  Â  const comment = (h.comment && String(h.comment).trim()) ? h.comment : 'ã‚³ãƒ¡ãƒ³ãƒˆãªã—';
Â  Â  Â  Â  Â  Â  Â  Â  const avg = (h.scores.reduce((a,b)=>a+b,0) / h.scores.length).toFixed(1);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  lessonList.insertAdjacentHTML('beforeend', `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="list-group-item" onclick="showLessonDetail('${h.id}', '${h.date}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="d-flex w-100 justify-content-between list-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ãƒ¬ãƒƒã‚¹ãƒ³æ—¥: ${h.date}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="list-date">è©³ç´° &gt;</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 p-2" style="background:#f7f7f7; border-radius:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-1 fw-bold" style="color:var(--brand-color);">Avg: ${avg}ç‚¹</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mb-1 small" style="white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"><strong>ã‚³ãƒ¡ãƒ³ãƒˆ:</strong> ${comment}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  function showLessonDetail(id, date) {
Â  Â  Â  Â  Â  Â  const detail = allHistoryData.find(h => h.id === id) || allHistoryData.find(h => h.date === date); if (!detail) return;
Â  Â  Â  Â  Â  Â  document.getElementById('modalDate').innerText = date;
Â  Â  Â  Â  Â  Â  document.getElementById('modalComment').innerText = (detail.comment && String(detail.comment).trim()) ? detail.comment : 'ã‚³ãƒ¡ãƒ³ãƒˆãªã—';
Â  Â  Â  Â  Â  Â  document.getElementById('modalHomework').innerText = (detail.homework && String(detail.homework).trim()) ? detail.homework : 'å®¿é¡Œãªã—';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const s1 = detail.scores.slice(0,5).reduce((a,b)=>a+b,0)/5;
Â  Â  Â  Â  Â  Â  const s2 = detail.scores.slice(5,10).reduce((a,b)=>a+b,0)/5;
Â  Â  Â  Â  Â  Â  document.getElementById('modalAvgArea').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-avg-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="avg-item"><span class="avg-label">åŸºç¤ãƒ»é›†ä¸­ (1-5)</span><span class="avg-val">${s1.toFixed(1)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="avg-item"><span class="avg-label">å¿œç”¨ãƒ»å¯¾å¿œ (6-10)</span><span class="avg-val">${s2.toFixed(1)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  const scoresContainer = document.getElementById('modalScores'); scoresContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  for (let i = 0; i < 10; i++) { scoresContainer.insertAdjacentHTML('beforeend', `<div class="modal-score-item"><strong>[${i + 1}] ${scoreLabels[i]}ï¼š</strong> ${detail.scores[i]} ç‚¹</div>`); }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const driveLinkBtn = document.getElementById('driveLink');
Â  Â  Â  Â  Â  Â  if (customerData.shared_folder_url) { driveLinkBtn.href = customerData.shared_folder_url; driveLinkBtn.style.display = 'block'; } else { driveLinkBtn.style.display = 'none'; }
Â  Â  Â  Â  Â  Â  new bootstrap.Modal(document.getElementById('historyDetailModal')).show();
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>

# ä»Šå›ã®ä¿®æ­£ä¾é ¼å†…å®¹
index.htmlã®å†™çœŸã¯OKã€‚ãŸã ã—history.htmlã®å†™çœŸã¨ã‚°ãƒ©ãƒ•ãŒä¾ç„¶ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œãªã„ã€‚
ä¿®æ­£ã›ã‚ˆã€‚
